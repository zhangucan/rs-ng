/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { forwardRef, Inject, Injectable } from '@angular/core';
import { Ng2ImgMaxService } from 'ng2-img-max';
import { Subject } from 'rxjs';
import { ImgCropService } from './img-crop.service';
import * as i0 from "@angular/core";
import * as i1 from "ng2-img-max/dist/src/ng2-img-max.service";
import * as i2 from "./img-crop.service";
export class ImgResizeExactService {
    /**
     * @param {?} ng2ImgMaxService
     * @param {?} imgCropService
     */
    constructor(ng2ImgMaxService, imgCropService) {
        this.ng2ImgMaxService = ng2ImgMaxService;
        this.imgCropService = imgCropService;
    }
    /**
     * @param {?} file
     * @param {?} toWidth
     * @param {?} toHeight
     * @param {?=} fillColor
     * @return {?}
     */
    resizeExactFill(file, toWidth, toHeight, fillColor) {
        /** @type {?} */
        const resizedImageSubject = new Subject();
        if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
            setTimeout(() => {
                resizedImageSubject.error({
                    resizedFile: file,
                    reason: 'File provided is neither of type jpg nor of type png.',
                    error: 'INVALID_EXTENSION'
                });
            }, 0);
            return resizedImageSubject.asObservable();
        }
        /** @type {?} */
        const img = new Image();
        img.onload = () => {
            this.ng2ImgMaxService.getEXIFOrientedImage(img).then(orientedImg => {
                window.URL.revokeObjectURL(img.src);
                /** @type {?} */
                const imgRatio = orientedImg.width / orientedImg.height;
                /** @type {?} */
                const resizedRatio = toWidth / toHeight;
                /* ratio > 1 means width > height */
                /* setting one parameter of ng2ImgMaxService very high will ensure that the resizing will fit the other provided parameter */
                /** @type {?} */
                let resizeHeight = 100000;
                /** @type {?} */
                let resizeWidth = 100000;
                if (imgRatio > resizedRatio) {
                    /* the original height is smaller than the resized height as in ratio, therefore we have to resize to width, then fill to the height */
                    resizeWidth = toWidth;
                }
                else if (imgRatio <= resizedRatio) {
                    /* the original height is bigger than the resized height as in ratio, therefore we can resize to height, then fill to the width */
                    resizeHeight = toHeight;
                }
                this.ng2ImgMaxService.resize([file], resizeWidth, resizeHeight).subscribe((resizeResult) => {
                    /* To fill the image based on the center, we calculate where the img needs to be positioned to be centered*/
                    /** @type {?} */
                    let startX = 0;
                    /** @type {?} */
                    let startY = 0;
                    /* one side is already resized exactly to the desired size, now fill the other side */
                    if (resizeWidth === 100000) {
                        /* resized to height -> as we fill to the width, we have to set startX */
                        /** @type {?} */
                        const newImgWidth = orientedImg.width / (orientedImg.height / toHeight);
                        startX = (newImgWidth - toWidth) / 2;
                    }
                    else if (resizeHeight === 100000) {
                        /* resized to width -> as we fill to the height, we have to set startY */
                        /** @type {?} */
                        const newImgHeight = orientedImg.height / (orientedImg.width / toWidth);
                        startY = (newImgHeight - toHeight) / 2;
                    }
                    /** @type {?} */
                    const img = new Image();
                    /** @type {?} */
                    const cvs = document.createElement('canvas');
                    /** @type {?} */
                    let ctx = cvs.getContext('2d');
                    img.onload = () => {
                        cvs.width = toWidth;
                        cvs.height = toHeight;
                        if (fillColor) {
                            ctx.fillStyle = fillColor;
                            ctx.fillRect(0, 0, toWidth, toHeight);
                        }
                        ctx.drawImage(img, startX, startY, toWidth, toHeight, 0, 0, toWidth, toHeight);
                        /** @type {?} */
                        const imageData = ctx.getImageData(0, 0, toWidth, toHeight);
                        /** @type {?} */
                        let useAlpha = true;
                        if (file.type === 'image/jpeg' || (file.type === 'image/png' && !this.isImgUsingAlpha(imageData))) {
                            // image without alpha
                            useAlpha = false;
                            ctx = cvs.getContext('2d', { 'alpha': false });
                            if (fillColor) {
                                ctx.fillStyle = fillColor;
                                ctx.fillRect(0, 0, toWidth, toHeight);
                            }
                            ctx.drawImage(img, startX, startY, toWidth, toHeight, 0, 0, toWidth, toHeight);
                        }
                        cvs.toBlob((blob) => {
                            window.URL.revokeObjectURL(img.src);
                            /** @type {?} */
                            const newFile = this.generateResultFile(blob, file.name, file.type, new Date().getTime());
                            // END OF CROPPING
                            resizedImageSubject.next(newFile);
                        }, useAlpha ? 'image/png' : 'image/jpeg');
                    };
                    img.src = window.URL.createObjectURL(resizeResult);
                }, error => {
                    // something went wrong
                    resizedImageSubject.error(error);
                });
            });
        };
        img.src = window.URL.createObjectURL(file);
        return resizedImageSubject.asObservable();
    }
    /**
     * @param {?} file
     * @param {?} toWidth
     * @param {?} toHeight
     * @return {?}
     */
    resizeExactCrop(file, toWidth, toHeight) {
        /** @type {?} */
        const resizedImageSubject = new Subject();
        if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
            setTimeout(() => {
                resizedImageSubject.error({
                    resizedFile: file,
                    reason: 'File provided is neither of type jpg nor of type png.',
                    error: 'INVALID_EXTENSION'
                });
            }, 0);
            return resizedImageSubject.asObservable();
        }
        /** @type {?} */
        const img = new Image();
        img.onload = () => {
            this.ng2ImgMaxService.getEXIFOrientedImage(img).then(orientedImg => {
                window.URL.revokeObjectURL(img.src);
                /** @type {?} */
                const imgRatio = orientedImg.width / orientedImg.height;
                /** @type {?} */
                const resizedRatio = toWidth / toHeight;
                /* ratio > 1 means width > height */
                /* setting one parameter of ng2ImgMaxService very high will ensure that the resizing will fit the other provided parameter */
                /** @type {?} */
                let resizeHeight = 100000;
                /** @type {?} */
                let resizeWidth = 100000;
                /* To crop the image based on the center, so we will keep the most important part of the image, we calculate to crop from where to where */
                /** @type {?} */
                let startX = 0;
                /** @type {?} */
                let startY = 0;
                if (imgRatio > resizedRatio) {
                    /* the original height is smaller than the resized height as in ratio, therefore we have to resize to height, then crop to the width */
                    resizeHeight = toHeight;
                }
                else if (imgRatio <= resizedRatio) {
                    /* the original height is bigger than the resized height as in ratio, therefore we can resize to width, then crop to the height */
                    resizeWidth = toWidth;
                }
                this.ng2ImgMaxService.resize([file], resizeWidth, resizeHeight).subscribe((resizeResult) => {
                    /* one side is already resized exactly to the desired size, now crop the other side */
                    if (resizeWidth === 100000) {
                        /* resized to height -> as we crop to the width, we have to set startX */
                        /** @type {?} */
                        const newImgWidth = orientedImg.width / (orientedImg.height / toHeight);
                        startX = (newImgWidth - toWidth) / 2;
                    }
                    else if (resizeHeight === 100000) {
                        /* resized to width -> as we crop to the height, we have to set startY */
                        /** @type {?} */
                        const newImgHeight = orientedImg.height / (orientedImg.width / toWidth);
                        startY = (newImgHeight - toHeight) / 2;
                    }
                    this.imgCropService.cropImage(resizeResult, toWidth, toHeight, startX, startY).subscribe((cropResult) => {
                        // all good, result is a file
                        resizedImageSubject.next(cropResult);
                    }, error => {
                        // something went wrong
                        resizedImageSubject.error(error);
                    });
                }, error => {
                    // something went wrong
                    resizedImageSubject.error(error);
                });
            });
        };
        img.src = window.URL.createObjectURL(file);
        return resizedImageSubject.asObservable();
    }
    /**
     * @private
     * @param {?} imageData
     * @return {?}
     */
    isImgUsingAlpha(imageData) {
        for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i + 3] !== 255) {
                return true;
            }
        }
        return false;
    }
    /**
     * @private
     * @param {?} blob
     * @param {?} name
     * @param {?} type
     * @param {?} lastModified
     * @return {?}
     */
    generateResultFile(blob, name, type, lastModified) {
        /** @type {?} */
        const resultFile = new Blob([blob], { type: type });
        return this.blobToFile(resultFile, name, lastModified);
    }
    /**
     * @private
     * @param {?} blob
     * @param {?} name
     * @param {?} lastModified
     * @return {?}
     */
    blobToFile(blob, name, lastModified) {
        /** @type {?} */
        const file = blob;
        file.name = name;
        file.lastModified = lastModified;
        // Cast to a File() type
        return (/** @type {?} */ (file));
    }
}
ImgResizeExactService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
ImgResizeExactService.ctorParameters = () => [
    { type: Ng2ImgMaxService, decorators: [{ type: Inject, args: [forwardRef(() => Ng2ImgMaxService),] }] },
    { type: ImgCropService, decorators: [{ type: Inject, args: [forwardRef(() => ImgCropService),] }] }
];
/** @nocollapse */ ImgResizeExactService.ngInjectableDef = i0.defineInjectable({ factory: function ImgResizeExactService_Factory() { return new ImgResizeExactService(i0.inject(i1.Ng2ImgMaxService), i0.inject(i2.ImgCropService)); }, token: ImgResizeExactService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ImgResizeExactService.prototype.ng2ImgMaxService;
    /**
     * @type {?}
     * @private
     */
    ImgResizeExactService.prototype.imgCropService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1nLXJlc2l6ZS1leGFjdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVyL3NoYXJlLyIsInNvdXJjZXMiOlsibGliL2ltYWdlLWVkaXRvci9zZXJ2aWNlcy9pbWctcmVzaXplLWV4YWN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFDN0MsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sb0JBQW9CLENBQUM7Ozs7QUFLbEQsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7SUFDaEMsWUFBZ0UsZ0JBQWtDLEVBQ3BDLGNBQThCO1FBRDVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDcEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQzVGLENBQUM7Ozs7Ozs7O0lBRU0sZUFBZSxDQUFDLElBQVUsRUFBRSxPQUFlLEVBQUUsUUFBZ0IsRUFBRSxTQUFrQjs7Y0FDaEYsbUJBQW1CLEdBQWlCLElBQUksT0FBTyxFQUFPO1FBQzVELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7WUFDM0QsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDZCxtQkFBbUIsQ0FBQyxLQUFLLENBQUM7b0JBQ3hCLFdBQVcsRUFBRSxJQUFJO29CQUNqQixNQUFNLEVBQUUsdURBQXVEO29CQUMvRCxLQUFLLEVBQUUsbUJBQW1CO2lCQUMzQixDQUFDLENBQUM7WUFDTCxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDTixPQUFPLG1CQUFtQixDQUFDLFlBQVksRUFBRSxDQUFDO1NBQzNDOztjQUNLLEdBQUcsR0FBRyxJQUFJLEtBQUss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O0lBQ3JCLENBQUM7OztZQXZMRixVQUFVLFNBQ1QsRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDOzs7O1lBTGQsZ0JBQWdCLHVCQVFULE1BQU0sU0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQUM7WUFOaEQsY0FBYyx1QkFPUCxNQUFNLFNBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQzs7Ozs7Ozs7SUFEeEMsaURBQXNGOzs7OztJQUN0RiwrQ0FBZ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2ZvcndhcmRSZWYsIEluamVjdCwgSW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge05nMkltZ01heFNlcnZpY2V9IGZyb20gJ25nMi1pbWctbWF4JztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0ltZ0Nyb3BTZXJ2aWNlfSBmcm9tICcuL2ltZy1jcm9wLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZShcbiAge3Byb3ZpZGVkSW46ICdyb290J31cbilcbmV4cG9ydCBjbGFzcyBJbWdSZXNpemVFeGFjdFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gTmcySW1nTWF4U2VydmljZSkpIHByaXZhdGUgbmcySW1nTWF4U2VydmljZTogTmcySW1nTWF4U2VydmljZSxcbiAgICAgICAgICAgICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IEltZ0Nyb3BTZXJ2aWNlKSkgcHJpdmF0ZSBpbWdDcm9wU2VydmljZTogSW1nQ3JvcFNlcnZpY2UpIHtcbiAgfVxuXG4gIHB1YmxpYyByZXNpemVFeGFjdEZpbGwoZmlsZTogRmlsZSwgdG9XaWR0aDogbnVtYmVyLCB0b0hlaWdodDogbnVtYmVyLCBmaWxsQ29sb3I/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJlc2l6ZWRJbWFnZVN1YmplY3Q6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICBpZiAoZmlsZS50eXBlICE9PSAnaW1hZ2UvanBlZycgJiYgZmlsZS50eXBlICE9PSAnaW1hZ2UvcG5nJykge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHJlc2l6ZWRJbWFnZVN1YmplY3QuZXJyb3Ioe1xuICAgICAgICAgIHJlc2l6ZWRGaWxlOiBmaWxlLFxuICAgICAgICAgIHJlYXNvbjogJ0ZpbGUgcHJvdmlkZWQgaXMgbmVpdGhlciBvZiB0eXBlIGpwZyBub3Igb2YgdHlwZSBwbmcuJyxcbiAgICAgICAgICBlcnJvcjogJ0lOVkFMSURfRVhURU5TSU9OJ1xuICAgICAgICB9KTtcbiAgICAgIH0sIDApO1xuICAgICAgcmV0dXJuIHJlc2l6ZWRJbWFnZVN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICB0aGlzLm5nMkltZ01heFNlcnZpY2UuZ2V0RVhJRk9yaWVudGVkSW1hZ2UoaW1nKS50aGVuKG9yaWVudGVkSW1nID0+IHtcbiAgICAgICAgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwoaW1nLnNyYyk7XG4gICAgICAgIGNvbnN0IGltZ1JhdGlvID0gb3JpZW50ZWRJbWcud2lkdGggLyBvcmllbnRlZEltZy5oZWlnaHQ7XG4gICAgICAgIGNvbnN0IHJlc2l6ZWRSYXRpbyA9IHRvV2lkdGggLyB0b0hlaWdodDtcbiAgICAgICAgLyogcmF0aW8gPiAxIG1lYW5zIHdpZHRoID4gaGVpZ2h0ICovXG5cbiAgICAgICAgLyogc2V0dGluZyBvbmUgcGFyYW1ldGVyIG9mIG5nMkltZ01heFNlcnZpY2UgdmVyeSBoaWdoIHdpbGwgZW5zdXJlIHRoYXQgdGhlIHJlc2l6aW5nIHdpbGwgZml0IHRoZSBvdGhlciBwcm92aWRlZCBwYXJhbWV0ZXIgKi9cbiAgICAgICAgbGV0IHJlc2l6ZUhlaWdodCA9IDEwMDAwMDtcbiAgICAgICAgbGV0IHJlc2l6ZVdpZHRoID0gMTAwMDAwO1xuXG4gICAgICAgIGlmIChpbWdSYXRpbyA+IHJlc2l6ZWRSYXRpbykge1xuICAgICAgICAgIC8qIHRoZSBvcmlnaW5hbCBoZWlnaHQgaXMgc21hbGxlciB0aGFuIHRoZSByZXNpemVkIGhlaWdodCBhcyBpbiByYXRpbywgdGhlcmVmb3JlIHdlIGhhdmUgdG8gcmVzaXplIHRvIHdpZHRoLCB0aGVuIGZpbGwgdG8gdGhlIGhlaWdodCAqL1xuICAgICAgICAgIHJlc2l6ZVdpZHRoID0gdG9XaWR0aDtcbiAgICAgICAgfSBlbHNlIGlmIChpbWdSYXRpbyA8PSByZXNpemVkUmF0aW8pIHtcbiAgICAgICAgICAvKiB0aGUgb3JpZ2luYWwgaGVpZ2h0IGlzIGJpZ2dlciB0aGFuIHRoZSByZXNpemVkIGhlaWdodCBhcyBpbiByYXRpbywgdGhlcmVmb3JlIHdlIGNhbiByZXNpemUgdG8gaGVpZ2h0LCB0aGVuIGZpbGwgdG8gdGhlIHdpZHRoICovXG4gICAgICAgICAgcmVzaXplSGVpZ2h0ID0gdG9IZWlnaHQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm5nMkltZ01heFNlcnZpY2UucmVzaXplKFtmaWxlXSwgcmVzaXplV2lkdGgsIHJlc2l6ZUhlaWdodCkuc3Vic2NyaWJlKChyZXNpemVSZXN1bHQpID0+IHtcblxuICAgICAgICAgIC8qIFRvIGZpbGwgdGhlIGltYWdlIGJhc2VkIG9uIHRoZSBjZW50ZXIsIHdlIGNhbGN1bGF0ZSB3aGVyZSB0aGUgaW1nIG5lZWRzIHRvIGJlIHBvc2l0aW9uZWQgdG8gYmUgY2VudGVyZWQqL1xuICAgICAgICAgIGxldCBzdGFydFggPSAwO1xuICAgICAgICAgIGxldCBzdGFydFkgPSAwO1xuXG4gICAgICAgICAgLyogb25lIHNpZGUgaXMgYWxyZWFkeSByZXNpemVkIGV4YWN0bHkgdG8gdGhlIGRlc2lyZWQgc2l6ZSwgbm93IGZpbGwgdGhlIG90aGVyIHNpZGUgKi9cbiAgICAgICAgICBpZiAocmVzaXplV2lkdGggPT09IDEwMDAwMCkge1xuICAgICAgICAgICAgLyogcmVzaXplZCB0byBoZWlnaHQgLT4gYXMgd2UgZmlsbCB0byB0aGUgd2lkdGgsIHdlIGhhdmUgdG8gc2V0IHN0YXJ0WCAqL1xuICAgICAgICAgICAgY29uc3QgbmV3SW1nV2lkdGggPSBvcmllbnRlZEltZy53aWR0aCAvIChvcmllbnRlZEltZy5oZWlnaHQgLyB0b0hlaWdodCk7XG4gICAgICAgICAgICBzdGFydFggPSAobmV3SW1nV2lkdGggLSB0b1dpZHRoKSAvIDI7XG4gICAgICAgICAgfSBlbHNlIGlmIChyZXNpemVIZWlnaHQgPT09IDEwMDAwMCkge1xuICAgICAgICAgICAgLyogcmVzaXplZCB0byB3aWR0aCAtPiBhcyB3ZSBmaWxsIHRvIHRoZSBoZWlnaHQsIHdlIGhhdmUgdG8gc2V0IHN0YXJ0WSAqL1xuICAgICAgICAgICAgY29uc3QgbmV3SW1nSGVpZ2h0ID0gb3JpZW50ZWRJbWcuaGVpZ2h0IC8gKG9yaWVudGVkSW1nLndpZHRoIC8gdG9XaWR0aCk7XG4gICAgICAgICAgICBzdGFydFkgPSAobmV3SW1nSGVpZ2h0IC0gdG9IZWlnaHQpIC8gMjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgICBjb25zdCBjdnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgICBsZXQgY3R4ID0gY3ZzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICAgIGN2cy53aWR0aCA9IHRvV2lkdGg7XG4gICAgICAgICAgICBjdnMuaGVpZ2h0ID0gdG9IZWlnaHQ7XG4gICAgICAgICAgICBpZiAoZmlsbENvbG9yKSB7XG4gICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBmaWxsQ29sb3I7XG4gICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB0b1dpZHRoLCB0b0hlaWdodCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdHguZHJhd0ltYWdlKGltZywgc3RhcnRYLCBzdGFydFksIHRvV2lkdGgsIHRvSGVpZ2h0LCAwLCAwLCB0b1dpZHRoLCB0b0hlaWdodCk7XG4gICAgICAgICAgICBjb25zdCBpbWFnZURhdGEgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIHRvV2lkdGgsIHRvSGVpZ2h0KTtcbiAgICAgICAgICAgIGxldCB1c2VBbHBoYSA9IHRydWU7XG4gICAgICAgICAgICBpZiAoZmlsZS50eXBlID09PSAnaW1hZ2UvanBlZycgfHwgKGZpbGUudHlwZSA9PT0gJ2ltYWdlL3BuZycgJiYgIXRoaXMuaXNJbWdVc2luZ0FscGhhKGltYWdlRGF0YSkpKSB7XG4gICAgICAgICAgICAgIC8vIGltYWdlIHdpdGhvdXQgYWxwaGFcbiAgICAgICAgICAgICAgdXNlQWxwaGEgPSBmYWxzZTtcbiAgICAgICAgICAgICAgY3R4ID0gY3ZzLmdldENvbnRleHQoJzJkJywgeydhbHBoYSc6IGZhbHNlfSk7XG4gICAgICAgICAgICAgIGlmIChmaWxsQ29sb3IpIHtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbENvbG9yO1xuICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB0b1dpZHRoLCB0b0hlaWdodCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIHN0YXJ0WCwgc3RhcnRZLCB0b1dpZHRoLCB0b0hlaWdodCwgMCwgMCwgdG9XaWR0aCwgdG9IZWlnaHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3ZzLnRvQmxvYigoYmxvYikgPT4ge1xuICAgICAgICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChpbWcuc3JjKTtcbiAgICAgICAgICAgICAgY29uc3QgbmV3RmlsZTogRmlsZSA9IHRoaXMuZ2VuZXJhdGVSZXN1bHRGaWxlKGJsb2IsIGZpbGUubmFtZSwgZmlsZS50eXBlLCBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gICAgICAgICAgICAgIC8vIEVORCBPRiBDUk9QUElOR1xuICAgICAgICAgICAgICByZXNpemVkSW1hZ2VTdWJqZWN0Lm5leHQobmV3RmlsZSk7XG4gICAgICAgICAgICB9LCB1c2VBbHBoYSA/ICdpbWFnZS9wbmcnIDogJ2ltYWdlL2pwZWcnKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGltZy5zcmMgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChyZXNpemVSZXN1bHQpO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgLy8gc29tZXRoaW5nIHdlbnQgd3JvbmdcbiAgICAgICAgICByZXNpemVkSW1hZ2VTdWJqZWN0LmVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9O1xuICAgIGltZy5zcmMgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChmaWxlKTtcbiAgICByZXR1cm4gcmVzaXplZEltYWdlU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHB1YmxpYyByZXNpemVFeGFjdENyb3AoZmlsZTogRmlsZSwgdG9XaWR0aDogbnVtYmVyLCB0b0hlaWdodDogbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXNpemVkSW1hZ2VTdWJqZWN0OiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gICAgaWYgKGZpbGUudHlwZSAhPT0gJ2ltYWdlL2pwZWcnICYmIGZpbGUudHlwZSAhPT0gJ2ltYWdlL3BuZycpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICByZXNpemVkSW1hZ2VTdWJqZWN0LmVycm9yKHtcbiAgICAgICAgICByZXNpemVkRmlsZTogZmlsZSxcbiAgICAgICAgICByZWFzb246ICdGaWxlIHByb3ZpZGVkIGlzIG5laXRoZXIgb2YgdHlwZSBqcGcgbm9yIG9mIHR5cGUgcG5nLicsXG4gICAgICAgICAgZXJyb3I6ICdJTlZBTElEX0VYVEVOU0lPTidcbiAgICAgICAgfSk7XG4gICAgICB9LCAwKTtcbiAgICAgIHJldHVybiByZXNpemVkSW1hZ2VTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cbiAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgdGhpcy5uZzJJbWdNYXhTZXJ2aWNlLmdldEVYSUZPcmllbnRlZEltYWdlKGltZykudGhlbihvcmllbnRlZEltZyA9PiB7XG4gICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKGltZy5zcmMpO1xuICAgICAgICBjb25zdCBpbWdSYXRpbyA9IG9yaWVudGVkSW1nLndpZHRoIC8gb3JpZW50ZWRJbWcuaGVpZ2h0O1xuICAgICAgICBjb25zdCByZXNpemVkUmF0aW8gPSB0b1dpZHRoIC8gdG9IZWlnaHQ7XG4gICAgICAgIC8qIHJhdGlvID4gMSBtZWFucyB3aWR0aCA+IGhlaWdodCAqL1xuXG4gICAgICAgIC8qIHNldHRpbmcgb25lIHBhcmFtZXRlciBvZiBuZzJJbWdNYXhTZXJ2aWNlIHZlcnkgaGlnaCB3aWxsIGVuc3VyZSB0aGF0IHRoZSByZXNpemluZyB3aWxsIGZpdCB0aGUgb3RoZXIgcHJvdmlkZWQgcGFyYW1ldGVyICovXG4gICAgICAgIGxldCByZXNpemVIZWlnaHQgPSAxMDAwMDA7XG4gICAgICAgIGxldCByZXNpemVXaWR0aCA9IDEwMDAwMDtcblxuICAgICAgICAvKiBUbyBjcm9wIHRoZSBpbWFnZSBiYXNlZCBvbiB0aGUgY2VudGVyLCBzbyB3ZSB3aWxsIGtlZXAgdGhlIG1vc3QgaW1wb3J0YW50IHBhcnQgb2YgdGhlIGltYWdlLCB3ZSBjYWxjdWxhdGUgdG8gY3JvcCBmcm9tIHdoZXJlIHRvIHdoZXJlICovXG4gICAgICAgIGxldCBzdGFydFggPSAwO1xuICAgICAgICBsZXQgc3RhcnRZID0gMDtcblxuICAgICAgICBpZiAoaW1nUmF0aW8gPiByZXNpemVkUmF0aW8pIHtcbiAgICAgICAgICAvKiB0aGUgb3JpZ2luYWwgaGVpZ2h0IGlzIHNtYWxsZXIgdGhhbiB0aGUgcmVzaXplZCBoZWlnaHQgYXMgaW4gcmF0aW8sIHRoZXJlZm9yZSB3ZSBoYXZlIHRvIHJlc2l6ZSB0byBoZWlnaHQsIHRoZW4gY3JvcCB0byB0aGUgd2lkdGggKi9cbiAgICAgICAgICByZXNpemVIZWlnaHQgPSB0b0hlaWdodDtcbiAgICAgICAgfSBlbHNlIGlmIChpbWdSYXRpbyA8PSByZXNpemVkUmF0aW8pIHtcbiAgICAgICAgICAvKiB0aGUgb3JpZ2luYWwgaGVpZ2h0IGlzIGJpZ2dlciB0aGFuIHRoZSByZXNpemVkIGhlaWdodCBhcyBpbiByYXRpbywgdGhlcmVmb3JlIHdlIGNhbiByZXNpemUgdG8gd2lkdGgsIHRoZW4gY3JvcCB0byB0aGUgaGVpZ2h0ICovXG4gICAgICAgICAgcmVzaXplV2lkdGggPSB0b1dpZHRoO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5uZzJJbWdNYXhTZXJ2aWNlLnJlc2l6ZShbZmlsZV0sIHJlc2l6ZVdpZHRoLCByZXNpemVIZWlnaHQpLnN1YnNjcmliZSgocmVzaXplUmVzdWx0KSA9PiB7XG4gICAgICAgICAgLyogb25lIHNpZGUgaXMgYWxyZWFkeSByZXNpemVkIGV4YWN0bHkgdG8gdGhlIGRlc2lyZWQgc2l6ZSwgbm93IGNyb3AgdGhlIG90aGVyIHNpZGUgKi9cbiAgICAgICAgICBpZiAocmVzaXplV2lkdGggPT09IDEwMDAwMCkge1xuICAgICAgICAgICAgLyogcmVzaXplZCB0byBoZWlnaHQgLT4gYXMgd2UgY3JvcCB0byB0aGUgd2lkdGgsIHdlIGhhdmUgdG8gc2V0IHN0YXJ0WCAqL1xuICAgICAgICAgICAgY29uc3QgbmV3SW1nV2lkdGggPSBvcmllbnRlZEltZy53aWR0aCAvIChvcmllbnRlZEltZy5oZWlnaHQgLyB0b0hlaWdodCk7XG4gICAgICAgICAgICBzdGFydFggPSAobmV3SW1nV2lkdGggLSB0b1dpZHRoKSAvIDI7XG4gICAgICAgICAgfSBlbHNlIGlmIChyZXNpemVIZWlnaHQgPT09IDEwMDAwMCkge1xuICAgICAgICAgICAgLyogcmVzaXplZCB0byB3aWR0aCAtPiBhcyB3ZSBjcm9wIHRvIHRoZSBoZWlnaHQsIHdlIGhhdmUgdG8gc2V0IHN0YXJ0WSAqL1xuICAgICAgICAgICAgY29uc3QgbmV3SW1nSGVpZ2h0ID0gb3JpZW50ZWRJbWcuaGVpZ2h0IC8gKG9yaWVudGVkSW1nLndpZHRoIC8gdG9XaWR0aCk7XG4gICAgICAgICAgICBzdGFydFkgPSAobmV3SW1nSGVpZ2h0IC0gdG9IZWlnaHQpIC8gMjtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5pbWdDcm9wU2VydmljZS5jcm9wSW1hZ2UocmVzaXplUmVzdWx0LCB0b1dpZHRoLCB0b0hlaWdodCwgc3RhcnRYLCBzdGFydFkpLnN1YnNjcmliZSgoY3JvcFJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgLy8gYWxsIGdvb2QsIHJlc3VsdCBpcyBhIGZpbGVcbiAgICAgICAgICAgIHJlc2l6ZWRJbWFnZVN1YmplY3QubmV4dChjcm9wUmVzdWx0KTtcbiAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAvLyBzb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgICAgICAgICAgcmVzaXplZEltYWdlU3ViamVjdC5lcnJvcihlcnJvcik7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAvLyBzb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgICAgICAgIHJlc2l6ZWRJbWFnZVN1YmplY3QuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH07XG4gICAgaW1nLnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpO1xuICAgIHJldHVybiByZXNpemVkSW1hZ2VTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0ltZ1VzaW5nQWxwaGEoaW1hZ2VEYXRhKTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbWFnZURhdGEuZGF0YS5sZW5ndGg7IGkgKz0gNCkge1xuICAgICAgaWYgKGltYWdlRGF0YS5kYXRhW2kgKyAzXSAhPT0gMjU1KSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlUmVzdWx0RmlsZShibG9iOiBCbG9iLCBuYW1lOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgbGFzdE1vZGlmaWVkOiBudW1iZXIpOiBGaWxlIHtcbiAgICBjb25zdCByZXN1bHRGaWxlID0gbmV3IEJsb2IoW2Jsb2JdLCB7dHlwZTogdHlwZX0pO1xuICAgIHJldHVybiB0aGlzLmJsb2JUb0ZpbGUocmVzdWx0RmlsZSwgbmFtZSwgbGFzdE1vZGlmaWVkKTtcbiAgfVxuXG4gIHByaXZhdGUgYmxvYlRvRmlsZShibG9iOiBCbG9iLCBuYW1lOiBzdHJpbmcsIGxhc3RNb2RpZmllZDogbnVtYmVyKTogRmlsZSB7XG4gICAgY29uc3QgZmlsZTogYW55ID0gYmxvYjtcbiAgICBmaWxlLm5hbWUgPSBuYW1lO1xuICAgIGZpbGUubGFzdE1vZGlmaWVkID0gbGFzdE1vZGlmaWVkO1xuXG4gICAgLy8gQ2FzdCB0byBhIEZpbGUoKSB0eXBlXG4gICAgcmV0dXJuIDxGaWxlPiBmaWxlO1xuICB9XG59XG4iXX0=