/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { forwardRef, Inject, Injectable } from '@angular/core';
import { Ng2ImgMaxService } from 'ng2-img-max';
import { Subject } from 'rxjs';
import { ImgCropService } from './img-crop.service';
import * as i0 from "@angular/core";
import * as i1 from "ng2-img-max/dist/src/ng2-img-max.service";
import * as i2 from "./img-crop.service";
var ImgResizeExactService = /** @class */ (function () {
    function ImgResizeExactService(ng2ImgMaxService, imgCropService) {
        this.ng2ImgMaxService = ng2ImgMaxService;
        this.imgCropService = imgCropService;
    }
    /**
     * @param {?} file
     * @param {?} toWidth
     * @param {?} toHeight
     * @param {?=} fillColor
     * @return {?}
     */
    ImgResizeExactService.prototype.resizeExactFill = /**
     * @param {?} file
     * @param {?} toWidth
     * @param {?} toHeight
     * @param {?=} fillColor
     * @return {?}
     */
    function (file, toWidth, toHeight, fillColor) {
        var _this = this;
        /** @type {?} */
        var resizedImageSubject = new Subject();
        if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
            setTimeout(function () {
                resizedImageSubject.error({
                    resizedFile: file,
                    reason: 'File provided is neither of type jpg nor of type png.',
                    error: 'INVALID_EXTENSION'
                });
            }, 0);
            return resizedImageSubject.asObservable();
        }
        /** @type {?} */
        var img = new Image();
        img.onload = function () {
            _this.ng2ImgMaxService.getEXIFOrientedImage(img).then(function (orientedImg) {
                window.URL.revokeObjectURL(img.src);
                /** @type {?} */
                var imgRatio = orientedImg.width / orientedImg.height;
                /** @type {?} */
                var resizedRatio = toWidth / toHeight;
                /* ratio > 1 means width > height */
                /* setting one parameter of ng2ImgMaxService very high will ensure that the resizing will fit the other provided parameter */
                /** @type {?} */
                var resizeHeight = 100000;
                /** @type {?} */
                var resizeWidth = 100000;
                if (imgRatio > resizedRatio) {
                    /* the original height is smaller than the resized height as in ratio, therefore we have to resize to width, then fill to the height */
                    resizeWidth = toWidth;
                }
                else if (imgRatio <= resizedRatio) {
                    /* the original height is bigger than the resized height as in ratio, therefore we can resize to height, then fill to the width */
                    resizeHeight = toHeight;
                }
                _this.ng2ImgMaxService.resize([file], resizeWidth, resizeHeight).subscribe(function (resizeResult) {
                    /* To fill the image based on the center, we calculate where the img needs to be positioned to be centered*/
                    /** @type {?} */
                    var startX = 0;
                    /** @type {?} */
                    var startY = 0;
                    /* one side is already resized exactly to the desired size, now fill the other side */
                    if (resizeWidth === 100000) {
                        /* resized to height -> as we fill to the width, we have to set startX */
                        /** @type {?} */
                        var newImgWidth = orientedImg.width / (orientedImg.height / toHeight);
                        startX = (newImgWidth - toWidth) / 2;
                    }
                    else if (resizeHeight === 100000) {
                        /* resized to width -> as we fill to the height, we have to set startY */
                        /** @type {?} */
                        var newImgHeight = orientedImg.height / (orientedImg.width / toWidth);
                        startY = (newImgHeight - toHeight) / 2;
                    }
                    /** @type {?} */
                    var img = new Image();
                    /** @type {?} */
                    var cvs = document.createElement('canvas');
                    /** @type {?} */
                    var ctx = cvs.getContext('2d');
                    img.onload = function () {
                        cvs.width = toWidth;
                        cvs.height = toHeight;
                        if (fillColor) {
                            ctx.fillStyle = fillColor;
                            ctx.fillRect(0, 0, toWidth, toHeight);
                        }
                        ctx.drawImage(img, startX, startY, toWidth, toHeight, 0, 0, toWidth, toHeight);
                        /** @type {?} */
                        var imageData = ctx.getImageData(0, 0, toWidth, toHeight);
                        /** @type {?} */
                        var useAlpha = true;
                        if (file.type === 'image/jpeg' || (file.type === 'image/png' && !_this.isImgUsingAlpha(imageData))) {
                            // image without alpha
                            useAlpha = false;
                            ctx = cvs.getContext('2d', { 'alpha': false });
                            if (fillColor) {
                                ctx.fillStyle = fillColor;
                                ctx.fillRect(0, 0, toWidth, toHeight);
                            }
                            ctx.drawImage(img, startX, startY, toWidth, toHeight, 0, 0, toWidth, toHeight);
                        }
                        cvs.toBlob(function (blob) {
                            window.URL.revokeObjectURL(img.src);
                            /** @type {?} */
                            var newFile = _this.generateResultFile(blob, file.name, file.type, new Date().getTime());
                            // END OF CROPPING
                            resizedImageSubject.next(newFile);
                        }, useAlpha ? 'image/png' : 'image/jpeg');
                    };
                    img.src = window.URL.createObjectURL(resizeResult);
                }, function (error) {
                    // something went wrong
                    resizedImageSubject.error(error);
                });
            });
        };
        img.src = window.URL.createObjectURL(file);
        return resizedImageSubject.asObservable();
    };
    /**
     * @param {?} file
     * @param {?} toWidth
     * @param {?} toHeight
     * @return {?}
     */
    ImgResizeExactService.prototype.resizeExactCrop = /**
     * @param {?} file
     * @param {?} toWidth
     * @param {?} toHeight
     * @return {?}
     */
    function (file, toWidth, toHeight) {
        var _this = this;
        /** @type {?} */
        var resizedImageSubject = new Subject();
        if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
            setTimeout(function () {
                resizedImageSubject.error({
                    resizedFile: file,
                    reason: 'File provided is neither of type jpg nor of type png.',
                    error: 'INVALID_EXTENSION'
                });
            }, 0);
            return resizedImageSubject.asObservable();
        }
        /** @type {?} */
        var img = new Image();
        img.onload = function () {
            _this.ng2ImgMaxService.getEXIFOrientedImage(img).then(function (orientedImg) {
                window.URL.revokeObjectURL(img.src);
                /** @type {?} */
                var imgRatio = orientedImg.width / orientedImg.height;
                /** @type {?} */
                var resizedRatio = toWidth / toHeight;
                /* ratio > 1 means width > height */
                /* setting one parameter of ng2ImgMaxService very high will ensure that the resizing will fit the other provided parameter */
                /** @type {?} */
                var resizeHeight = 100000;
                /** @type {?} */
                var resizeWidth = 100000;
                /* To crop the image based on the center, so we will keep the most important part of the image, we calculate to crop from where to where */
                /** @type {?} */
                var startX = 0;
                /** @type {?} */
                var startY = 0;
                if (imgRatio > resizedRatio) {
                    /* the original height is smaller than the resized height as in ratio, therefore we have to resize to height, then crop to the width */
                    resizeHeight = toHeight;
                }
                else if (imgRatio <= resizedRatio) {
                    /* the original height is bigger than the resized height as in ratio, therefore we can resize to width, then crop to the height */
                    resizeWidth = toWidth;
                }
                _this.ng2ImgMaxService.resize([file], resizeWidth, resizeHeight).subscribe(function (resizeResult) {
                    /* one side is already resized exactly to the desired size, now crop the other side */
                    if (resizeWidth === 100000) {
                        /* resized to height -> as we crop to the width, we have to set startX */
                        /** @type {?} */
                        var newImgWidth = orientedImg.width / (orientedImg.height / toHeight);
                        startX = (newImgWidth - toWidth) / 2;
                    }
                    else if (resizeHeight === 100000) {
                        /* resized to width -> as we crop to the height, we have to set startY */
                        /** @type {?} */
                        var newImgHeight = orientedImg.height / (orientedImg.width / toWidth);
                        startY = (newImgHeight - toHeight) / 2;
                    }
                    _this.imgCropService.cropImage(resizeResult, toWidth, toHeight, startX, startY).subscribe(function (cropResult) {
                        // all good, result is a file
                        resizedImageSubject.next(cropResult);
                    }, function (error) {
                        // something went wrong
                        resizedImageSubject.error(error);
                    });
                }, function (error) {
                    // something went wrong
                    resizedImageSubject.error(error);
                });
            });
        };
        img.src = window.URL.createObjectURL(file);
        return resizedImageSubject.asObservable();
    };
    /**
     * @private
     * @param {?} imageData
     * @return {?}
     */
    ImgResizeExactService.prototype.isImgUsingAlpha = /**
     * @private
     * @param {?} imageData
     * @return {?}
     */
    function (imageData) {
        for (var i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i + 3] !== 255) {
                return true;
            }
        }
        return false;
    };
    /**
     * @private
     * @param {?} blob
     * @param {?} name
     * @param {?} type
     * @param {?} lastModified
     * @return {?}
     */
    ImgResizeExactService.prototype.generateResultFile = /**
     * @private
     * @param {?} blob
     * @param {?} name
     * @param {?} type
     * @param {?} lastModified
     * @return {?}
     */
    function (blob, name, type, lastModified) {
        /** @type {?} */
        var resultFile = new Blob([blob], { type: type });
        return this.blobToFile(resultFile, name, lastModified);
    };
    /**
     * @private
     * @param {?} blob
     * @param {?} name
     * @param {?} lastModified
     * @return {?}
     */
    ImgResizeExactService.prototype.blobToFile = /**
     * @private
     * @param {?} blob
     * @param {?} name
     * @param {?} lastModified
     * @return {?}
     */
    function (blob, name, lastModified) {
        /** @type {?} */
        var file = blob;
        file.name = name;
        file.lastModified = lastModified;
        // Cast to a File() type
        return (/** @type {?} */ (file));
    };
    ImgResizeExactService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] }
    ];
    /** @nocollapse */
    ImgResizeExactService.ctorParameters = function () { return [
        { type: Ng2ImgMaxService, decorators: [{ type: Inject, args: [forwardRef(function () { return Ng2ImgMaxService; }),] }] },
        { type: ImgCropService, decorators: [{ type: Inject, args: [forwardRef(function () { return ImgCropService; }),] }] }
    ]; };
    /** @nocollapse */ ImgResizeExactService.ngInjectableDef = i0.defineInjectable({ factory: function ImgResizeExactService_Factory() { return new ImgResizeExactService(i0.inject(i1.Ng2ImgMaxService), i0.inject(i2.ImgCropService)); }, token: ImgResizeExactService, providedIn: "root" });
    return ImgResizeExactService;
}());
export { ImgResizeExactService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ImgResizeExactService.prototype.ng2ImgMaxService;
    /**
     * @type {?}
     * @private
     */
    ImgResizeExactService.prototype.imgCropService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1nLXJlc2l6ZS1leGFjdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVyL3NoYXJlLyIsInNvdXJjZXMiOlsibGliL2ltYWdlLWVkaXRvci9zZXJ2aWNlcy9pbWctcmVzaXplLWV4YWN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFDN0MsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sb0JBQW9CLENBQUM7Ozs7QUFFbEQ7SUFJRSwrQkFBZ0UsZ0JBQWtDLEVBQ3BDLGNBQThCO1FBRDVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDcEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQzVGLENBQUM7Ozs7Ozs7O0lBRU0sK0NBQWU7Ozs7Ozs7SUFBdEIsVUFBdUIsSUFBVSxFQUFFLE9BQWUsRUFBRSxRQUFnQixFQUFFLFNBQWtCO1FBQXhGLGlCQXdGQzs7WUF2Rk8sbUJBQW1CLEdBQWlCLElBQUksT0FBTyxFQUFPO1FBQzVELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7WUFDM0QsVUFBVSxDQUFDO2dCQUNULG1CQUFtQixDQUFDLEtBQUssQ0FBQztvQkFDeEIsV0FBVyxFQUFFLElBQUk7b0JBQ2pCLE1BQU0sRUFBRSx1REFBdUQ7b0JBQy9ELEtBQUssRUFBRSxtQkFBbUI7aUJBQzNCLENBQUMsQ0FBQztZQUNMLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNOLE9BQU8sbUJBQW1CLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDM0M7O1lBQ0ssR0FBRyxHQUFHLElBQUksS0FBSyxFQUFF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QU0sRUFBQzs7OztnQkFMZCxnQkFBZ0IsdUJBUVQsTUFBTSxTQUFDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsZ0JBQWdCLEVBQWhCLENBQWdCLENBQUM7Z0JBTmhELGNBQWMsdUJBT1AsTUFBTSxTQUFDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsY0FBYyxFQUFkLENBQWMsQ0FBQzs7O2dDQVZ0RDtDQTZMQyxBQXhMRCxJQXdMQztTQXJMWSxxQkFBcUI7Ozs7OztJQUNwQixpREFBc0Y7Ozs7O0lBQ3RGLCtDQUFnRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Zm9yd2FyZFJlZiwgSW5qZWN0LCBJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7TmcySW1nTWF4U2VydmljZX0gZnJvbSAnbmcyLWltZy1tYXgnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7SW1nQ3JvcFNlcnZpY2V9IGZyb20gJy4vaW1nLWNyb3Auc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKFxuICB7cHJvdmlkZWRJbjogJ3Jvb3QnfVxuKVxuZXhwb3J0IGNsYXNzIEltZ1Jlc2l6ZUV4YWN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBOZzJJbWdNYXhTZXJ2aWNlKSkgcHJpdmF0ZSBuZzJJbWdNYXhTZXJ2aWNlOiBOZzJJbWdNYXhTZXJ2aWNlLFxuICAgICAgICAgICAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gSW1nQ3JvcFNlcnZpY2UpKSBwcml2YXRlIGltZ0Nyb3BTZXJ2aWNlOiBJbWdDcm9wU2VydmljZSkge1xuICB9XG5cbiAgcHVibGljIHJlc2l6ZUV4YWN0RmlsbChmaWxlOiBGaWxlLCB0b1dpZHRoOiBudW1iZXIsIHRvSGVpZ2h0OiBudW1iZXIsIGZpbGxDb2xvcj86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgcmVzaXplZEltYWdlU3ViamVjdDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIGlmIChmaWxlLnR5cGUgIT09ICdpbWFnZS9qcGVnJyAmJiBmaWxlLnR5cGUgIT09ICdpbWFnZS9wbmcnKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgcmVzaXplZEltYWdlU3ViamVjdC5lcnJvcih7XG4gICAgICAgICAgcmVzaXplZEZpbGU6IGZpbGUsXG4gICAgICAgICAgcmVhc29uOiAnRmlsZSBwcm92aWRlZCBpcyBuZWl0aGVyIG9mIHR5cGUganBnIG5vciBvZiB0eXBlIHBuZy4nLFxuICAgICAgICAgIGVycm9yOiAnSU5WQUxJRF9FWFRFTlNJT04nXG4gICAgICAgIH0pO1xuICAgICAgfSwgMCk7XG4gICAgICByZXR1cm4gcmVzaXplZEltYWdlU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB9XG4gICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG4gICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgIHRoaXMubmcySW1nTWF4U2VydmljZS5nZXRFWElGT3JpZW50ZWRJbWFnZShpbWcpLnRoZW4ob3JpZW50ZWRJbWcgPT4ge1xuICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChpbWcuc3JjKTtcbiAgICAgICAgY29uc3QgaW1nUmF0aW8gPSBvcmllbnRlZEltZy53aWR0aCAvIG9yaWVudGVkSW1nLmhlaWdodDtcbiAgICAgICAgY29uc3QgcmVzaXplZFJhdGlvID0gdG9XaWR0aCAvIHRvSGVpZ2h0O1xuICAgICAgICAvKiByYXRpbyA+IDEgbWVhbnMgd2lkdGggPiBoZWlnaHQgKi9cblxuICAgICAgICAvKiBzZXR0aW5nIG9uZSBwYXJhbWV0ZXIgb2YgbmcySW1nTWF4U2VydmljZSB2ZXJ5IGhpZ2ggd2lsbCBlbnN1cmUgdGhhdCB0aGUgcmVzaXppbmcgd2lsbCBmaXQgdGhlIG90aGVyIHByb3ZpZGVkIHBhcmFtZXRlciAqL1xuICAgICAgICBsZXQgcmVzaXplSGVpZ2h0ID0gMTAwMDAwO1xuICAgICAgICBsZXQgcmVzaXplV2lkdGggPSAxMDAwMDA7XG5cbiAgICAgICAgaWYgKGltZ1JhdGlvID4gcmVzaXplZFJhdGlvKSB7XG4gICAgICAgICAgLyogdGhlIG9yaWdpbmFsIGhlaWdodCBpcyBzbWFsbGVyIHRoYW4gdGhlIHJlc2l6ZWQgaGVpZ2h0IGFzIGluIHJhdGlvLCB0aGVyZWZvcmUgd2UgaGF2ZSB0byByZXNpemUgdG8gd2lkdGgsIHRoZW4gZmlsbCB0byB0aGUgaGVpZ2h0ICovXG4gICAgICAgICAgcmVzaXplV2lkdGggPSB0b1dpZHRoO1xuICAgICAgICB9IGVsc2UgaWYgKGltZ1JhdGlvIDw9IHJlc2l6ZWRSYXRpbykge1xuICAgICAgICAgIC8qIHRoZSBvcmlnaW5hbCBoZWlnaHQgaXMgYmlnZ2VyIHRoYW4gdGhlIHJlc2l6ZWQgaGVpZ2h0IGFzIGluIHJhdGlvLCB0aGVyZWZvcmUgd2UgY2FuIHJlc2l6ZSB0byBoZWlnaHQsIHRoZW4gZmlsbCB0byB0aGUgd2lkdGggKi9cbiAgICAgICAgICByZXNpemVIZWlnaHQgPSB0b0hlaWdodDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubmcySW1nTWF4U2VydmljZS5yZXNpemUoW2ZpbGVdLCByZXNpemVXaWR0aCwgcmVzaXplSGVpZ2h0KS5zdWJzY3JpYmUoKHJlc2l6ZVJlc3VsdCkgPT4ge1xuXG4gICAgICAgICAgLyogVG8gZmlsbCB0aGUgaW1hZ2UgYmFzZWQgb24gdGhlIGNlbnRlciwgd2UgY2FsY3VsYXRlIHdoZXJlIHRoZSBpbWcgbmVlZHMgdG8gYmUgcG9zaXRpb25lZCB0byBiZSBjZW50ZXJlZCovXG4gICAgICAgICAgbGV0IHN0YXJ0WCA9IDA7XG4gICAgICAgICAgbGV0IHN0YXJ0WSA9IDA7XG5cbiAgICAgICAgICAvKiBvbmUgc2lkZSBpcyBhbHJlYWR5IHJlc2l6ZWQgZXhhY3RseSB0byB0aGUgZGVzaXJlZCBzaXplLCBub3cgZmlsbCB0aGUgb3RoZXIgc2lkZSAqL1xuICAgICAgICAgIGlmIChyZXNpemVXaWR0aCA9PT0gMTAwMDAwKSB7XG4gICAgICAgICAgICAvKiByZXNpemVkIHRvIGhlaWdodCAtPiBhcyB3ZSBmaWxsIHRvIHRoZSB3aWR0aCwgd2UgaGF2ZSB0byBzZXQgc3RhcnRYICovXG4gICAgICAgICAgICBjb25zdCBuZXdJbWdXaWR0aCA9IG9yaWVudGVkSW1nLndpZHRoIC8gKG9yaWVudGVkSW1nLmhlaWdodCAvIHRvSGVpZ2h0KTtcbiAgICAgICAgICAgIHN0YXJ0WCA9IChuZXdJbWdXaWR0aCAtIHRvV2lkdGgpIC8gMjtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc2l6ZUhlaWdodCA9PT0gMTAwMDAwKSB7XG4gICAgICAgICAgICAvKiByZXNpemVkIHRvIHdpZHRoIC0+IGFzIHdlIGZpbGwgdG8gdGhlIGhlaWdodCwgd2UgaGF2ZSB0byBzZXQgc3RhcnRZICovXG4gICAgICAgICAgICBjb25zdCBuZXdJbWdIZWlnaHQgPSBvcmllbnRlZEltZy5oZWlnaHQgLyAob3JpZW50ZWRJbWcud2lkdGggLyB0b1dpZHRoKTtcbiAgICAgICAgICAgIHN0YXJ0WSA9IChuZXdJbWdIZWlnaHQgLSB0b0hlaWdodCkgLyAyO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgICAgICAgIGNvbnN0IGN2cyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICAgIGxldCBjdHggPSBjdnMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgY3ZzLndpZHRoID0gdG9XaWR0aDtcbiAgICAgICAgICAgIGN2cy5oZWlnaHQgPSB0b0hlaWdodDtcbiAgICAgICAgICAgIGlmIChmaWxsQ29sb3IpIHtcbiAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZpbGxDb2xvcjtcbiAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRvV2lkdGgsIHRvSGVpZ2h0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCBzdGFydFgsIHN0YXJ0WSwgdG9XaWR0aCwgdG9IZWlnaHQsIDAsIDAsIHRvV2lkdGgsIHRvSGVpZ2h0KTtcbiAgICAgICAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgdG9XaWR0aCwgdG9IZWlnaHQpO1xuICAgICAgICAgICAgbGV0IHVzZUFscGhhID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChmaWxlLnR5cGUgPT09ICdpbWFnZS9qcGVnJyB8fCAoZmlsZS50eXBlID09PSAnaW1hZ2UvcG5nJyAmJiAhdGhpcy5pc0ltZ1VzaW5nQWxwaGEoaW1hZ2VEYXRhKSkpIHtcbiAgICAgICAgICAgICAgLy8gaW1hZ2Ugd2l0aG91dCBhbHBoYVxuICAgICAgICAgICAgICB1c2VBbHBoYSA9IGZhbHNlO1xuICAgICAgICAgICAgICBjdHggPSBjdnMuZ2V0Q29udGV4dCgnMmQnLCB7J2FscGhhJzogZmFsc2V9KTtcbiAgICAgICAgICAgICAgaWYgKGZpbGxDb2xvcikge1xuICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBmaWxsQ29sb3I7XG4gICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRvV2lkdGgsIHRvSGVpZ2h0KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKGltZywgc3RhcnRYLCBzdGFydFksIHRvV2lkdGgsIHRvSGVpZ2h0LCAwLCAwLCB0b1dpZHRoLCB0b0hlaWdodCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdnMudG9CbG9iKChibG9iKSA9PiB7XG4gICAgICAgICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKGltZy5zcmMpO1xuICAgICAgICAgICAgICBjb25zdCBuZXdGaWxlOiBGaWxlID0gdGhpcy5nZW5lcmF0ZVJlc3VsdEZpbGUoYmxvYiwgZmlsZS5uYW1lLCBmaWxlLnR5cGUsIG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcbiAgICAgICAgICAgICAgLy8gRU5EIE9GIENST1BQSU5HXG4gICAgICAgICAgICAgIHJlc2l6ZWRJbWFnZVN1YmplY3QubmV4dChuZXdGaWxlKTtcbiAgICAgICAgICAgIH0sIHVzZUFscGhhID8gJ2ltYWdlL3BuZycgOiAnaW1hZ2UvanBlZycpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgaW1nLnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKHJlc2l6ZVJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAvLyBzb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgICAgICAgIHJlc2l6ZWRJbWFnZVN1YmplY3QuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH07XG4gICAgaW1nLnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpO1xuICAgIHJldHVybiByZXNpemVkSW1hZ2VTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIHJlc2l6ZUV4YWN0Q3JvcChmaWxlOiBGaWxlLCB0b1dpZHRoOiBudW1iZXIsIHRvSGVpZ2h0OiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJlc2l6ZWRJbWFnZVN1YmplY3Q6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICBpZiAoZmlsZS50eXBlICE9PSAnaW1hZ2UvanBlZycgJiYgZmlsZS50eXBlICE9PSAnaW1hZ2UvcG5nJykge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHJlc2l6ZWRJbWFnZVN1YmplY3QuZXJyb3Ioe1xuICAgICAgICAgIHJlc2l6ZWRGaWxlOiBmaWxlLFxuICAgICAgICAgIHJlYXNvbjogJ0ZpbGUgcHJvdmlkZWQgaXMgbmVpdGhlciBvZiB0eXBlIGpwZyBub3Igb2YgdHlwZSBwbmcuJyxcbiAgICAgICAgICBlcnJvcjogJ0lOVkFMSURfRVhURU5TSU9OJ1xuICAgICAgICB9KTtcbiAgICAgIH0sIDApO1xuICAgICAgcmV0dXJuIHJlc2l6ZWRJbWFnZVN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICB0aGlzLm5nMkltZ01heFNlcnZpY2UuZ2V0RVhJRk9yaWVudGVkSW1hZ2UoaW1nKS50aGVuKG9yaWVudGVkSW1nID0+IHtcbiAgICAgICAgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwoaW1nLnNyYyk7XG4gICAgICAgIGNvbnN0IGltZ1JhdGlvID0gb3JpZW50ZWRJbWcud2lkdGggLyBvcmllbnRlZEltZy5oZWlnaHQ7XG4gICAgICAgIGNvbnN0IHJlc2l6ZWRSYXRpbyA9IHRvV2lkdGggLyB0b0hlaWdodDtcbiAgICAgICAgLyogcmF0aW8gPiAxIG1lYW5zIHdpZHRoID4gaGVpZ2h0ICovXG5cbiAgICAgICAgLyogc2V0dGluZyBvbmUgcGFyYW1ldGVyIG9mIG5nMkltZ01heFNlcnZpY2UgdmVyeSBoaWdoIHdpbGwgZW5zdXJlIHRoYXQgdGhlIHJlc2l6aW5nIHdpbGwgZml0IHRoZSBvdGhlciBwcm92aWRlZCBwYXJhbWV0ZXIgKi9cbiAgICAgICAgbGV0IHJlc2l6ZUhlaWdodCA9IDEwMDAwMDtcbiAgICAgICAgbGV0IHJlc2l6ZVdpZHRoID0gMTAwMDAwO1xuXG4gICAgICAgIC8qIFRvIGNyb3AgdGhlIGltYWdlIGJhc2VkIG9uIHRoZSBjZW50ZXIsIHNvIHdlIHdpbGwga2VlcCB0aGUgbW9zdCBpbXBvcnRhbnQgcGFydCBvZiB0aGUgaW1hZ2UsIHdlIGNhbGN1bGF0ZSB0byBjcm9wIGZyb20gd2hlcmUgdG8gd2hlcmUgKi9cbiAgICAgICAgbGV0IHN0YXJ0WCA9IDA7XG4gICAgICAgIGxldCBzdGFydFkgPSAwO1xuXG4gICAgICAgIGlmIChpbWdSYXRpbyA+IHJlc2l6ZWRSYXRpbykge1xuICAgICAgICAgIC8qIHRoZSBvcmlnaW5hbCBoZWlnaHQgaXMgc21hbGxlciB0aGFuIHRoZSByZXNpemVkIGhlaWdodCBhcyBpbiByYXRpbywgdGhlcmVmb3JlIHdlIGhhdmUgdG8gcmVzaXplIHRvIGhlaWdodCwgdGhlbiBjcm9wIHRvIHRoZSB3aWR0aCAqL1xuICAgICAgICAgIHJlc2l6ZUhlaWdodCA9IHRvSGVpZ2h0O1xuICAgICAgICB9IGVsc2UgaWYgKGltZ1JhdGlvIDw9IHJlc2l6ZWRSYXRpbykge1xuICAgICAgICAgIC8qIHRoZSBvcmlnaW5hbCBoZWlnaHQgaXMgYmlnZ2VyIHRoYW4gdGhlIHJlc2l6ZWQgaGVpZ2h0IGFzIGluIHJhdGlvLCB0aGVyZWZvcmUgd2UgY2FuIHJlc2l6ZSB0byB3aWR0aCwgdGhlbiBjcm9wIHRvIHRoZSBoZWlnaHQgKi9cbiAgICAgICAgICByZXNpemVXaWR0aCA9IHRvV2lkdGg7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm5nMkltZ01heFNlcnZpY2UucmVzaXplKFtmaWxlXSwgcmVzaXplV2lkdGgsIHJlc2l6ZUhlaWdodCkuc3Vic2NyaWJlKChyZXNpemVSZXN1bHQpID0+IHtcbiAgICAgICAgICAvKiBvbmUgc2lkZSBpcyBhbHJlYWR5IHJlc2l6ZWQgZXhhY3RseSB0byB0aGUgZGVzaXJlZCBzaXplLCBub3cgY3JvcCB0aGUgb3RoZXIgc2lkZSAqL1xuICAgICAgICAgIGlmIChyZXNpemVXaWR0aCA9PT0gMTAwMDAwKSB7XG4gICAgICAgICAgICAvKiByZXNpemVkIHRvIGhlaWdodCAtPiBhcyB3ZSBjcm9wIHRvIHRoZSB3aWR0aCwgd2UgaGF2ZSB0byBzZXQgc3RhcnRYICovXG4gICAgICAgICAgICBjb25zdCBuZXdJbWdXaWR0aCA9IG9yaWVudGVkSW1nLndpZHRoIC8gKG9yaWVudGVkSW1nLmhlaWdodCAvIHRvSGVpZ2h0KTtcbiAgICAgICAgICAgIHN0YXJ0WCA9IChuZXdJbWdXaWR0aCAtIHRvV2lkdGgpIC8gMjtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc2l6ZUhlaWdodCA9PT0gMTAwMDAwKSB7XG4gICAgICAgICAgICAvKiByZXNpemVkIHRvIHdpZHRoIC0+IGFzIHdlIGNyb3AgdG8gdGhlIGhlaWdodCwgd2UgaGF2ZSB0byBzZXQgc3RhcnRZICovXG4gICAgICAgICAgICBjb25zdCBuZXdJbWdIZWlnaHQgPSBvcmllbnRlZEltZy5oZWlnaHQgLyAob3JpZW50ZWRJbWcud2lkdGggLyB0b1dpZHRoKTtcbiAgICAgICAgICAgIHN0YXJ0WSA9IChuZXdJbWdIZWlnaHQgLSB0b0hlaWdodCkgLyAyO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmltZ0Nyb3BTZXJ2aWNlLmNyb3BJbWFnZShyZXNpemVSZXN1bHQsIHRvV2lkdGgsIHRvSGVpZ2h0LCBzdGFydFgsIHN0YXJ0WSkuc3Vic2NyaWJlKChjcm9wUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAvLyBhbGwgZ29vZCwgcmVzdWx0IGlzIGEgZmlsZVxuICAgICAgICAgICAgcmVzaXplZEltYWdlU3ViamVjdC5uZXh0KGNyb3BSZXN1bHQpO1xuICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nXG4gICAgICAgICAgICByZXNpemVkSW1hZ2VTdWJqZWN0LmVycm9yKGVycm9yKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nXG4gICAgICAgICAgcmVzaXplZEltYWdlU3ViamVjdC5lcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfTtcbiAgICBpbWcuc3JjID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG4gICAgcmV0dXJuIHJlc2l6ZWRJbWFnZVN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcml2YXRlIGlzSW1nVXNpbmdBbHBoYShpbWFnZURhdGEpOiBib29sZWFuIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGltYWdlRGF0YS5kYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICBpZiAoaW1hZ2VEYXRhLmRhdGFbaSArIDNdICE9PSAyNTUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVSZXN1bHRGaWxlKGJsb2I6IEJsb2IsIG5hbWU6IHN0cmluZywgdHlwZTogc3RyaW5nLCBsYXN0TW9kaWZpZWQ6IG51bWJlcik6IEZpbGUge1xuICAgIGNvbnN0IHJlc3VsdEZpbGUgPSBuZXcgQmxvYihbYmxvYl0sIHt0eXBlOiB0eXBlfSk7XG4gICAgcmV0dXJuIHRoaXMuYmxvYlRvRmlsZShyZXN1bHRGaWxlLCBuYW1lLCBsYXN0TW9kaWZpZWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBibG9iVG9GaWxlKGJsb2I6IEJsb2IsIG5hbWU6IHN0cmluZywgbGFzdE1vZGlmaWVkOiBudW1iZXIpOiBGaWxlIHtcbiAgICBjb25zdCBmaWxlOiBhbnkgPSBibG9iO1xuICAgIGZpbGUubmFtZSA9IG5hbWU7XG4gICAgZmlsZS5sYXN0TW9kaWZpZWQgPSBsYXN0TW9kaWZpZWQ7XG5cbiAgICAvLyBDYXN0IHRvIGEgRmlsZSgpIHR5cGVcbiAgICByZXR1cm4gPEZpbGU+IGZpbGU7XG4gIH1cbn1cbiJdfQ==