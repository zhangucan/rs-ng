/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DEFAULT_TREE_NODE_KEYS } from '@er/types';
import { CommonsUtils } from '../comm';
import { DataItemUtils } from '../data-item';
import { StatesUtils } from '../states';
var TreeUtils = /** @class */ (function () {
    function TreeUtils() {
    }
    /**
     * @param {?} dataItems
     * @param {?} keyMap
     * @param {?=} root
     * @param {?=} lazy
     * @return {?}
     */
    TreeUtils.transNodes = /**
     * @param {?} dataItems
     * @param {?} keyMap
     * @param {?=} root
     * @param {?=} lazy
     * @return {?}
     */
    function (dataItems, keyMap, root, lazy) {
        /** @type {?} */
        var treeKeys = Object.keys(keyMap.node).map(function (key) { return keyMap.node[key]; });
        /** @type {?} */
        var nodes;
        /** @type {?} */
        var rootNode;
        if (keyMap.src.levelIdLength) {
            nodes = CommonsUtils.orderBy(dataItems, [keyMap.src.orderKey || keyMap.src.idKey], ['asc']);
            nodes = nodes.map(function (item) {
                if (item[keyMap.src.idKey]) {
                    /** @type {?} */
                    var parentId = item[keyMap.src.idKey].substr(0, item[keyMap.src.idKey].length - keyMap.src.levelIdLength);
                    if (parentId && parentId !== item[keyMap.src.idKey]) {
                        item[keyMap.src.parentKey] = parentId;
                    }
                    if (!item[keyMap.node.dataKey]) {
                        item[keyMap.node.dataKey] = tslib_1.__assign({}, item);
                    }
                    item[keyMap.node.idKey] = item[keyMap.src.idKey];
                    item = CommonsUtils.pick(item, treeKeys);
                    return item;
                }
            });
        }
        else if (keyMap.src.parentKey) {
            nodes = CommonsUtils.orderBy(dataItems, [keyMap.src.parentKey, keyMap.src.idKey], ['asc']);
            nodes = nodes.map(function (item) {
                if (!item[keyMap.node.dataKey]) {
                    item[keyMap.node.dataKey] = tslib_1.__assign({}, item);
                }
                item[keyMap.node.idKey] = item[keyMap.src.idKey];
                item = CommonsUtils.pick(item, treeKeys);
                return item;
            });
        }
        nodes.forEach(function (item) {
            item[keyMap.node.dataKey] = item[keyMap.node.dataKey] || tslib_1.__assign({}, item);
            /** @type {?} */
            var children = nodes.filter(function (item2) {
                return item2 && item2[keyMap.src.parentKey] && item2[keyMap.src.parentKey] === item['data'][keyMap.src.idKey];
            });
            if (children.length > 0) {
                item[keyMap.node.childrenKey] = children;
            }
            item[keyMap.node.labelKey] = DataItemUtils.getItemLabel(item, keyMap.src.labelKey);
            if (item[keyMap.src.parentKey]) {
                item[keyMap.node.parentKey] = item[keyMap.src.parentKey];
            }
            if (lazy) {
                item[keyMap.node.leafKey] = false;
            }
            if (root && CommonsUtils.isString(root) && root === item[keyMap.src.idKey]) {
                rootNode = [item];
            }
        });
        if (root && CommonsUtils.isJson(root)) {
            root['children'] = nodes;
            return [root];
        }
        else {
            return nodes = rootNode ? rootNode : nodes.filter(function (node) { return !node[keyMap.node.parentKey]; });
        }
    };
    /**
     * @param {?} treeNodes
     * @param {?} value
     * @param {?} props
     * @return {?}
     */
    TreeUtils.findNode = /**
     * @param {?} treeNodes
     * @param {?} value
     * @param {?} props
     * @return {?}
     */
    function (treeNodes, value, props) {
        /** @type {?} */
        var found;
        if (treeNodes) {
            for (var i = 0; i < treeNodes.length; i++) {
                if (value[props.dataItemProps.idKey] === treeNodes[i][DEFAULT_TREE_NODE_KEYS.dataKey][props.dataItemProps.idKey]) {
                    found = treeNodes[i];
                    break;
                }
                if (treeNodes[i].hasOwnProperty(DEFAULT_TREE_NODE_KEYS.childrenKey)) {
                    /** @type {?} */
                    var children = treeNodes[i][DEFAULT_TREE_NODE_KEYS.childrenKey];
                    found = TreeUtils.findNode(children, value, props);
                    if (found) {
                        break;
                    }
                }
            }
        }
        return found;
    };
    /**
     * @param {?} nodes
     * @param {?} predicate
     * @return {?}
     */
    TreeUtils.filter = /**
     * @param {?} nodes
     * @param {?} predicate
     * @return {?}
     */
    function (nodes, predicate) {
        /** @type {?} */
        var result = !nodes ? null : nodes.reduce(function (list, node) {
            /** @type {?} */
            var clone = null;
            if (predicate(node)) {
                // if the object matches the filter, clone it as it is
                clone = CommonsUtils.copy(tslib_1.__assign({}, node, { matched: true }));
            }
            else if (node.children != null) {
                // if the object has childrens, filter the list of children
                /** @type {?} */
                var children = TreeUtils.filter(node.children, predicate);
                if (children.length > 0) {
                    // if any of the children matches, clone the parent object, overwrite
                    // the children list with the filtered list
                    clone = Object.assign({}, node, { children: children });
                }
            }
            if (clone) {
                list.push(clone);
            }
            return list;
        }, []);
        return result;
    };
    /**
     * @param {?} node
     * @param {?} isExpand
     * @param {?=} props
     * @param {?=} toExpandLevel
     * @param {?=} currentLevel
     * @param {?=} id
     * @return {?}
     */
    TreeUtils.expandNode = /**
     * @param {?} node
     * @param {?} isExpand
     * @param {?=} props
     * @param {?=} toExpandLevel
     * @param {?=} currentLevel
     * @param {?=} id
     * @return {?}
     */
    function (node, isExpand, props, toExpandLevel, currentLevel, id) {
        if (props === void 0) { props = {}; }
        if (toExpandLevel === void 0) { toExpandLevel = 100; }
        if (currentLevel === void 0) { currentLevel = 1; }
        if (!node) {
            return;
        }
        if (toExpandLevel >= currentLevel) {
            if (id && (currentLevel === toExpandLevel)) {
                node.expanded = node['id'] === id;
            }
            else if (!id || (id && currentLevel < toExpandLevel)) {
                node.expanded = isExpand;
            }
            TreeUtils.initNode(node, props);
            currentLevel++;
            if (node.children) {
                node.children.forEach(function (childNode) {
                    TreeUtils.initNode(childNode, props);
                    if (toExpandLevel >= currentLevel) {
                        TreeUtils.expandNode(childNode, isExpand, props, toExpandLevel, currentLevel, id);
                    }
                });
            }
        }
    };
    /**
     * @param {?} node
     * @param {?=} props
     * @return {?}
     */
    TreeUtils.initNode = /**
     * @param {?} node
     * @param {?=} props
     * @return {?}
     */
    function (node, props) {
        if (props === void 0) { props = {}; }
        if (!node._inited) {
            ['expandedIcon', 'collapsedIcon'].forEach(function (iconType) { return TreeUtils.initIcon(node, iconType, props); });
            if (props['selectable']) {
                node.selectable = CommonsUtils.getValue(props['selectable'], node);
            }
            node = tslib_1.__assign({}, node, { '_inited': true });
        }
    };
    /**
     * @param {?} node
     * @param {?} iconType
     * @param {?} props
     * @return {?}
     */
    TreeUtils.initIcon = /**
     * @param {?} node
     * @param {?} iconType
     * @param {?} props
     * @return {?}
     */
    function (node, iconType, props) {
        if (!props) {
            node[iconType] = TreeUtils.DEFAULT_NODE_PROPS[iconType];
        }
        else if (props[iconType] && props[iconType].method) {
            node[iconType] = ((/** @type {?} */ (props[iconType].method)))(node);
        }
        else {
            node[iconType] = props[iconType] || TreeUtils.DEFAULT_NODE_PROPS[iconType];
        }
    };
    /**
     * @param {?} siblingId
     * @return {?}
     */
    TreeUtils.getSelectedTreeState = /**
     * @param {?} siblingId
     * @return {?}
     */
    function (siblingId) {
        if (!siblingId) {
            return null;
        }
        /** @type {?} */
        var sibling = siblingId && StatesUtils.getValue(siblingId);
        if (sibling && sibling.component) {
            /** @type {?} */
            var treeId = CommonsUtils.get(sibling.component, '$props.$ext.$container.tree.$id');
            /** @type {?} */
            var treeState = StatesUtils.getValue(treeId);
            return treeState;
        }
    };
    /**
     * @param {?} siblingId
     * @return {?}
     */
    TreeUtils.getSelectedNode = /**
     * @param {?} siblingId
     * @return {?}
     */
    function (siblingId) {
        /** @type {?} */
        var treeState = TreeUtils.getSelectedTreeState(siblingId);
        return treeState && treeState['selectedNode'];
    };
    /**
     * @param {?} siblingId
     * @return {?}
     */
    TreeUtils.getSelectedNodeValue = /**
     * @param {?} siblingId
     * @return {?}
     */
    function (siblingId) {
        /** @type {?} */
        var treeState = TreeUtils.getSelectedTreeState(siblingId);
        return treeState && treeState['selectedNodeValue'];
    };
    TreeUtils.DEFAULT_NODE_PROPS = {
        lazy: false,
        autoExpandLevel: 0,
        expandedIcon: 'fa fa-folder-open',
        collapsedIcon: 'fa fa-folder',
        icon: 'fa fa-leaf'
    };
    return TreeUtils;
}());
export { TreeUtils };
if (false) {
    /** @type {?} */
    TreeUtils.DEFAULT_NODE_PROPS;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvdXRpbHMvIiwic291cmNlcyI6WyJsaWIvdHJlZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBZ0Isc0JBQXNCLEVBQWUsTUFBTSxXQUFXLENBQUM7QUFFOUUsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUNyQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBQzNDLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFFdEM7SUFBQTtJQXlMQSxDQUFDOzs7Ozs7OztJQS9LUSxvQkFBVTs7Ozs7OztJQUFqQixVQUFrQixTQUFlLEVBQUUsTUFHbEMsRUFBRSxJQUF3QixFQUFFLElBQWM7O1lBQ25DLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFoQixDQUFnQixDQUFDOztZQUNsRSxLQUFLOztZQUNMLFFBQVE7UUFDWixJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO1lBQzVCLEtBQUssR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQzVGLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSTtnQkFDcEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTs7d0JBQ3BCLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENB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QUM7UUFDbEIsWUFBWSxFQUFFLG1CQUFtQjtRQUNqQyxhQUFhLEVBQUUsY0FBYztRQUM3QixJQUFJLEVBQUUsWUFBWTtLQUNuQixDQUFDO0lBaUxKLGdCQUFDO0NBQUEsQUF6TEQsSUF5TEM7U0F6TFksU0FBUzs7O0lBRXBCLDZCQU1FIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEYXRhSXRlbVByb3BzLCBERUZBVUxUX1RSRUVfTk9ERV9LRVlTLCBUcmVlTm9kZUtleXN9IGZyb20gJ0Blci90eXBlcyc7XG5pbXBvcnQge1RyZWVOb2RlfSBmcm9tICdwcmltZW5nL2FwaSc7XG5pbXBvcnQge0NvbW1vbnNVdGlsc30gZnJvbSAnLi4vY29tbSc7XG5pbXBvcnQge0RhdGFJdGVtVXRpbHN9IGZyb20gJy4uL2RhdGEtaXRlbSc7XG5pbXBvcnQge1N0YXRlc1V0aWxzfSBmcm9tICcuLi9zdGF0ZXMnO1xuXG5leHBvcnQgY2xhc3MgVHJlZVV0aWxzIHtcblxuICBzdGF0aWMgREVGQVVMVF9OT0RFX1BST1BTID0ge1xuICAgIGxhenk6IGZhbHNlLFxuICAgIGF1dG9FeHBhbmRMZXZlbDogMCxcbiAgICBleHBhbmRlZEljb246ICdmYSBmYS1mb2xkZXItb3BlbicsXG4gICAgY29sbGFwc2VkSWNvbjogJ2ZhIGZhLWZvbGRlcicsXG4gICAgaWNvbjogJ2ZhIGZhLWxlYWYnXG4gIH07XG5cbiAgc3RhdGljIHRyYW5zTm9kZXMoZGF0YUl0ZW1zOiB7fVtdLCBrZXlNYXA6IHtcbiAgICBzcmM6IERhdGFJdGVtUHJvcHMsXG4gICAgbm9kZTogVHJlZU5vZGVLZXlzXG4gIH0sIHJvb3Q/OiBzdHJpbmcgfCBUcmVlTm9kZSwgbGF6eT86IGJvb2xlYW4pOiB7fVtdIHtcbiAgICBjb25zdCB0cmVlS2V5cyA9IE9iamVjdC5rZXlzKGtleU1hcC5ub2RlKS5tYXAoa2V5ID0+IGtleU1hcC5ub2RlW2tleV0pO1xuICAgIGxldCBub2RlcztcbiAgICBsZXQgcm9vdE5vZGU7XG4gICAgaWYgKGtleU1hcC5zcmMubGV2ZWxJZExlbmd0aCkge1xuICAgICAgbm9kZXMgPSBDb21tb25zVXRpbHMub3JkZXJCeShkYXRhSXRlbXMsIFtrZXlNYXAuc3JjLm9yZGVyS2V5IHx8IGtleU1hcC5zcmMuaWRLZXldLCBbJ2FzYyddKTtcbiAgICAgIG5vZGVzID0gbm9kZXMubWFwKGl0ZW0gPT4ge1xuICAgICAgICBpZiAoaXRlbVtrZXlNYXAuc3JjLmlkS2V5XSkge1xuICAgICAgICAgIGNvbnN0IHBhcmVudElkID0gaXRlbVtrZXlNYXAuc3JjLmlkS2V5XS5zdWJzdHIoMCwgaXRlbVtrZXlNYXAuc3JjLmlkS2V5XS5sZW5ndGggLSBrZXlNYXAuc3JjLmxldmVsSWRMZW5ndGgpO1xuICAgICAgICAgIGlmIChwYXJlbnRJZCAmJiBwYXJlbnRJZCAhPT0gaXRlbVtrZXlNYXAuc3JjLmlkS2V5XSkge1xuICAgICAgICAgICAgaXRlbVtrZXlNYXAuc3JjLnBhcmVudEtleV0gPSBwYXJlbnRJZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFpdGVtW2tleU1hcC5ub2RlLmRhdGFLZXldKSB7XG4gICAgICAgICAgICBpdGVtW2tleU1hcC5ub2RlLmRhdGFLZXldID0gey4uLml0ZW19O1xuICAgICAgICAgIH1cbiAgICAgICAgICBpdGVtW2tleU1hcC5ub2RlLmlkS2V5XSA9IGl0ZW1ba2V5TWFwLnNyYy5pZEtleV07XG4gICAgICAgICAgaXRlbSA9IENvbW1vbnNVdGlscy5waWNrKGl0ZW0sIHRyZWVLZXlzKTtcbiAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChrZXlNYXAuc3JjLnBhcmVudEtleSkge1xuICAgICAgbm9kZXMgPSBDb21tb25zVXRpbHMub3JkZXJCeShkYXRhSXRlbXMsIFtrZXlNYXAuc3JjLnBhcmVudEtleSwga2V5TWFwLnNyYy5pZEtleV0sIFsnYXNjJ10pO1xuICAgICAgbm9kZXMgPSBub2Rlcy5tYXAoaXRlbSA9PiB7XG4gICAgICAgIGlmICghaXRlbVtrZXlNYXAubm9kZS5kYXRhS2V5XSkge1xuICAgICAgICAgIGl0ZW1ba2V5TWFwLm5vZGUuZGF0YUtleV0gPSB7Li4uaXRlbX07XG4gICAgICAgIH1cbiAgICAgICAgaXRlbVtrZXlNYXAubm9kZS5pZEtleV0gPSBpdGVtW2tleU1hcC5zcmMuaWRLZXldO1xuICAgICAgICBpdGVtID0gQ29tbW9uc1V0aWxzLnBpY2soaXRlbSwgdHJlZUtleXMpO1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBub2Rlcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbVtrZXlNYXAubm9kZS5kYXRhS2V5XSA9IGl0ZW1ba2V5TWFwLm5vZGUuZGF0YUtleV0gfHwgey4uLml0ZW19O1xuICAgICAgY29uc3QgY2hpbGRyZW4gPSBub2Rlcy5maWx0ZXIoaXRlbTIgPT5cbiAgICAgICAgaXRlbTIgJiYgaXRlbTJba2V5TWFwLnNyYy5wYXJlbnRLZXldICYmIGl0ZW0yW2tleU1hcC5zcmMucGFyZW50S2V5XSA9PT0gaXRlbVsnZGF0YSddW2tleU1hcC5zcmMuaWRLZXldXG4gICAgICApO1xuICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaXRlbVtrZXlNYXAubm9kZS5jaGlsZHJlbktleV0gPSBjaGlsZHJlbjtcbiAgICAgIH1cbiAgICAgIGl0ZW1ba2V5TWFwLm5vZGUubGFiZWxLZXldID0gRGF0YUl0ZW1VdGlscy5nZXRJdGVtTGFiZWwoaXRlbSwga2V5TWFwLnNyYy5sYWJlbEtleSk7XG4gICAgICBpZiAoaXRlbVtrZXlNYXAuc3JjLnBhcmVudEtleV0pIHtcbiAgICAgICAgaXRlbVtrZXlNYXAubm9kZS5wYXJlbnRLZXldID0gaXRlbVtrZXlNYXAuc3JjLnBhcmVudEtleV07XG4gICAgICB9XG4gICAgICBpZiAobGF6eSkge1xuICAgICAgICBpdGVtW2tleU1hcC5ub2RlLmxlYWZLZXldID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAocm9vdCAmJiBDb21tb25zVXRpbHMuaXNTdHJpbmcocm9vdCkgJiYgcm9vdCA9PT0gaXRlbVtrZXlNYXAuc3JjLmlkS2V5XSkge1xuICAgICAgICByb290Tm9kZSA9IFtpdGVtXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAocm9vdCAmJiBDb21tb25zVXRpbHMuaXNKc29uKHJvb3QpKSB7XG4gICAgICByb290WydjaGlsZHJlbiddID0gbm9kZXM7XG4gICAgICByZXR1cm4gW3Jvb3RdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbm9kZXMgPSByb290Tm9kZSA/IHJvb3ROb2RlIDogbm9kZXMuZmlsdGVyKG5vZGUgPT4gIW5vZGVba2V5TWFwLm5vZGUucGFyZW50S2V5XSk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGZpbmROb2RlKHRyZWVOb2RlczogVHJlZU5vZGVbXSwgdmFsdWUsIHByb3BzKTogVHJlZU5vZGUge1xuICAgIGxldCBmb3VuZDtcbiAgICBpZiAodHJlZU5vZGVzKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyZWVOb2Rlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAodmFsdWVbcHJvcHMuZGF0YUl0ZW1Qcm9wcy5pZEtleV0gPT09IHRyZWVOb2Rlc1tpXVtERUZBVUxUX1RSRUVfTk9ERV9LRVlTLmRhdGFLZXldW3Byb3BzLmRhdGFJdGVtUHJvcHMuaWRLZXldKSB7XG4gICAgICAgICAgZm91bmQgPSB0cmVlTm9kZXNbaV07XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRyZWVOb2Rlc1tpXS5oYXNPd25Qcm9wZXJ0eShERUZBVUxUX1RSRUVfTk9ERV9LRVlTLmNoaWxkcmVuS2V5KSkge1xuICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gdHJlZU5vZGVzW2ldW0RFRkFVTFRfVFJFRV9OT0RFX0tFWVMuY2hpbGRyZW5LZXldO1xuICAgICAgICAgIGZvdW5kID0gVHJlZVV0aWxzLmZpbmROb2RlKGNoaWxkcmVuLCB2YWx1ZSwgcHJvcHMpO1xuICAgICAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmb3VuZDtcbiAgfVxuXG4gIHN0YXRpYyBmaWx0ZXIobm9kZXMsIHByZWRpY2F0ZSkge1xuICAgIGNvbnN0IHJlc3VsdCA9ICFub2RlcyA/IG51bGwgOiBub2Rlcy5yZWR1Y2UoKGxpc3QsIG5vZGUpID0+IHtcbiAgICAgIGxldCBjbG9uZSA9IG51bGw7XG4gICAgICBpZiAocHJlZGljYXRlKG5vZGUpKSB7XG4gICAgICAgIC8vIGlmIHRoZSBvYmplY3QgbWF0Y2hlcyB0aGUgZmlsdGVyLCBjbG9uZSBpdCBhcyBpdCBpc1xuICAgICAgICBjbG9uZSA9IENvbW1vbnNVdGlscy5jb3B5KHtcbiAgICAgICAgICAuLi5ub2RlLFxuICAgICAgICAgIG1hdGNoZWQ6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGRyZW4gIT0gbnVsbCkge1xuICAgICAgICAvLyBpZiB0aGUgb2JqZWN0IGhhcyBjaGlsZHJlbnMsIGZpbHRlciB0aGUgbGlzdCBvZiBjaGlsZHJlblxuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IFRyZWVVdGlscy5maWx0ZXIobm9kZS5jaGlsZHJlbiwgcHJlZGljYXRlKTtcbiAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyBpZiBhbnkgb2YgdGhlIGNoaWxkcmVuIG1hdGNoZXMsIGNsb25lIHRoZSBwYXJlbnQgb2JqZWN0LCBvdmVyd3JpdGVcbiAgICAgICAgICAvLyB0aGUgY2hpbGRyZW4gbGlzdCB3aXRoIHRoZSBmaWx0ZXJlZCBsaXN0XG4gICAgICAgICAgY2xvbmUgPSBPYmplY3QuYXNzaWduKHt9LCBub2RlLCB7Y2hpbGRyZW46IGNoaWxkcmVufSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChjbG9uZSkge1xuICAgICAgICBsaXN0LnB1c2goY2xvbmUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgfSwgW10pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzdGF0aWMgZXhwYW5kTm9kZShub2RlOiBUcmVlTm9kZSwgaXNFeHBhbmQ6IGJvb2xlYW4sIHByb3BzID0ge30sIHRvRXhwYW5kTGV2ZWw6IG51bWJlciA9IDEwMCwgY3VycmVudExldmVsOiBudW1iZXIgPSAxLCBpZD86IGFueSkge1xuICAgIGlmICghbm9kZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodG9FeHBhbmRMZXZlbCA+PSBjdXJyZW50TGV2ZWwpIHtcbiAgICAgIGlmIChpZCAmJiAoY3VycmVudExldmVsID09PSB0b0V4cGFuZExldmVsKSkge1xuICAgICAgICBub2RlLmV4cGFuZGVkID0gbm9kZVsnaWQnXSA9PT0gaWQ7XG4gICAgICB9IGVsc2UgaWYgKCFpZCB8fCAoaWQgJiYgY3VycmVudExldmVsIDwgdG9FeHBhbmRMZXZlbCkpIHtcbiAgICAgICAgbm9kZS5leHBhbmRlZCA9IGlzRXhwYW5kO1xuICAgICAgfVxuICAgICAgVHJlZVV0aWxzLmluaXROb2RlKG5vZGUsIHByb3BzKTtcbiAgICAgIGN1cnJlbnRMZXZlbCsrO1xuICAgICAgaWYgKG5vZGUuY2hpbGRyZW4pIHtcbiAgICAgICAgbm9kZS5jaGlsZHJlbi5mb3JFYWNoKGNoaWxkTm9kZSA9PiB7XG4gICAgICAgICAgVHJlZVV0aWxzLmluaXROb2RlKGNoaWxkTm9kZSwgcHJvcHMpO1xuICAgICAgICAgIGlmICh0b0V4cGFuZExldmVsID49IGN1cnJlbnRMZXZlbCkge1xuICAgICAgICAgICAgVHJlZVV0aWxzLmV4cGFuZE5vZGUoY2hpbGROb2RlLCBpc0V4cGFuZCwgcHJvcHMsIHRvRXhwYW5kTGV2ZWwsIGN1cnJlbnRMZXZlbCwgaWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGluaXROb2RlKG5vZGUsIHByb3BzID0ge30pIHtcbiAgICBpZiAoIW5vZGUuX2luaXRlZCkge1xuICAgICAgWydleHBhbmRlZEljb24nLCAnY29sbGFwc2VkSWNvbiddLmZvckVhY2goaWNvblR5cGUgPT4gVHJlZVV0aWxzLmluaXRJY29uKG5vZGUsIGljb25UeXBlLCBwcm9wcykpO1xuICAgICAgaWYgKHByb3BzWydzZWxlY3RhYmxlJ10pIHtcbiAgICAgICAgbm9kZS5zZWxlY3RhYmxlID0gQ29tbW9uc1V0aWxzLmdldFZhbHVlKHByb3BzWydzZWxlY3RhYmxlJ10sIG5vZGUpO1xuICAgICAgfVxuICAgICAgbm9kZSA9IHtcbiAgICAgICAgLi4ubm9kZSxcbiAgICAgICAgJ19pbml0ZWQnOiB0cnVlXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBpbml0SWNvbihub2RlLCBpY29uVHlwZSwgcHJvcHMpIHtcbiAgICBpZiAoIXByb3BzKSB7XG4gICAgICBub2RlW2ljb25UeXBlXSA9IFRyZWVVdGlscy5ERUZBVUxUX05PREVfUFJPUFNbaWNvblR5cGVdO1xuICAgIH0gZWxzZSBpZiAocHJvcHNbaWNvblR5cGVdICYmIHByb3BzW2ljb25UeXBlXS5tZXRob2QpIHtcbiAgICAgIG5vZGVbaWNvblR5cGVdID0gKDxGdW5jdGlvbj5wcm9wc1tpY29uVHlwZV0ubWV0aG9kKShub2RlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9kZVtpY29uVHlwZV0gPSBwcm9wc1tpY29uVHlwZV0gfHwgVHJlZVV0aWxzLkRFRkFVTFRfTk9ERV9QUk9QU1tpY29uVHlwZV07XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGdldFNlbGVjdGVkVHJlZVN0YXRlKHNpYmxpbmdJZCkge1xuICAgIGlmICghc2libGluZ0lkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3Qgc2libGluZyA9IHNpYmxpbmdJZCAmJiBTdGF0ZXNVdGlscy5nZXRWYWx1ZShzaWJsaW5nSWQpO1xuICAgIGlmIChzaWJsaW5nICYmIHNpYmxpbmcuY29tcG9uZW50KSB7XG4gICAgICBjb25zdCB0cmVlSWQgPSBDb21tb25zVXRpbHMuZ2V0KHNpYmxpbmcuY29tcG9uZW50LCAnJHByb3BzLiRleHQuJGNvbnRhaW5lci50cmVlLiRpZCcpO1xuICAgICAgY29uc3QgdHJlZVN0YXRlID0gU3RhdGVzVXRpbHMuZ2V0VmFsdWUodHJlZUlkKTtcbiAgICAgIHJldHVybiB0cmVlU3RhdGU7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGdldFNlbGVjdGVkTm9kZShzaWJsaW5nSWQpOiBUcmVlTm9kZSB7XG4gICAgY29uc3QgdHJlZVN0YXRlID0gVHJlZVV0aWxzLmdldFNlbGVjdGVkVHJlZVN0YXRlKHNpYmxpbmdJZCk7XG4gICAgcmV0dXJuIHRyZWVTdGF0ZSAmJiB0cmVlU3RhdGVbJ3NlbGVjdGVkTm9kZSddO1xuICB9XG5cbiAgc3RhdGljIGdldFNlbGVjdGVkTm9kZVZhbHVlKHNpYmxpbmdJZCk6IHt9W10ge1xuICAgIGNvbnN0IHRyZWVTdGF0ZSA9IFRyZWVVdGlscy5nZXRTZWxlY3RlZFRyZWVTdGF0ZShzaWJsaW5nSWQpO1xuICAgIHJldHVybiB0cmVlU3RhdGUgJiYgdHJlZVN0YXRlWydzZWxlY3RlZE5vZGVWYWx1ZSddO1xuICB9XG5cbn1cbiJdfQ==