/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject } from 'rxjs';
import { CommonsUtils } from '../comm';
/** @type {?} */
const APP_STORE = new BehaviorSubject({});
export class StatesUtils {
    /**
     * @return {?}
     */
    static getStore() {
        return APP_STORE;
    }
    /**
     * @param {?} path
     * @param {?=} value
     * @param {?=} preserved
     * @return {?}
     */
    static create(path, value, preserved) {
        /** @type {?} */
        const storeItem = StatesUtils.getStoreItem(path, true);
        storeItem.state.next(value);
        if (preserved) {
            storeItem.preserved = preserved;
        }
        return storeItem.state;
    }
    /**
     * @param {?} path
     * @param {?=} createWhenAbsent
     * @return {?}
     */
    static get(path, createWhenAbsent) {
        /** @type {?} */
        const storeItem = StatesUtils.getStoreItem(path, createWhenAbsent);
        if (storeItem) {
            return storeItem.state;
        }
        else {
            return undefined;
        }
    }
    /**
     * @param {...?} path
     * @return {?}
     */
    static observe(...path) {
        return StatesUtils.get(path, true);
    }
    /**
     * @param {...?} path
     * @return {?}
     */
    static toggle(...path) {
        /** @type {?} */
        const state = StatesUtils.get(path);
        state.next(!!!state.value);
        return state;
    }
    /**
     * @param {?} path
     * @return {?}
     */
    static inc(path) {
        /** @type {?} */
        const state = StatesUtils.get(path, true);
        /** @type {?} */
        let newValue = 0;
        if (state.value) {
            newValue = state.value + 1;
        }
        state.next(newValue);
        return state;
    }
    /**
     * @param {?} path
     * @return {?}
     */
    static dec(path) {
        /** @type {?} */
        const state = StatesUtils.get(path, true);
        /** @type {?} */
        let newValue = 0;
        if (state.value) {
            newValue = state.value - 1;
        }
        state.next(newValue);
        return state;
    }
    /**
     * @param {?} path
     * @param {?} offset
     * @return {?}
     */
    static add(path, offset) {
        /** @type {?} */
        const state = StatesUtils.get(path, true);
        /** @type {?} */
        let newValue = 0;
        if (state.value) {
            newValue = state.value + offset;
        }
        state.next(newValue);
        return state;
    }
    /**
     * used to clear some state properties
     * @param {?} path
     * @param {?} final
     * @return {?}
     */
    static set(path, final) {
        /** @type {?} */
        const state = StatesUtils.get(path, true);
        if (!state.value) {
            return StatesUtils.create(path, final);
        }
        else {
            state.next(final);
            return state;
        }
    }
    /**
     * @param {?} path
     * @param {?} key
     * @return {?}
     */
    static delete(path, key) {
        /** @type {?} */
        const state = StatesUtils.get(path);
        if (state.value) {
            state.next(CommonsUtils.unset(state.value, key));
        }
    }
    /**
     * used to update state properties when patch has no undefined values
     * @param {?} path
     * @param {?} patch
     * @return {?}
     */
    static update(path, patch) {
        /** @type {?} */
        const state = StatesUtils.get(path, true);
        if (!state.value) {
            return StatesUtils.create(path, patch);
        }
        else {
            state.next(CommonsUtils.merge({}, state.value, patch));
            return state;
        }
    }
    /**
     * @param {...?} path
     * @return {?}
     */
    static getValue(...path) {
        /** @type {?} */
        const state = StatesUtils.get(path);
        return state ? Object.assign({}, state.value) : undefined;
    }
    /**
     * @param {...?} path
     * @return {?}
     */
    static deleteState(...path) {
        /** @type {?} */
        const state = StatesUtils.get(path);
        CommonsUtils.unset(APP_STORE.value, CommonsUtils.flatPath(path));
        if (state) {
            state.next(undefined);
            state.complete();
        }
        APP_STORE.next(APP_STORE.value);
    }
    /**
     * @private
     * @param {?} path
     * @param {?=} createWhenAbsent
     * @return {?}
     */
    static getStoreItem(path, createWhenAbsent) {
        /** @type {?} */
        const key = CommonsUtils.flatPath(path);
        /** @type {?} */
        let storeItem = CommonsUtils.get(APP_STORE.value, key);
        if (!storeItem && createWhenAbsent) {
            storeItem = {
                state: new BehaviorSubject(undefined),
                createdAt: new Date().getMilliseconds()
            };
            /** @type {?} */
            const value = CommonsUtils.set(APP_STORE.value, key, storeItem);
            APP_STORE.next(value);
        }
        return storeItem;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvdXRpbHMvIiwic291cmNlcyI6WyJsaWIvc3RhdGVzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxTQUFTLENBQUM7O01BRS9CLFNBQVMsR0FBMkIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDO0FBRWpFLE1BQU0sT0FBTyxXQUFXOzs7O0lBRXRCLE1BQU0sQ0FBQyxRQUFRO1FBQ2IsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7Ozs7OztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBdUIsRUFBRSxLQUFVLEVBQUUsU0FBbUI7O2NBQzlELFNBQVMsR0FBRyxXQUFXLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7UUFDdEQsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsSUFBSSxTQUFTLEVBQUU7WUFDYixTQUFTLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztTQUNqQztRQUNELE9BQU8sU0FBUyxDQUFDLEtBQUssQ0FBQztJQUN6QixDQUFDOzs7Ozs7SUFFRCxNQUFNLENBQUMsR0FBRyxDQUFDLElBQXVCLEVBQUUsZ0JBQTBCOztjQUN0RCxTQUFTLEdBQUcsV0FBVyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUM7UUFDbEUsSUFBSSxTQUFTLEVBQUU7WUFDYixPQUFPLFNBQVMsQ0FBQyxLQUFLLENBQUM7U0FDeEI7YUFBTTtZQUNMLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO0lBQ0gsQ0FBQzs7Ozs7SUFFRCxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBYztRQUM5QixPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3JDLENB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U0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDO1lBQy9ELFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdkI7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1N0YXRlLCBTdG9yZSwgU3RvcmVJdGVtfSBmcm9tICdAZXIvdHlwZXMnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtDb21tb25zVXRpbHN9IGZyb20gJy4uL2NvbW0nO1xuXG5jb25zdCBBUFBfU1RPUkU6IEJlaGF2aW9yU3ViamVjdDxTdG9yZT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHt9KTtcblxuZXhwb3J0IGNsYXNzIFN0YXRlc1V0aWxzIHtcblxuICBzdGF0aWMgZ2V0U3RvcmUoKTogQmVoYXZpb3JTdWJqZWN0PFN0b3JlPiB7XG4gICAgcmV0dXJuIEFQUF9TVE9SRTtcbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUocGF0aDogc3RyaW5nIHwgc3RyaW5nW10sIHZhbHVlPzoge30sIHByZXNlcnZlZD86IGJvb2xlYW4pOiBTdGF0ZSB7XG4gICAgY29uc3Qgc3RvcmVJdGVtID0gU3RhdGVzVXRpbHMuZ2V0U3RvcmVJdGVtKHBhdGgsIHRydWUpO1xuICAgIHN0b3JlSXRlbS5zdGF0ZS5uZXh0KHZhbHVlKTtcbiAgICBpZiAocHJlc2VydmVkKSB7XG4gICAgICBzdG9yZUl0ZW0ucHJlc2VydmVkID0gcHJlc2VydmVkO1xuICAgIH1cbiAgICByZXR1cm4gc3RvcmVJdGVtLnN0YXRlO1xuICB9XG5cbiAgc3RhdGljIGdldChwYXRoOiBzdHJpbmcgfCBzdHJpbmdbXSwgY3JlYXRlV2hlbkFic2VudD86IGJvb2xlYW4pOiBCZWhhdmlvclN1YmplY3Q8YW55PiB7XG4gICAgY29uc3Qgc3RvcmVJdGVtID0gU3RhdGVzVXRpbHMuZ2V0U3RvcmVJdGVtKHBhdGgsIGNyZWF0ZVdoZW5BYnNlbnQpO1xuICAgIGlmIChzdG9yZUl0ZW0pIHtcbiAgICAgIHJldHVybiBzdG9yZUl0ZW0uc3RhdGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIG9ic2VydmUoLi4ucGF0aDogc3RyaW5nW10pOiBCZWhhdmlvclN1YmplY3Q8YW55PiB7XG4gICAgcmV0dXJuIFN0YXRlc1V0aWxzLmdldChwYXRoLCB0cnVlKTtcbiAgfVxuXG4gIHN0YXRpYyB0b2dnbGUoLi4ucGF0aDogc3RyaW5nW10pOiBTdGF0ZSB7XG4gICAgY29uc3Qgc3RhdGUgPSBTdGF0ZXNVdGlscy5nZXQocGF0aCk7XG4gICAgc3RhdGUubmV4dCghISFzdGF0ZS52YWx1ZSk7XG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG5cbiAgc3RhdGljIGluYyhwYXRoOiBzdHJpbmcgfCBzdHJpbmdbXSk6IFN0YXRlIHtcbiAgICBjb25zdCBzdGF0ZSA9IFN0YXRlc1V0aWxzLmdldChwYXRoLCB0cnVlKTtcbiAgICBsZXQgbmV3VmFsdWUgPSAwO1xuICAgIGlmIChzdGF0ZS52YWx1ZSkge1xuICAgICAgbmV3VmFsdWUgPSBzdGF0ZS52YWx1ZSArIDE7XG4gICAgfVxuICAgIHN0YXRlLm5leHQobmV3VmFsdWUpO1xuICAgIHJldHVybiBzdGF0ZTtcbiAgfVxuXG4gIHN0YXRpYyBkZWMocGF0aDogc3RyaW5nIHwgc3RyaW5nW10pOiBTdGF0ZSB7XG4gICAgY29uc3Qgc3RhdGUgPSBTdGF0ZXNVdGlscy5nZXQocGF0aCwgdHJ1ZSk7XG4gICAgbGV0IG5ld1ZhbHVlID0gMDtcbiAgICBpZiAoc3RhdGUudmFsdWUpIHtcbiAgICAgIG5ld1ZhbHVlID0gc3RhdGUudmFsdWUgLSAxO1xuICAgIH1cbiAgICBzdGF0ZS5uZXh0KG5ld1ZhbHVlKTtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cblxuICBzdGF0aWMgYWRkKHBhdGg6IHN0cmluZyB8IHN0cmluZ1tdLCBvZmZzZXQ6IG51bWJlcik6IFN0YXRlIHtcbiAgICBjb25zdCBzdGF0ZSA9IFN0YXRlc1V0aWxzLmdldChwYXRoLCB0cnVlKTtcbiAgICBsZXQgbmV3VmFsdWUgPSAwO1xuICAgIGlmIChzdGF0ZS52YWx1ZSkge1xuICAgICAgbmV3VmFsdWUgPSBzdGF0ZS52YWx1ZSArIG9mZnNldDtcbiAgICB9XG4gICAgc3RhdGUubmV4dChuZXdWYWx1ZSk7XG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIHVzZWQgdG8gY2xlYXIgc29tZSBzdGF0ZSBwcm9wZXJ0aWVzXG4gICAqL1xuICBzdGF0aWMgc2V0KHBhdGg6IHN0cmluZyB8IHN0cmluZ1tdLCBmaW5hbDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSk6IFN0YXRlIHtcbiAgICBjb25zdCBzdGF0ZSA9IFN0YXRlc1V0aWxzLmdldChwYXRoLCB0cnVlKTtcbiAgICBpZiAoIXN0YXRlLnZhbHVlKSB7XG4gICAgICByZXR1cm4gU3RhdGVzVXRpbHMuY3JlYXRlKHBhdGgsIGZpbmFsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RhdGUubmV4dChmaW5hbCk7XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGRlbGV0ZShwYXRoOiBzdHJpbmcgfCBzdHJpbmdbXSwga2V5OiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHN0YXRlID0gU3RhdGVzVXRpbHMuZ2V0KHBhdGgpO1xuICAgIGlmIChzdGF0ZS52YWx1ZSkge1xuICAgICAgc3RhdGUubmV4dChDb21tb25zVXRpbHMudW5zZXQoc3RhdGUudmFsdWUsIGtleSkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiB1c2VkIHRvIHVwZGF0ZSBzdGF0ZSBwcm9wZXJ0aWVzIHdoZW4gcGF0Y2ggaGFzIG5vIHVuZGVmaW5lZCB2YWx1ZXNcbiAgICovXG4gIHN0YXRpYyB1cGRhdGUocGF0aDogc3RyaW5nIHwgc3RyaW5nW10sIHBhdGNoOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KTogU3RhdGUge1xuICAgIGNvbnN0IHN0YXRlID0gU3RhdGVzVXRpbHMuZ2V0KHBhdGgsIHRydWUpO1xuICAgIGlmICghc3RhdGUudmFsdWUpIHtcbiAgICAgIHJldHVybiBTdGF0ZXNVdGlscy5jcmVhdGUocGF0aCwgcGF0Y2gpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdGF0ZS5uZXh0KENvbW1vbnNVdGlscy5tZXJnZSh7fSwgc3RhdGUudmFsdWUsIHBhdGNoKSk7XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGdldFZhbHVlKC4uLnBhdGg6IHN0cmluZ1tdKTogYW55IHtcbiAgICBjb25zdCBzdGF0ZSA9IFN0YXRlc1V0aWxzLmdldChwYXRoKTtcbiAgICByZXR1cm4gc3RhdGUgPyB7Li4uc3RhdGUudmFsdWV9IDogdW5kZWZpbmVkO1xuICB9XG5cbiAgc3RhdGljIGRlbGV0ZVN0YXRlKC4uLnBhdGg6IHN0cmluZ1tdKSB7XG4gICAgY29uc3Qgc3RhdGUgPSBTdGF0ZXNVdGlscy5nZXQocGF0aCk7XG4gICAgQ29tbW9uc1V0aWxzLnVuc2V0KEFQUF9TVE9SRS52YWx1ZSwgQ29tbW9uc1V0aWxzLmZsYXRQYXRoKHBhdGgpKTtcbiAgICBpZiAoc3RhdGUpIHtcbiAgICAgIHN0YXRlLm5leHQodW5kZWZpbmVkKTtcbiAgICAgIHN0YXRlLmNvbXBsZXRlKCk7XG4gICAgfVxuICAgIEFQUF9TVE9SRS5uZXh0KEFQUF9TVE9SRS52YWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRTdG9yZUl0ZW0ocGF0aDogc3RyaW5nIHwgc3RyaW5nW10sIGNyZWF0ZVdoZW5BYnNlbnQ/OiBib29sZWFuKTogU3RvcmVJdGVtIHtcbiAgICBjb25zdCBrZXkgPSBDb21tb25zVXRpbHMuZmxhdFBhdGgocGF0aCk7XG4gICAgbGV0IHN0b3JlSXRlbTogU3RvcmVJdGVtID0gQ29tbW9uc1V0aWxzLmdldChBUFBfU1RPUkUudmFsdWUsIGtleSk7XG4gICAgaWYgKCFzdG9yZUl0ZW0gJiYgY3JlYXRlV2hlbkFic2VudCkge1xuICAgICAgc3RvcmVJdGVtID0ge1xuICAgICAgICBzdGF0ZTogbmV3IEJlaGF2aW9yU3ViamVjdCh1bmRlZmluZWQpLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkuZ2V0TWlsbGlzZWNvbmRzKClcbiAgICAgIH07XG4gICAgICBjb25zdCB2YWx1ZSA9IENvbW1vbnNVdGlscy5zZXQoQVBQX1NUT1JFLnZhbHVlLCBrZXksIHN0b3JlSXRlbSk7XG4gICAgICBBUFBfU1RPUkUubmV4dCh2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiBzdG9yZUl0ZW07XG4gIH1cbn1cblxuIl19