/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, forwardRef, Input, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { DomSanitizer } from '@angular/platform-browser';
import { ControlWrapperComponent, HttpUtils, LogUtils } from '@er/core';
import { ImageToolsService } from '@er/image-editor';
import { HttpMethod, NotifyLevel, StateNames } from '@er/types';
import { CommonsUtils, ConfigUtils, StatesUtils } from '@er/utils';
import { FileUpload } from 'primeng/primeng';
import { BehaviorSubject, Subject } from 'rxjs';
import { DEFAULT_PNG_FILE_UPLOAD_PROPS } from './type';
export class PngFileUploadComponent extends ControlWrapperComponent {
    /**
     * @param {?} imageToolsService
     * @param {?} sanitizer
     * @param {?} cd
     */
    constructor(imageToolsService, sanitizer, cd) {
        super();
        this.imageToolsService = imageToolsService;
        this.sanitizer = sanitizer;
        this.cd = cd;
        this.selectedFiles$ = new BehaviorSubject([]);
        this.uploadedFiles = [];
        this.$defaultProps = DEFAULT_PNG_FILE_UPLOAD_PROPS;
        this.showUpload = true;
        this.uploadProgress$ = new Subject();
        this.processing$ = new Subject();
        this.fileAttrs = {};
    }
    /**
     * @return {?}
     */
    get uploadValue() {
        if (!this.value) {
            return this.value;
        }
        return CommonsUtils.getArrayValue(this.value);
    }
    /**
     * @param {?} file
     * @return {?}
     */
    fileIcon(file) {
        /** @type {?} */
        let ext = (this.fileUpload.getFileExtension(file) || '').toLowerCase();
        ext = ext.substring(1, 4);
        /** @type {?} */
        const exts = ['txt', 'doc', 'xls', '.pdf', '.zip'];
        /** @type {?} */
        let icon;
        switch (ext) {
            case 'txt':
                icon = 'text';
                break;
            case 'xls':
                icon = 'excel';
                break;
            case 'doc':
                icon = 'word';
                break;
            case 'zip':
                icon = 'zip';
                break;
            case 'pdf':
                icon = 'pdf';
                break;
            case 'mp3':
                icon = 'audio';
                break;
            case 'mp4':
                icon = 'video';
                break;
            default:
                icon = exts.indexOf(ext) >= 0 ? ext : undefined;
        }
        return icon ? `file-${icon}-o` : 'file-o';
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
    }
    /**
     * @param {?} model
     * @return {?}
     */
    writeValue(model) {
        super.writeValue(model);
        this.showUpload = !((model && this.$props && !this.$props.multiple));
        this.cd.detectChanges();
    }
    /**
     * @return {?}
     */
    onPropsInit() {
        super.onPropsInit();
        if (!this.$props.url) {
            this.$props.url = `${ConfigUtils.getConfig().api.servers.image.uri}`;
            LogUtils.debug(this, '文件上传路径', this.$props.url);
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onSelect(event) {
        /** @type {?} */
        const files = event.files;
        for (let i = 0; i < files.length; i++) {
            /** @type {?} */
            const file = files[i];
            this.processing$.next(true);
            this.imageToolsService.resizeImage(file, this.$props.$ext.maxWidth, this.$props.$ext.maxHeight).subscribe(result => {
                this.imageToolsService.compressImage(result, this.$props.$ext.maxSize).subscribe(final => {
                    final['objectURL'] = this.sanitizer.bypassSecurityTrustUrl((URL.createObjectURL(final)));
                    this.selectedFiles$.next(this.selectedFiles$.value.concat(final));
                    this.processing$.next(false);
                    this.fileUpload.files = this.fileUpload.files.map(f => f.name === file.name ? final : f);
                });
            });
        }
    }
    /**
     * @param {?} event
     * @param {?} i
     * @return {?}
     */
    delete(event, i) {
        /** @type {?} */
        const files = this.selectedFiles$.value;
        files.splice(i, 1);
        this.selectedFiles$.next(files);
        this.fileUpload.remove(event, i);
    }
    /**
     * @param {?} fileId
     * @return {?}
     */
    remove(fileId) {
        this.$subscriptions = HttpUtils.request({
            uri: `${ConfigUtils.getConfig().api.servers.image.uri}/${fileId}`,
            method: HttpMethod.DELETE
        }).subscribe(resp => {
            if (resp && resp.success) {
                if (this.$props.multiple) {
                    this.value = this.value.filter(v => v !== fileId);
                }
                else {
                    this.value = undefined;
                }
                this.showUpload = true;
                this.cd.detectChanges();
            }
        });
    }
    /**
     * @param {?} event
     * @param {?} file
     * @return {?}
     */
    setFileAttr(event, file) {
        this.fileAttrs[file.name] = event.target.value;
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onBeforeSend(event) {
        /** @type {?} */
        const formData = event.formData;
        formData.append(this.$props.$ext.attrsName, `waterMark=${this.$props.$ext.waterMark}`);
        formData.append(this.$props.$ext.attrsName, `smallSize=${this.$props.$ext.smallSize}`);
        formData.append(this.$props.$ext.attrsName, `storeTo=${this.$props.$ext.storeTo}`);
        if (!CommonsUtils.isEmpty(this.fileAttrs)) {
            Object.keys(this.fileAttrs).forEach(key => {
                formData.append(this.$props.$ext.attrsName, `${key}=${this.fileAttrs[key]}`);
            });
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onProgress(event) {
        this.uploadProgress$.next(event.progress);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onUploadSuccess(event) {
        for (const file of event.files) {
            this.uploadedFiles.push(file);
        }
        /** @type {?} */
        const response = JSON.parse(event.xhr.responseText);
        if (response.success) {
            StatesUtils.create(StateNames.notify, {
                message: '文件上传成功',
                title: '提示'
            });
            if (this.$props.multiple) {
                this.value = [
                    ...this.value || [],
                    ...Object.keys(response.content).map(k => response.content[k])
                ];
            }
            else {
                this.value = Object.keys(response.content).map(k => response.content[k])[0];
                this.showUpload = false;
            }
            this.fileAttrs = {};
            this.selectedFiles$.next([]);
            this.uploadProgress$.next(undefined);
            this.cd.detectChanges();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onUploadFailed(event) {
        /** @type {?} */
        const response = JSON.parse(event.xhr.responseText);
        StatesUtils.create(StateNames.notify, {
            level: NotifyLevel.ERROR,
            message: response.message,
            title: '文件上传失败'
        });
        this.uploadProgress$.next(undefined);
    }
}
PngFileUploadComponent.decorators = [
    { type: Component, args: [{
                selector: 'png-file-upload',
                template: `
    <ng-container *ngIf="showUpload">
      <p-fileUpload
        #fileUpload
        erPropsBind
        [props]="$props || {}"
        [context]="ctx"
        (onSelect)="onSelect($event)"
        (onUpload)="onUploadSuccess($event)"
        (onError)="onUploadFailed($event)"
        (onProgress)="onProgress($event)"
        (onBeforeSend)="onBeforeSend($event)"
      >
        <ng-template pTemplate="toolbar">
          <div *ngIf="uploadProgress$|async as uploadProgress">
            <p-progressBar [value]="uploadProgress"></p-progressBar>
          </div>
        </ng-template>
        <ng-template pTemplate="file"></ng-template>
        <ng-template pTemplate="content">
          <span class="text-muted small" *ngIf="!fileUpload.hasFiles()">您也可以拖动文件到这里</span>
        </ng-template>
      </p-fileUpload>
      <div *ngIf="processing$|async"><i class="fa fa-spin fa-gears"></i>正在处理图片</div>
      <div class="ui-fileupload-row" *ngFor="let file of selectedFiles$|async; let i = index">
      <div>
        <span class="badge badge-info">{{i + 1}}</span>
      </div>
      <div>
        <png-image *ngIf="fileUpload.isImage(file)"
                   [src]="file['objectURL']" [imageStyle]="{width: $props.previewWidth + 'px'}">
        </png-image>
        <span *ngIf="!fileUpload.isImage(file)" class="fa fa-2x text-primary fa-{{fileIcon(file)}}"></span>
      </div>
      <div>{{file.name}}</div>
      <div>{{fileUpload.formatSize(file.size)}}<span class="text-danger">(压缩后)</span></div>
      <div>
        <input pInputText placeholder="图片描述信息" size="50" (change)="setFileAttr($event,file)"/>
      </div>
      <div>
        <button type="button" icon="pi pi-times white" pButton (click)="delete($event,i)"></button>
      </div>
    </div>
    </ng-container>

    <div *ngIf="uploadValue && uploadValue.length>0">
      <div style="text-decoration: underline;font-weight: bold">已上传文件：</div>
      <div class="ui-fileupload-row" *ngFor="let fileId of uploadValue">
        <div>
          <png-image [fileId]="fileId" size="small"
                     styleClass="d-flex align-items-center"
                     imageStyleClass="mr-3"
                     [imageStyle]="{width:$props.previewWidth}">
          </png-image>
        </div>
        <div>
          <button type="button" icon="pi pi-times white" pButton (click)="remove(fileId)"></button>
        </div>
      </div>
    </div>
  `,
                providers: [{
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => PngFileUploadComponent),
                        multi: true
                    }]
            }] }
];
/** @nocollapse */
PngFileUploadComponent.ctorParameters = () => [
    { type: ImageToolsService },
    { type: DomSanitizer },
    { type: ChangeDetectorRef }
];
PngFileUploadComponent.propDecorators = {
    maxSize: [{ type: Input }],
    fileUpload: [{ type: ViewChild, args: ['fileUpload',] }]
};
if (false) {
    /** @type {?} */
    PngFileUploadComponent.prototype.maxSize;
    /** @type {?} */
    PngFileUploadComponent.prototype.selectedFiles$;
    /** @type {?} */
    PngFileUploadComponent.prototype.uploadedFiles;
    /** @type {?} */
    PngFileUploadComponent.prototype.$defaultProps;
    /** @type {?} */
    PngFileUploadComponent.prototype.currentFile;
    /** @type {?} */
    PngFileUploadComponent.prototype.showUpload;
    /** @type {?} */
    PngFileUploadComponent.prototype.uploadProgress$;
    /** @type {?} */
    PngFileUploadComponent.prototype.processing$;
    /** @type {?} */
    PngFileUploadComponent.prototype.fileUpload;
    /** @type {?} */
    PngFileUploadComponent.prototype.fileAttrs;
    /**
     * @type {?}
     * @private
     */
    PngFileUploadComponent.prototype.imageToolsService;
    /** @type {?} */
    PngFileUploadComponent.prototype.sanitizer;
    /**
     * @type {?}
     * @private
     */
    PngFileUploadComponent.prototype.cd;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVyL3ByaW1lbmcvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9maWxlLXVwbG9hZC9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBNEIsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ25ILE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUN2RCxPQUFPLEVBQUMsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUN0RSxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUNuRCxPQUFPLEVBQUMsVUFBVSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDOUQsT0FBTyxFQUFDLFlBQVksRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQ2pFLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUMsZUFBZSxFQUFFLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUU5QyxPQUFPLEVBQUMsNkJBQTZCLEVBQXFCLE1BQU0sUUFBUSxDQUFDO0FBMEV6RSxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsdUJBQTJDOzs7Ozs7SUFzQnJGLFlBQW9CLGlCQUFvQyxFQUFTLFNBQXVCLEVBQVUsRUFBcUI7UUFDckgsS0FBSyxFQUFFLENBQUM7UUFEVSxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQVMsY0FBUyxHQUFULFNBQVMsQ0FBYztRQUFVLE9BQUUsR0FBRixFQUFFLENBQW1CO1FBbEJ2SCxtQkFBYyxHQUE0QixJQUFJLGVB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LDJDQUEwQzs7Ozs7SUFFOUIsbURBQTRDOztJQUFFLDJDQUE4Qjs7Ozs7SUFBRSxvQ0FBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIGZvcndhcmRSZWYsIElucHV0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge05HX1ZBTFVFX0FDQ0VTU09SfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge0RvbVNhbml0aXplcn0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQge0NvbnRyb2xXcmFwcGVyQ29tcG9uZW50LCBIdHRwVXRpbHMsIExvZ1V0aWxzfSBmcm9tICdAZXIvY29yZSc7XG5pbXBvcnQge0ltYWdlVG9vbHNTZXJ2aWNlfSBmcm9tICdAZXIvaW1hZ2UtZWRpdG9yJztcbmltcG9ydCB7SHR0cE1ldGhvZCwgTm90aWZ5TGV2ZWwsIFN0YXRlTmFtZXN9IGZyb20gJ0Blci90eXBlcyc7XG5pbXBvcnQge0NvbW1vbnNVdGlscywgQ29uZmlnVXRpbHMsIFN0YXRlc1V0aWxzfSBmcm9tICdAZXIvdXRpbHMnO1xuaW1wb3J0IHtGaWxlVXBsb2FkfSBmcm9tICdwcmltZW5nL3ByaW1lbmcnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3QsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge0RFRkFVTFRfUE5HX0ZJTEVfVVBMT0FEX1BST1BTLCBQbmdGaWxlVXBsb2FkUHJvcHN9IGZyb20gJy4vdHlwZSc7XG5cbmV4cG9ydCB7UG5nRmlsZVVwbG9hZFByb3BzfSBmcm9tICcuL3R5cGUnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwbmctZmlsZS11cGxvYWQnLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJzaG93VXBsb2FkXCI+XG4gICAgICA8cC1maWxlVXBsb2FkXG4gICAgICAgICNmaWxlVXBsb2FkXG4gICAgICAgIGVyUHJvcHNCaW5kXG4gICAgICAgIFtwcm9wc109XCIkcHJvcHMgfHwge31cIlxuICAgICAgICBbY29udGV4dF09XCJjdHhcIlxuICAgICAgICAob25TZWxlY3QpPVwib25TZWxlY3QoJGV2ZW50KVwiXG4gICAgICAgIChvblVwbG9hZCk9XCJvblVwbG9hZFN1Y2Nlc3MoJGV2ZW50KVwiXG4gICAgICAgIChvbkVycm9yKT1cIm9uVXBsb2FkRmFpbGVkKCRldmVudClcIlxuICAgICAgICAob25Qcm9ncmVzcyk9XCJvblByb2dyZXNzKCRldmVudClcIlxuICAgICAgICAob25CZWZvcmVTZW5kKT1cIm9uQmVmb3JlU2VuZCgkZXZlbnQpXCJcbiAgICAgID5cbiAgICAgICAgPG5nLXRlbXBsYXRlIHBUZW1wbGF0ZT1cInRvb2xiYXJcIj5cbiAgICAgICAgICA8ZGl2ICpuZ0lmPVwidXBsb2FkUHJvZ3Jlc3MkfGFzeW5jIGFzIHVwbG9hZFByb2dyZXNzXCI+XG4gICAgICAgICAgICA8cC1wcm9ncmVzc0JhciBbdmFsdWVdPVwidXBsb2FkUHJvZ3Jlc3NcIj48L3AtcHJvZ3Jlc3NCYXI+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvbmctdGVtcGxhdGU+XG4gICAgICAgIDxuZy10ZW1wbGF0ZSBwVGVtcGxhdGU9XCJmaWxlXCI+PC9uZy10ZW1wbGF0ZT5cbiAgICAgICAgPG5nLXRlbXBsYXRlIHBUZW1wbGF0ZT1cImNvbnRlbnRcIj5cbiAgICAgICAgICA8c3BhbiBjbGFzcz1cInRleHQtbXV0ZWQgc21hbGxcIiAqbmdJZj1cIiFmaWxlVXBsb2FkLmhhc0ZpbGVzKClcIj7mgqjkuZ/lj6/ku6Xmi5bliqjmlofku7bliLDov5nph4w8L3NwYW4+XG4gICAgICAgIDwvbmctdGVtcGxhdGU+XG4gICAgICA8L3AtZmlsZVVwbG9hZD5cbiAgICAgIDxkaXYgKm5nSWY9XCJwcm9jZXNzaW5nJHxhc3luY1wiPjxpIGNsYXNzPVwiZmEgZmEtc3BpbiBmYS1nZWFyc1wiPjwvaT7mraPlnKjlpITnkIblm77niYc8L2Rpdj5cbiAgICAgIDxkaXYgY2xhc3M9XCJ1aS1maWxldXBsb2FkLXJvd1wiICpuZ0Zvcj1cImxldCBmaWxlIG9mIHNlbGVjdGVkRmlsZXMkfGFzeW5jOyBsZXQgaSA9IGluZGV4XCI+XG4gICAgICA8ZGl2PlxuICAgICAgICA8c3BhbiBjbGFzcz1cImJhZGdlIGJhZGdlLWluZm9cIj57e2kgKyAxfX08L3NwYW4+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxkaXY+XG4gICAgICAgIDxwbmctaW1hZ2UgKm5nSWY9XCJmaWxlVXBsb2FkLmlzSW1hZ2UoZmlsZSlcIlxuICAgICAgICAgICAgICAgICAgIFtzcmNdPVwiZmlsZVsnb2JqZWN0VVJMJ11cIiBbaW1hZ2VTdHlsZV09XCJ7d2lkdGg6ICRwcm9wcy5wcmV2aWV3V2lkdGggKyAncHgnfVwiPlxuICAgICAgICA8L3BuZy1pbWFnZT5cbiAgICAgICAgPHNwYW4gKm5nSWY9XCIhZmlsZVVwbG9hZC5pc0ltYWdlKGZpbGUpXCIgY2xhc3M9XCJmYSBmYS0yeCB0ZXh0LXByaW1hcnkgZmEte3tmaWxlSWNvbihmaWxlKX19XCI+PC9zcGFuPlxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2Pnt7ZmlsZS5uYW1lfX08L2Rpdj5cbiAgICAgIDxkaXY+e3tmaWxlVXBsb2FkLmZvcm1hdFNpemUoZmlsZS5zaXplKX19PHNwYW4gY2xhc3M9XCJ0ZXh0LWRhbmdlclwiPijljovnvKnlkI4pPC9zcGFuPjwvZGl2PlxuICAgICAgPGRpdj5cbiAgICAgICAgPGlucHV0IHBJbnB1dFRleHQgcGxhY2Vob2xkZXI9XCLlm77niYfmj4/ov7Dkv6Hmga9cIiBzaXplPVwiNTBcIiAoY2hhbmdlKT1cInNldEZpbGVBdHRyKCRldmVudCxmaWxlKVwiLz5cbiAgICAgIDwvZGl2PlxuICAgICAgPGRpdj5cbiAgICAgICAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgaWNvbj1cInBpIHBpLXRpbWVzIHdoaXRlXCIgcEJ1dHRvbiAoY2xpY2spPVwiZGVsZXRlKCRldmVudCxpKVwiPjwvYnV0dG9uPlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPC9uZy1jb250YWluZXI+XG5cbiAgICA8ZGl2ICpuZ0lmPVwidXBsb2FkVmFsdWUgJiYgdXBsb2FkVmFsdWUubGVuZ3RoPjBcIj5cbiAgICAgIDxkaXYgc3R5bGU9XCJ0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTtmb250LXdlaWdodDogYm9sZFwiPuW3suS4iuS8oOaWh+S7tu+8mjwvZGl2PlxuICAgICAgPGRpdiBjbGFzcz1cInVpLWZpbGV1cGxvYWQtcm93XCIgKm5nRm9yPVwibGV0IGZpbGVJZCBvZiB1cGxvYWRWYWx1ZVwiPlxuICAgICAgICA8ZGl2PlxuICAgICAgICAgIDxwbmctaW1hZ2UgW2ZpbGVJZF09XCJmaWxlSWRcIiBzaXplPVwic21hbGxcIlxuICAgICAgICAgICAgICAgICAgICAgc3R5bGVDbGFzcz1cImQtZmxleCBhbGlnbi1pdGVtcy1jZW50ZXJcIlxuICAgICAgICAgICAgICAgICAgICAgaW1hZ2VTdHlsZUNsYXNzPVwibXItM1wiXG4gICAgICAgICAgICAgICAgICAgICBbaW1hZ2VTdHlsZV09XCJ7d2lkdGg6JHByb3BzLnByZXZpZXdXaWR0aH1cIj5cbiAgICAgICAgICA8L3BuZy1pbWFnZT5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXY+XG4gICAgICAgICAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgaWNvbj1cInBpIHBpLXRpbWVzIHdoaXRlXCIgcEJ1dHRvbiAoY2xpY2spPVwicmVtb3ZlKGZpbGVJZClcIj48L2J1dHRvbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgYCxcbiAgcHJvdmlkZXJzOiBbe1xuICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IFBuZ0ZpbGVVcGxvYWRDb21wb25lbnQpLFxuICAgIG11bHRpOiB0cnVlXG4gIH1dXG59KVxuXG5leHBvcnQgY2xhc3MgUG5nRmlsZVVwbG9hZENvbXBvbmVudCBleHRlbmRzIENvbnRyb2xXcmFwcGVyQ29tcG9uZW50PFBuZ0ZpbGVVcGxvYWRQcm9wcz4gaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuXG4gIEBJbnB1dCgpIG1heFNpemU6IG51bWJlcjtcblxuICBzZWxlY3RlZEZpbGVzJDogQmVoYXZpb3JTdWJqZWN0PEZpbGVbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcblxuICB1cGxvYWRlZEZpbGVzOiBhbnlbXSA9IFtdO1xuXG4gICRkZWZhdWx0UHJvcHMgPSBERUZBVUxUX1BOR19GSUxFX1VQTE9BRF9QUk9QUztcblxuICBjdXJyZW50RmlsZTogRmlsZTtcblxuICBzaG93VXBsb2FkID0gdHJ1ZTtcblxuICB1cGxvYWRQcm9ncmVzcyQ6IFN1YmplY3Q8bnVtYmVyPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgcHJvY2Vzc2luZyQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIEBWaWV3Q2hpbGQoJ2ZpbGVVcGxvYWQnKSBmaWxlVXBsb2FkOiBGaWxlVXBsb2FkO1xuXG4gIGZpbGVBdHRyczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW1hZ2VUb29sc1NlcnZpY2U6IEltYWdlVG9vbHNTZXJ2aWNlLCBwdWJsaWMgc2FuaXRpemVyOiBEb21TYW5pdGl6ZXIsIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIGdldCB1cGxvYWRWYWx1ZSgpIHtcbiAgICBpZiAoIXRoaXMudmFsdWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gQ29tbW9uc1V0aWxzLmdldEFycmF5VmFsdWUodGhpcy52YWx1ZSk7XG4gIH1cblxuICBmaWxlSWNvbihmaWxlKSB7XG4gICAgbGV0IGV4dCA9ICh0aGlzLmZpbGVVcGxvYWQuZ2V0RmlsZUV4dGVuc2lvbihmaWxlKSB8fCAnJykudG9Mb3dlckNhc2UoKTtcbiAgICBleHQgPSBleHQuc3Vic3RyaW5nKDEsIDQpO1xuICAgIGNvbnN0IGV4dHMgPSBbJ3R4dCcsICdkb2MnLCAneGxzJywgJy5wZGYnLCAnLnppcCddO1xuICAgIGxldCBpY29uO1xuICAgIHN3aXRjaCAoZXh0KSB7XG4gICAgICBjYXNlICd0eHQnOlxuICAgICAgICBpY29uID0gJ3RleHQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3hscyc6XG4gICAgICAgIGljb24gPSAnZXhjZWwnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2RvYyc6XG4gICAgICAgIGljb24gPSAnd29yZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnemlwJzpcbiAgICAgICAgaWNvbiA9ICd6aXAnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3BkZic6XG4gICAgICAgIGljb24gPSAncGRmJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdtcDMnOlxuICAgICAgICBpY29uID0gJ2F1ZGlvJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdtcDQnOlxuICAgICAgICBpY29uID0gJ3ZpZGVvJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBpY29uID0gZXh0cy5pbmRleE9mKGV4dCkgPj0gMCA/IGV4dCA6IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIGljb24gPyBgZmlsZS0ke2ljb259LW9gIDogJ2ZpbGUtbyc7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gIH1cblxuICB3cml0ZVZhbHVlKG1vZGVsKSB7XG4gICAgc3VwZXIud3JpdGVWYWx1ZShtb2RlbCk7XG4gICAgdGhpcy5zaG93VXBsb2FkID0gISgobW9kZWwgJiYgdGhpcy4kcHJvcHMgJiYgIXRoaXMuJHByb3BzLm11bHRpcGxlKSk7XG4gICAgdGhpcy5jZC5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBvblByb3BzSW5pdCgpIHtcbiAgICBzdXBlci5vblByb3BzSW5pdCgpO1xuICAgIGlmICghdGhpcy4kcHJvcHMudXJsKSB7XG4gICAgICB0aGlzLiRwcm9wcy51cmwgPSBgJHtDb25maWdVdGlscy5nZXRDb25maWcoKS5hcGkuc2VydmVycy5pbWFnZS51cml9YDtcbiAgICAgIExvZ1V0aWxzLmRlYnVnKHRoaXMsICfmlofku7bkuIrkvKDot6/lvoQnLCB0aGlzLiRwcm9wcy51cmwpO1xuICAgIH1cbiAgfVxuXG4gIG9uU2VsZWN0KGV2ZW50KSB7XG4gICAgY29uc3QgZmlsZXMgPSBldmVudC5maWxlcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBmaWxlID0gZmlsZXNbaV07XG4gICAgICB0aGlzLnByb2Nlc3NpbmckLm5leHQodHJ1ZSk7XG4gICAgICB0aGlzLmltYWdlVG9vbHNTZXJ2aWNlLnJlc2l6ZUltYWdlKGZpbGUsIHRoaXMuJHByb3BzLiRleHQubWF4V2lkdGgsIHRoaXMuJHByb3BzLiRleHQubWF4SGVpZ2h0KS5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgICAgdGhpcy5pbWFnZVRvb2xzU2VydmljZS5jb21wcmVzc0ltYWdlKHJlc3VsdCwgdGhpcy4kcHJvcHMuJGV4dC5tYXhTaXplKS5zdWJzY3JpYmUoZmluYWwgPT4ge1xuICAgICAgICAgIGZpbmFsWydvYmplY3RVUkwnXSA9IHRoaXMuc2FuaXRpemVyLmJ5cGFzc1NlY3VyaXR5VHJ1c3RVcmwoKFVSTC5jcmVhdGVPYmplY3RVUkwoZmluYWwpKSk7XG4gICAgICAgICAgdGhpcy5zZWxlY3RlZEZpbGVzJC5uZXh0KHRoaXMuc2VsZWN0ZWRGaWxlcyQudmFsdWUuY29uY2F0KGZpbmFsKSk7XG4gICAgICAgICAgdGhpcy5wcm9jZXNzaW5nJC5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmZpbGVVcGxvYWQuZmlsZXMgPSB0aGlzLmZpbGVVcGxvYWQuZmlsZXMubWFwKGYgPT4gZi5uYW1lID09PSBmaWxlLm5hbWUgPyBmaW5hbCA6IGYpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZShldmVudCwgaSkge1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5zZWxlY3RlZEZpbGVzJC52YWx1ZTtcbiAgICBmaWxlcy5zcGxpY2UoaSwgMSk7XG4gICAgdGhpcy5zZWxlY3RlZEZpbGVzJC5uZXh0KGZpbGVzKTtcbiAgICB0aGlzLmZpbGVVcGxvYWQucmVtb3ZlKGV2ZW50LCBpKTtcbiAgfVxuXG4gIHJlbW92ZShmaWxlSWQpIHtcbiAgICB0aGlzLiRzdWJzY3JpcHRpb25zID0gSHR0cFV0aWxzLnJlcXVlc3Qoe1xuICAgICAgICB1cmk6IGAke0NvbmZpZ1V0aWxzLmdldENvbmZpZygpLmFwaS5zZXJ2ZXJzLmltYWdlLnVyaX0vJHtmaWxlSWR9YCxcbiAgICAgICAgbWV0aG9kOiBIdHRwTWV0aG9kLkRFTEVURVxuICAgICAgfVxuICAgICkuc3Vic2NyaWJlKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3AgJiYgcmVzcC5zdWNjZXNzKSB7XG4gICAgICAgIGlmICh0aGlzLiRwcm9wcy5tdWx0aXBsZSkge1xuICAgICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnZhbHVlLmZpbHRlcih2ID0+IHYgIT09IGZpbGVJZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy52YWx1ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNob3dVcGxvYWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNldEZpbGVBdHRyKGV2ZW50LCBmaWxlKSB7XG4gICAgdGhpcy5maWxlQXR0cnNbZmlsZS5uYW1lXSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgfVxuXG4gIG9uQmVmb3JlU2VuZChldmVudCkge1xuICAgIGNvbnN0IGZvcm1EYXRhID0gZXZlbnQuZm9ybURhdGE7XG4gICAgZm9ybURhdGEuYXBwZW5kKHRoaXMuJHByb3BzLiRleHQuYXR0cnNOYW1lLCBgd2F0ZXJNYXJrPSR7dGhpcy4kcHJvcHMuJGV4dC53YXRlck1hcmt9YCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKHRoaXMuJHByb3BzLiRleHQuYXR0cnNOYW1lLCBgc21hbGxTaXplPSR7dGhpcy4kcHJvcHMuJGV4dC5zbWFsbFNpemV9YCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKHRoaXMuJHByb3BzLiRleHQuYXR0cnNOYW1lLCBgc3RvcmVUbz0ke3RoaXMuJHByb3BzLiRleHQuc3RvcmVUb31gKTtcbiAgICBpZiAoIUNvbW1vbnNVdGlscy5pc0VtcHR5KHRoaXMuZmlsZUF0dHJzKSkge1xuICAgICAgT2JqZWN0LmtleXModGhpcy5maWxlQXR0cnMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKHRoaXMuJHByb3BzLiRleHQuYXR0cnNOYW1lLCBgJHtrZXl9PSR7dGhpcy5maWxlQXR0cnNba2V5XX1gKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9uUHJvZ3Jlc3MoZXZlbnQpIHtcbiAgICB0aGlzLnVwbG9hZFByb2dyZXNzJC5uZXh0KGV2ZW50LnByb2dyZXNzKTtcbiAgfVxuXG4gIG9uVXBsb2FkU3VjY2VzcyhldmVudCkge1xuICAgIGZvciAoY29uc3QgZmlsZSBvZiBldmVudC5maWxlcykge1xuICAgICAgdGhpcy51cGxvYWRlZEZpbGVzLnB1c2goZmlsZSk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShldmVudC54aHIucmVzcG9uc2VUZXh0KTtcbiAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgU3RhdGVzVXRpbHMuY3JlYXRlKFN0YXRlTmFtZXMubm90aWZ5LCB7XG4gICAgICAgIG1lc3NhZ2U6ICfmlofku7bkuIrkvKDmiJDlip8nLFxuICAgICAgICB0aXRsZTogJ+aPkOekuidcbiAgICAgIH0pO1xuICAgICAgaWYgKHRoaXMuJHByb3BzLm11bHRpcGxlKSB7XG4gICAgICAgIHRoaXMudmFsdWUgPSBbXG4gICAgICAgICAgLi4udGhpcy52YWx1ZSB8fCBbXSxcbiAgICAgICAgICAuLi5PYmplY3Qua2V5cyhyZXNwb25zZS5jb250ZW50KS5tYXAoayA9PiByZXNwb25zZS5jb250ZW50W2tdKVxuICAgICAgICBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy52YWx1ZSA9IE9iamVjdC5rZXlzKHJlc3BvbnNlLmNvbnRlbnQpLm1hcChrID0+IHJlc3BvbnNlLmNvbnRlbnRba10pWzBdO1xuICAgICAgICB0aGlzLnNob3dVcGxvYWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZmlsZUF0dHJzID0ge307XG4gICAgICB0aGlzLnNlbGVjdGVkRmlsZXMkLm5leHQoW10pO1xuICAgICAgdGhpcy51cGxvYWRQcm9ncmVzcyQubmV4dCh1bmRlZmluZWQpO1xuICAgICAgdGhpcy5jZC5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgb25VcGxvYWRGYWlsZWQoZXZlbnQpIHtcbiAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoZXZlbnQueGhyLnJlc3BvbnNlVGV4dCk7XG4gICAgU3RhdGVzVXRpbHMuY3JlYXRlKFN0YXRlTmFtZXMubm90aWZ5LCB7XG4gICAgICBsZXZlbDogTm90aWZ5TGV2ZWwuRVJST1IsXG4gICAgICBtZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlLFxuICAgICAgdGl0bGU6ICfmlofku7bkuIrkvKDlpLHotKUnXG4gICAgfSk7XG4gICAgdGhpcy51cGxvYWRQcm9ncmVzcyQubmV4dCh1bmRlZmluZWQpO1xuICB9XG59XG4iXX0=