/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Order } from '@er/types';
import { CommonsUtils, DialogUtils, StatesUtils } from '@er/utils';
import * as esb from 'elastic-builder';
import { throwError } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { ApiUtils } from '../api';
/**
 * @record
 */
export function NextSeqProps() { }
if (false) {
    /** @type {?|undefined} */
    NextSeqProps.prototype.apiEntry;
    /** @type {?|undefined} */
    NextSeqProps.prototype.parent;
    /** @type {?|undefined} */
    NextSeqProps.prototype.query;
    /** @type {?|undefined} */
    NextSeqProps.prototype.parentKey;
    /** @type {?|undefined} */
    NextSeqProps.prototype.seqKey;
    /** @type {?|undefined} */
    NextSeqProps.prototype.seqLen;
    /** @type {?|undefined} */
    NextSeqProps.prototype.withParent;
}
/**
 * @record
 */
export function DistinctValueProps() { }
if (false) {
    /** @type {?|undefined} */
    DistinctValueProps.prototype.apiProps;
    /** @type {?|undefined} */
    DistinctValueProps.prototype.id;
}
export class DataUtils {
    /**
     * @param {?} options
     * @return {?}
     */
    static getNextValue(options) {
        /** @type {?} */
        const opt = CommonsUtils.defaults(options || {}, DataUtils.DEFAULT_PROPS);
        /** @type {?} */
        const q = CommonsUtils.getArrayValue(opt.query) || [];
        if (opt.parent) {
            q.push(esb.termQuery(opt.parentKey, opt.parent));
        }
        return ApiUtils.getByQuery(`${opt.apiEntry}`, (/** @type {?} */ ({
            query: q,
            sort: { [opt.seqKey]: Order.DESC },
            size: 1
        }))).pipe(map((data) => {
            /** @type {?} */
            const prefix = '0'.repeat(opt.seqLen);
            /** @type {?} */
            let next = 1;
            if (data.total !== 0) {
                /** @type {?} */
                const last = data.items[0];
                if (last[opt.seqKey]) {
                    next = parseInt(last[opt.seqKey].replace(/^0+/, '')) + 1;
                }
                else {
                    DialogUtils.error('错误', '无法生成新的序列号');
                    throwError('无法生成新的序列号');
                }
            }
            /** @type {?} */
            const seq = (prefix + next).slice(-prefix.length);
            if (opt.withParent && opt.parent) {
                return opt.parent + seq;
            }
            else {
                return seq;
            }
        }));
    }
    /**
     * @param {?} props
     * @return {?}
     */
    static checkDistinct(props) {
        /** @type {?} */
        const result$ = ApiUtils.fetch(Object.assign({}, props.apiProps, { size: 2 })).pipe(map((data) => !data.items || data.items.length === 0 ||
            (data.items.length === 1 && data.items[0]['id'] === props.id)), tap(distinct => {
            if (!distinct) {
                DialogUtils.error('验证失败', `数值【${props.apiProps.queryValue}】已经存在，请修改后再执行本操作！`);
            }
        }));
        return result$;
    }
    /**
     * @param {?} event
     * @param {?} keyOrQuery
     * @return {?}
     */
    static onNodeSelect(event, keyOrQuery) {
        /** @type {?} */
        const treeProps = event['$from'].$props;
        /** @type {?} */
        const tableId = CommonsUtils.get(treeProps, '$ext.$container.table.$id');
        if (tableId) {
            /** @type {?} */
            let q = keyOrQuery;
            /** @type {?} */
            const nodeCode = event.node.data && event.node.data.code;
            if (nodeCode && CommonsUtils.isString(keyOrQuery)) {
                q = esb.prefixQuery(keyOrQuery, nodeCode);
            }
            StatesUtils.update(tableId, (/** @type {?} */ ({
                query: nodeCode ? q : esb.matchAllQuery()
            })));
        }
    }
}
DataUtils.DEFAULT_ROOT_SEQ = '001';
DataUtils.DEFAULT_PROPS = {
    parentKey: 'parent.code',
    seqKey: 'code',
    seqLen: 3
};
if (false) {
    /** @type {?} */
    DataUtils.DEFAULT_ROOT_SEQ;
    /** @type {?} */
    DataUtils.DEFAULT_PROPS;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9kYXRhL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQTJCLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUMxRCxPQUFPLEVBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDakUsT0FBTyxLQUFLLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQztBQUV2QyxPQUFPLEVBQWEsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEMsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLFFBQVEsQ0FBQzs7OztBQUVoQyxrQ0FRQzs7O0lBUEMsZ0NBQWtCOztJQUNsQiw4QkFBZ0I7O0lBQ2hCLDZCQUF3Qjs7SUFDeEIsaUNBQW1COztJQUNuQiw4QkFBZ0I7O0lBQ2hCLDhCQUFnQjs7SUFDaEIsa0NBQXFCOzs7OztBQUd2Qix3Q0FHQzs7O0lBRkMsc0NBQXdCOztJQUN4QixnQ0FBUzs7QUFHWCxNQUFNLE9BQU8sU0FBUzs7Ozs7SUFVcEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFxQjs7Y0FDakMsR0FBRyxHQUFpQixZQUFZLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxFQUFFLEVBQUUsU0FBUyxDQUFDLGFBQWEsQ0FBQzs7Y0FDakYsQ0FBQyxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDckQsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFO1lBQ2QsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7U0FDbEQ7UUFDRCxPQUFP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QyxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQzNDO1lBQ0QsV0FBVyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsbUJBQVk7Z0JBQ3RDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRTthQUMxQyxFQUFBLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQzs7QUF0RU0sMEJBQWdCLEdBQUcsS0FBSyxDQUFDO0FBRXpCLHVCQUFhLEdBQWlCO0lBQ25DLFNBQVMsRUFBRSxhQUFhO0lBQ3hCLE1BQU0sRUFBRSxNQUFNO0lBQ2QsTUFBTSxFQUFFLENBQUM7Q0FDVixDQUFDOzs7SUFORiwyQkFBZ0M7O0lBRWhDLHdCQUlFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBcGlEYXRhUHJvcHMsIEFwaVBheWxvYWQsIE9yZGVyfSBmcm9tICdAZXIvdHlwZXMnO1xuaW1wb3J0IHtDb21tb25zVXRpbHMsIERpYWxvZ1V0aWxzLCBTdGF0ZXNVdGlsc30gZnJvbSAnQGVyL3V0aWxzJztcbmltcG9ydCAqIGFzIGVzYiBmcm9tICdlbGFzdGljLWJ1aWxkZXInO1xuaW1wb3J0IHtRdWVyeX0gZnJvbSAnZWxhc3RpYy1idWlsZGVyJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge21hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0FwaVV0aWxzfSBmcm9tICcuLi9hcGknO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRTZXFQcm9wcyB7XG4gIGFwaUVudHJ5Pzogc3RyaW5nO1xuICBwYXJlbnQ/OiBzdHJpbmc7XG4gIHF1ZXJ5PzogUXVlcnkgfCBRdWVyeVtdO1xuICBwYXJlbnRLZXk/OiBzdHJpbmc7XG4gIHNlcUtleT86IHN0cmluZztcbiAgc2VxTGVuPzogbnVtYmVyO1xuICB3aXRoUGFyZW50PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaXN0aW5jdFZhbHVlUHJvcHMge1xuICBhcGlQcm9wcz86IEFwaURhdGFQcm9wcztcbiAgaWQ/OiBhbnk7XG59XG5cbmV4cG9ydCBjbGFzcyBEYXRhVXRpbHMge1xuXG4gIHN0YXRpYyBERUZBVUxUX1JPT1RfU0VRID0gJzAwMSc7XG5cbiAgc3RhdGljIERFRkFVTFRfUFJPUFM6IE5leHRTZXFQcm9wcyA9IHtcbiAgICBwYXJlbnRLZXk6ICdwYXJlbnQuY29kZScsXG4gICAgc2VxS2V5OiAnY29kZScsXG4gICAgc2VxTGVuOiAzXG4gIH07XG5cbiAgc3RhdGljIGdldE5leHRWYWx1ZShvcHRpb25zOiBOZXh0U2VxUHJvcHMpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IG9wdDogTmV4dFNlcVByb3BzID0gQ29tbW9uc1V0aWxzLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIERhdGFVdGlscy5ERUZBVUxUX1BST1BTKTtcbiAgICBjb25zdCBxID0gQ29tbW9uc1V0aWxzLmdldEFycmF5VmFsdWUob3B0LnF1ZXJ5KSB8fCBbXTtcbiAgICBpZiAob3B0LnBhcmVudCkge1xuICAgICAgcS5wdXNoKGVzYi50ZXJtUXVlcnkob3B0LnBhcmVudEtleSwgb3B0LnBhcmVudCkpO1xuICAgIH1cbiAgICByZXR1cm4gQXBpVXRpbHMuZ2V0QnlRdWVyeShgJHtvcHQuYXBpRW50cnl9YCwgPEFwaVBheWxvYWQ+e1xuICAgICAgcXVlcnk6IHEsXG4gICAgICBzb3J0OiB7W29wdC5zZXFLZXldOiBPcmRlci5ERVNDfSxcbiAgICAgIHNpemU6IDFcbiAgICB9KS5waXBlKFxuICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgcHJlZml4ID0gJzAnLnJlcGVhdChvcHQuc2VxTGVuKTtcbiAgICAgICAgbGV0IG5leHQgPSAxO1xuICAgICAgICBpZiAoZGF0YS50b3RhbCAhPT0gMCkge1xuICAgICAgICAgIGNvbnN0IGxhc3QgPSBkYXRhLml0ZW1zWzBdO1xuICAgICAgICAgIGlmIChsYXN0W29wdC5zZXFLZXldKSB7XG4gICAgICAgICAgICBuZXh0ID0gcGFyc2VJbnQobGFzdFtvcHQuc2VxS2V5XS5yZXBsYWNlKC9eMCsvLCAnJykpICsgMTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRGlhbG9nVXRpbHMuZXJyb3IoJ+mUmeivrycsICfml6Dms5XnlJ/miJDmlrDnmoTluo/liJflj7cnKTtcbiAgICAgICAgICAgIHRocm93RXJyb3IoJ+aXoOazleeUn+aIkOaWsOeahOW6j+WIl+WPtycpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzZXEgPSAocHJlZml4ICsgbmV4dCkuc2xpY2UoLXByZWZpeC5sZW5ndGgpO1xuICAgICAgICBpZiAob3B0LndpdGhQYXJlbnQgJiYgb3B0LnBhcmVudCkge1xuICAgICAgICAgIHJldHVybiBvcHQucGFyZW50ICsgc2VxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBzZXE7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHN0YXRpYyBjaGVja0Rpc3RpbmN0KHByb3BzOiBEaXN0aW5jdFZhbHVlUHJvcHMpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXN1bHQkID0gQXBpVXRpbHMuZmV0Y2goe1xuICAgICAgLi4ucHJvcHMuYXBpUHJvcHMsXG4gICAgICBzaXplOiAyXG4gICAgfSkucGlwZShcbiAgICAgIG1hcCgoZGF0YSkgPT4gIWRhdGEuaXRlbXMgfHwgZGF0YS5pdGVtcy5sZW5ndGggPT09IDAgfHxcbiAgICAgICAgKGRhdGEuaXRlbXMubGVuZ3RoID09PSAxICYmIGRhdGEuaXRlbXNbMF1bJ2lkJ10gPT09IHByb3BzLmlkKSksXG4gICAgICB0YXAoZGlzdGluY3QgPT4ge1xuICAgICAgICBpZiAoIWRpc3RpbmN0KSB7XG4gICAgICAgICAgRGlhbG9nVXRpbHMuZXJyb3IoJ+mqjOivgeWksei0pScsIGDmlbDlgLzjgJAke3Byb3BzLmFwaVByb3BzLnF1ZXJ5VmFsdWV944CR5bey57uP5a2Y5Zyo77yM6K+35L+u5pS55ZCO5YaN5omn6KGM5pys5pON5L2c77yBYCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuXG4gIHN0YXRpYyBvbk5vZGVTZWxlY3QoZXZlbnQsIGtleU9yUXVlcnkpIHtcbiAgICBjb25zdCB0cmVlUHJvcHMgPSBldmVudFsnJGZyb20nXS4kcHJvcHM7XG4gICAgY29uc3QgdGFibGVJZCA9IENvbW1vbnNVdGlscy5nZXQodHJlZVByb3BzLCAnJGV4dC4kY29udGFpbmVyLnRhYmxlLiRpZCcpO1xuICAgIGlmICh0YWJsZUlkKSB7XG4gICAgICBsZXQgcSA9IGtleU9yUXVlcnk7XG4gICAgICBjb25zdCBub2RlQ29kZSA9IGV2ZW50Lm5vZGUuZGF0YSAmJiBldmVudC5ub2RlLmRhdGEuY29kZTtcbiAgICAgIGlmIChub2RlQ29kZSAmJiBDb21tb25zVXRpbHMuaXNTdHJpbmcoa2V5T3JRdWVyeSkpIHtcbiAgICAgICAgcSA9IGVzYi5wcmVmaXhRdWVyeShrZXlPclF1ZXJ5LCBub2RlQ29kZSk7XG4gICAgICB9XG4gICAgICBTdGF0ZXNVdGlscy51cGRhdGUodGFibGVJZCwgPEFwaVBheWxvYWQ+e1xuICAgICAgICBxdWVyeTogbm9kZUNvZGUgPyBxIDogZXNiLm1hdGNoQWxsUXVlcnkoKVxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=