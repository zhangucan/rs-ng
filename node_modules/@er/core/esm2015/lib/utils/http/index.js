/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HttpClient, HttpEventType, HttpHeaders, HttpParams, HttpRequest } from '@angular/common/http';
import { HttpContentType, HttpMethod, HttpRequestPayloadType, HttpResponseType, StateNames } from '@er/types';
import { CommonsUtils, ConfigUtils, RxUtils, StatesUtils } from '@er/utils';
import { of } from 'rxjs';
import { catchError, filter, map, tap } from 'rxjs/operators';
import { DiUtils } from '../di';
export class HttpUtils {
    /**
     * @return {?}
     */
    static getHttpClient() {
        if (!HttpUtils._httpClient) {
            HttpUtils._httpClient = DiUtils.get(HttpClient);
        }
        return HttpUtils._httpClient;
    }
    /**
     * @return {?}
     */
    static timeout() {
        if (HttpUtils._timeout) {
            HttpUtils._timeout = ConfigUtils.getConfig().httpTimeout || 5000;
        }
        return HttpUtils._timeout;
    }
    /**
     * @template T
     * @param {?} options
     * @return {?}
     */
    static request(options) {
        /** @type {?} */
        let httpRequestOptions;
        if (CommonsUtils.isString(options)) {
            httpRequestOptions = CommonsUtils.getObjWhenStr(options, 'uri');
        }
        else {
            httpRequestOptions = (/** @type {?} */ (options));
        }
        if (httpRequestOptions.stateName) {
            return StatesUtils.get(httpRequestOptions.stateName);
        }
        if (httpRequestOptions.onRequest) {
            /** @type {?} */
            const result = httpRequestOptions.onRequest(httpRequestOptions);
            if (result === false) {
                return;
            }
            httpRequestOptions = (/** @type {?} */ (result));
        }
        /** @type {?} */
        let url = httpRequestOptions.uri || '/';
        if (!url.startsWith('http') && url.indexOf('assets/') < 0) {
            if (!url.startsWith('/')) {
                url = '/' + url;
            }
            url = ConfigUtils.getConfig().api.servers[httpRequestOptions.serverType || ConfigUtils.getConfig().api.default].uri + url;
        }
        /** @type {?} */
        const requestOptions = {};
        requestOptions.observe = httpRequestOptions.observe || 'body';
        requestOptions.responseType = httpRequestOptions.responseType || HttpResponseType.JSON;
        requestOptions.headers = HttpUtils.getRequestHeader(httpRequestOptions);
        /** @type {?} */
        const method = httpRequestOptions.method || ((httpRequestOptions.body || httpRequestOptions.payload) ? HttpMethod.POST : HttpMethod.GET);
        if (httpRequestOptions.payload) {
            if (httpRequestOptions.payloadType === HttpRequestPayloadType.PARAMS) {
                httpRequestOptions.params = httpRequestOptions.payload;
            }
            else if (httpRequestOptions.payloadType === HttpRequestPayloadType.BODY) {
                httpRequestOptions.body = httpRequestOptions.payload;
            }
            else if (!method || httpRequestOptions.method === HttpMethod.GET) {
                httpRequestOptions.params = httpRequestOptions.payload;
            }
            else {
                httpRequestOptions.body = httpRequestOptions.payload;
            }
        }
        if (httpRequestOptions.params) {
            requestOptions.params = HttpUtils.getRequestParams(httpRequestOptions);
        }
        if (httpRequestOptions.body) {
            requestOptions.body = HttpUtils.getRequestBody(httpRequestOptions);
        }
        if (!httpRequestOptions.context) {
            httpRequestOptions.context = this; // use HttpUtils.request.call(this,...) to init context
        }
        return HttpUtils.getHttpClient().request(method, url, Object.assign({}, requestOptions, { observe: 'events' }))
            .pipe(RxUtils.retry(httpRequestOptions.retry, HttpUtils.timeout()), filter(event => event.type === HttpEventType.Sent || event.type === HttpEventType.Response), tap(event => {
            if (event.type === HttpEventType.Sent) {
                HttpUtils.updateHttpTagState(httpRequestOptions.tag, true, { url, opts: httpRequestOptions });
            }
        }), filter(event => event.type === HttpEventType.Response), map(event => {
            /** @type {?} */
            let response = event;
            if (!httpRequestOptions.observe || httpRequestOptions.observe === 'body') {
                response = event.body;
            }
            HttpUtils.updateHttpTagState(httpRequestOptions.tag, false, {
                status: 'success',
                httpRequestOptions
            });
            /** @type {?} */
            const resp = httpRequestOptions.onResponse
                ? httpRequestOptions.onResponse.call(httpRequestOptions.context, response, httpRequestOptions)
                : response;
            if (httpRequestOptions.stateName) {
                StatesUtils.update(httpRequestOptions.stateName, resp);
            }
            return resp;
        }), catchError((error) => {
            HttpUtils.updateHttpTagState(httpRequestOptions.tag, false, { status: 'error', error });
            if (httpRequestOptions.onError) {
                httpRequestOptions.onError.call(httpRequestOptions.context, error, httpRequestOptions);
            }
            return of('服务器请求失败，状态码:' + error.status);
        }));
    }
    /**
     * @private
     * @param {?} tag
     * @param {?} state
     * @param {?=} extra
     * @return {?}
     */
    static updateHttpTagState(tag, state, extra) {
        if (tag) {
            StatesUtils.create([StateNames.http, tag], Object.assign({ start: state }, extra));
        }
    }
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    static getRequestParams(options) {
        /** @type {?} */
        let params;
        if (typeof options.params === 'string') {
            params = new HttpParams({ fromString: options.params });
        }
        else {
            params = new HttpParams();
            for (const key in options.params) {
                if (key) {
                    if (options.params.hasOwnProperty(key) && (options.params[key] !== null || options.params[key] !== undefined)) {
                        params = params.append(key, CommonsUtils.toString(options.params[key]));
                    }
                }
            }
        }
        return params;
    }
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    static getRequestBody(options) {
        return options.body;
    }
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    static getRequestHeader(options) {
        /** @type {?} */
        let headers = new HttpHeaders();
        if (options.contentType) {
            headers = headers.append('Content-Type', options.contentType);
        }
        else {
            headers = headers.append('Content-Type', HttpContentType.JSON);
        }
        if (options.headers) {
            for (const key in options.headers) {
                if (key) {
                    headers = headers.append(key, options.headers[key]);
                }
            }
        }
        return headers;
    }
    /**
     * @param {?} file
     * @return {?}
     */
    upload(file) {
        /** @type {?} */
        const formdata = new FormData();
        formdata.append('file', file);
        /** @type {?} */
        const req = new HttpRequest('POST', `upload`, formdata, {
            reportProgress: true,
            responseType: 'text'
        });
        return HttpUtils.getHttpClient().request(req);
    }
}
HttpUtils._httpClient = null;
HttpUtils._timeout = 3000;
if (false) {
    /**
     * @type {?}
     * @private
     */
    HttpUtils._httpClient;
    /**
     * @type {?}
     * @private
     */
    HttpUtils._timeout;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9odHRwL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFhLGFBQWEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hILE9BQU8sRUFFTCxlQUFlLEVBQ2YsVUFBVSxFQUVWLHNCQUFzQixFQUN0QixnQkFBZ0IsRUFDaEIsVUFBVSxFQUNYLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDMUUsT0FBTyxFQUFhLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQztBQUU5QixNQUFNLE9BQU8sU0FBUzs7OztJQUtwQixNQUFNLENBQUMsYUFBYTtRQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRTtZQUMxQixTQUFTLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQWEsVUFBVSxDQUFDLENBQUM7U0FDN0Q7UUFDRCxPQUFPLFNBQVMsQ0FBQyxXQUFXLENBQUM7SUFDL0IsQ0FBQzs7OztJQUVELE1BQU0sQ0FBQyxPQUFPO1FBQ1osSUFBSSxTQUFTLENBQUMsUUFBUSxFQUFFO1lBQ3RCLFNBQVMsQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUM7U0FDbEU7UUFDRCxPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQUM7SUFDNUIsQ0FBQzs7Ozs7O0lBRUQsTUFBTSxDQUFD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QUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDL0Q7YUFBTTtZQUNMLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDaEU7UUFDRCxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUU7WUFDbkIsS0FBSyxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO2dCQUNqQyxJQUFJLEdBQUcsRUFBRTtvQkFDUCxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUNyRDthQUNGO1NBQ0Y7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOzs7OztJQUVELE1BQU0sQ0FBQyxJQUFVOztjQUNULFFBQVEsR0FBYSxJQUFJLFFBQVEsRUFBRTtRQUN6QyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQzs7Y0FDeEIsR0FBRyxHQUFHLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO1lBQ3RELGNBQWMsRUFBRSxJQUFJO1lBQ3BCLFlBQVksRUFBRSxNQUFNO1NBQ3JCLENBQUM7UUFDRixPQUFPLFNBQVMsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEQsQ0FBQzs7QUEvS2MscUJBQVcsR0FBZSxJQUFJLENBQUM7QUFDL0Isa0JBQVEsR0FBRyxJQUFJLENBQUM7Ozs7OztJQUQvQixzQkFBOEM7Ozs7O0lBQzlDLG1CQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SHR0cENsaWVudCwgSHR0cEV2ZW50LCBIdHRwRXZlbnRUeXBlLCBIdHRwSGVhZGVycywgSHR0cFBhcmFtcywgSHR0cFJlcXVlc3R9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7XG4gIEh0dHBDbGllbnRSZXF1ZXN0T3B0aW9ucyxcbiAgSHR0cENvbnRlbnRUeXBlLFxuICBIdHRwTWV0aG9kLFxuICBIdHRwUmVxdWVzdE9wdGlvbnMsXG4gIEh0dHBSZXF1ZXN0UGF5bG9hZFR5cGUsXG4gIEh0dHBSZXNwb25zZVR5cGUsXG4gIFN0YXRlTmFtZXNcbn0gZnJvbSAnQGVyL3R5cGVzJztcbmltcG9ydCB7Q29tbW9uc1V0aWxzLCBDb25maWdVdGlscywgUnhVdGlscywgU3RhdGVzVXRpbHN9IGZyb20gJ0Blci91dGlscyc7XG5pbXBvcnQge09ic2VydmFibGUsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7Y2F0Y2hFcnJvciwgZmlsdGVyLCBtYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtEaVV0aWxzfSBmcm9tICcuLi9kaSc7XG5cbmV4cG9ydCBjbGFzcyBIdHRwVXRpbHMge1xuXG4gIHByaXZhdGUgc3RhdGljIF9odHRwQ2xpZW50OiBIdHRwQ2xpZW50ID0gbnVsbDtcbiAgcHJpdmF0ZSBzdGF0aWMgX3RpbWVvdXQgPSAzMDAwO1xuXG4gIHN0YXRpYyBnZXRIdHRwQ2xpZW50KCkge1xuICAgIGlmICghSHR0cFV0aWxzLl9odHRwQ2xpZW50KSB7XG4gICAgICBIdHRwVXRpbHMuX2h0dHBDbGllbnQgPSBEaVV0aWxzLmdldDxIdHRwQ2xpZW50PihIdHRwQ2xpZW50KTtcbiAgICB9XG4gICAgcmV0dXJuIEh0dHBVdGlscy5faHR0cENsaWVudDtcbiAgfVxuXG4gIHN0YXRpYyB0aW1lb3V0KCkge1xuICAgIGlmIChIdHRwVXRpbHMuX3RpbWVvdXQpIHtcbiAgICAgIEh0dHBVdGlscy5fdGltZW91dCA9IENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmh0dHBUaW1lb3V0IHx8IDUwMDA7XG4gICAgfVxuICAgIHJldHVybiBIdHRwVXRpbHMuX3RpbWVvdXQ7XG4gIH1cblxuICBzdGF0aWMgcmVxdWVzdDxUID0gYW55PihvcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMgfCBzdHJpbmcpOiBPYnNlcnZhYmxlPFQ+IHtcblxuICAgIGxldCBodHRwUmVxdWVzdE9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucztcblxuICAgIGlmIChDb21tb25zVXRpbHMuaXNTdHJpbmcob3B0aW9ucykpIHtcbiAgICAgIGh0dHBSZXF1ZXN0T3B0aW9ucyA9IENvbW1vbnNVdGlscy5nZXRPYmpXaGVuU3RyKG9wdGlvbnMsICd1cmknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaHR0cFJlcXVlc3RPcHRpb25zID0gb3B0aW9ucyBhcyBIdHRwUmVxdWVzdE9wdGlvbnM7XG4gICAgfVxuXG4gICAgaWYgKGh0dHBSZXF1ZXN0T3B0aW9ucy5zdGF0ZU5hbWUpIHtcbiAgICAgIHJldHVybiBTdGF0ZXNVdGlscy5nZXQoaHR0cFJlcXVlc3RPcHRpb25zLnN0YXRlTmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKGh0dHBSZXF1ZXN0T3B0aW9ucy5vblJlcXVlc3QpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5vblJlcXVlc3QoaHR0cFJlcXVlc3RPcHRpb25zKTtcbiAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGh0dHBSZXF1ZXN0T3B0aW9ucyA9IDxIdHRwUmVxdWVzdE9wdGlvbnM+cmVzdWx0O1xuICAgIH1cblxuICAgIGxldCB1cmwgPSBodHRwUmVxdWVzdE9wdGlvbnMudXJpIHx8ICcvJztcblxuICAgIGlmICghdXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSAmJiB1cmwuaW5kZXhPZignYXNzZXRzLycpIDwgMCkge1xuICAgICAgaWYgKCF1cmwuc3RhcnRzV2l0aCgnLycpKSB7XG4gICAgICAgIHVybCA9ICcvJyArIHVybDtcbiAgICAgIH1cbiAgICAgIHVybCA9IENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmFwaS5zZXJ2ZXJzW2h0dHBSZXF1ZXN0T3B0aW9ucy5zZXJ2ZXJUeXBlIHx8IENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmFwaS5kZWZhdWx0XS51cmkgKyB1cmw7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWVzdE9wdGlvbnM6IEh0dHBDbGllbnRSZXF1ZXN0T3B0aW9ucyA9IHt9O1xuXG4gICAgcmVxdWVzdE9wdGlvbnMub2JzZXJ2ZSA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5vYnNlcnZlIHx8ICdib2R5JztcblxuICAgIHJlcXVlc3RPcHRpb25zLnJlc3BvbnNlVHlwZSA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5yZXNwb25zZVR5cGUgfHwgSHR0cFJlc3BvbnNlVHlwZS5KU09OO1xuXG4gICAgcmVxdWVzdE9wdGlvbnMuaGVhZGVycyA9IEh0dHBVdGlscy5nZXRSZXF1ZXN0SGVhZGVyKGh0dHBSZXF1ZXN0T3B0aW9ucyk7XG5cbiAgICBjb25zdCBtZXRob2QgPSBodHRwUmVxdWVzdE9wdGlvbnMubWV0aG9kIHx8ICgoaHR0cFJlcXVlc3RPcHRpb25zLmJvZHkgfHwgaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWQpID8gSHR0cE1ldGhvZC5QT1NUIDogSHR0cE1ldGhvZC5HRVQpO1xuXG4gICAgaWYgKGh0dHBSZXF1ZXN0T3B0aW9ucy5wYXlsb2FkKSB7XG4gICAgICBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWRUeXBlID09PSBIdHRwUmVxdWVzdFBheWxvYWRUeXBlLlBBUkFNUykge1xuICAgICAgICBodHRwUmVxdWVzdE9wdGlvbnMucGFyYW1zID0gaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWQ7XG4gICAgICB9IGVsc2UgaWYgKGh0dHBSZXF1ZXN0T3B0aW9ucy5wYXlsb2FkVHlwZSA9PT0gSHR0cFJlcXVlc3RQYXlsb2FkVHlwZS5CT0RZKSB7XG4gICAgICAgIGh0dHBSZXF1ZXN0T3B0aW9ucy5ib2R5ID0gaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWQ7XG4gICAgICB9IGVsc2UgaWYgKCFtZXRob2QgfHwgaHR0cFJlcXVlc3RPcHRpb25zLm1ldGhvZCA9PT0gSHR0cE1ldGhvZC5HRVQpIHtcbiAgICAgICAgaHR0cFJlcXVlc3RPcHRpb25zLnBhcmFtcyA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5wYXlsb2FkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaHR0cFJlcXVlc3RPcHRpb25zLmJvZHkgPSBodHRwUmVxdWVzdE9wdGlvbnMucGF5bG9hZDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLnBhcmFtcykge1xuICAgICAgcmVxdWVzdE9wdGlvbnMucGFyYW1zID0gSHR0cFV0aWxzLmdldFJlcXVlc3RQYXJhbXMoaHR0cFJlcXVlc3RPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLmJvZHkpIHtcbiAgICAgIHJlcXVlc3RPcHRpb25zLmJvZHkgPSBIdHRwVXRpbHMuZ2V0UmVxdWVzdEJvZHkoaHR0cFJlcXVlc3RPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoIWh0dHBSZXF1ZXN0T3B0aW9ucy5jb250ZXh0KSB7XG4gICAgICBodHRwUmVxdWVzdE9wdGlvbnMuY29udGV4dCA9IHRoaXM7IC8vIHVzZSBIdHRwVXRpbHMucmVxdWVzdC5jYWxsKHRoaXMsLi4uKSB0byBpbml0IGNvbnRleHRcbiAgICB9XG5cbiAgICByZXR1cm4gSHR0cFV0aWxzLmdldEh0dHBDbGllbnQoKS5yZXF1ZXN0KG1ldGhvZCwgdXJsLCB7XG4gICAgICAuLi5yZXF1ZXN0T3B0aW9ucyxcbiAgICAgIG9ic2VydmU6ICdldmVudHMnXG4gICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBSeFV0aWxzLnJldHJ5KGh0dHBSZXF1ZXN0T3B0aW9ucy5yZXRyeSwgSHR0cFV0aWxzLnRpbWVvdXQoKSksXG4gICAgICAgIGZpbHRlcihldmVudCA9PiBldmVudC50eXBlID09PSBIdHRwRXZlbnRUeXBlLlNlbnQgfHwgZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5SZXNwb25zZSksXG4gICAgICAgIHRhcChldmVudCA9PiB7XG4gICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuU2VudCkge1xuICAgICAgICAgICAgSHR0cFV0aWxzLnVwZGF0ZUh0dHBUYWdTdGF0ZShodHRwUmVxdWVzdE9wdGlvbnMudGFnLCB0cnVlLCB7dXJsLCBvcHRzOiBodHRwUmVxdWVzdE9wdGlvbnN9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICBmaWx0ZXIoZXZlbnQgPT4gZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5SZXNwb25zZSksXG4gICAgICAgIG1hcChldmVudCA9PiB7XG4gICAgICAgICAgbGV0IHJlc3BvbnNlID0gZXZlbnQ7XG4gICAgICAgICAgaWYgKCFodHRwUmVxdWVzdE9wdGlvbnMub2JzZXJ2ZSB8fCBodHRwUmVxdWVzdE9wdGlvbnMub2JzZXJ2ZSA9PT0gJ2JvZHknKSB7XG4gICAgICAgICAgICByZXNwb25zZSA9IGV2ZW50LmJvZHk7XG4gICAgICAgICAgfVxuICAgICAgICAgIEh0dHBVdGlscy51cGRhdGVIdHRwVGFnU3RhdGUoaHR0cFJlcXVlc3RPcHRpb25zLnRhZywgZmFsc2UsIHtcbiAgICAgICAgICAgIHN0YXR1czogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICAgaHR0cFJlcXVlc3RPcHRpb25zXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgcmVzcCA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5vblJlc3BvbnNlXG4gICAgICAgICAgICA/IGh0dHBSZXF1ZXN0T3B0aW9ucy5vblJlc3BvbnNlLmNhbGwoaHR0cFJlcXVlc3RPcHRpb25zLmNvbnRleHQsIHJlc3BvbnNlLCBodHRwUmVxdWVzdE9wdGlvbnMpXG4gICAgICAgICAgICA6IHJlc3BvbnNlO1xuICAgICAgICAgIGlmIChodHRwUmVxdWVzdE9wdGlvbnMuc3RhdGVOYW1lKSB7XG4gICAgICAgICAgICBTdGF0ZXNVdGlscy51cGRhdGUoaHR0cFJlcXVlc3RPcHRpb25zLnN0YXRlTmFtZSwgcmVzcCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXNwO1xuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgICBIdHRwVXRpbHMudXBkYXRlSHR0cFRhZ1N0YXRlKGh0dHBSZXF1ZXN0T3B0aW9ucy50YWcsIGZhbHNlLCB7c3RhdHVzOiAnZXJyb3InLCBlcnJvcn0pO1xuICAgICAgICAgIGlmIChodHRwUmVxdWVzdE9wdGlvbnMub25FcnJvcikge1xuICAgICAgICAgICAgaHR0cFJlcXVlc3RPcHRpb25zLm9uRXJyb3IuY2FsbChodHRwUmVxdWVzdE9wdGlvbnMuY29udGV4dCwgZXJyb3IsIGh0dHBSZXF1ZXN0T3B0aW9ucyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBvZign5pyN5Yqh5Zmo6K+35rGC5aSx6LSl77yM54q25oCB56CBOicgKyBlcnJvci5zdGF0dXMpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHVwZGF0ZUh0dHBUYWdTdGF0ZSh0YWcsIHN0YXRlOiBib29sZWFuLCBleHRyYT86IHt9KSB7XG4gICAgaWYgKHRhZykge1xuICAgICAgU3RhdGVzVXRpbHMuY3JlYXRlKFtTdGF0ZU5hbWVzLmh0dHAsIHRhZ10sIHtzdGFydDogc3RhdGUsIC4uLmV4dHJhfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0UmVxdWVzdFBhcmFtcyhvcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMpIHtcbiAgICBsZXQgcGFyYW1zOiBIdHRwUGFyYW1zO1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5wYXJhbXMgPT09ICdzdHJpbmcnKSB7XG4gICAgICBwYXJhbXMgPSBuZXcgSHR0cFBhcmFtcyh7ZnJvbVN0cmluZzogb3B0aW9ucy5wYXJhbXN9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoKTtcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIG9wdGlvbnMucGFyYW1zKSB7XG4gICAgICAgIGlmIChrZXkpIHtcbiAgICAgICAgICBpZiAob3B0aW9ucy5wYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAob3B0aW9ucy5wYXJhbXNba2V5XSAhPT0gbnVsbCB8fCBvcHRpb25zLnBhcmFtc1trZXldICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMuYXBwZW5kKGtleSwgQ29tbW9uc1V0aWxzLnRvU3RyaW5nKG9wdGlvbnMucGFyYW1zW2tleV0pKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtcztcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldFJlcXVlc3RCb2R5KG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucykge1xuXG4gICAgcmV0dXJuIG9wdGlvbnMuYm9keTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldFJlcXVlc3RIZWFkZXIob3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zKTogSHR0cEhlYWRlcnMge1xuICAgIGxldCBoZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgIGlmIChvcHRpb25zLmNvbnRlbnRUeXBlKSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoJ0NvbnRlbnQtVHlwZScsIG9wdGlvbnMuY29udGVudFR5cGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoJ0NvbnRlbnQtVHlwZScsIEh0dHBDb250ZW50VHlwZS5KU09OKTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuaGVhZGVycykge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gb3B0aW9ucy5oZWFkZXJzKSB7XG4gICAgICAgIGlmIChrZXkpIHtcbiAgICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoa2V5LCBvcHRpb25zLmhlYWRlcnNba2V5XSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cblxuICB1cGxvYWQoZmlsZTogRmlsZSk6IE9ic2VydmFibGU8SHR0cEV2ZW50PHt9Pj4ge1xuICAgIGNvbnN0IGZvcm1kYXRhOiBGb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIGZvcm1kYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgIGNvbnN0IHJlcSA9IG5ldyBIdHRwUmVxdWVzdCgnUE9TVCcsIGB1cGxvYWRgLCBmb3JtZGF0YSwge1xuICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWUsXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0J1xuICAgIH0pO1xuICAgIHJldHVybiBIdHRwVXRpbHMuZ2V0SHR0cENsaWVudCgpLnJlcXVlc3QocmVxKTtcbiAgfVxuXG59XG4iXX0=