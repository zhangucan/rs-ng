/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ApiServerType, NotifyLevel, StateNames } from '@er/types';
import { CommonsUtils, ConfigUtils, ContextUtils, DialogUtils, EsUtils, StatesUtils } from '@er/utils';
import { of, zip } from 'rxjs';
import { filter, first, map, switchMap } from 'rxjs/operators';
import { HttpUtils } from '../http';
import { LogUtils } from '../log';
/** @type {?} */
export const DEFAULT_API_REQUEST_OPTIONS = {
    notifyFailure: true
};
export class ApiUtils {
    /**
     * @param {?} serverType
     * @return {?}
     */
    static getPresetApiOptions(serverType) {
        if (!serverType) {
            serverType = CommonsUtils.get(ConfigUtils.getConfig(), 'api.default') || ApiServerType.ES;
        }
        ApiUtils.presetApiOptions[serverType] = Object.assign({}, DEFAULT_API_REQUEST_OPTIONS, CommonsUtils.get(ConfigUtils.getConfig(), `api.servers.${serverType}`, {}));
        if (!ApiUtils.presetApiOptions[serverType].actions) {
            ApiUtils.presetApiOptions[serverType].actions = {};
        }
        return ApiUtils.presetApiOptions[serverType];
    }
    /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    static login(payload, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.login || {};
        return ApiUtils.doRequest(null, payload, presetActionOptions, options);
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    static logout(options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.logout || {};
        return ApiUtils.doRequest(null, null, presetActionOptions, options);
    }
    /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    static changePwd(payload, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.changePwd || {};
        return ApiUtils.doRequest(null, payload, presetActionOptions, options);
    }
    /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    static register(payload, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.register || {};
        return ApiUtils.doRequest(null, payload, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    static save(apiEntry, data, options = {}) {
        if (data) {
            /** @type {?} */
            const _data = Object.assign({}, data);
            if (_data['id']) {
                /** @type {?} */
                const id = _data['id'];
                delete _data['id'];
                return ApiUtils.patchById.call(this, apiEntry, id, _data, options);
            }
            else {
                return ApiUtils.create.call(this, apiEntry, _data, options);
            }
        }
    }
    /**
     * @param {?} apiEntry
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    static create(apiEntry, data, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.create || {};
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, data, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?=} options
     * @return {?}
     */
    static getById(apiEntry, id, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.getById || {};
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, { id }, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    static getByIds(apiEntry, ids, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.getByIds || {};
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, ids, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?=} payload
     * @param {?=} options
     * @return {?}
     */
    static getByQuery(apiEntry, payload, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.getByQuery;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, payload, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    static updateById(apiEntry, id, data, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.updateById;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, Object.assign({ id }, data), presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    static patchById(apiEntry, id, data, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.patchById;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, Object.assign({ id }, data), presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} query
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    static updateByQuery(apiEntry, query, data, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.updateByQuery;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, query, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?=} options
     * @return {?}
     */
    static deleteById(apiEntry, id, options = {}) {
        /** @type {?} */
        const obv = DialogUtils.confirm('操作确认', '确认执行<b>删除</b>操作吗?')
            .pipe(first(), filter(accept => accept), switchMap(_ => {
            /** @type {?} */
            const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.deleteById;
            return ApiUtils.doRequest(apiEntry, id, presetActionOptions, options);
        }));
        return obv;
    }
    /**
     * @param {?} apiEntry
     * @param {?} query
     * @param {?=} options
     * @return {?}
     */
    static deleteByQuery(apiEntry, query, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.deleteByQuery;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, query, presetActionOptions, options);
    }
    /**
     * @param {?} apiEntry
     * @param {?} body
     * @param {?=} options
     * @return {?}
     */
    static batch(apiEntry, body, options = {}) {
        /** @type {?} */
        const presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.batch;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, body, presetActionOptions, options);
    }
    /**
     * @param {?} dataSource
     * @param {?=} tag
     * @return {?}
     */
    static batchFetch(dataSource, tag) {
        if (dataSource) {
            /** @type {?} */
            let _apiDataProp = dataSource;
            if (dataSource['apiDataProps']) {
                _apiDataProp = dataSource['apiDataProps'];
            }
            _apiDataProp = CommonsUtils.copy(_apiDataProp);
            /** @type {?} */
            const apiDataProps = CommonsUtils.getArrayValue(_apiDataProp);
            if (CommonsUtils.isEmpty(apiDataProps)) {
                return;
            }
            if (!tag) {
                tag = dataSource['id'] || apiDataProps[0].id || '';
            }
            apiDataProps.forEach(apiDataProp => {
                if (dataSource['query']) {
                    /** @type {?} */
                    const query = dataSource['query'];
                    /** @type {?} */
                    const apiQuery = CommonsUtils.getArrayValue(apiDataProp.query || []);
                    apiQuery.concat(CommonsUtils.getArrayValue(query));
                    apiDataProp.query = apiQuery;
                }
                /** @type {?} */
                const _filter = apiDataProp.filter;
                if (CommonsUtils.isFunction(_filter)) {
                    if (dataSource['queryValue']) {
                        apiDataProp.filter = ((/** @type {?} */ (apiDataProp.filter)))(dataSource['queryValue']);
                    }
                    else {
                        delete apiDataProp.filter;
                    }
                }
                if (dataSource['interval']) {
                    CommonsUtils.set((/** @type {?} */ (apiDataProp)), 'aggProps.interval', dataSource['interval']);
                }
                if (dataSource['format']) {
                    CommonsUtils.set((/** @type {?} */ (apiDataProp)), 'aggProps.format', dataSource['format']);
                }
            });
            // return forkJoin(...apiDataProps.map(apiDataProp => ApiUtils.fetch(apiDataProp, tag)))
            //   .pipe(
            //     catchError((err) => throwError(err))
            //   );
            return zip(...apiDataProps.map(apiDataProp => ApiUtils.fetch(apiDataProp, tag)))
                .pipe(map(dataSet => {
                /** @type {?} */
                let resultList;
                /** @type {?} */
                let resultMap;
                dataSet.forEach((data, i) => {
                    if (apiDataProps[i].id) {
                        if (!resultMap) {
                            resultMap = {};
                        }
                        resultMap[apiDataProps[i].id] = data;
                    }
                    else {
                        if (!resultList) {
                            resultList = [];
                        }
                        resultList.push(data);
                    }
                });
                if (resultList && resultList.length === 1) {
                    resultList = resultList[0];
                }
                if (resultMap && resultList) {
                    return Object.assign({}, resultMap, { data: resultList });
                }
                else {
                    return resultMap || resultList || [];
                }
            }));
        }
    }
    /**
     * @param {?} apiDataProps
     * @param {?=} tag
     * @return {?}
     */
    static fetch(apiDataProps, tag) {
        if (!apiDataProps.apiEntry) {
            LogUtils.error('apiUtil', '没有定义apiEntry');
            return of([]);
        }
        /** @type {?} */
        let queryPayload;
        if (CommonsUtils.isFunction(apiDataProps.payload)) {
            queryPayload = ((/** @type {?} */ (apiDataProps.payload))).call(undefined, apiDataProps);
        }
        else if (apiDataProps.payload) {
            queryPayload = apiDataProps.payload;
        }
        if (!queryPayload) {
            /** @type {?} */
            const qBody = EsUtils.buildQueryBody(apiDataProps);
            queryPayload = qBody;
        }
        /** @type {?} */
        const options = apiDataProps.requestOptions || {};
        if (!options.tag) {
            options.tag = tag || '';
        }
        LogUtils.debug('apiUtils', 'apiData数据查询', { apiDataProps: apiDataProps, apiRequestBody: queryPayload });
        return ApiUtils.getByQuery(apiDataProps.apiEntry, queryPayload, options)
            .pipe(map(data => {
            /** @type {?} */
            let aggs;
            if (data && data.aggs) {
                aggs = EsUtils.resolveAggs(data.aggs);
                data.aggs = aggs;
            }
            if (CommonsUtils.isEmpty(data.items)) {
                delete data.items;
            }
            if (CommonsUtils.isEmpty(data.aggs)) {
                delete data.aggs;
            }
            /** @type {?} */
            let path = apiDataProps.dataPath || (apiDataProps.aggProps ? 'aggs' : undefined);
            if (path === '/') {
                path = undefined;
            }
            return path ? CommonsUtils.get(data, path) : data;
        }));
    }
    /**
     * @private
     * @param {?} options
     * @param {?} context
     * @return {?}
     */
    static setContext(options, context) {
        options = options || {};
        options.context = context;
    }
    /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} presetActionOptions
     * @param {?=} actionOptions
     * @return {?}
     */
    static doRequest(apiEntry, payload, presetActionOptions, actionOptions) {
        /** @type {?} */
        const apiRequestOptions = Object.assign({}, presetActionOptions, actionOptions);
        delete apiRequestOptions.actions;
        /** @type {?} */
        const requestPayload = payload;
        /** @type {?} */
        const requestOptions = Object.assign({}, apiRequestOptions, { uri: ApiUtils.buildUri(apiEntry, requestPayload, apiRequestOptions), payload: ApiUtils.buildPayload(apiEntry, requestPayload, apiRequestOptions) });
        delete requestOptions.paramsKeys;
        delete requestOptions.uriResolver;
        delete requestOptions.payloadResolver;
        if (!requestOptions.uri || !requestOptions.uri.startsWith('http')) {
            /** @type {?} */
            const apiServer = ApiUtils.getPresetApiOptions(presetActionOptions.serverType).uri || '';
            requestOptions.uri = apiServer + (requestOptions.uri.startsWith('/') ? '' : '/') + requestOptions.uri;
        }
        return HttpUtils.request(requestOptions)
            .pipe(filter(response => !!response), map(response => {
            if (response.success === true) {
                if (apiRequestOptions.alertSuccess) {
                    DialogUtils.info('操作完成', apiRequestOptions.successMessage);
                }
                if (apiRequestOptions.notifySuccess) {
                    StatesUtils.create(StateNames.notify, {
                        title: '操作完成',
                        message: apiRequestOptions.successMessage
                    });
                }
                if (apiRequestOptions.onSuccess) {
                    return apiRequestOptions.onSuccess.call(requestOptions.context, response, requestOptions);
                }
                else {
                    if (apiRequestOptions.dataPath) {
                        return CommonsUtils.get(response.content, apiRequestOptions.dataPath);
                    }
                    return response.content || response;
                }
            }
            else if (!response.success === false) {
                if (apiRequestOptions.alertFailure) {
                    DialogUtils.error('操作失败', response.message);
                }
                if (apiRequestOptions.notifyFailure) {
                    StatesUtils.create(StateNames.notify, {
                        level: NotifyLevel.ERROR,
                        title: response.error,
                        message: response.message
                    });
                }
                if (apiRequestOptions.onFailure) {
                    return apiRequestOptions.onFailure.call(requestOptions.context, response, requestOptions);
                }
                return response;
            }
            return response;
        }), first());
    }
    /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} options
     * @return {?}
     */
    static buildUri(apiEntry, payload, options) {
        /** @type {?} */
        let uri = apiEntry;
        if (CommonsUtils.isTemplateStr(apiEntry)) {
            // apiEntry = CommonsUtils.templateStr(apiEntry, ContextUtils.context());
        }
        if (CommonsUtils.isString(options.uriResolver)) {
            uri = (/** @type {?} */ (options.uriResolver));
        }
        else if (CommonsUtils.isFunction(options.uriResolver)) {
            uri = ((/** @type {?} */ (options.uriResolver))).call(options.context, apiEntry, payload, options);
        }
        else if (!uri) {
            uri = options.uri || '';
        }
        if (!uri.startsWith('http')) {
            /** @type {?} */
            const serverUri = ApiUtils.getPresetApiOptions(options.serverType).uri;
            if (serverUri) {
                uri = serverUri + (uri.startsWith('/') ? uri : '/' + uri);
            }
        }
        return uri;
    }
    /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} options
     * @return {?}
     */
    static buildPayload(apiEntry, payload, options) {
        /** @type {?} */
        let _payload = payload;
        if (CommonsUtils.isJson(_payload)) {
            _payload = CommonsUtils.merge({}, _payload || {}, options.payload || {}, options.body || options.params || {});
        }
        if (options.payloadResolver) {
            _payload = ((/** @type {?} */ (options.payloadResolver))).call(options.context, apiEntry, _payload, options);
        }
        if (CommonsUtils.isString(_payload)) {
            return _payload;
        }
        else if (CommonsUtils.isString(options.body)) {
            return options.body;
        }
        else if (CommonsUtils.isEmpty(_payload)) {
            return undefined;
        }
        _payload = ContextUtils.resolveVariables(_payload);
        _payload = ApiUtils.resolveApiParamsName(options.paramsKeys || ApiUtils.getPresetApiOptions(options.serverType).paramsKeys || {}, _payload);
        if (CommonsUtils.isEmpty(_payload)) {
            return undefined;
        }
        return _payload;
    }
    /**
     * @private
     * @param {?} paramsKeys
     * @param {?} payload
     * @return {?}
     */
    static resolveApiParamsName(paramsKeys, payload) {
        if (!CommonsUtils.isJson(payload)) {
            return payload;
        }
        /** @type {?} */
        const resolved = {};
        for (const key in payload) {
            if (paramsKeys.hasOwnProperty(key)) {
                resolved[paramsKeys[key]] = payload[key];
            }
            else {
                resolved[key] = payload[key];
            }
        }
        return resolved;
    }
}
ApiUtils.presetApiOptions = {};
if (false) {
    /**
     * @type {?}
     * @private
     */
    ApiUtils.presetApiOptions;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9hcGkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBOEMsYUFBYSxFQUFjLFdBQVcsRUFBUyxVQUFVLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDakksT0FBTyxFQUFDLFlBQVksRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBRXJHLE9BQU8sRUFBYSxFQUFFLEVBQUUsR0FBRyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBQ2xDLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxRQUFRLENBQUM7O0FBRWhDLE1BQU0sT0FBTywyQkFBMkIsR0FBc0I7SUFDNUQsYUFBYSxFQUFFLElBQUk7Q0FDcEI7QUFFRCxNQUFNLE9BQU8sUUFBUTs7Ozs7SUFLbkIsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFVBQVU7UUFFbkMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLFVBQVUsR0FBRyxZQUFZLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsRUFBRSxhQUFhLENBQUMsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDO1NBQzNGO1FBQ0QsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxxQkFDaEMsMkJBQTJCLEVBQzNCLFlBQVksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxFQUFFLGVBQWUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQzlFLENBQUM7UUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixD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LENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDOUI7U0FDRjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7O0FBOVdjLHlCQUFnQixHQUF5QyxFQUFFLENBQUM7Ozs7OztJQUEzRSwwQkFBMkUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0FwaURhdGFQcm9wcywgQXBpUGF5bG9hZCwgQXBpUmVxdWVzdE9wdGlvbnMsIEFwaVNlcnZlclR5cGUsIERhdGFTb3VyY2UsIE5vdGlmeUxldmVsLCBRdWVyeSwgU3RhdGVOYW1lc30gZnJvbSAnQGVyL3R5cGVzJztcbmltcG9ydCB7Q29tbW9uc1V0aWxzLCBDb25maWdVdGlscywgQ29udGV4dFV0aWxzLCBEaWFsb2dVdGlscywgRXNVdGlscywgU3RhdGVzVXRpbHN9IGZyb20gJ0Blci91dGlscyc7XG5pbXBvcnQge1JlcXVlc3RCb2R5U2VhcmNofSBmcm9tICdlbGFzdGljLWJ1aWxkZXInO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBvZiwgemlwfSBmcm9tICdyeGpzJztcbmltcG9ydCB7ZmlsdGVyLCBmaXJzdCwgbWFwLCBzd2l0Y2hNYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7SHR0cFV0aWxzfSBmcm9tICcuLi9odHRwJztcbmltcG9ydCB7TG9nVXRpbHN9IGZyb20gJy4uL2xvZyc7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0FQSV9SRVFVRVNUX09QVElPTlM6IEFwaVJlcXVlc3RPcHRpb25zID0ge1xuICBub3RpZnlGYWlsdXJlOiB0cnVlXG59O1xuXG5leHBvcnQgY2xhc3MgQXBpVXRpbHMge1xuXG4gIHByaXZhdGUgc3RhdGljIHByZXNldEFwaU9wdGlvbnM6IHsgW2tleTogc3RyaW5nXTogQXBpUmVxdWVzdE9wdGlvbnMgfSA9IHt9O1xuXG5cbiAgc3RhdGljIGdldFByZXNldEFwaU9wdGlvbnMoc2VydmVyVHlwZSk6IEFwaVJlcXVlc3RPcHRpb25zIHtcblxuICAgIGlmICghc2VydmVyVHlwZSkge1xuICAgICAgc2VydmVyVHlwZSA9IENvbW1vbnNVdGlscy5nZXQoQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCksICdhcGkuZGVmYXVsdCcpIHx8IEFwaVNlcnZlclR5cGUuRVM7XG4gICAgfVxuICAgIEFwaVV0aWxzLnByZXNldEFwaU9wdGlvbnNbc2VydmVyVHlwZV0gPSB7XG4gICAgICAuLi5ERUZBVUxUX0FQSV9SRVFVRVNUX09QVElPTlMsXG4gICAgICAuLi5Db21tb25zVXRpbHMuZ2V0KENvbmZpZ1V0aWxzLmdldENvbmZpZygpLCBgYXBpLnNlcnZlcnMuJHtzZXJ2ZXJUeXBlfWAsIHt9KVxuICAgIH07XG4gICAgaWYgKCFBcGlVdGlscy5wcmVzZXRBcGlPcHRpb25zW3NlcnZlclR5cGVdLmFjdGlvbnMpIHtcbiAgICAgIEFwaVV0aWxzLnByZXNldEFwaU9wdGlvbnNbc2VydmVyVHlwZV0uYWN0aW9ucyA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gQXBpVXRpbHMucHJlc2V0QXBpT3B0aW9uc1tzZXJ2ZXJUeXBlXTtcbiAgfVxuXG4gIHN0YXRpYyBsb2dpbihwYXlsb2FkOiB7fSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5sb2dpbiB8fCB7fTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KG51bGwsIHBheWxvYWQsIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIGxvZ291dChvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmxvZ291dCB8fCB7fTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KG51bGwsIG51bGwsIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIGNoYW5nZVB3ZChwYXlsb2FkOiB7fSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5jaGFuZ2VQd2QgfHwge307XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChudWxsLCBwYXlsb2FkLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyByZWdpc3RlcihwYXlsb2FkOiB7fSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5yZWdpc3RlciB8fCB7fTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KG51bGwsIHBheWxvYWQsIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIHNhdmUoYXBpRW50cnk6IHN0cmluZywgZGF0YToge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBjb25zdCBfZGF0YSA9IHsuLi5kYXRhfTtcbiAgICAgIGlmIChfZGF0YVsnaWQnXSkge1xuICAgICAgICBjb25zdCBpZCA9IF9kYXRhWydpZCddO1xuICAgICAgICBkZWxldGUgX2RhdGFbJ2lkJ107XG4gICAgICAgIHJldHVybiBBcGlVdGlscy5wYXRjaEJ5SWQuY2FsbCh0aGlzLCBhcGlFbnRyeSwgaWQsIF9kYXRhLCBvcHRpb25zKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBBcGlVdGlscy5jcmVhdGUuY2FsbCh0aGlzLCBhcGlFbnRyeSwgX2RhdGEsIG9wdGlvbnMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUoYXBpRW50cnk6IHN0cmluZywgZGF0YToge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMuY3JlYXRlIHx8IHt9O1xuICAgIEFwaVV0aWxzLnNldENvbnRleHQob3B0aW9ucywgdGhpcyk7XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChhcGlFbnRyeSwgZGF0YSwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgZ2V0QnlJZChhcGlFbnRyeTogc3RyaW5nLCBpZDogc3RyaW5nLCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmdldEJ5SWQgfHwge307XG4gICAgQXBpVXRpbHMuc2V0Q29udGV4dChvcHRpb25zLCB0aGlzKTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KGFwaUVudHJ5LCB7aWR9LCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRCeUlkcyhhcGlFbnRyeTogc3RyaW5nLCBpZHM6IHN0cmluZyB8IHN0cmluZ1tdLCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmdldEJ5SWRzIHx8IHt9O1xuICAgIEFwaVV0aWxzLnNldENvbnRleHQob3B0aW9ucywgdGhpcyk7XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChhcGlFbnRyeSwgaWRzLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRCeVF1ZXJ5KGFwaUVudHJ5OiBzdHJpbmcsIHBheWxvYWQ/OiBBcGlQYXlsb2FkIHwgc3RyaW5nIHwgUmVxdWVzdEJvZHlTZWFyY2gsIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMuZ2V0QnlRdWVyeTtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIHBheWxvYWQsIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIHVwZGF0ZUJ5SWQoYXBpRW50cnk6IHN0cmluZywgaWQ6IHN0cmluZywgZGF0YToge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMudXBkYXRlQnlJZDtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIHtpZCwgLi4uZGF0YX0sIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIHBhdGNoQnlJZChhcGlFbnRyeTogc3RyaW5nLCBpZDogc3RyaW5nLCBkYXRhOiB7fSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5wYXRjaEJ5SWQ7XG4gICAgQXBpVXRpbHMuc2V0Q29udGV4dChvcHRpb25zLCB0aGlzKTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KGFwaUVudHJ5LCB7aWQsIC4uLmRhdGF9LCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyB1cGRhdGVCeVF1ZXJ5KGFwaUVudHJ5OiBzdHJpbmcsIHF1ZXJ5OiBRdWVyeSB8IFF1ZXJ5W10gfCBSZXF1ZXN0Qm9keVNlYXJjaCwgZGF0YToge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMudXBkYXRlQnlRdWVyeTtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIHF1ZXJ5LCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBkZWxldGVCeUlkKGFwaUVudHJ5OiBzdHJpbmcsIGlkOiBzdHJpbmcsIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IG9idiA9IERpYWxvZ1V0aWxzLmNvbmZpcm0oJ+aTjeS9nOehruiupCcsICfnoa7orqTmiafooYw8Yj7liKDpmaQ8L2I+5pON5L2c5ZCXPycpXG4gICAgICAucGlwZShcbiAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgZmlsdGVyKGFjY2VwdCA9PiBhY2NlcHQpLFxuICAgICAgICBzd2l0Y2hNYXAoXyA9PiB7XG4gICAgICAgICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmRlbGV0ZUJ5SWQ7XG4gICAgICAgICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChhcGlFbnRyeSwgaWQsIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICByZXR1cm4gb2J2O1xuICB9XG5cbiAgc3RhdGljIGRlbGV0ZUJ5UXVlcnkoYXBpRW50cnk6IHN0cmluZywgcXVlcnk6IFF1ZXJ5IHwgUmVxdWVzdEJvZHlTZWFyY2gsIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMuZGVsZXRlQnlRdWVyeTtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIHF1ZXJ5LCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBiYXRjaChhcGlFbnRyeTogc3RyaW5nLCBib2R5LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmJhdGNoO1xuICAgIEFwaVV0aWxzLnNldENvbnRleHQob3B0aW9ucywgdGhpcyk7XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChhcGlFbnRyeSwgYm9keSwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgYmF0Y2hGZXRjaChkYXRhU291cmNlOiBBcGlEYXRhUHJvcHMgfCBBcGlEYXRhUHJvcHNbXSB8IERhdGFTb3VyY2UsIHRhZz8pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmIChkYXRhU291cmNlKSB7XG4gICAgICBsZXQgX2FwaURhdGFQcm9wID0gZGF0YVNvdXJjZTtcbiAgICAgIGlmIChkYXRhU291cmNlWydhcGlEYXRhUHJvcHMnXSkge1xuICAgICAgICBfYXBpRGF0YVByb3AgPSBkYXRhU291cmNlWydhcGlEYXRhUHJvcHMnXTtcbiAgICAgIH1cbiAgICAgIF9hcGlEYXRhUHJvcCA9IENvbW1vbnNVdGlscy5jb3B5KF9hcGlEYXRhUHJvcCk7XG4gICAgICBjb25zdCBhcGlEYXRhUHJvcHM6IEFwaURhdGFQcm9wc1tdID0gQ29tbW9uc1V0aWxzLmdldEFycmF5VmFsdWUoX2FwaURhdGFQcm9wKTtcbiAgICAgIGlmIChDb21tb25zVXRpbHMuaXNFbXB0eShhcGlEYXRhUHJvcHMpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICghdGFnKSB7XG4gICAgICAgIHRhZyA9IGRhdGFTb3VyY2VbJ2lkJ10gfHwgYXBpRGF0YVByb3BzWzBdLmlkIHx8ICcnO1xuICAgICAgfVxuICAgICAgYXBpRGF0YVByb3BzLmZvckVhY2goYXBpRGF0YVByb3AgPT4ge1xuICAgICAgICBpZiAoZGF0YVNvdXJjZVsncXVlcnknXSkge1xuICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0gZGF0YVNvdXJjZVsncXVlcnknXTtcbiAgICAgICAgICBjb25zdCBhcGlRdWVyeSA9IENvbW1vbnNVdGlscy5nZXRBcnJheVZhbHVlKGFwaURhdGFQcm9wLnF1ZXJ5IHx8IFtdKTtcbiAgICAgICAgICBhcGlRdWVyeS5jb25jYXQoQ29tbW9uc1V0aWxzLmdldEFycmF5VmFsdWUocXVlcnkpKTtcbiAgICAgICAgICBhcGlEYXRhUHJvcC5xdWVyeSA9IGFwaVF1ZXJ5O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IF9maWx0ZXIgPSBhcGlEYXRhUHJvcC5maWx0ZXI7XG4gICAgICAgIGlmIChDb21tb25zVXRpbHMuaXNGdW5jdGlvbihfZmlsdGVyKSkge1xuICAgICAgICAgIGlmIChkYXRhU291cmNlWydxdWVyeVZhbHVlJ10pIHtcbiAgICAgICAgICAgIGFwaURhdGFQcm9wLmZpbHRlciA9IChhcGlEYXRhUHJvcC5maWx0ZXIgYXMgRnVuY3Rpb24pKGRhdGFTb3VyY2VbJ3F1ZXJ5VmFsdWUnXSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRlbGV0ZSBhcGlEYXRhUHJvcC5maWx0ZXI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGFTb3VyY2VbJ2ludGVydmFsJ10pIHtcbiAgICAgICAgICBDb21tb25zVXRpbHMuc2V0KDx7fT5hcGlEYXRhUHJvcCwgJ2FnZ1Byb3BzLmludGVydmFsJywgZGF0YVNvdXJjZVsnaW50ZXJ2YWwnXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRhdGFTb3VyY2VbJ2Zvcm1hdCddKSB7XG4gICAgICAgICAgQ29tbW9uc1V0aWxzLnNldCg8e30+YXBpRGF0YVByb3AsICdhZ2dQcm9wcy5mb3JtYXQnLCBkYXRhU291cmNlWydmb3JtYXQnXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgLy8gcmV0dXJuIGZvcmtKb2luKC4uLmFwaURhdGFQcm9wcy5tYXAoYXBpRGF0YVByb3AgPT4gQXBpVXRpbHMuZmV0Y2goYXBpRGF0YVByb3AsIHRhZykpKVxuICAgICAgLy8gICAucGlwZShcbiAgICAgIC8vICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRocm93RXJyb3IoZXJyKSlcbiAgICAgIC8vICAgKTtcbiAgICAgIHJldHVybiB6aXAoLi4uYXBpRGF0YVByb3BzLm1hcChhcGlEYXRhUHJvcCA9PiBBcGlVdGlscy5mZXRjaChhcGlEYXRhUHJvcCwgdGFnKSkpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIG1hcChkYXRhU2V0ID0+IHtcbiAgICAgICAgICAgIGxldCByZXN1bHRMaXN0O1xuICAgICAgICAgICAgbGV0IHJlc3VsdE1hcDtcbiAgICAgICAgICAgIGRhdGFTZXQuZm9yRWFjaCgoZGF0YSwgaSkgPT4ge1xuICAgICAgICAgICAgICBpZiAoYXBpRGF0YVByb3BzW2ldLmlkKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHRNYXApIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdE1hcCA9IHt9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bHRNYXBbYXBpRGF0YVByb3BzW2ldLmlkXSA9IGRhdGE7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHRMaXN0KSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRMaXN0ID0gW107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc3VsdExpc3QucHVzaChkYXRhKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAocmVzdWx0TGlzdCAmJiByZXN1bHRMaXN0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICByZXN1bHRMaXN0ID0gcmVzdWx0TGlzdFswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHRNYXAgJiYgcmVzdWx0TGlzdCkge1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIC4uLnJlc3VsdE1hcCxcbiAgICAgICAgICAgICAgICBkYXRhOiByZXN1bHRMaXN0XG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0TWFwIHx8IHJlc3VsdExpc3QgfHwgW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgZmV0Y2goYXBpRGF0YVByb3BzOiBBcGlEYXRhUHJvcHMsIHRhZz8pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICghYXBpRGF0YVByb3BzLmFwaUVudHJ5KSB7XG4gICAgICBMb2dVdGlscy5lcnJvcignYXBpVXRpbCcsICfmsqHmnInlrprkuYlhcGlFbnRyeScpO1xuICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICB9XG4gICAgbGV0IHF1ZXJ5UGF5bG9hZDoge307XG4gICAgaWYgKENvbW1vbnNVdGlscy5pc0Z1bmN0aW9uKGFwaURhdGFQcm9wcy5wYXlsb2FkKSkge1xuICAgICAgcXVlcnlQYXlsb2FkID0gKDxGdW5jdGlvbj5hcGlEYXRhUHJvcHMucGF5bG9hZCkuY2FsbCh1bmRlZmluZWQsIGFwaURhdGFQcm9wcyk7XG4gICAgfSBlbHNlIGlmIChhcGlEYXRhUHJvcHMucGF5bG9hZCkge1xuICAgICAgcXVlcnlQYXlsb2FkID0gYXBpRGF0YVByb3BzLnBheWxvYWQ7XG4gICAgfVxuICAgIGlmICghcXVlcnlQYXlsb2FkKSB7XG4gICAgICBjb25zdCBxQm9keSA9IEVzVXRpbHMuYnVpbGRRdWVyeUJvZHkoYXBpRGF0YVByb3BzKTtcbiAgICAgIHF1ZXJ5UGF5bG9hZCA9IHFCb2R5O1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zID0gYXBpRGF0YVByb3BzLnJlcXVlc3RPcHRpb25zIHx8IHt9O1xuICAgIGlmICghb3B0aW9ucy50YWcpIHtcbiAgICAgIG9wdGlvbnMudGFnID0gdGFnIHx8ICcnO1xuICAgIH1cbiAgICBMb2dVdGlscy5kZWJ1ZygnYXBpVXRpbHMnLCAnYXBpRGF0YeaVsOaNruafpeivoicsIHthcGlEYXRhUHJvcHM6IGFwaURhdGFQcm9wcywgYXBpUmVxdWVzdEJvZHk6IHF1ZXJ5UGF5bG9hZH0pO1xuICAgIHJldHVybiBBcGlVdGlscy5nZXRCeVF1ZXJ5KGFwaURhdGFQcm9wcy5hcGlFbnRyeSwgcXVlcnlQYXlsb2FkLCBvcHRpb25zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChkYXRhID0+IHtcbiAgICAgICAgICBsZXQgYWdncztcbiAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmFnZ3MpIHtcbiAgICAgICAgICAgIGFnZ3MgPSBFc1V0aWxzLnJlc29sdmVBZ2dzKGRhdGEuYWdncyk7XG4gICAgICAgICAgICBkYXRhLmFnZ3MgPSBhZ2dzO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoQ29tbW9uc1V0aWxzLmlzRW1wdHkoZGF0YS5pdGVtcykpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLml0ZW1zO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoQ29tbW9uc1V0aWxzLmlzRW1wdHkoZGF0YS5hZ2dzKSkge1xuICAgICAgICAgICAgZGVsZXRlIGRhdGEuYWdncztcbiAgICAgICAgICB9XG4gICAgICAgICAgbGV0IHBhdGggPSBhcGlEYXRhUHJvcHMuZGF0YVBhdGggfHwgKGFwaURhdGFQcm9wcy5hZ2dQcm9wcyA/ICdhZ2dzJyA6IHVuZGVmaW5lZCk7XG4gICAgICAgICAgaWYgKHBhdGggPT09ICcvJykge1xuICAgICAgICAgICAgcGF0aCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHBhdGggPyBDb21tb25zVXRpbHMuZ2V0KGRhdGEsIHBhdGgpIDogZGF0YTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBzZXRDb250ZXh0KG9wdGlvbnMsIGNvbnRleHQpIHtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICBvcHRpb25zLmNvbnRleHQgPSBjb250ZXh0O1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZG9SZXF1ZXN0KGFwaUVudHJ5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiBhbnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXRBY3Rpb25PcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbk9wdGlvbnM/OiBBcGlSZXF1ZXN0T3B0aW9ucyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgYXBpUmVxdWVzdE9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge1xuICAgICAgLi4ucHJlc2V0QWN0aW9uT3B0aW9ucyxcbiAgICAgIC4uLmFjdGlvbk9wdGlvbnNcbiAgICB9O1xuICAgIGRlbGV0ZSBhcGlSZXF1ZXN0T3B0aW9ucy5hY3Rpb25zO1xuICAgIGNvbnN0IHJlcXVlc3RQYXlsb2FkID0gcGF5bG9hZDtcbiAgICBjb25zdCByZXF1ZXN0T3B0aW9ucyA9IHtcbiAgICAgIC4uLmFwaVJlcXVlc3RPcHRpb25zLFxuICAgICAgdXJpOiBBcGlVdGlscy5idWlsZFVyaShhcGlFbnRyeSwgcmVxdWVzdFBheWxvYWQsIGFwaVJlcXVlc3RPcHRpb25zKSxcbiAgICAgIHBheWxvYWQ6IEFwaVV0aWxzLmJ1aWxkUGF5bG9hZChhcGlFbnRyeSwgcmVxdWVzdFBheWxvYWQsIGFwaVJlcXVlc3RPcHRpb25zKVxuICAgIH07XG4gICAgZGVsZXRlIHJlcXVlc3RPcHRpb25zLnBhcmFtc0tleXM7XG4gICAgZGVsZXRlIHJlcXVlc3RPcHRpb25zLnVyaVJlc29sdmVyO1xuICAgIGRlbGV0ZSByZXF1ZXN0T3B0aW9ucy5wYXlsb2FkUmVzb2x2ZXI7XG4gICAgaWYgKCFyZXF1ZXN0T3B0aW9ucy51cmkgfHwgIXJlcXVlc3RPcHRpb25zLnVyaS5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICAgIGNvbnN0IGFwaVNlcnZlciA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMocHJlc2V0QWN0aW9uT3B0aW9ucy5zZXJ2ZXJUeXBlKS51cmkgfHwgJyc7XG4gICAgICByZXF1ZXN0T3B0aW9ucy51cmkgPSBhcGlTZXJ2ZXIgKyAocmVxdWVzdE9wdGlvbnMudXJpLnN0YXJ0c1dpdGgoJy8nKSA/ICcnIDogJy8nKSArIHJlcXVlc3RPcHRpb25zLnVyaTtcbiAgICB9XG4gICAgcmV0dXJuIEh0dHBVdGlscy5yZXF1ZXN0KHJlcXVlc3RPcHRpb25zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcihyZXNwb25zZSA9PiAhIXJlc3BvbnNlKSxcbiAgICAgICAgbWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2VzcyA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgaWYgKGFwaVJlcXVlc3RPcHRpb25zLmFsZXJ0U3VjY2Vzcykge1xuICAgICAgICAgICAgICBEaWFsb2dVdGlscy5pbmZvKCfmk43kvZzlrozmiJAnLCBhcGlSZXF1ZXN0T3B0aW9ucy5zdWNjZXNzTWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBpUmVxdWVzdE9wdGlvbnMubm90aWZ5U3VjY2Vzcykge1xuICAgICAgICAgICAgICBTdGF0ZXNVdGlscy5jcmVhdGUoU3RhdGVOYW1lcy5ub3RpZnksIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+aTjeS9nOWujOaIkCcsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYXBpUmVxdWVzdE9wdGlvbnMuc3VjY2Vzc01lc3NhZ2VcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBpUmVxdWVzdE9wdGlvbnMub25TdWNjZXNzKSB7XG4gICAgICAgICAgICAgIHJldHVybiBhcGlSZXF1ZXN0T3B0aW9ucy5vblN1Y2Nlc3MuY2FsbChyZXF1ZXN0T3B0aW9ucy5jb250ZXh0LCByZXNwb25zZSwgcmVxdWVzdE9wdGlvbnMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKGFwaVJlcXVlc3RPcHRpb25zLmRhdGFQYXRoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIENvbW1vbnNVdGlscy5nZXQocmVzcG9uc2UuY29udGVudCwgYXBpUmVxdWVzdE9wdGlvbnMuZGF0YVBhdGgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5jb250ZW50IHx8IHJlc3BvbnNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAoIXJlc3BvbnNlLnN1Y2Nlc3MgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBpZiAoYXBpUmVxdWVzdE9wdGlvbnMuYWxlcnRGYWlsdXJlKSB7XG4gICAgICAgICAgICAgIERpYWxvZ1V0aWxzLmVycm9yKCfmk43kvZzlpLHotKUnLCByZXNwb25zZS5tZXNzYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcGlSZXF1ZXN0T3B0aW9ucy5ub3RpZnlGYWlsdXJlKSB7XG4gICAgICAgICAgICAgIFN0YXRlc1V0aWxzLmNyZWF0ZShTdGF0ZU5hbWVzLm5vdGlmeSwge1xuICAgICAgICAgICAgICAgIGxldmVsOiBOb3RpZnlMZXZlbC5FUlJPUixcbiAgICAgICAgICAgICAgICB0aXRsZTogcmVzcG9uc2UuZXJyb3IsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogcmVzcG9uc2UubWVzc2FnZVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcGlSZXF1ZXN0T3B0aW9ucy5vbkZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGFwaVJlcXVlc3RPcHRpb25zLm9uRmFpbHVyZS5jYWxsKHJlcXVlc3RPcHRpb25zLmNvbnRleHQsIHJlc3BvbnNlLCByZXF1ZXN0T3B0aW9ucyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpcnN0KClcbiAgICAgICk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBidWlsZFVyaShhcGlFbnRyeTogc3RyaW5nLCBwYXlsb2FkOiBhbnksIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zKSB7XG4gICAgbGV0IHVyaSA9IGFwaUVudHJ5O1xuICAgIGlmIChDb21tb25zVXRpbHMuaXNUZW1wbGF0ZVN0cihhcGlFbnRyeSkpIHtcbiAgICAgIC8vIGFwaUVudHJ5ID0gQ29tbW9uc1V0aWxzLnRlbXBsYXRlU3RyKGFwaUVudHJ5LCBDb250ZXh0VXRpbHMuY29udGV4dCgpKTtcbiAgICB9XG4gICAgaWYgKENvbW1vbnNVdGlscy5pc1N0cmluZyhvcHRpb25zLnVyaVJlc29sdmVyKSkge1xuICAgICAgdXJpID0gb3B0aW9ucy51cmlSZXNvbHZlciBhcyBzdHJpbmc7XG4gICAgfSBlbHNlIGlmIChDb21tb25zVXRpbHMuaXNGdW5jdGlvbihvcHRpb25zLnVyaVJlc29sdmVyKSkge1xuICAgICAgdXJpID0gKG9wdGlvbnMudXJpUmVzb2x2ZXIgYXMgRnVuY3Rpb24pLmNhbGwob3B0aW9ucy5jb250ZXh0LCBhcGlFbnRyeSwgcGF5bG9hZCwgb3B0aW9ucyk7XG4gICAgfSBlbHNlIGlmICghdXJpKSB7XG4gICAgICB1cmkgPSBvcHRpb25zLnVyaSB8fCAnJztcbiAgICB9XG4gICAgaWYgKCF1cmkuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICBjb25zdCBzZXJ2ZXJVcmkgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkudXJpO1xuICAgICAgaWYgKHNlcnZlclVyaSkge1xuICAgICAgICB1cmkgPSBzZXJ2ZXJVcmkgKyAodXJpLnN0YXJ0c1dpdGgoJy8nKSA/IHVyaSA6ICcvJyArIHVyaSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1cmk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBidWlsZFBheWxvYWQoYXBpRW50cnk6IHN0cmluZywgcGF5bG9hZDogYW55LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyk6IHt9IHtcbiAgICBsZXQgX3BheWxvYWQgPSBwYXlsb2FkO1xuICAgIGlmIChDb21tb25zVXRpbHMuaXNKc29uKF9wYXlsb2FkKSkge1xuICAgICAgX3BheWxvYWQgPSBDb21tb25zVXRpbHMubWVyZ2Uoe30sIF9wYXlsb2FkIHx8IHt9LCBvcHRpb25zLnBheWxvYWQgfHwge30sIG9wdGlvbnMuYm9keSB8fCBvcHRpb25zLnBhcmFtcyB8fCB7fSk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnBheWxvYWRSZXNvbHZlcikge1xuICAgICAgX3BheWxvYWQgPSAob3B0aW9ucy5wYXlsb2FkUmVzb2x2ZXIgYXMgRnVuY3Rpb24pLmNhbGwob3B0aW9ucy5jb250ZXh0LCBhcGlFbnRyeSwgX3BheWxvYWQsIG9wdGlvbnMpO1xuICAgIH1cbiAgICBpZiAoQ29tbW9uc1V0aWxzLmlzU3RyaW5nKF9wYXlsb2FkKSkge1xuICAgICAgcmV0dXJuIF9wYXlsb2FkO1xuICAgIH0gZWxzZSBpZiAoQ29tbW9uc1V0aWxzLmlzU3RyaW5nKG9wdGlvbnMuYm9keSkpIHtcbiAgICAgIHJldHVybiBvcHRpb25zLmJvZHk7XG4gICAgfSBlbHNlIGlmIChDb21tb25zVXRpbHMuaXNFbXB0eShfcGF5bG9hZCkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIF9wYXlsb2FkID0gQ29udGV4dFV0aWxzLnJlc29sdmVWYXJpYWJsZXMoX3BheWxvYWQpO1xuICAgIF9wYXlsb2FkID0gQXBpVXRpbHMucmVzb2x2ZUFwaVBhcmFtc05hbWUoXG4gICAgICBvcHRpb25zLnBhcmFtc0tleXMgfHwgQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLnBhcmFtc0tleXMgfHwge30sXG4gICAgICBfcGF5bG9hZCk7XG4gICAgaWYgKENvbW1vbnNVdGlscy5pc0VtcHR5KF9wYXlsb2FkKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIF9wYXlsb2FkO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmVzb2x2ZUFwaVBhcmFtc05hbWUocGFyYW1zS2V5czoge30sIHBheWxvYWQpIHtcbiAgICBpZiAoIUNvbW1vbnNVdGlscy5pc0pzb24ocGF5bG9hZCkpIHtcbiAgICAgIHJldHVybiBwYXlsb2FkO1xuICAgIH1cbiAgICBjb25zdCByZXNvbHZlZCA9IHt9O1xuICAgIGZvciAoY29uc3Qga2V5IGluIHBheWxvYWQpIHtcbiAgICAgIGlmIChwYXJhbXNLZXlzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgcmVzb2x2ZWRbcGFyYW1zS2V5c1trZXldXSA9IHBheWxvYWRba2V5XTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmVkW2tleV0gPSBwYXlsb2FkW2tleV07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXNvbHZlZDtcbiAgfVxufVxuXG4iXX0=