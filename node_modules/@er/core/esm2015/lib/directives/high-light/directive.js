/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Input } from '@angular/core';
import { BaseDirective } from '../../bases/directive';
export class HighlightDirective extends BaseDirective {
    /**
     * @param {?} el
     */
    constructor(el) {
        super();
        this.el = el;
        this.searchTerm = undefined;
        this.caseSensitive = true;
        this.viewRendered = false;
        this.WRAPPER_TOKEN = '==--==##';
    }
    /**
     * @private
     * @return {?}
     */
    get caseSensitivity() {
        return this.caseSensitive ? '' : 'i';
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        this.highlightSearchTerm();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.highlightSearchTerm();
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() {
        this.viewRendered = true;
    }
    /**
     * @return {?}
     */
    highlightSearchTerm() {
        if (!this.searchTerm) {
            if (this.viewRendered) {
                this.removePreviouslyMarkedTextInNode();
            }
            return;
        }
        if (this.el.nativeElement) {
            this.removePreviouslyMarkedTextInNode();
            this.markMatchedTextTokens(this.el.nativeElement);
        }
    }
    /**
     * @private
     * @param {?} htmlNode
     * @return {?}
     */
    markMatchedTextTokens(htmlNode) {
        /** @type {?} */
        const _searchTerm = this.getSearchTerm();
        /** @type {?} */
        const searchRegex = new RegExp(_searchTerm, 'gmi');
        /** @type {?} */
        const _searchTermUniqueTokens = this.getUniqueTokenWrappedSearchTerm();
        /** @type {?} */
        const searchRegexUniqueTokens = new RegExp(_searchTermUniqueTokens, 'gmi');
        this.traverseHtmlElementsTree(htmlNode, e => {
            this.traverseNodesInElement(htmlNode.childNodes, node => this.wrapUniqueTokensAroundMatchedText(node, searchRegex));
        });
        this.markMatchedTextAndRemoveUniqueTokens(htmlNode, searchRegexUniqueTokens);
    }
    /**
     * @private
     * @param {?} htmlNode
     * @param {?} searchRegex
     * @return {?}
     */
    markMatchedTextAndRemoveUniqueTokens(htmlNode, searchRegex) {
        if (htmlNode.innerHTML) {
            /** @type {?} */
            const innerHtml = htmlNode.innerHTML;
            /** @type {?} */
            const newHtml = innerHtml.replace(searchRegex, match => {
                /** @type {?} */
                const wrapperLength = this.WRAPPER_TOKEN.length;
                /** @type {?} */
                const markedStr = match.substr(wrapperLength, match.length - (wrapperLength * 2));
                return `<mark>${markedStr}</mark>`;
            });
            htmlNode.innerHTML = newHtml;
        }
    }
    /**
     * @private
     * @param {?} nodes
     * @param {?} visitCallback
     * @return {?}
     */
    traverseNodesInElement(nodes, visitCallback) {
        for (let i = 0; i < nodes.length; i++) {
            /** @type {?} */
            const node = nodes[i];
            if (node.nodeType === 3) {
                visitCallback(node);
            }
        }
    }
    /**
     * @private
     * @param {?} htmlNode
     * @param {?} searchRegex
     * @return {?}
     */
    wrapUniqueTokensAroundMatchedText(htmlNode, searchRegex) {
        /** @type {?} */
        const innerText = htmlNode.nodeValue;
        /** @type {?} */
        const newText = innerText.replace(searchRegex, `${this.WRAPPER_TOKEN}$&${this.WRAPPER_TOKEN}`);
        htmlNode.nodeValue = newText;
    }
    /**
     * @private
     * @param {?} currentNode
     * @param {?} visitCallback
     * @return {?}
     */
    traverseHtmlElementsTree(currentNode, visitCallback) {
        if (currentNode) {
            visitCallback(currentNode);
        }
        for (let i = 0; i < currentNode.children.length; i++) {
            /** @type {?} */
            const childNode = currentNode.children[i];
            this.markMatchedTextTokens((/** @type {?} */ (childNode)));
        }
    }
    /**
     * @private
     * @return {?}
     */
    removePreviouslyMarkedTextInNode() {
        /** @type {?} */
        const node = this.el.nativeElement;
        /** @type {?} */
        const markingPattern = new RegExp('<mark>|<\/mark>', 'g');
        /** @type {?} */
        const cleanText = node.innerHTML.replace(markingPattern, '');
        node.innerHTML = cleanText;
    }
    // private highlightedNewTextInNode() {
    //   const node = this.el.nativeElement;
    //   const htmlNegativeLookaheadPattern = '(?![^<>]*>)';
    //   const searchTermPattern = this.getSearchTerm();
    //   const searchRegex = new RegExp(searchTermPattern + htmlNegativeLookaheadPattern, 'gmi');
    //   const markedText = node.innerHTML.replace(searchRegex, '<mark>$&</mark>');
    //   node.innerHTML = markedText;
    // }
    /**
     * @private
     * @return {?}
     */
    getSearchTerm() {
        /** @type {?} */
        let escapedSearchTerm = `${this.escapeRegExp(this.searchTerm)}`;
        /** @type {?} */
        const spaceToMultiMatchRegex = new RegExp(' ', 'gm');
        escapedSearchTerm = escapedSearchTerm.replace(spaceToMultiMatchRegex, '|');
        return escapedSearchTerm;
    }
    /**
     * @private
     * @return {?}
     */
    getUniqueTokenWrappedSearchTerm() {
        /** @type {?} */
        let escapedSearchTerm = this.escapeRegExp(this.searchTerm);
        /** @type {?} */
        const spaceToMultiMatchRegex = new RegExp(' ', 'gm');
        escapedSearchTerm = escapedSearchTerm.replace(spaceToMultiMatchRegex, `${this.WRAPPER_TOKEN}|${this.WRAPPER_TOKEN}`);
        escapedSearchTerm = `${this.WRAPPER_TOKEN}${escapedSearchTerm}${this.WRAPPER_TOKEN}`;
        return escapedSearchTerm;
    }
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    escapeRegExp(str) {
        return str.replace('/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g', '\\$&');
    }
}
HighlightDirective.decorators = [
    { type: Directive, args: [{
                selector: '[erHighlight]'
            },] }
];
/** @nocollapse */
HighlightDirective.ctorParameters = () => [
    { type: ElementRef }
];
HighlightDirective.propDecorators = {
    searchTerm: [{ type: Input, args: ['erHighlight',] }],
    caseSensitive: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    HighlightDirective.prototype.searchTerm;
    /** @type {?} */
    HighlightDirective.prototype.caseSensitive;
    /**
     * @type {?}
     * @private
     */
    HighlightDirective.prototype.viewRendered;
    /**
     * @type {?}
     * @private
     */
    HighlightDirective.prototype.WRAPPER_TOKEN;
    /**
     * @type {?}
     * @private
     */
    HighlightDirective.prototype.el;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVyL2NvcmUvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9oaWdoLWxpZ2h0L2RpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFrQyxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBMkIsTUFBTSxlQUFlLENBQUM7QUFDdEgsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBS3BELE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxhQUFhOzs7O0lBUW5ELFlBQW9CLEVBQWM7UUFDaEMsS0FBSyxFQUFFLENBQUM7UUFEVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBTlosZUFBVSxHQUFHLFNBQVMsQ0FBQztRQUNwQyxrQkFBYSxHQUFHLElBQUksQ0FBQztRQUV0QixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUNyQixrQkFBYSxHQUFHLFVBQVUsQ0FBQztJQUluQyxDQUFDOzs7OztJQUVELElBQVksZUFBZTtRQUN6QixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQ3ZDLENBQUM7Ozs7O0lBRUQsV0FBVyxDQUFDLE9BQXNCO1FBQ2hDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQzdCLENBQUM7Ozs7SUFFRCxlQUFlO1FBQ2IsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDN0IsQ0FBQzs7OztJQUVELGtCQUFrQjtRQUNoQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztJQUMzQixDQUFDOzs7O0lBRUQsbUJBQW1CO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3BCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDckIsSUFBSSxDQUFDLGdDQUFnQyxFQUFFLENBQUM7YUFDekM7WUFDRCxPQUFPO1NBQ1I7UUFFRCxJQUFJ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QUN0RSxDQUFDOzs7WUFqSUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxlQUFlO2FBQzFCOzs7O1lBTG1ELFVBQVU7Ozt5QkFRM0QsS0FBSyxTQUFDLGFBQWE7NEJBQ25CLEtBQUs7Ozs7SUFETix3Q0FBNkM7O0lBQzdDLDJDQUE4Qjs7Ozs7SUFFOUIsMENBQTZCOzs7OztJQUM3QiwyQ0FBbUM7Ozs7O0lBRXZCLGdDQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QWZ0ZXJWaWV3Q2hlY2tlZCwgQWZ0ZXJWaWV3SW5pdCwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbnB1dCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QmFzZURpcmVjdGl2ZX0gZnJvbSAnLi4vLi4vYmFzZXMvZGlyZWN0aXZlJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2VySGlnaGxpZ2h0XSdcbn0pXG5leHBvcnQgY2xhc3MgSGlnaGxpZ2h0RGlyZWN0aXZlIGV4dGVuZHMgQmFzZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgQWZ0ZXJWaWV3SW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCB7XG5cbiAgQElucHV0KCdlckhpZ2hsaWdodCcpIHNlYXJjaFRlcm0gPSB1bmRlZmluZWQ7XG4gIEBJbnB1dCgpIGNhc2VTZW5zaXRpdmUgPSB0cnVlO1xuXG4gIHByaXZhdGUgdmlld1JlbmRlcmVkID0gZmFsc2U7XG4gIHByaXZhdGUgV1JBUFBFUl9UT0tFTiA9ICc9PS0tPT0jIyc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbDogRWxlbWVudFJlZikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwcml2YXRlIGdldCBjYXNlU2Vuc2l0aXZpdHkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jYXNlU2Vuc2l0aXZlID8gJycgOiAnaSc7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgdGhpcy5oaWdobGlnaHRTZWFyY2hUZXJtKCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5oaWdobGlnaHRTZWFyY2hUZXJtKCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKTogdm9pZCB7XG4gICAgdGhpcy52aWV3UmVuZGVyZWQgPSB0cnVlO1xuICB9XG5cbiAgaGlnaGxpZ2h0U2VhcmNoVGVybSgpIHtcbiAgICBpZiAoIXRoaXMuc2VhcmNoVGVybSkge1xuICAgICAgaWYgKHRoaXMudmlld1JlbmRlcmVkKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlUHJldmlvdXNseU1hcmtlZFRleHRJbk5vZGUoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5lbC5uYXRpdmVFbGVtZW50KSB7XG4gICAgICB0aGlzLnJlbW92ZVByZXZpb3VzbHlNYXJrZWRUZXh0SW5Ob2RlKCk7XG4gICAgICB0aGlzLm1hcmtNYXRjaGVkVGV4dFRva2Vucyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbWFya01hdGNoZWRUZXh0VG9rZW5zKGh0bWxOb2RlOiBIVE1MRWxlbWVudCkge1xuICAgIGNvbnN0IF9zZWFyY2hUZXJtID0gdGhpcy5nZXRTZWFyY2hUZXJtKCk7XG4gICAgY29uc3Qgc2VhcmNoUmVnZXggPSBuZXcgUmVnRXhwKF9zZWFyY2hUZXJtLCAnZ21pJyk7XG5cbiAgICBjb25zdCBfc2VhcmNoVGVybVVuaXF1ZVRva2VucyA9IHRoaXMuZ2V0VW5pcXVlVG9rZW5XcmFwcGVkU2VhcmNoVGVybSgpO1xuICAgIGNvbnN0IHNlYXJjaFJlZ2V4VW5pcXVlVG9rZW5zID0gbmV3IFJlZ0V4cChfc2VhcmNoVGVybVVuaXF1ZVRva2VucywgJ2dtaScpO1xuICAgIHRoaXMudHJhdmVyc2VIdG1sRWxlbWVudHNUcmVlKGh0bWxOb2RlLCBlID0+IHtcbiAgICAgIHRoaXMudHJhdmVyc2VOb2Rlc0luRWxlbWVudChodG1sTm9kZS5jaGlsZE5vZGVzLCBub2RlID0+IHRoaXMud3JhcFVuaXF1ZVRva2Vuc0Fyb3VuZE1hdGNoZWRUZXh0KG5vZGUsIHNlYXJjaFJlZ2V4KSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLm1hcmtNYXRjaGVkVGV4dEFuZFJlbW92ZVVuaXF1ZVRva2VucyhodG1sTm9kZSwgc2VhcmNoUmVnZXhVbmlxdWVUb2tlbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXJrTWF0Y2hlZFRleHRBbmRSZW1vdmVVbmlxdWVUb2tlbnMoaHRtbE5vZGU6IEhUTUxFbGVtZW50LCBzZWFyY2hSZWdleDogUmVnRXhwKSB7XG4gICAgaWYgKGh0bWxOb2RlLmlubmVySFRNTCkge1xuICAgICAgY29uc3QgaW5uZXJIdG1sID0gaHRtbE5vZGUuaW5uZXJIVE1MO1xuICAgICAgY29uc3QgbmV3SHRtbCA9IGlubmVySHRtbC5yZXBsYWNlKHNlYXJjaFJlZ2V4LCBtYXRjaCA9PiB7XG4gICAgICAgIGNvbnN0IHdyYXBwZXJMZW5ndGggPSB0aGlzLldSQVBQRVJfVE9LRU4ubGVuZ3RoO1xuICAgICAgICBjb25zdCBtYXJrZWRTdHIgPSBtYXRjaC5zdWJzdHIod3JhcHBlckxlbmd0aCwgbWF0Y2gubGVuZ3RoIC0gKHdyYXBwZXJMZW5ndGggKiAyKSk7XG4gICAgICAgIHJldHVybiBgPG1hcms+JHttYXJrZWRTdHJ9PC9tYXJrPmA7XG4gICAgICB9KTtcblxuICAgICAgaHRtbE5vZGUuaW5uZXJIVE1MID0gbmV3SHRtbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyYXZlcnNlTm9kZXNJbkVsZW1lbnQobm9kZXM6IE5vZGVMaXN0LCB2aXNpdENhbGxiYWNrOiAobm9kZTogTm9kZSkgPT4gYW55KSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldO1xuICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDMpIHtcbiAgICAgICAgdmlzaXRDYWxsYmFjayhub2RlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHdyYXBVbmlxdWVUb2tlbnNBcm91bmRNYXRjaGVkVGV4dChodG1sTm9kZTogTm9kZSwgc2VhcmNoUmVnZXg6IFJlZ0V4cCkge1xuICAgIGNvbnN0IGlubmVyVGV4dCA9IGh0bWxOb2RlLm5vZGVWYWx1ZTtcbiAgICBjb25zdCBuZXdUZXh0ID0gaW5uZXJUZXh0LnJlcGxhY2Uoc2VhcmNoUmVnZXgsIGAke3RoaXMuV1JBUFBFUl9UT0tFTn0kJiR7dGhpcy5XUkFQUEVSX1RPS0VOfWApO1xuICAgIGh0bWxOb2RlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7XG4gIH1cblxuICBwcml2YXRlIHRyYXZlcnNlSHRtbEVsZW1lbnRzVHJlZShjdXJyZW50Tm9kZTogSFRNTEVsZW1lbnQsIHZpc2l0Q2FsbGJhY2s6IChub2RlOiBIVE1MRWxlbWVudCkgPT4gYW55KSB7XG4gICAgaWYgKGN1cnJlbnROb2RlKSB7XG4gICAgICB2aXNpdENhbGxiYWNrKGN1cnJlbnROb2RlKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cnJlbnROb2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBjaGlsZE5vZGUgPSBjdXJyZW50Tm9kZS5jaGlsZHJlbltpXTtcbiAgICAgIHRoaXMubWFya01hdGNoZWRUZXh0VG9rZW5zKDxIVE1MRWxlbWVudD5jaGlsZE5vZGUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlUHJldmlvdXNseU1hcmtlZFRleHRJbk5vZGUoKSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCBtYXJraW5nUGF0dGVybiA9IG5ldyBSZWdFeHAoJzxtYXJrPnw8XFwvbWFyaz4nLCAnZycpO1xuICAgIGNvbnN0IGNsZWFuVGV4dCA9IG5vZGUuaW5uZXJIVE1MLnJlcGxhY2UobWFya2luZ1BhdHRlcm4sICcnKTtcbiAgICBub2RlLmlubmVySFRNTCA9IGNsZWFuVGV4dDtcbiAgfVxuXG4gIC8vIHByaXZhdGUgaGlnaGxpZ2h0ZWROZXdUZXh0SW5Ob2RlKCkge1xuICAvLyAgIGNvbnN0IG5vZGUgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQ7XG4gIC8vICAgY29uc3QgaHRtbE5lZ2F0aXZlTG9va2FoZWFkUGF0dGVybiA9ICcoPyFbXjw+XSo+KSc7XG4gIC8vICAgY29uc3Qgc2VhcmNoVGVybVBhdHRlcm4gPSB0aGlzLmdldFNlYXJjaFRlcm0oKTtcbiAgLy8gICBjb25zdCBzZWFyY2hSZWdleCA9IG5ldyBSZWdFeHAoc2VhcmNoVGVybVBhdHRlcm4gKyBodG1sTmVnYXRpdmVMb29rYWhlYWRQYXR0ZXJuLCAnZ21pJyk7XG4gIC8vICAgY29uc3QgbWFya2VkVGV4dCA9IG5vZGUuaW5uZXJIVE1MLnJlcGxhY2Uoc2VhcmNoUmVnZXgsICc8bWFyaz4kJjwvbWFyaz4nKTtcbiAgLy8gICBub2RlLmlubmVySFRNTCA9IG1hcmtlZFRleHQ7XG4gIC8vIH1cbiAgcHJpdmF0ZSBnZXRTZWFyY2hUZXJtKCkge1xuICAgIGxldCBlc2NhcGVkU2VhcmNoVGVybSA9IGAke3RoaXMuZXNjYXBlUmVnRXhwKHRoaXMuc2VhcmNoVGVybSl9YDtcbiAgICBjb25zdCBzcGFjZVRvTXVsdGlNYXRjaFJlZ2V4ID0gbmV3IFJlZ0V4cCgnICcsICdnbScpO1xuICAgIGVzY2FwZWRTZWFyY2hUZXJtID0gZXNjYXBlZFNlYXJjaFRlcm0ucmVwbGFjZShzcGFjZVRvTXVsdGlNYXRjaFJlZ2V4LCAnfCcpO1xuICAgIHJldHVybiBlc2NhcGVkU2VhcmNoVGVybTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VW5pcXVlVG9rZW5XcmFwcGVkU2VhcmNoVGVybSgpIHtcbiAgICBsZXQgZXNjYXBlZFNlYXJjaFRlcm0gPSB0aGlzLmVzY2FwZVJlZ0V4cCh0aGlzLnNlYXJjaFRlcm0pO1xuICAgIGNvbnN0IHNwYWNlVG9NdWx0aU1hdGNoUmVnZXggPSBuZXcgUmVnRXhwKCcgJywgJ2dtJyk7XG4gICAgZXNjYXBlZFNlYXJjaFRlcm0gPSBlc2NhcGVkU2VhcmNoVGVybS5yZXBsYWNlKHNwYWNlVG9NdWx0aU1hdGNoUmVnZXgsIGAke3RoaXMuV1JBUFBFUl9UT0tFTn18JHt0aGlzLldSQVBQRVJfVE9LRU59YCk7XG4gICAgZXNjYXBlZFNlYXJjaFRlcm0gPSBgJHt0aGlzLldSQVBQRVJfVE9LRU59JHtlc2NhcGVkU2VhcmNoVGVybX0ke3RoaXMuV1JBUFBFUl9UT0tFTn1gO1xuICAgIHJldHVybiBlc2NhcGVkU2VhcmNoVGVybTtcbiAgfVxuXG4gIHByaXZhdGUgZXNjYXBlUmVnRXhwKHN0cikge1xuICAgIHJldHVybiBzdHIucmVwbGFjZSgnL1tcXC1cXFtcXF1cXC9cXHtcXH1cXChcXClcXCpcXCtcXD9cXC5cXFxcXFxeXFwkXFx8XS9nJywgJ1xcXFwkJicpO1xuICB9XG59XG4iXX0=