/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ApiServerType, NotifyLevel, StateNames } from '@er/types';
import { CommonsUtils, ConfigUtils, ContextUtils, DialogUtils, EsUtils, StatesUtils } from '@er/utils';
import { of, zip } from 'rxjs';
import { filter, first, map, switchMap } from 'rxjs/operators';
import { HttpUtils } from '../http';
import { LogUtils } from '../log';
/** @type {?} */
export var DEFAULT_API_REQUEST_OPTIONS = {
    notifyFailure: true
};
var ApiUtils = /** @class */ (function () {
    function ApiUtils() {
    }
    /**
     * @param {?} serverType
     * @return {?}
     */
    ApiUtils.getPresetApiOptions = /**
     * @param {?} serverType
     * @return {?}
     */
    function (serverType) {
        if (!serverType) {
            serverType = CommonsUtils.get(ConfigUtils.getConfig(), 'api.default') || ApiServerType.ES;
        }
        ApiUtils.presetApiOptions[serverType] = tslib_1.__assign({}, DEFAULT_API_REQUEST_OPTIONS, CommonsUtils.get(ConfigUtils.getConfig(), "api.servers." + serverType, {}));
        if (!ApiUtils.presetApiOptions[serverType].actions) {
            ApiUtils.presetApiOptions[serverType].actions = {};
        }
        return ApiUtils.presetApiOptions[serverType];
    };
    /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.login = /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    function (payload, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.login || {};
        return ApiUtils.doRequest(null, payload, presetActionOptions, options);
    };
    /**
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.logout = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.logout || {};
        return ApiUtils.doRequest(null, null, presetActionOptions, options);
    };
    /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.changePwd = /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    function (payload, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.changePwd || {};
        return ApiUtils.doRequest(null, payload, presetActionOptions, options);
    };
    /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.register = /**
     * @param {?} payload
     * @param {?=} options
     * @return {?}
     */
    function (payload, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.register || {};
        return ApiUtils.doRequest(null, payload, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.save = /**
     * @param {?} apiEntry
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, data, options) {
        if (options === void 0) { options = {}; }
        if (data) {
            /** @type {?} */
            var _data = tslib_1.__assign({}, data);
            if (_data['id']) {
                /** @type {?} */
                var id = _data['id'];
                delete _data['id'];
                return ApiUtils.patchById.call(this, apiEntry, id, _data, options);
            }
            else {
                return ApiUtils.create.call(this, apiEntry, _data, options);
            }
        }
    };
    /**
     * @param {?} apiEntry
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.create = /**
     * @param {?} apiEntry
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, data, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.create || {};
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, data, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.getById = /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, id, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.getById || {};
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, { id: id }, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.getByIds = /**
     * @param {?} apiEntry
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, ids, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.getByIds || {};
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, ids, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?=} payload
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.getByQuery = /**
     * @param {?} apiEntry
     * @param {?=} payload
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, payload, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.getByQuery;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, payload, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.updateById = /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, id, data, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.updateById;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, tslib_1.__assign({ id: id }, data), presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.patchById = /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, id, data, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.patchById;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, tslib_1.__assign({ id: id }, data), presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} query
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.updateByQuery = /**
     * @param {?} apiEntry
     * @param {?} query
     * @param {?} data
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, query, data, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.updateByQuery;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, query, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.deleteById = /**
     * @param {?} apiEntry
     * @param {?} id
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, id, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var obv = DialogUtils.confirm('操作确认', '确认执行<b>删除</b>操作吗?')
            .pipe(first(), filter(function (accept) { return accept; }), switchMap(function (_) {
            /** @type {?} */
            var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.deleteById;
            return ApiUtils.doRequest(apiEntry, id, presetActionOptions, options);
        }));
        return obv;
    };
    /**
     * @param {?} apiEntry
     * @param {?} query
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.deleteByQuery = /**
     * @param {?} apiEntry
     * @param {?} query
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, query, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.deleteByQuery;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, query, presetActionOptions, options);
    };
    /**
     * @param {?} apiEntry
     * @param {?} body
     * @param {?=} options
     * @return {?}
     */
    ApiUtils.batch = /**
     * @param {?} apiEntry
     * @param {?} body
     * @param {?=} options
     * @return {?}
     */
    function (apiEntry, body, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var presetActionOptions = ApiUtils.getPresetApiOptions(options.serverType).actions.batch;
        ApiUtils.setContext(options, this);
        return ApiUtils.doRequest(apiEntry, body, presetActionOptions, options);
    };
    /**
     * @param {?} dataSource
     * @param {?=} tag
     * @return {?}
     */
    ApiUtils.batchFetch = /**
     * @param {?} dataSource
     * @param {?=} tag
     * @return {?}
     */
    function (dataSource, tag) {
        if (dataSource) {
            /** @type {?} */
            var _apiDataProp = dataSource;
            if (dataSource['apiDataProps']) {
                _apiDataProp = dataSource['apiDataProps'];
            }
            _apiDataProp = CommonsUtils.copy(_apiDataProp);
            /** @type {?} */
            var apiDataProps_1 = CommonsUtils.getArrayValue(_apiDataProp);
            if (CommonsUtils.isEmpty(apiDataProps_1)) {
                return;
            }
            if (!tag) {
                tag = dataSource['id'] || apiDataProps_1[0].id || '';
            }
            apiDataProps_1.forEach(function (apiDataProp) {
                if (dataSource['query']) {
                    /** @type {?} */
                    var query = dataSource['query'];
                    /** @type {?} */
                    var apiQuery = CommonsUtils.getArrayValue(apiDataProp.query || []);
                    apiQuery.concat(CommonsUtils.getArrayValue(query));
                    apiDataProp.query = apiQuery;
                }
                /** @type {?} */
                var _filter = apiDataProp.filter;
                if (CommonsUtils.isFunction(_filter)) {
                    if (dataSource['queryValue']) {
                        apiDataProp.filter = ((/** @type {?} */ (apiDataProp.filter)))(dataSource['queryValue']);
                    }
                    else {
                        delete apiDataProp.filter;
                    }
                }
                if (dataSource['interval']) {
                    CommonsUtils.set((/** @type {?} */ (apiDataProp)), 'aggProps.interval', dataSource['interval']);
                }
                if (dataSource['format']) {
                    CommonsUtils.set((/** @type {?} */ (apiDataProp)), 'aggProps.format', dataSource['format']);
                }
            });
            // return forkJoin(...apiDataProps.map(apiDataProp => ApiUtils.fetch(apiDataProp, tag)))
            //   .pipe(
            //     catchError((err) => throwError(err))
            //   );
            return zip.apply(void 0, tslib_1.__spread(apiDataProps_1.map(function (apiDataProp) { return ApiUtils.fetch(apiDataProp, tag); }))).pipe(map(function (dataSet) {
                /** @type {?} */
                var resultList;
                /** @type {?} */
                var resultMap;
                dataSet.forEach(function (data, i) {
                    if (apiDataProps_1[i].id) {
                        if (!resultMap) {
                            resultMap = {};
                        }
                        resultMap[apiDataProps_1[i].id] = data;
                    }
                    else {
                        if (!resultList) {
                            resultList = [];
                        }
                        resultList.push(data);
                    }
                });
                if (resultList && resultList.length === 1) {
                    resultList = resultList[0];
                }
                if (resultMap && resultList) {
                    return tslib_1.__assign({}, resultMap, { data: resultList });
                }
                else {
                    return resultMap || resultList || [];
                }
            }));
        }
    };
    /**
     * @param {?} apiDataProps
     * @param {?=} tag
     * @return {?}
     */
    ApiUtils.fetch = /**
     * @param {?} apiDataProps
     * @param {?=} tag
     * @return {?}
     */
    function (apiDataProps, tag) {
        if (!apiDataProps.apiEntry) {
            LogUtils.error('apiUtil', '没有定义apiEntry');
            return of([]);
        }
        /** @type {?} */
        var queryPayload;
        if (CommonsUtils.isFunction(apiDataProps.payload)) {
            queryPayload = ((/** @type {?} */ (apiDataProps.payload))).call(undefined, apiDataProps);
        }
        else if (apiDataProps.payload) {
            queryPayload = apiDataProps.payload;
        }
        if (!queryPayload) {
            /** @type {?} */
            var qBody = EsUtils.buildQueryBody(apiDataProps);
            queryPayload = qBody;
        }
        /** @type {?} */
        var options = apiDataProps.requestOptions || {};
        if (!options.tag) {
            options.tag = tag || '';
        }
        LogUtils.debug('apiUtils', 'apiData数据查询', { apiDataProps: apiDataProps, apiRequestBody: queryPayload });
        return ApiUtils.getByQuery(apiDataProps.apiEntry, queryPayload, options)
            .pipe(map(function (data) {
            /** @type {?} */
            var aggs;
            if (data && data.aggs) {
                aggs = EsUtils.resolveAggs(data.aggs);
                data.aggs = aggs;
            }
            if (CommonsUtils.isEmpty(data.items)) {
                delete data.items;
            }
            if (CommonsUtils.isEmpty(data.aggs)) {
                delete data.aggs;
            }
            /** @type {?} */
            var path = apiDataProps.dataPath || (apiDataProps.aggProps ? 'aggs' : undefined);
            if (path === '/') {
                path = undefined;
            }
            return path ? CommonsUtils.get(data, path) : data;
        }));
    };
    /**
     * @private
     * @param {?} options
     * @param {?} context
     * @return {?}
     */
    ApiUtils.setContext = /**
     * @private
     * @param {?} options
     * @param {?} context
     * @return {?}
     */
    function (options, context) {
        options = options || {};
        options.context = context;
    };
    /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} presetActionOptions
     * @param {?=} actionOptions
     * @return {?}
     */
    ApiUtils.doRequest = /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} presetActionOptions
     * @param {?=} actionOptions
     * @return {?}
     */
    function (apiEntry, payload, presetActionOptions, actionOptions) {
        /** @type {?} */
        var apiRequestOptions = tslib_1.__assign({}, presetActionOptions, actionOptions);
        delete apiRequestOptions.actions;
        /** @type {?} */
        var requestPayload = payload;
        /** @type {?} */
        var requestOptions = tslib_1.__assign({}, apiRequestOptions, { uri: ApiUtils.buildUri(apiEntry, requestPayload, apiRequestOptions), payload: ApiUtils.buildPayload(apiEntry, requestPayload, apiRequestOptions) });
        delete requestOptions.paramsKeys;
        delete requestOptions.uriResolver;
        delete requestOptions.payloadResolver;
        if (!requestOptions.uri || !requestOptions.uri.startsWith('http')) {
            /** @type {?} */
            var apiServer = ApiUtils.getPresetApiOptions(presetActionOptions.serverType).uri || '';
            requestOptions.uri = apiServer + (requestOptions.uri.startsWith('/') ? '' : '/') + requestOptions.uri;
        }
        return HttpUtils.request(requestOptions)
            .pipe(filter(function (response) { return !!response; }), map(function (response) {
            if (response.success === true) {
                if (apiRequestOptions.alertSuccess) {
                    DialogUtils.info('操作完成', apiRequestOptions.successMessage);
                }
                if (apiRequestOptions.notifySuccess) {
                    StatesUtils.create(StateNames.notify, {
                        title: '操作完成',
                        message: apiRequestOptions.successMessage
                    });
                }
                if (apiRequestOptions.onSuccess) {
                    return apiRequestOptions.onSuccess.call(requestOptions.context, response, requestOptions);
                }
                else {
                    if (apiRequestOptions.dataPath) {
                        return CommonsUtils.get(response.content, apiRequestOptions.dataPath);
                    }
                    return response.content || response;
                }
            }
            else if (!response.success === false) {
                if (apiRequestOptions.alertFailure) {
                    DialogUtils.error('操作失败', response.message);
                }
                if (apiRequestOptions.notifyFailure) {
                    StatesUtils.create(StateNames.notify, {
                        level: NotifyLevel.ERROR,
                        title: response.error,
                        message: response.message
                    });
                }
                if (apiRequestOptions.onFailure) {
                    return apiRequestOptions.onFailure.call(requestOptions.context, response, requestOptions);
                }
                return response;
            }
            return response;
        }), first());
    };
    /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} options
     * @return {?}
     */
    ApiUtils.buildUri = /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} options
     * @return {?}
     */
    function (apiEntry, payload, options) {
        /** @type {?} */
        var uri = apiEntry;
        if (CommonsUtils.isTemplateStr(apiEntry)) {
            // apiEntry = CommonsUtils.templateStr(apiEntry, ContextUtils.context());
        }
        if (CommonsUtils.isString(options.uriResolver)) {
            uri = (/** @type {?} */ (options.uriResolver));
        }
        else if (CommonsUtils.isFunction(options.uriResolver)) {
            uri = ((/** @type {?} */ (options.uriResolver))).call(options.context, apiEntry, payload, options);
        }
        else if (!uri) {
            uri = options.uri || '';
        }
        if (!uri.startsWith('http')) {
            /** @type {?} */
            var serverUri = ApiUtils.getPresetApiOptions(options.serverType).uri;
            if (serverUri) {
                uri = serverUri + (uri.startsWith('/') ? uri : '/' + uri);
            }
        }
        return uri;
    };
    /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} options
     * @return {?}
     */
    ApiUtils.buildPayload = /**
     * @private
     * @param {?} apiEntry
     * @param {?} payload
     * @param {?} options
     * @return {?}
     */
    function (apiEntry, payload, options) {
        /** @type {?} */
        var _payload = payload;
        if (CommonsUtils.isJson(_payload)) {
            _payload = CommonsUtils.merge({}, _payload || {}, options.payload || {}, options.body || options.params || {});
        }
        if (options.payloadResolver) {
            _payload = ((/** @type {?} */ (options.payloadResolver))).call(options.context, apiEntry, _payload, options);
        }
        if (CommonsUtils.isString(_payload)) {
            return _payload;
        }
        else if (CommonsUtils.isString(options.body)) {
            return options.body;
        }
        else if (CommonsUtils.isEmpty(_payload)) {
            return undefined;
        }
        _payload = ContextUtils.resolveVariables(_payload);
        _payload = ApiUtils.resolveApiParamsName(options.paramsKeys || ApiUtils.getPresetApiOptions(options.serverType).paramsKeys || {}, _payload);
        if (CommonsUtils.isEmpty(_payload)) {
            return undefined;
        }
        return _payload;
    };
    /**
     * @private
     * @param {?} paramsKeys
     * @param {?} payload
     * @return {?}
     */
    ApiUtils.resolveApiParamsName = /**
     * @private
     * @param {?} paramsKeys
     * @param {?} payload
     * @return {?}
     */
    function (paramsKeys, payload) {
        if (!CommonsUtils.isJson(payload)) {
            return payload;
        }
        /** @type {?} */
        var resolved = {};
        for (var key in payload) {
            if (paramsKeys.hasOwnProperty(key)) {
                resolved[paramsKeys[key]] = payload[key];
            }
            else {
                resolved[key] = payload[key];
            }
        }
        return resolved;
    };
    ApiUtils.presetApiOptions = {};
    return ApiUtils;
}());
export { ApiUtils };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ApiUtils.presetApiOptions;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9hcGkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQThDLGFBQWEsRUFBYyxXQUFXLEVBQVMsVUFBVSxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQ2pJLE9BQU8sRUFBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVyRyxPQUFPLEVBQWEsRUFBRSxFQUFFLEdBQUcsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0QsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUNsQyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sUUFBUSxDQUFDOztBQUVoQyxNQUFNLEtBQU8sMkJBQTJCLEdBQXNCO0lBQzVELGFBQWEsRUFBRSxJQUFJO0NBQ3BCO0FBRUQ7SUFBQTtJQWlYQSxDQUFDOzs7OztJQTVXUSw0QkFBbUI7Ozs7SUFBMUIsVUFBMkIsVUFBVTtRQUVuQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsVUFBVSxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxFQUFFLGFBQWEsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxFQUFFLENBQUM7U0FDM0Y7UUFDRCxRQUFRLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLHdCQUNoQywyQkFBMkIsRUFDM0IsWUFBWSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLEVBQUUsaUJBQWUsVUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUM5RSxDQUFDO1FBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FB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O0lBQW5DLFVBQW9DLFVBQWMsRUFBRSxPQUFPO1FBQ3pELElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2pDLE9BQU8sT0FBTyxDQUFDO1NBQ2hCOztZQUNLLFFBQVEsR0FBRyxFQUFFO1FBQ25CLEtBQUssSUFBTSxHQUFHLElBQUksT0FBTyxFQUFFO1lBQ3pCLElBQUksVUFBVSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDbEMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQztpQkFBTTtnQkFDTCxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzlCO1NBQ0Y7UUFDRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBOVdjLHlCQUFnQixHQUF5QyxFQUFFLENBQUM7SUErVzdFLGVBQUM7Q0FBQSxBQWpYRCxJQWlYQztTQWpYWSxRQUFROzs7Ozs7SUFFbkIsMEJBQTJFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBcGlEYXRhUHJvcHMsIEFwaVBheWxvYWQsIEFwaVJlcXVlc3RPcHRpb25zLCBBcGlTZXJ2ZXJUeXBlLCBEYXRhU291cmNlLCBOb3RpZnlMZXZlbCwgUXVlcnksIFN0YXRlTmFtZXN9IGZyb20gJ0Blci90eXBlcyc7XG5pbXBvcnQge0NvbW1vbnNVdGlscywgQ29uZmlnVXRpbHMsIENvbnRleHRVdGlscywgRGlhbG9nVXRpbHMsIEVzVXRpbHMsIFN0YXRlc1V0aWxzfSBmcm9tICdAZXIvdXRpbHMnO1xuaW1wb3J0IHtSZXF1ZXN0Qm9keVNlYXJjaH0gZnJvbSAnZWxhc3RpYy1idWlsZGVyJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2YsIHppcH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2ZpbHRlciwgZmlyc3QsIG1hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0h0dHBVdGlsc30gZnJvbSAnLi4vaHR0cCc7XG5pbXBvcnQge0xvZ1V0aWxzfSBmcm9tICcuLi9sb2cnO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9BUElfUkVRVUVTVF9PUFRJT05TOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHtcbiAgbm90aWZ5RmFpbHVyZTogdHJ1ZVxufTtcblxuZXhwb3J0IGNsYXNzIEFwaVV0aWxzIHtcblxuICBwcml2YXRlIHN0YXRpYyBwcmVzZXRBcGlPcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IEFwaVJlcXVlc3RPcHRpb25zIH0gPSB7fTtcblxuXG4gIHN0YXRpYyBnZXRQcmVzZXRBcGlPcHRpb25zKHNlcnZlclR5cGUpOiBBcGlSZXF1ZXN0T3B0aW9ucyB7XG5cbiAgICBpZiAoIXNlcnZlclR5cGUpIHtcbiAgICAgIHNlcnZlclR5cGUgPSBDb21tb25zVXRpbHMuZ2V0KENvbmZpZ1V0aWxzLmdldENvbmZpZygpLCAnYXBpLmRlZmF1bHQnKSB8fCBBcGlTZXJ2ZXJUeXBlLkVTO1xuICAgIH1cbiAgICBBcGlVdGlscy5wcmVzZXRBcGlPcHRpb25zW3NlcnZlclR5cGVdID0ge1xuICAgICAgLi4uREVGQVVMVF9BUElfUkVRVUVTVF9PUFRJT05TLFxuICAgICAgLi4uQ29tbW9uc1V0aWxzLmdldChDb25maWdVdGlscy5nZXRDb25maWcoKSwgYGFwaS5zZXJ2ZXJzLiR7c2VydmVyVHlwZX1gLCB7fSlcbiAgICB9O1xuICAgIGlmICghQXBpVXRpbHMucHJlc2V0QXBpT3B0aW9uc1tzZXJ2ZXJUeXBlXS5hY3Rpb25zKSB7XG4gICAgICBBcGlVdGlscy5wcmVzZXRBcGlPcHRpb25zW3NlcnZlclR5cGVdLmFjdGlvbnMgPSB7fTtcbiAgICB9XG4gICAgcmV0dXJuIEFwaVV0aWxzLnByZXNldEFwaU9wdGlvbnNbc2VydmVyVHlwZV07XG4gIH1cblxuICBzdGF0aWMgbG9naW4ocGF5bG9hZDoge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMubG9naW4gfHwge307XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChudWxsLCBwYXlsb2FkLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBsb2dvdXQob3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5sb2dvdXQgfHwge307XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChudWxsLCBudWxsLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBjaGFuZ2VQd2QocGF5bG9hZDoge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMuY2hhbmdlUHdkIHx8IHt9O1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QobnVsbCwgcGF5bG9hZCwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgcmVnaXN0ZXIocGF5bG9hZDoge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMucmVnaXN0ZXIgfHwge307XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChudWxsLCBwYXlsb2FkLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBzYXZlKGFwaUVudHJ5OiBzdHJpbmcsIGRhdGE6IHt9LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgY29uc3QgX2RhdGEgPSB7Li4uZGF0YX07XG4gICAgICBpZiAoX2RhdGFbJ2lkJ10pIHtcbiAgICAgICAgY29uc3QgaWQgPSBfZGF0YVsnaWQnXTtcbiAgICAgICAgZGVsZXRlIF9kYXRhWydpZCddO1xuICAgICAgICByZXR1cm4gQXBpVXRpbHMucGF0Y2hCeUlkLmNhbGwodGhpcywgYXBpRW50cnksIGlkLCBfZGF0YSwgb3B0aW9ucyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gQXBpVXRpbHMuY3JlYXRlLmNhbGwodGhpcywgYXBpRW50cnksIF9kYXRhLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdGF0aWMgY3JlYXRlKGFwaUVudHJ5OiBzdHJpbmcsIGRhdGE6IHt9LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmNyZWF0ZSB8fCB7fTtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIGRhdGEsIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIGdldEJ5SWQoYXBpRW50cnk6IHN0cmluZywgaWQ6IHN0cmluZywgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5nZXRCeUlkIHx8IHt9O1xuICAgIEFwaVV0aWxzLnNldENvbnRleHQob3B0aW9ucywgdGhpcyk7XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChhcGlFbnRyeSwge2lkfSwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgZ2V0QnlJZHMoYXBpRW50cnk6IHN0cmluZywgaWRzOiBzdHJpbmcgfCBzdHJpbmdbXSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5nZXRCeUlkcyB8fCB7fTtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIGlkcywgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgZ2V0QnlRdWVyeShhcGlFbnRyeTogc3RyaW5nLCBwYXlsb2FkPzogQXBpUGF5bG9hZCB8IHN0cmluZyB8IFJlcXVlc3RCb2R5U2VhcmNoLCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmdldEJ5UXVlcnk7XG4gICAgQXBpVXRpbHMuc2V0Q29udGV4dChvcHRpb25zLCB0aGlzKTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KGFwaUVudHJ5LCBwYXlsb2FkLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyB1cGRhdGVCeUlkKGFwaUVudHJ5OiBzdHJpbmcsIGlkOiBzdHJpbmcsIGRhdGE6IHt9LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLnVwZGF0ZUJ5SWQ7XG4gICAgQXBpVXRpbHMuc2V0Q29udGV4dChvcHRpb25zLCB0aGlzKTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KGFwaUVudHJ5LCB7aWQsIC4uLmRhdGF9LCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN0YXRpYyBwYXRjaEJ5SWQoYXBpRW50cnk6IHN0cmluZywgaWQ6IHN0cmluZywgZGF0YToge30sIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBwcmVzZXRBY3Rpb25PcHRpb25zID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLmFjdGlvbnMucGF0Y2hCeUlkO1xuICAgIEFwaVV0aWxzLnNldENvbnRleHQob3B0aW9ucywgdGhpcyk7XG4gICAgcmV0dXJuIEFwaVV0aWxzLmRvUmVxdWVzdChhcGlFbnRyeSwge2lkLCAuLi5kYXRhfSwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgdXBkYXRlQnlRdWVyeShhcGlFbnRyeTogc3RyaW5nLCBxdWVyeTogUXVlcnkgfCBRdWVyeVtdIHwgUmVxdWVzdEJvZHlTZWFyY2gsIGRhdGE6IHt9LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLnVwZGF0ZUJ5UXVlcnk7XG4gICAgQXBpVXRpbHMuc2V0Q29udGV4dChvcHRpb25zLCB0aGlzKTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KGFwaUVudHJ5LCBxdWVyeSwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgZGVsZXRlQnlJZChhcGlFbnRyeTogc3RyaW5nLCBpZDogc3RyaW5nLCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBvYnYgPSBEaWFsb2dVdGlscy5jb25maXJtKCfmk43kvZznoa7orqQnLCAn56Gu6K6k5omn6KGMPGI+5Yig6ZmkPC9iPuaTjeS9nOWQlz8nKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpcnN0KCksXG4gICAgICAgIGZpbHRlcihhY2NlcHQgPT4gYWNjZXB0KSxcbiAgICAgICAgc3dpdGNoTWFwKF8gPT4ge1xuICAgICAgICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5kZWxldGVCeUlkO1xuICAgICAgICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIGlkLCBwcmVzZXRBY3Rpb25PcHRpb25zLCBvcHRpb25zKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgcmV0dXJuIG9idjtcbiAgfVxuXG4gIHN0YXRpYyBkZWxldGVCeVF1ZXJ5KGFwaUVudHJ5OiBzdHJpbmcsIHF1ZXJ5OiBRdWVyeSB8IFJlcXVlc3RCb2R5U2VhcmNoLCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgcHJlc2V0QWN0aW9uT3B0aW9ucyA9IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5hY3Rpb25zLmRlbGV0ZUJ5UXVlcnk7XG4gICAgQXBpVXRpbHMuc2V0Q29udGV4dChvcHRpb25zLCB0aGlzKTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZG9SZXF1ZXN0KGFwaUVudHJ5LCBxdWVyeSwgcHJlc2V0QWN0aW9uT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBzdGF0aWMgYmF0Y2goYXBpRW50cnk6IHN0cmluZywgYm9keSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXNldEFjdGlvbk9wdGlvbnMgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKG9wdGlvbnMuc2VydmVyVHlwZSkuYWN0aW9ucy5iYXRjaDtcbiAgICBBcGlVdGlscy5zZXRDb250ZXh0KG9wdGlvbnMsIHRoaXMpO1xuICAgIHJldHVybiBBcGlVdGlscy5kb1JlcXVlc3QoYXBpRW50cnksIGJvZHksIHByZXNldEFjdGlvbk9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIGJhdGNoRmV0Y2goZGF0YVNvdXJjZTogQXBpRGF0YVByb3BzIHwgQXBpRGF0YVByb3BzW10gfCBEYXRhU291cmNlLCB0YWc/KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoZGF0YVNvdXJjZSkge1xuICAgICAgbGV0IF9hcGlEYXRhUHJvcCA9IGRhdGFTb3VyY2U7XG4gICAgICBpZiAoZGF0YVNvdXJjZVsnYXBpRGF0YVByb3BzJ10pIHtcbiAgICAgICAgX2FwaURhdGFQcm9wID0gZGF0YVNvdXJjZVsnYXBpRGF0YVByb3BzJ107XG4gICAgICB9XG4gICAgICBfYXBpRGF0YVByb3AgPSBDb21tb25zVXRpbHMuY29weShfYXBpRGF0YVByb3ApO1xuICAgICAgY29uc3QgYXBpRGF0YVByb3BzOiBBcGlEYXRhUHJvcHNbXSA9IENvbW1vbnNVdGlscy5nZXRBcnJheVZhbHVlKF9hcGlEYXRhUHJvcCk7XG4gICAgICBpZiAoQ29tbW9uc1V0aWxzLmlzRW1wdHkoYXBpRGF0YVByb3BzKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoIXRhZykge1xuICAgICAgICB0YWcgPSBkYXRhU291cmNlWydpZCddIHx8IGFwaURhdGFQcm9wc1swXS5pZCB8fCAnJztcbiAgICAgIH1cbiAgICAgIGFwaURhdGFQcm9wcy5mb3JFYWNoKGFwaURhdGFQcm9wID0+IHtcbiAgICAgICAgaWYgKGRhdGFTb3VyY2VbJ3F1ZXJ5J10pIHtcbiAgICAgICAgICBjb25zdCBxdWVyeSA9IGRhdGFTb3VyY2VbJ3F1ZXJ5J107XG4gICAgICAgICAgY29uc3QgYXBpUXVlcnkgPSBDb21tb25zVXRpbHMuZ2V0QXJyYXlWYWx1ZShhcGlEYXRhUHJvcC5xdWVyeSB8fCBbXSk7XG4gICAgICAgICAgYXBpUXVlcnkuY29uY2F0KENvbW1vbnNVdGlscy5nZXRBcnJheVZhbHVlKHF1ZXJ5KSk7XG4gICAgICAgICAgYXBpRGF0YVByb3AucXVlcnkgPSBhcGlRdWVyeTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBfZmlsdGVyID0gYXBpRGF0YVByb3AuZmlsdGVyO1xuICAgICAgICBpZiAoQ29tbW9uc1V0aWxzLmlzRnVuY3Rpb24oX2ZpbHRlcikpIHtcbiAgICAgICAgICBpZiAoZGF0YVNvdXJjZVsncXVlcnlWYWx1ZSddKSB7XG4gICAgICAgICAgICBhcGlEYXRhUHJvcC5maWx0ZXIgPSAoYXBpRGF0YVByb3AuZmlsdGVyIGFzIEZ1bmN0aW9uKShkYXRhU291cmNlWydxdWVyeVZhbHVlJ10pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWxldGUgYXBpRGF0YVByb3AuZmlsdGVyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkYXRhU291cmNlWydpbnRlcnZhbCddKSB7XG4gICAgICAgICAgQ29tbW9uc1V0aWxzLnNldCg8e30+YXBpRGF0YVByb3AsICdhZ2dQcm9wcy5pbnRlcnZhbCcsIGRhdGFTb3VyY2VbJ2ludGVydmFsJ10pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhU291cmNlWydmb3JtYXQnXSkge1xuICAgICAgICAgIENvbW1vbnNVdGlscy5zZXQoPHt9PmFwaURhdGFQcm9wLCAnYWdnUHJvcHMuZm9ybWF0JywgZGF0YVNvdXJjZVsnZm9ybWF0J10pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIHJldHVybiBmb3JrSm9pbiguLi5hcGlEYXRhUHJvcHMubWFwKGFwaURhdGFQcm9wID0+IEFwaVV0aWxzLmZldGNoKGFwaURhdGFQcm9wLCB0YWcpKSlcbiAgICAgIC8vICAgLnBpcGUoXG4gICAgICAvLyAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aHJvd0Vycm9yKGVycikpXG4gICAgICAvLyAgICk7XG4gICAgICByZXR1cm4gemlwKC4uLmFwaURhdGFQcm9wcy5tYXAoYXBpRGF0YVByb3AgPT4gQXBpVXRpbHMuZmV0Y2goYXBpRGF0YVByb3AsIHRhZykpKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBtYXAoZGF0YVNldCA9PiB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0TGlzdDtcbiAgICAgICAgICAgIGxldCByZXN1bHRNYXA7XG4gICAgICAgICAgICBkYXRhU2V0LmZvckVhY2goKGRhdGEsIGkpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGFwaURhdGFQcm9wc1tpXS5pZCkge1xuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0TWFwKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRNYXAgPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzdWx0TWFwW2FwaURhdGFQcm9wc1tpXS5pZF0gPSBkYXRhO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0TGlzdCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0TGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bHRMaXN0LnB1c2goZGF0YSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHJlc3VsdExpc3QgJiYgcmVzdWx0TGlzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgcmVzdWx0TGlzdCA9IHJlc3VsdExpc3RbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0TWFwICYmIHJlc3VsdExpc3QpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi5yZXN1bHRNYXAsXG4gICAgICAgICAgICAgICAgZGF0YTogcmVzdWx0TGlzdFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdE1hcCB8fCByZXN1bHRMaXN0IHx8IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGZldGNoKGFwaURhdGFQcm9wczogQXBpRGF0YVByb3BzLCB0YWc/KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoIWFwaURhdGFQcm9wcy5hcGlFbnRyeSkge1xuICAgICAgTG9nVXRpbHMuZXJyb3IoJ2FwaVV0aWwnLCAn5rKh5pyJ5a6a5LmJYXBpRW50cnknKTtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICAgIGxldCBxdWVyeVBheWxvYWQ6IHt9O1xuICAgIGlmIChDb21tb25zVXRpbHMuaXNGdW5jdGlvbihhcGlEYXRhUHJvcHMucGF5bG9hZCkpIHtcbiAgICAgIHF1ZXJ5UGF5bG9hZCA9ICg8RnVuY3Rpb24+YXBpRGF0YVByb3BzLnBheWxvYWQpLmNhbGwodW5kZWZpbmVkLCBhcGlEYXRhUHJvcHMpO1xuICAgIH0gZWxzZSBpZiAoYXBpRGF0YVByb3BzLnBheWxvYWQpIHtcbiAgICAgIHF1ZXJ5UGF5bG9hZCA9IGFwaURhdGFQcm9wcy5wYXlsb2FkO1xuICAgIH1cbiAgICBpZiAoIXF1ZXJ5UGF5bG9hZCkge1xuICAgICAgY29uc3QgcUJvZHkgPSBFc1V0aWxzLmJ1aWxkUXVlcnlCb2R5KGFwaURhdGFQcm9wcyk7XG4gICAgICBxdWVyeVBheWxvYWQgPSBxQm9keTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9ucyA9IGFwaURhdGFQcm9wcy5yZXF1ZXN0T3B0aW9ucyB8fCB7fTtcbiAgICBpZiAoIW9wdGlvbnMudGFnKSB7XG4gICAgICBvcHRpb25zLnRhZyA9IHRhZyB8fCAnJztcbiAgICB9XG4gICAgTG9nVXRpbHMuZGVidWcoJ2FwaVV0aWxzJywgJ2FwaURhdGHmlbDmja7mn6Xor6InLCB7YXBpRGF0YVByb3BzOiBhcGlEYXRhUHJvcHMsIGFwaVJlcXVlc3RCb2R5OiBxdWVyeVBheWxvYWR9KTtcbiAgICByZXR1cm4gQXBpVXRpbHMuZ2V0QnlRdWVyeShhcGlEYXRhUHJvcHMuYXBpRW50cnksIHF1ZXJ5UGF5bG9hZCwgb3B0aW9ucylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZGF0YSA9PiB7XG4gICAgICAgICAgbGV0IGFnZ3M7XG4gICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5hZ2dzKSB7XG4gICAgICAgICAgICBhZ2dzID0gRXNVdGlscy5yZXNvbHZlQWdncyhkYXRhLmFnZ3MpO1xuICAgICAgICAgICAgZGF0YS5hZ2dzID0gYWdncztcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKENvbW1vbnNVdGlscy5pc0VtcHR5KGRhdGEuaXRlbXMpKSB7XG4gICAgICAgICAgICBkZWxldGUgZGF0YS5pdGVtcztcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKENvbW1vbnNVdGlscy5pc0VtcHR5KGRhdGEuYWdncykpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmFnZ3M7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxldCBwYXRoID0gYXBpRGF0YVByb3BzLmRhdGFQYXRoIHx8IChhcGlEYXRhUHJvcHMuYWdnUHJvcHMgPyAnYWdncycgOiB1bmRlZmluZWQpO1xuICAgICAgICAgIGlmIChwYXRoID09PSAnLycpIHtcbiAgICAgICAgICAgIHBhdGggPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBwYXRoID8gQ29tbW9uc1V0aWxzLmdldChkYXRhLCBwYXRoKSA6IGRhdGE7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgc2V0Q29udGV4dChvcHRpb25zLCBjb250ZXh0KSB7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgb3B0aW9ucy5jb250ZXh0ID0gY29udGV4dDtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGRvUmVxdWVzdChhcGlFbnRyeTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogYW55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2V0QWN0aW9uT3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25PcHRpb25zPzogQXBpUmVxdWVzdE9wdGlvbnMpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGFwaVJlcXVlc3RPcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHtcbiAgICAgIC4uLnByZXNldEFjdGlvbk9wdGlvbnMsXG4gICAgICAuLi5hY3Rpb25PcHRpb25zXG4gICAgfTtcbiAgICBkZWxldGUgYXBpUmVxdWVzdE9wdGlvbnMuYWN0aW9ucztcbiAgICBjb25zdCByZXF1ZXN0UGF5bG9hZCA9IHBheWxvYWQ7XG4gICAgY29uc3QgcmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICAuLi5hcGlSZXF1ZXN0T3B0aW9ucyxcbiAgICAgIHVyaTogQXBpVXRpbHMuYnVpbGRVcmkoYXBpRW50cnksIHJlcXVlc3RQYXlsb2FkLCBhcGlSZXF1ZXN0T3B0aW9ucyksXG4gICAgICBwYXlsb2FkOiBBcGlVdGlscy5idWlsZFBheWxvYWQoYXBpRW50cnksIHJlcXVlc3RQYXlsb2FkLCBhcGlSZXF1ZXN0T3B0aW9ucylcbiAgICB9O1xuICAgIGRlbGV0ZSByZXF1ZXN0T3B0aW9ucy5wYXJhbXNLZXlzO1xuICAgIGRlbGV0ZSByZXF1ZXN0T3B0aW9ucy51cmlSZXNvbHZlcjtcbiAgICBkZWxldGUgcmVxdWVzdE9wdGlvbnMucGF5bG9hZFJlc29sdmVyO1xuICAgIGlmICghcmVxdWVzdE9wdGlvbnMudXJpIHx8ICFyZXF1ZXN0T3B0aW9ucy51cmkuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICBjb25zdCBhcGlTZXJ2ZXIgPSBBcGlVdGlscy5nZXRQcmVzZXRBcGlPcHRpb25zKHByZXNldEFjdGlvbk9wdGlvbnMuc2VydmVyVHlwZSkudXJpIHx8ICcnO1xuICAgICAgcmVxdWVzdE9wdGlvbnMudXJpID0gYXBpU2VydmVyICsgKHJlcXVlc3RPcHRpb25zLnVyaS5zdGFydHNXaXRoKCcvJykgPyAnJyA6ICcvJykgKyByZXF1ZXN0T3B0aW9ucy51cmk7XG4gICAgfVxuICAgIHJldHVybiBIdHRwVXRpbHMucmVxdWVzdChyZXF1ZXN0T3B0aW9ucylcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIocmVzcG9uc2UgPT4gISFyZXNwb25zZSksXG4gICAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgPT09IHRydWUpIHtcbiAgICAgICAgICAgIGlmIChhcGlSZXF1ZXN0T3B0aW9ucy5hbGVydFN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgRGlhbG9nVXRpbHMuaW5mbygn5pON5L2c5a6M5oiQJywgYXBpUmVxdWVzdE9wdGlvbnMuc3VjY2Vzc01lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwaVJlcXVlc3RPcHRpb25zLm5vdGlmeVN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgU3RhdGVzVXRpbHMuY3JlYXRlKFN0YXRlTmFtZXMubm90aWZ5LCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6ICfmk43kvZzlrozmiJAnLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGFwaVJlcXVlc3RPcHRpb25zLnN1Y2Nlc3NNZXNzYWdlXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwaVJlcXVlc3RPcHRpb25zLm9uU3VjY2Vzcykge1xuICAgICAgICAgICAgICByZXR1cm4gYXBpUmVxdWVzdE9wdGlvbnMub25TdWNjZXNzLmNhbGwocmVxdWVzdE9wdGlvbnMuY29udGV4dCwgcmVzcG9uc2UsIHJlcXVlc3RPcHRpb25zKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChhcGlSZXF1ZXN0T3B0aW9ucy5kYXRhUGF0aCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBDb21tb25zVXRpbHMuZ2V0KHJlc3BvbnNlLmNvbnRlbnQsIGFwaVJlcXVlc3RPcHRpb25zLmRhdGFQYXRoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuY29udGVudCB8fCByZXNwb25zZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKCFyZXNwb25zZS5zdWNjZXNzID09PSBmYWxzZSkge1xuICAgICAgICAgICAgaWYgKGFwaVJlcXVlc3RPcHRpb25zLmFsZXJ0RmFpbHVyZSkge1xuICAgICAgICAgICAgICBEaWFsb2dVdGlscy5lcnJvcign5pON5L2c5aSx6LSlJywgcmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBpUmVxdWVzdE9wdGlvbnMubm90aWZ5RmFpbHVyZSkge1xuICAgICAgICAgICAgICBTdGF0ZXNVdGlscy5jcmVhdGUoU3RhdGVOYW1lcy5ub3RpZnksIHtcbiAgICAgICAgICAgICAgICBsZXZlbDogTm90aWZ5TGV2ZWwuRVJST1IsXG4gICAgICAgICAgICAgICAgdGl0bGU6IHJlc3BvbnNlLmVycm9yLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHJlc3BvbnNlLm1lc3NhZ2VcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBpUmVxdWVzdE9wdGlvbnMub25GYWlsdXJlKSB7XG4gICAgICAgICAgICAgIHJldHVybiBhcGlSZXF1ZXN0T3B0aW9ucy5vbkZhaWx1cmUuY2FsbChyZXF1ZXN0T3B0aW9ucy5jb250ZXh0LCByZXNwb25zZSwgcmVxdWVzdE9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgIH0pLFxuICAgICAgICBmaXJzdCgpXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgYnVpbGRVcmkoYXBpRW50cnk6IHN0cmluZywgcGF5bG9hZDogYW55LCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucykge1xuICAgIGxldCB1cmkgPSBhcGlFbnRyeTtcbiAgICBpZiAoQ29tbW9uc1V0aWxzLmlzVGVtcGxhdGVTdHIoYXBpRW50cnkpKSB7XG4gICAgICAvLyBhcGlFbnRyeSA9IENvbW1vbnNVdGlscy50ZW1wbGF0ZVN0cihhcGlFbnRyeSwgQ29udGV4dFV0aWxzLmNvbnRleHQoKSk7XG4gICAgfVxuICAgIGlmIChDb21tb25zVXRpbHMuaXNTdHJpbmcob3B0aW9ucy51cmlSZXNvbHZlcikpIHtcbiAgICAgIHVyaSA9IG9wdGlvbnMudXJpUmVzb2x2ZXIgYXMgc3RyaW5nO1xuICAgIH0gZWxzZSBpZiAoQ29tbW9uc1V0aWxzLmlzRnVuY3Rpb24ob3B0aW9ucy51cmlSZXNvbHZlcikpIHtcbiAgICAgIHVyaSA9IChvcHRpb25zLnVyaVJlc29sdmVyIGFzIEZ1bmN0aW9uKS5jYWxsKG9wdGlvbnMuY29udGV4dCwgYXBpRW50cnksIHBheWxvYWQsIG9wdGlvbnMpO1xuICAgIH0gZWxzZSBpZiAoIXVyaSkge1xuICAgICAgdXJpID0gb3B0aW9ucy51cmkgfHwgJyc7XG4gICAgfVxuICAgIGlmICghdXJpLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgY29uc3Qgc2VydmVyVXJpID0gQXBpVXRpbHMuZ2V0UHJlc2V0QXBpT3B0aW9ucyhvcHRpb25zLnNlcnZlclR5cGUpLnVyaTtcbiAgICAgIGlmIChzZXJ2ZXJVcmkpIHtcbiAgICAgICAgdXJpID0gc2VydmVyVXJpICsgKHVyaS5zdGFydHNXaXRoKCcvJykgPyB1cmkgOiAnLycgKyB1cmkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdXJpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgYnVpbGRQYXlsb2FkKGFwaUVudHJ5OiBzdHJpbmcsIHBheWxvYWQ6IGFueSwgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMpOiB7fSB7XG4gICAgbGV0IF9wYXlsb2FkID0gcGF5bG9hZDtcbiAgICBpZiAoQ29tbW9uc1V0aWxzLmlzSnNvbihfcGF5bG9hZCkpIHtcbiAgICAgIF9wYXlsb2FkID0gQ29tbW9uc1V0aWxzLm1lcmdlKHt9LCBfcGF5bG9hZCB8fCB7fSwgb3B0aW9ucy5wYXlsb2FkIHx8IHt9LCBvcHRpb25zLmJvZHkgfHwgb3B0aW9ucy5wYXJhbXMgfHwge30pO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5wYXlsb2FkUmVzb2x2ZXIpIHtcbiAgICAgIF9wYXlsb2FkID0gKG9wdGlvbnMucGF5bG9hZFJlc29sdmVyIGFzIEZ1bmN0aW9uKS5jYWxsKG9wdGlvbnMuY29udGV4dCwgYXBpRW50cnksIF9wYXlsb2FkLCBvcHRpb25zKTtcbiAgICB9XG4gICAgaWYgKENvbW1vbnNVdGlscy5pc1N0cmluZyhfcGF5bG9hZCkpIHtcbiAgICAgIHJldHVybiBfcGF5bG9hZDtcbiAgICB9IGVsc2UgaWYgKENvbW1vbnNVdGlscy5pc1N0cmluZyhvcHRpb25zLmJvZHkpKSB7XG4gICAgICByZXR1cm4gb3B0aW9ucy5ib2R5O1xuICAgIH0gZWxzZSBpZiAoQ29tbW9uc1V0aWxzLmlzRW1wdHkoX3BheWxvYWQpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBfcGF5bG9hZCA9IENvbnRleHRVdGlscy5yZXNvbHZlVmFyaWFibGVzKF9wYXlsb2FkKTtcbiAgICBfcGF5bG9hZCA9IEFwaVV0aWxzLnJlc29sdmVBcGlQYXJhbXNOYW1lKFxuICAgICAgb3B0aW9ucy5wYXJhbXNLZXlzIHx8IEFwaVV0aWxzLmdldFByZXNldEFwaU9wdGlvbnMob3B0aW9ucy5zZXJ2ZXJUeXBlKS5wYXJhbXNLZXlzIHx8IHt9LFxuICAgICAgX3BheWxvYWQpO1xuICAgIGlmIChDb21tb25zVXRpbHMuaXNFbXB0eShfcGF5bG9hZCkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHJldHVybiBfcGF5bG9hZDtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHJlc29sdmVBcGlQYXJhbXNOYW1lKHBhcmFtc0tleXM6IHt9LCBwYXlsb2FkKSB7XG4gICAgaWYgKCFDb21tb25zVXRpbHMuaXNKc29uKHBheWxvYWQpKSB7XG4gICAgICByZXR1cm4gcGF5bG9hZDtcbiAgICB9XG4gICAgY29uc3QgcmVzb2x2ZWQgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBwYXlsb2FkKSB7XG4gICAgICBpZiAocGFyYW1zS2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIHJlc29sdmVkW3BhcmFtc0tleXNba2V5XV0gPSBwYXlsb2FkW2tleV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlZFtrZXldID0gcGF5bG9hZFtrZXldO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gIH1cbn1cblxuIl19