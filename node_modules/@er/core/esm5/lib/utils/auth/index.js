/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { StateNames } from '@er/types';
import { CommonsUtils, ConfigUtils, JwtUtils, StatesUtils } from '@er/utils';
import { filter, tap } from 'rxjs/operators';
import { ApiUtils } from '../api';
import { RouteUtils } from '../nav';
import { PermissionUtils } from '../permission';
/**
 * @param {?} route
 * @param {?} state
 * @return {?}
 */
export function anyRoleUser(route, state) {
    if (AuthUtils.getCurrentUser().roles) {
        return AuthUtils.getCurrentUser().roles;
    }
    else {
        return 'NO_ROLE_USER';
    }
}
var AuthUtils = /** @class */ (function () {
    function AuthUtils() {
    }
    /**
     * @param {?} payLoad
     * @param {?=} isRememberMe
     * @return {?}
     */
    AuthUtils.login = /**
     * @param {?} payLoad
     * @param {?=} isRememberMe
     * @return {?}
     */
    function (payLoad, isRememberMe) {
        /** @type {?} */
        var login$ = ApiUtils.login(tslib_1.__assign({}, payLoad, { rememberMe: isRememberMe }), tslib_1.__assign({}, ConfigUtils.getConfig().auth.loginApiOptions || {}, { tag: StateNames.auth }))
            .pipe(filter(function (loginUser) { return !!loginUser; }), tap(function (loginUser) {
            if (loginUser.jwtToken) {
                if (ConfigUtils.getConfig().auth.getUserInfo) {
                    ConfigUtils.getConfig().auth.getUserInfo(loginUser)
                        .subscribe(function (userInfo) {
                        /** @type {?} */
                        var user = tslib_1.__assign({}, loginUser, userInfo);
                        AuthUtils.onLoginSuccess(user, isRememberMe);
                    });
                }
                else {
                    AuthUtils.onLoginSuccess(loginUser, isRememberMe);
                }
            }
        }));
        return login$;
    };
    /**
     * @param {?} payLoad
     * @return {?}
     */
    AuthUtils.register = /**
     * @param {?} payLoad
     * @return {?}
     */
    function (payLoad) {
        /** @type {?} */
        var reg$ = ApiUtils.register(payLoad, tslib_1.__assign({}, ConfigUtils.getConfig().auth.registerApiOptions || ConfigUtils.getConfig().auth.loginApiOptions, { tag: StateNames.auth }));
        return reg$;
    };
    /**
     * @return {?}
     */
    AuthUtils.logout = /**
     * @return {?}
     */
    function () {
        ApiUtils.logout(tslib_1.__assign({}, ConfigUtils.getConfig().auth.logoutApiOptions || ConfigUtils.getConfig().auth.loginApiOptions, { tag: StateNames.auth }))
            .subscribe(function (success) {
            if (success) {
                AuthUtils.updateUser({});
                PermissionUtils.clearRoles();
                PermissionUtils.clearPermission();
                /** @type {?} */
                var url = ConfigUtils.getConfig().auth.logoutSuccessRouter;
                RouteUtils.nav(url);
            }
        });
    };
    /**
     * @param {?} payload
     * @return {?}
     */
    AuthUtils.changePwd = /**
     * @param {?} payload
     * @return {?}
     */
    function (payload) {
        /** @type {?} */
        var pwd$ = ApiUtils.changePwd(payload, tslib_1.__assign({}, ConfigUtils.getConfig().auth.changePwdApiOptions || ConfigUtils.getConfig().auth.loginApiOptions, { tag: StateNames.auth }));
        return pwd$;
    };
    /**
     * @return {?}
     */
    AuthUtils.getCurrentUser = /**
     * @return {?}
     */
    function () {
        if (AuthUtils.CURRENT_USER) {
            return AuthUtils.CURRENT_USER || {};
        }
        /** @type {?} */
        var storageKey = ConfigUtils.getConfig().auth.storageKey;
        /** @type {?} */
        var user = (/** @type {?} */ ((JSON.parse(sessionStorage.getItem(storageKey)))));
        if (!user) {
            user = (/** @type {?} */ ((JSON.parse(localStorage.getItem(storageKey)))));
        }
        if (user && user.isSu) {
            user.isAdmin = true;
        }
        AuthUtils.CURRENT_USER = user;
        return AuthUtils.CURRENT_USER || {};
    };
    /**
     * @param {?} patch
     * @param {?=} remeber
     * @return {?}
     */
    AuthUtils.updateUser = /**
     * @param {?} patch
     * @param {?=} remeber
     * @return {?}
     */
    function (patch, remeber) {
        if (!CommonsUtils.isEmpty(patch)) {
            AuthUtils.CURRENT_USER = tslib_1.__assign({}, AuthUtils.CURRENT_USER, patch);
        }
        else {
            AuthUtils.CURRENT_USER = {};
        }
        StatesUtils.update(StateNames.user, AuthUtils.CURRENT_USER);
        /** @type {?} */
        var storageKey = ConfigUtils.getConfig().auth.storageKey;
        sessionStorage.setItem(storageKey, JSON.stringify(AuthUtils.CURRENT_USER));
        if (remeber) {
            if (!CommonsUtils.isEmpty(AuthUtils.CURRENT_USER)) {
                localStorage.setItem(storageKey, JSON.stringify(AuthUtils.CURRENT_USER));
            }
            else {
                localStorage.removeItem(storageKey);
            }
        }
    };
    /**
     * @param {?} returnUrl
     * @return {?}
     */
    AuthUtils.checkLogin = /**
     * @param {?} returnUrl
     * @return {?}
     */
    function (returnUrl) {
        /** @type {?} */
        var currentUser = AuthUtils.getCurrentUser();
        if (currentUser.jwtToken && JwtUtils.isValid(currentUser.jwtToken)) {
            return true;
        }
        else {
            if (true === StatesUtils.getValue(StateNames.auth, 'dialog')) {
                StatesUtils.update(StateNames.popup, {
                    content: ConfigUtils.getConfig().auth.component,
                    header: ConfigUtils.getConfig().auth.title,
                    visible: true,
                    minWidth: 500,
                    minHeight: 300,
                    contentMaxWidth: 500,
                    contentMaxHeight: 300
                });
            }
            else {
                /** @type {?} */
                var loginRouter = ConfigUtils.getConfig().auth.loginRouter;
                StatesUtils.update(StateNames.auth, { successUrl: returnUrl });
                RouteUtils.nav(loginRouter);
            }
            return false;
        }
    };
    /**
     * @private
     * @param {?} user
     * @param {?} isRememberMe
     * @return {?}
     */
    AuthUtils.onLoginSuccess = /**
     * @private
     * @param {?} user
     * @param {?} isRememberMe
     * @return {?}
     */
    function (user, isRememberMe) {
        if (ConfigUtils.getConfig().auth.onLoginSuccess) {
            ConfigUtils.getConfig().auth.onLoginSuccess(user);
        }
        user.enabled = true;
        AuthUtils.updateUser(user, isRememberMe);
        PermissionUtils.addRoles(user.roles);
        if (ConfigUtils.getConfig().auth.defaultRules) {
            PermissionUtils.addRoles(ConfigUtils.getConfig().auth.defaultRules);
        }
        PermissionUtils.addPermissions(user.permissions || []);
        /** @type {?} */
        var key = ConfigUtils.getConfig().auth.requiredUserProps;
        if (key) {
            if (!CommonsUtils.get(user, key)) {
                RouteUtils.nav(ConfigUtils.getConfig().auth.failedPropsRouter);
            }
            else {
                /** @type {?} */
                var successUrl = ConfigUtils.getConfig().auth.loginSuccessRouter;
                RouteUtils.nav(successUrl);
            }
        }
        else {
            /** @type {?} */
            var successUrl = ConfigUtils.getConfig().auth.loginSuccessRouter;
            RouteUtils.nav(successUrl);
        }
    };
    AuthUtils.CURRENT_USER = null;
    return AuthUtils;
}());
export { AuthUtils };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AuthUtils.CURRENT_USER;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9hdXRoL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFDLFVBQVUsRUFBTyxNQUFNLFdBQVcsQ0FBQztBQUMzQyxPQUFPLEVBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBRTNFLE9BQU8sRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLFFBQVEsQ0FBQztBQUNoQyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sUUFBUSxDQUFDO0FBQ2xDLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxlQUFlLENBQUM7Ozs7OztBQUU5QyxNQUFNLFVBQVUsV0FBVyxDQUFDLEtBQTZCLEVBQUUsS0FBMEI7SUFDbkYsSUFBSSxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUMsS0FBSyxFQUFFO1FBQ3BDLE9BQU8sU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssQ0FBQztLQUN6QztTQUFNO1FBQ0wsT0FBTyxjQUFjLENBQUM7S0FDdkI7QUFDSCxDQUFDO0FBRUQ7SUFBQTtJQXlKQSxDQUFDOzs7Ozs7SUFySlEsZUFBSzs7Ozs7SUFBWixVQUFhLE9BQVcsRUFBRSxZQUFzQjs7WUFDeEMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxLQUFLLHNCQUN4QixPQUFPLElBQ1YsVUFBVSxFQUFFLFlBQVksMEJBRXJCLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLEVBQUUsSUFDckQsR0FBRyxFQUFFLFVBQVUsQ0FBQyxJQUFJLElBQ3BCO2FBQ0MsSUFBSSxDQUNILE1BQU0sQ0FBQyxVQUFBLFNBQVMsSUFBSSxPQUFBLENBQUMsQ0FBQyxTQUFTLEVBQVgsQ0FBVyxDQUFD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QyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDekMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckMsSUFBSSxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUM3QyxlQUFlLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDckU7UUFDRCxlQUFlLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDLENBQUM7O1lBQ2pELEdBQUcsR0FBRyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQjtRQUMxRCxJQUFJLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDaEMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7YUFDaEU7aUJBQU07O29CQUNDLFVBQVUsR0FBRyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQjtnQkFDbEUsVUFBVSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUM1QjtTQUNGO2FBQU07O2dCQUNDLFVBQVUsR0FBRyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQjtZQUNsRSxVQUFVLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzVCO0lBQ0gsQ0FBQztJQXRKYyxzQkFBWSxHQUFTLElBQUksQ0FBQztJQXVKM0MsZ0JBQUM7Q0FBQSxBQXpKRCxJQXlKQztTQXpKWSxTQUFTOzs7Ozs7SUFFcEIsdUJBQXlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBSb3V0ZXJTdGF0ZVNuYXBzaG90fSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHtTdGF0ZU5hbWVzLCBVc2VyfSBmcm9tICdAZXIvdHlwZXMnO1xuaW1wb3J0IHtDb21tb25zVXRpbHMsIENvbmZpZ1V0aWxzLCBKd3RVdGlscywgU3RhdGVzVXRpbHN9IGZyb20gJ0Blci91dGlscyc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmaWx0ZXIsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtBcGlVdGlsc30gZnJvbSAnLi4vYXBpJztcbmltcG9ydCB7Um91dGVVdGlsc30gZnJvbSAnLi4vbmF2JztcbmltcG9ydCB7UGVybWlzc2lvblV0aWxzfSBmcm9tICcuLi9wZXJtaXNzaW9uJztcblxuZXhwb3J0IGZ1bmN0aW9uIGFueVJvbGVVc2VyKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdCkge1xuICBpZiAoQXV0aFV0aWxzLmdldEN1cnJlbnRVc2VyKCkucm9sZXMpIHtcbiAgICByZXR1cm4gQXV0aFV0aWxzLmdldEN1cnJlbnRVc2VyKCkucm9sZXM7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuICdOT19ST0xFX1VTRVInO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBdXRoVXRpbHMge1xuXG4gIHByaXZhdGUgc3RhdGljIENVUlJFTlRfVVNFUjogVXNlciA9IG51bGw7XG5cbiAgc3RhdGljIGxvZ2luKHBheUxvYWQ6IHt9LCBpc1JlbWVtYmVyTWU/OiBib29sZWFuKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBsb2dpbiQgPSBBcGlVdGlscy5sb2dpbih7XG4gICAgICAuLi5wYXlMb2FkLFxuICAgICAgcmVtZW1iZXJNZTogaXNSZW1lbWJlck1lXG4gICAgfSwge1xuICAgICAgLi4uQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXV0aC5sb2dpbkFwaU9wdGlvbnMgfHwge30sXG4gICAgICB0YWc6IFN0YXRlTmFtZXMuYXV0aFxuICAgIH0pXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKGxvZ2luVXNlciA9PiAhIWxvZ2luVXNlciksXG4gICAgICAgIHRhcChsb2dpblVzZXIgPT4ge1xuICAgICAgICAgIGlmIChsb2dpblVzZXIuand0VG9rZW4pIHtcbiAgICAgICAgICAgIGlmIChDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmdldFVzZXJJbmZvKSB7XG4gICAgICAgICAgICAgIENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmF1dGguZ2V0VXNlckluZm8obG9naW5Vc2VyKVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUodXNlckluZm8gPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4ubG9naW5Vc2VyLFxuICAgICAgICAgICAgICAgICAgICAuLi51c2VySW5mb1xuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgIEF1dGhVdGlscy5vbkxvZ2luU3VjY2Vzcyh1c2VyLCBpc1JlbWVtYmVyTWUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgQXV0aFV0aWxzLm9uTG9naW5TdWNjZXNzKGxvZ2luVXNlciwgaXNSZW1lbWJlck1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIHJldHVybiBsb2dpbiQ7XG4gIH1cblxuICBzdGF0aWMgcmVnaXN0ZXIocGF5TG9hZDoge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJlZyQgPSBBcGlVdGlscy5yZWdpc3RlcihwYXlMb2FkLCB7XG4gICAgICAuLi5Db25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLnJlZ2lzdGVyQXBpT3B0aW9ucyB8fCBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmxvZ2luQXBpT3B0aW9ucyxcbiAgICAgIHRhZzogU3RhdGVOYW1lcy5hdXRoXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlZyQ7XG4gIH1cblxuICBzdGF0aWMgbG9nb3V0KCkge1xuICAgIEFwaVV0aWxzLmxvZ291dCh7XG4gICAgICAuLi5Db25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmxvZ291dEFwaU9wdGlvbnMgfHwgQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXV0aC5sb2dpbkFwaU9wdGlvbnMsXG4gICAgICB0YWc6IFN0YXRlTmFtZXMuYXV0aFxuICAgIH0pXG4gICAgICAuc3Vic2NyaWJlKHN1Y2Nlc3MgPT4ge1xuICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgIEF1dGhVdGlscy51cGRhdGVVc2VyKHt9KTtcbiAgICAgICAgICBQZXJtaXNzaW9uVXRpbHMuY2xlYXJSb2xlcygpO1xuICAgICAgICAgIFBlcm1pc3Npb25VdGlscy5jbGVhclBlcm1pc3Npb24oKTtcbiAgICAgICAgICBjb25zdCB1cmwgPSBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmxvZ291dFN1Y2Nlc3NSb3V0ZXI7XG4gICAgICAgICAgUm91dGVVdGlscy5uYXYodXJsKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBzdGF0aWMgY2hhbmdlUHdkKHBheWxvYWQpIHtcbiAgICBjb25zdCBwd2QkID0gQXBpVXRpbHMuY2hhbmdlUHdkKHBheWxvYWQsIHtcbiAgICAgIC4uLkNvbmZpZ1V0aWxzLmdldENvbmZpZygpLmF1dGguY2hhbmdlUHdkQXBpT3B0aW9ucyB8fCBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmxvZ2luQXBpT3B0aW9ucyxcbiAgICAgIHRhZzogU3RhdGVOYW1lcy5hdXRoXG4gICAgfSk7XG4gICAgcmV0dXJuIHB3ZCQ7XG4gIH1cblxuICBzdGF0aWMgZ2V0Q3VycmVudFVzZXIoKTogVXNlciB7XG4gICAgaWYgKEF1dGhVdGlscy5DVVJSRU5UX1VTRVIpIHtcbiAgICAgIHJldHVybiBBdXRoVXRpbHMuQ1VSUkVOVF9VU0VSIHx8IHt9O1xuICAgIH1cbiAgICBjb25zdCBzdG9yYWdlS2V5ID0gQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXV0aC5zdG9yYWdlS2V5O1xuICAgIGxldCB1c2VyID0gKEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShzdG9yYWdlS2V5KSkpIGFzIFVzZXI7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB1c2VyID0gKEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oc3RvcmFnZUtleSkpKSBhcyBVc2VyO1xuICAgIH1cbiAgICBpZiAodXNlciAmJiB1c2VyLmlzU3UpIHtcbiAgICAgIHVzZXIuaXNBZG1pbiA9IHRydWU7XG4gICAgfVxuICAgIEF1dGhVdGlscy5DVVJSRU5UX1VTRVIgPSB1c2VyO1xuICAgIHJldHVybiBBdXRoVXRpbHMuQ1VSUkVOVF9VU0VSIHx8IHt9O1xuICB9XG5cbiAgc3RhdGljIHVwZGF0ZVVzZXIocGF0Y2g6IFVzZXIsIHJlbWViZXI/OiBib29sZWFuKSB7XG4gICAgaWYgKCFDb21tb25zVXRpbHMuaXNFbXB0eShwYXRjaCkpIHtcbiAgICAgIEF1dGhVdGlscy5DVVJSRU5UX1VTRVIgPSB7XG4gICAgICAgIC4uLkF1dGhVdGlscy5DVVJSRU5UX1VTRVIsXG4gICAgICAgIC4uLnBhdGNoXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBBdXRoVXRpbHMuQ1VSUkVOVF9VU0VSID0ge307XG4gICAgfVxuICAgIFN0YXRlc1V0aWxzLnVwZGF0ZShTdGF0ZU5hbWVzLnVzZXIsIEF1dGhVdGlscy5DVVJSRU5UX1VTRVIpO1xuICAgIGNvbnN0IHN0b3JhZ2VLZXkgPSBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLnN0b3JhZ2VLZXk7XG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShzdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShBdXRoVXRpbHMuQ1VSUkVOVF9VU0VSKSk7XG4gICAgaWYgKHJlbWViZXIpIHtcbiAgICAgIGlmICghQ29tbW9uc1V0aWxzLmlzRW1wdHkoQXV0aFV0aWxzLkNVUlJFTlRfVVNFUikpIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oc3RvcmFnZUtleSwgSlNPTi5zdHJpbmdpZnkoQXV0aFV0aWxzLkNVUlJFTlRfVVNFUikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oc3RvcmFnZUtleSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGNoZWNrTG9naW4ocmV0dXJuVXJsOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IGN1cnJlbnRVc2VyOiBVc2VyID0gQXV0aFV0aWxzLmdldEN1cnJlbnRVc2VyKCk7XG5cbiAgICBpZiAoY3VycmVudFVzZXIuand0VG9rZW4gJiYgSnd0VXRpbHMuaXNWYWxpZChjdXJyZW50VXNlci5qd3RUb2tlbikpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodHJ1ZSA9PT0gU3RhdGVzVXRpbHMuZ2V0VmFsdWUoU3RhdGVOYW1lcy5hdXRoLCAnZGlhbG9nJykpIHtcbiAgICAgICAgU3RhdGVzVXRpbHMudXBkYXRlKFN0YXRlTmFtZXMucG9wdXAsIHtcbiAgICAgICAgICBjb250ZW50OiBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmNvbXBvbmVudCxcbiAgICAgICAgICBoZWFkZXI6IENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmF1dGgudGl0bGUsXG4gICAgICAgICAgdmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgICBtaW5XaWR0aDogNTAwLFxuICAgICAgICAgIG1pbkhlaWdodDogMzAwLFxuICAgICAgICAgIGNvbnRlbnRNYXhXaWR0aDogNTAwLFxuICAgICAgICAgIGNvbnRlbnRNYXhIZWlnaHQ6IDMwMFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGxvZ2luUm91dGVyID0gQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXV0aC5sb2dpblJvdXRlcjtcbiAgICAgICAgU3RhdGVzVXRpbHMudXBkYXRlKFN0YXRlTmFtZXMuYXV0aCwge3N1Y2Nlc3NVcmw6IHJldHVyblVybH0pO1xuICAgICAgICBSb3V0ZVV0aWxzLm5hdihsb2dpblJvdXRlcik7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgb25Mb2dpblN1Y2Nlc3ModXNlciwgaXNSZW1lbWJlck1lKSB7XG4gICAgaWYgKENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmF1dGgub25Mb2dpblN1Y2Nlc3MpIHtcbiAgICAgIENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmF1dGgub25Mb2dpblN1Y2Nlc3ModXNlcik7XG4gICAgfVxuICAgIHVzZXIuZW5hYmxlZCA9IHRydWU7XG4gICAgQXV0aFV0aWxzLnVwZGF0ZVVzZXIodXNlciwgaXNSZW1lbWJlck1lKTtcbiAgICBQZXJtaXNzaW9uVXRpbHMuYWRkUm9sZXModXNlci5yb2xlcyk7XG4gICAgaWYgKENvbmZpZ1V0aWxzLmdldENvbmZpZygpLmF1dGguZGVmYXVsdFJ1bGVzKSB7XG4gICAgICBQZXJtaXNzaW9uVXRpbHMuYWRkUm9sZXMoQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXV0aC5kZWZhdWx0UnVsZXMpO1xuICAgIH1cbiAgICBQZXJtaXNzaW9uVXRpbHMuYWRkUGVybWlzc2lvbnModXNlci5wZXJtaXNzaW9ucyB8fCBbXSk7XG4gICAgY29uc3Qga2V5ID0gQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXV0aC5yZXF1aXJlZFVzZXJQcm9wcztcbiAgICBpZiAoa2V5KSB7XG4gICAgICBpZiAoIUNvbW1vbnNVdGlscy5nZXQodXNlciwga2V5KSkge1xuICAgICAgICBSb3V0ZVV0aWxzLm5hdihDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmZhaWxlZFByb3BzUm91dGVyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NVcmwgPSBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmxvZ2luU3VjY2Vzc1JvdXRlcjtcbiAgICAgICAgUm91dGVVdGlscy5uYXYoc3VjY2Vzc1VybCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3NVcmwgPSBDb25maWdVdGlscy5nZXRDb25maWcoKS5hdXRoLmxvZ2luU3VjY2Vzc1JvdXRlcjtcbiAgICAgIFJvdXRlVXRpbHMubmF2KHN1Y2Nlc3NVcmwpO1xuICAgIH1cbiAgfVxufVxuIl19