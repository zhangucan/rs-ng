/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { HttpClient, HttpEventType, HttpHeaders, HttpParams, HttpRequest } from '@angular/common/http';
import { HttpContentType, HttpMethod, HttpRequestPayloadType, HttpResponseType, StateNames } from '@er/types';
import { CommonsUtils, ConfigUtils, RxUtils, StatesUtils } from '@er/utils';
import { of } from 'rxjs';
import { catchError, filter, map, tap } from 'rxjs/operators';
import { DiUtils } from '../di';
var HttpUtils = /** @class */ (function () {
    function HttpUtils() {
    }
    /**
     * @return {?}
     */
    HttpUtils.getHttpClient = /**
     * @return {?}
     */
    function () {
        if (!HttpUtils._httpClient) {
            HttpUtils._httpClient = DiUtils.get(HttpClient);
        }
        return HttpUtils._httpClient;
    };
    /**
     * @return {?}
     */
    HttpUtils.timeout = /**
     * @return {?}
     */
    function () {
        if (HttpUtils._timeout) {
            HttpUtils._timeout = ConfigUtils.getConfig().httpTimeout || 5000;
        }
        return HttpUtils._timeout;
    };
    /**
     * @template T
     * @param {?} options
     * @return {?}
     */
    HttpUtils.request = /**
     * @template T
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var httpRequestOptions;
        if (CommonsUtils.isString(options)) {
            httpRequestOptions = CommonsUtils.getObjWhenStr(options, 'uri');
        }
        else {
            httpRequestOptions = (/** @type {?} */ (options));
        }
        if (httpRequestOptions.stateName) {
            return StatesUtils.get(httpRequestOptions.stateName);
        }
        if (httpRequestOptions.onRequest) {
            /** @type {?} */
            var result = httpRequestOptions.onRequest(httpRequestOptions);
            if (result === false) {
                return;
            }
            httpRequestOptions = (/** @type {?} */ (result));
        }
        /** @type {?} */
        var url = httpRequestOptions.uri || '/';
        if (!url.startsWith('http') && url.indexOf('assets/') < 0) {
            if (!url.startsWith('/')) {
                url = '/' + url;
            }
            url = ConfigUtils.getConfig().api.servers[httpRequestOptions.serverType || ConfigUtils.getConfig().api.default].uri + url;
        }
        /** @type {?} */
        var requestOptions = {};
        requestOptions.observe = httpRequestOptions.observe || 'body';
        requestOptions.responseType = httpRequestOptions.responseType || HttpResponseType.JSON;
        requestOptions.headers = HttpUtils.getRequestHeader(httpRequestOptions);
        /** @type {?} */
        var method = httpRequestOptions.method || ((httpRequestOptions.body || httpRequestOptions.payload) ? HttpMethod.POST : HttpMethod.GET);
        if (httpRequestOptions.payload) {
            if (httpRequestOptions.payloadType === HttpRequestPayloadType.PARAMS) {
                httpRequestOptions.params = httpRequestOptions.payload;
            }
            else if (httpRequestOptions.payloadType === HttpRequestPayloadType.BODY) {
                httpRequestOptions.body = httpRequestOptions.payload;
            }
            else if (!method || httpRequestOptions.method === HttpMethod.GET) {
                httpRequestOptions.params = httpRequestOptions.payload;
            }
            else {
                httpRequestOptions.body = httpRequestOptions.payload;
            }
        }
        if (httpRequestOptions.params) {
            requestOptions.params = HttpUtils.getRequestParams(httpRequestOptions);
        }
        if (httpRequestOptions.body) {
            requestOptions.body = HttpUtils.getRequestBody(httpRequestOptions);
        }
        if (!httpRequestOptions.context) {
            httpRequestOptions.context = this; // use HttpUtils.request.call(this,...) to init context
        }
        return HttpUtils.getHttpClient().request(method, url, tslib_1.__assign({}, requestOptions, { observe: 'events' }))
            .pipe(RxUtils.retry(httpRequestOptions.retry, HttpUtils.timeout()), filter(function (event) { return event.type === HttpEventType.Sent || event.type === HttpEventType.Response; }), tap(function (event) {
            if (event.type === HttpEventType.Sent) {
                HttpUtils.updateHttpTagState(httpRequestOptions.tag, true, { url: url, opts: httpRequestOptions });
            }
        }), filter(function (event) { return event.type === HttpEventType.Response; }), map(function (event) {
            /** @type {?} */
            var response = event;
            if (!httpRequestOptions.observe || httpRequestOptions.observe === 'body') {
                response = event.body;
            }
            HttpUtils.updateHttpTagState(httpRequestOptions.tag, false, {
                status: 'success',
                httpRequestOptions: httpRequestOptions
            });
            /** @type {?} */
            var resp = httpRequestOptions.onResponse
                ? httpRequestOptions.onResponse.call(httpRequestOptions.context, response, httpRequestOptions)
                : response;
            if (httpRequestOptions.stateName) {
                StatesUtils.update(httpRequestOptions.stateName, resp);
            }
            return resp;
        }), catchError(function (error) {
            HttpUtils.updateHttpTagState(httpRequestOptions.tag, false, { status: 'error', error: error });
            if (httpRequestOptions.onError) {
                httpRequestOptions.onError.call(httpRequestOptions.context, error, httpRequestOptions);
            }
            return of('服务器请求失败，状态码:' + error.status);
        }));
    };
    /**
     * @private
     * @param {?} tag
     * @param {?} state
     * @param {?=} extra
     * @return {?}
     */
    HttpUtils.updateHttpTagState = /**
     * @private
     * @param {?} tag
     * @param {?} state
     * @param {?=} extra
     * @return {?}
     */
    function (tag, state, extra) {
        if (tag) {
            StatesUtils.create([StateNames.http, tag], tslib_1.__assign({ start: state }, extra));
        }
    };
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    HttpUtils.getRequestParams = /**
     * @private
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var params;
        if (typeof options.params === 'string') {
            params = new HttpParams({ fromString: options.params });
        }
        else {
            params = new HttpParams();
            for (var key in options.params) {
                if (key) {
                    if (options.params.hasOwnProperty(key) && (options.params[key] !== null || options.params[key] !== undefined)) {
                        params = params.append(key, CommonsUtils.toString(options.params[key]));
                    }
                }
            }
        }
        return params;
    };
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    HttpUtils.getRequestBody = /**
     * @private
     * @param {?} options
     * @return {?}
     */
    function (options) {
        return options.body;
    };
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    HttpUtils.getRequestHeader = /**
     * @private
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var headers = new HttpHeaders();
        if (options.contentType) {
            headers = headers.append('Content-Type', options.contentType);
        }
        else {
            headers = headers.append('Content-Type', HttpContentType.JSON);
        }
        if (options.headers) {
            for (var key in options.headers) {
                if (key) {
                    headers = headers.append(key, options.headers[key]);
                }
            }
        }
        return headers;
    };
    /**
     * @param {?} file
     * @return {?}
     */
    HttpUtils.prototype.upload = /**
     * @param {?} file
     * @return {?}
     */
    function (file) {
        /** @type {?} */
        var formdata = new FormData();
        formdata.append('file', file);
        /** @type {?} */
        var req = new HttpRequest('POST', "upload", formdata, {
            reportProgress: true,
            responseType: 'text'
        });
        return HttpUtils.getHttpClient().request(req);
    };
    HttpUtils._httpClient = null;
    HttpUtils._timeout = 3000;
    return HttpUtils;
}());
export { HttpUtils };
if (false) {
    /**
     * @type {?}
     * @private
     */
    HttpUtils._httpClient;
    /**
     * @type {?}
     * @private
     */
    HttpUtils._timeout;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9odHRwL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBYSxhQUFhLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNoSCxPQUFPLEVBRUwsZUFBZSxFQUNmLFVBQVUsRUFFVixzQkFBc0IsRUFDdEIsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDWCxNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQzFFLE9BQU8sRUFBYSxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzVELE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxPQUFPLENBQUM7QUFFOUI7SUFBQTtJQW1MQSxDQUFDOzs7O0lBOUtRLHVCQUFhOzs7SUFBcEI7UUFDRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRTtZQUMxQixTQUFTLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQWEsVUFBVSxDQUFDLENBQUM7U0FDN0Q7UUFDRCxPQUFPLFNBQVMsQ0FBQyxXQUFXLENBQUM7SUFDL0IsQ0FBQzs7OztJQUVNLGlCQUFPOzs7SUFBZDtRQUNFLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRTtZQUN0QixTQUFTLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDO1NBQ2xFO1FBQ0QsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDO0lBQzVCLENBQUM7Ozs7OztJQUVNLGlCQUFPOzs7OztJQUFkLFVBQXdCLE9BQW9DOztZQUV0RCxrQkFBc0M7UUFFMUMsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2xDLGtCQUFrQixHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2pFO2FBQU07WUFDTCxrQkFBa0IsR0FBRyxtQkFBQSxPQUFPLEVBQXNCLENBQUM7U0FDcEQ7UUFFRCxJQUFJLGtCQUFrQixDQUFDLFNBQVMsRUFBRTtZQUNoQyxPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDdEQ7UUFFRCxJQUFJLGtCQUFrQixDQUFDLFNBQVMsRUFBRTs7Z0JBQzFCLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUM7WUFDL0QsSUFBSSxNQUFNLEtBQUssS0FBSyxFQUFFO2dCQUNwQixPQUFPO2FBQ1I7WUFDRCxrQkFBa0IsR0FBRyxtQkFBb0IsTUFBTSxFQUFBLENBQUM7U0FDakQ7O1lBRUcsR0FBRyxHQUFHLGtCQUFrQixDQUFDLEdBQUcsSUFBSSxHQUFHO1FBRXZDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3pELElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUN4QixHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQzthQUNqQjtZQUNELEdBQUcsR0FBRyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLElBQUksV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1NBQzNIOztZQUVLLGNBQWMsR0FBNkIsRUFBRTtRQUVuRCxjQUFjLENBQUMsT0FBTyxHQUFHLGtCQUFrQixDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUM7UUFFOUQsY0FBYyxDQUFDLFlBQVksR0FBRyxrQkFBa0IsQ0FBQyxZQUFZLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDO1FBRXZGLGNBQWMsQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUM7O1lBRWxFLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLGtCQUFrQixDQUFDLElBQUksSUFBSSxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztRQUV4SSxJQUFJLGtCQUFrQixDQUFDLE9BQU8sRUFBRTtZQUM5QixJQUFJLGtCQUFrQixDQUFDLFdBQVcsS0FBSyxzQkFBc0IsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3BFLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7YUFDeEQ7aUJBQU0sSUFBSSxrQkFBa0IsQ0FBQyxXQUFXLEtBQUssc0JBQXNCLENBQUMsSUFBSSxFQUFFO2dCQUN6RSxrQkFBa0IsQ0FBQyxJQUFJLEdBQUcsa0JBQWtCLENBQUMsT0FBTyxDQUFDO2FBQ3REO2lCQUFNLElBQUksQ0FBQyxNQUFNLElBQUksa0JBQWtCLENBQUMsTUFBTSxLQUFLLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2xFLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7YUFDeEQ7aUJBQU07Z0JBQ0wsa0JBQWtCLENBQUMsSUFBSSxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQzthQUN0RDtTQUNGO1FBRUQsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7WUFDN0IsY0FBYyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUN4RTtRQUVELElBQUksa0JBQWtCLENBQUMsSUFBSSxFQUFFO1lBQzNCLGNBQWMsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3BFO1FBRUQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sRUFBRTtZQUMvQixrQkFBa0IsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsdURBQXVEO1NBQzNGO1FBRUQsT0FBTyxTQUFTLENBQUMsYUFBYSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLHVCQUMvQyxjQUFjLElBQ2pCLE9BQU8sRUFBRSxRQUFRLElBQ2pCO2FBQ0MsSUFBSSxDQUNILE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUM1RCxNQUFNLENBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxLQUFLLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsUUFBUSxFQUExRSxDQUEwRSxDQUFDLEVBQzNGLEdBQUcsQ0FBQyxVQUFBLEtBQUs7WUFDUCxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLElBQUksRUFBRTtnQkFDckMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBQyxHQUFHLEtBQUEsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUMsQ0FBQyxDQUFDO2FBQzdGO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsTUFBTSxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsUUFBUSxFQUFyQyxDQUFxQyxDQUFDLEVBQ3RELEdBQUcsQ0FBQyxVQUFBLEtBQUs7O2dCQUNILFFBQVEsR0FBRyxLQUFLO1lBQ3BCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLElBQUksa0JBQWtCLENBQUMsT0FBTyxLQUFLLE1BQU0sRUFBRTtnQkFDeEUsUUFBUSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7YUFDdkI7WUFDRCxTQUFTLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRTtnQkFDMUQsTUFBTSxFQUFFLFNBQVM7Z0JBQ2pCLGtCQUFrQixvQkFBQTthQUNuQixDQUFDLENBQUM7O2dCQUNHLElBQUksR0FBRyxrQkFBa0IsQ0FBQyxVQUFVO2dCQUN4QyxDQUFDLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLGtCQUFrQixDQUFDO2dCQUM5RixDQUFDLENBQUMsUUFBUTtZQUNaLElBQUksa0JBQWtCLENBQUMsU0FBUyxFQUFFO2dCQUNoQyxXQUFXLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUN4RDtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLFVBQUMsS0FBSztZQUNmLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLE9BQUEsRUFBQyxDQUFDLENBQUM7WUFDdEYsSUFBSSxrQkFBa0IsQ0FBQyxPQUFPLEVBQUU7Z0JBQzlCLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO2FBQ3hGO1lBQ0QsT0FBTyxFQUFFLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQzs7Ozs7Ozs7SUFFYyw0QkFBa0I7Ozs7Ozs7SUFBakMsVUFBa0MsR0FBRyxFQUFFLEtBQWMsRUFBRSxLQUFVO1FBQy9ELElBQUksR0FBRyxFQUFFO1lBQ1AsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLHFCQUFHLEtBQUssRUFBRSxLQUFLLElBQUssS0FBSyxFQUFFLENBQUM7U0FDdEU7SUFDSCxDQUFDOzs7Ozs7SUFFYywwQkFBZ0I7Ozs7O0lBQS9CLFVBQWdDLE9BQTJCOztZQUNyRCxNQUFrQjtRQUN0QixJQUFJLE9BQU8sT0FBTyxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDdEMsTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLEVBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUMsQ0FBQyxDQUFDO1NBQ3ZEO2FBQU07WUFDTCxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUMxQixLQUFLLElBQU0sR0FBRyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hDLElBQUksR0FBRyxFQUFFO29CQUNQLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxFQUFFO3dCQUM3RyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDekU7aUJBQ0Y7YUFDRjtTQUNGO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7Ozs7O0lBRWMsd0JBQWM7Ozs7O0lBQTdCLFVBQThCLE9BQTJCO1FBRXZELE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQztJQUN0QixDQUFDOzs7Ozs7SUFFYywwQkFBZ0I7Ozs7O0lBQS9CLFVBQWdDLE9BQTJCOztZQUNyRCxPQUFPLEdBQWdCLElBQUksV0FBVyxFQUFFO1FBQzVDLElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRTtZQUN2QixPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQy9EO2FBQU07WUFDTCxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2hFO1FBQ0QsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQ25CLEtBQUssSUFBTSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRTtnQkFDakMsSUFBSSxHQUFHLEVBQUU7b0JBQ1AsT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDckQ7YUFDRjtTQUNGO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQzs7Ozs7SUFFRCwwQkFBTTs7OztJQUFOLFVBQU8sSUFBVTs7WUFDVCxRQUFRLEdBQWEsSUFBSSxRQUFRLEVBQUU7UUFDekMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7O1lBQ3hCLEdBQUcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRTtZQUN0RCxjQUFjLEVBQUUsSUFBSTtZQUNwQixZQUFZLEVBQUUsTUFBTTtTQUNyQixDQUFDO1FBQ0YsT0FBTyxTQUFTLENBQUMsYUFBYSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUEvS2MscUJBQVcsR0FBZSxJQUFJLENBQUM7SUFDL0Isa0JBQVEsR0FBRyxJQUFJLENBQUM7SUFnTGpDLGdCQUFDO0NBQUEsQUFuTEQsSUFtTEM7U0FuTFksU0FBUzs7Ozs7O0lBRXBCLHNCQUE4Qzs7Ozs7SUFDOUMsbUJBQStCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwRXZlbnQsIEh0dHBFdmVudFR5cGUsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zLCBIdHRwUmVxdWVzdH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtcbiAgSHR0cENsaWVudFJlcXVlc3RPcHRpb25zLFxuICBIdHRwQ29udGVudFR5cGUsXG4gIEh0dHBNZXRob2QsXG4gIEh0dHBSZXF1ZXN0T3B0aW9ucyxcbiAgSHR0cFJlcXVlc3RQYXlsb2FkVHlwZSxcbiAgSHR0cFJlc3BvbnNlVHlwZSxcbiAgU3RhdGVOYW1lc1xufSBmcm9tICdAZXIvdHlwZXMnO1xuaW1wb3J0IHtDb21tb25zVXRpbHMsIENvbmZpZ1V0aWxzLCBSeFV0aWxzLCBTdGF0ZXNVdGlsc30gZnJvbSAnQGVyL3V0aWxzJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtjYXRjaEVycm9yLCBmaWx0ZXIsIG1hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0RpVXRpbHN9IGZyb20gJy4uL2RpJztcblxuZXhwb3J0IGNsYXNzIEh0dHBVdGlscyB7XG5cbiAgcHJpdmF0ZSBzdGF0aWMgX2h0dHBDbGllbnQ6IEh0dHBDbGllbnQgPSBudWxsO1xuICBwcml2YXRlIHN0YXRpYyBfdGltZW91dCA9IDMwMDA7XG5cbiAgc3RhdGljIGdldEh0dHBDbGllbnQoKSB7XG4gICAgaWYgKCFIdHRwVXRpbHMuX2h0dHBDbGllbnQpIHtcbiAgICAgIEh0dHBVdGlscy5faHR0cENsaWVudCA9IERpVXRpbHMuZ2V0PEh0dHBDbGllbnQ+KEh0dHBDbGllbnQpO1xuICAgIH1cbiAgICByZXR1cm4gSHR0cFV0aWxzLl9odHRwQ2xpZW50O1xuICB9XG5cbiAgc3RhdGljIHRpbWVvdXQoKSB7XG4gICAgaWYgKEh0dHBVdGlscy5fdGltZW91dCkge1xuICAgICAgSHR0cFV0aWxzLl90aW1lb3V0ID0gQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuaHR0cFRpbWVvdXQgfHwgNTAwMDtcbiAgICB9XG4gICAgcmV0dXJuIEh0dHBVdGlscy5fdGltZW91dDtcbiAgfVxuXG4gIHN0YXRpYyByZXF1ZXN0PFQgPSBhbnk+KG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucyB8IHN0cmluZyk6IE9ic2VydmFibGU8VD4ge1xuXG4gICAgbGV0IGh0dHBSZXF1ZXN0T3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zO1xuXG4gICAgaWYgKENvbW1vbnNVdGlscy5pc1N0cmluZyhvcHRpb25zKSkge1xuICAgICAgaHR0cFJlcXVlc3RPcHRpb25zID0gQ29tbW9uc1V0aWxzLmdldE9ialdoZW5TdHIob3B0aW9ucywgJ3VyaScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBodHRwUmVxdWVzdE9wdGlvbnMgPSBvcHRpb25zIGFzIEh0dHBSZXF1ZXN0T3B0aW9ucztcbiAgICB9XG5cbiAgICBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLnN0YXRlTmFtZSkge1xuICAgICAgcmV0dXJuIFN0YXRlc1V0aWxzLmdldChodHRwUmVxdWVzdE9wdGlvbnMuc3RhdGVOYW1lKTtcbiAgICB9XG5cbiAgICBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLm9uUmVxdWVzdCkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gaHR0cFJlcXVlc3RPcHRpb25zLm9uUmVxdWVzdChodHRwUmVxdWVzdE9wdGlvbnMpO1xuICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaHR0cFJlcXVlc3RPcHRpb25zID0gPEh0dHBSZXF1ZXN0T3B0aW9ucz5yZXN1bHQ7XG4gICAgfVxuXG4gICAgbGV0IHVybCA9IGh0dHBSZXF1ZXN0T3B0aW9ucy51cmkgfHwgJy8nO1xuXG4gICAgaWYgKCF1cmwuc3RhcnRzV2l0aCgnaHR0cCcpICYmIHVybC5pbmRleE9mKCdhc3NldHMvJykgPCAwKSB7XG4gICAgICBpZiAoIXVybC5zdGFydHNXaXRoKCcvJykpIHtcbiAgICAgICAgdXJsID0gJy8nICsgdXJsO1xuICAgICAgfVxuICAgICAgdXJsID0gQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXBpLnNlcnZlcnNbaHR0cFJlcXVlc3RPcHRpb25zLnNlcnZlclR5cGUgfHwgQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuYXBpLmRlZmF1bHRdLnVyaSArIHVybDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0T3B0aW9uczogSHR0cENsaWVudFJlcXVlc3RPcHRpb25zID0ge307XG5cbiAgICByZXF1ZXN0T3B0aW9ucy5vYnNlcnZlID0gaHR0cFJlcXVlc3RPcHRpb25zLm9ic2VydmUgfHwgJ2JvZHknO1xuXG4gICAgcmVxdWVzdE9wdGlvbnMucmVzcG9uc2VUeXBlID0gaHR0cFJlcXVlc3RPcHRpb25zLnJlc3BvbnNlVHlwZSB8fCBIdHRwUmVzcG9uc2VUeXBlLkpTT047XG5cbiAgICByZXF1ZXN0T3B0aW9ucy5oZWFkZXJzID0gSHR0cFV0aWxzLmdldFJlcXVlc3RIZWFkZXIoaHR0cFJlcXVlc3RPcHRpb25zKTtcblxuICAgIGNvbnN0IG1ldGhvZCA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5tZXRob2QgfHwgKChodHRwUmVxdWVzdE9wdGlvbnMuYm9keSB8fCBodHRwUmVxdWVzdE9wdGlvbnMucGF5bG9hZCkgPyBIdHRwTWV0aG9kLlBPU1QgOiBIdHRwTWV0aG9kLkdFVCk7XG5cbiAgICBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWQpIHtcbiAgICAgIGlmIChodHRwUmVxdWVzdE9wdGlvbnMucGF5bG9hZFR5cGUgPT09IEh0dHBSZXF1ZXN0UGF5bG9hZFR5cGUuUEFSQU1TKSB7XG4gICAgICAgIGh0dHBSZXF1ZXN0T3B0aW9ucy5wYXJhbXMgPSBodHRwUmVxdWVzdE9wdGlvbnMucGF5bG9hZDtcbiAgICAgIH0gZWxzZSBpZiAoaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWRUeXBlID09PSBIdHRwUmVxdWVzdFBheWxvYWRUeXBlLkJPRFkpIHtcbiAgICAgICAgaHR0cFJlcXVlc3RPcHRpb25zLmJvZHkgPSBodHRwUmVxdWVzdE9wdGlvbnMucGF5bG9hZDtcbiAgICAgIH0gZWxzZSBpZiAoIW1ldGhvZCB8fCBodHRwUmVxdWVzdE9wdGlvbnMubWV0aG9kID09PSBIdHRwTWV0aG9kLkdFVCkge1xuICAgICAgICBodHRwUmVxdWVzdE9wdGlvbnMucGFyYW1zID0gaHR0cFJlcXVlc3RPcHRpb25zLnBheWxvYWQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBodHRwUmVxdWVzdE9wdGlvbnMuYm9keSA9IGh0dHBSZXF1ZXN0T3B0aW9ucy5wYXlsb2FkO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChodHRwUmVxdWVzdE9wdGlvbnMucGFyYW1zKSB7XG4gICAgICByZXF1ZXN0T3B0aW9ucy5wYXJhbXMgPSBIdHRwVXRpbHMuZ2V0UmVxdWVzdFBhcmFtcyhodHRwUmVxdWVzdE9wdGlvbnMpO1xuICAgIH1cblxuICAgIGlmIChodHRwUmVxdWVzdE9wdGlvbnMuYm9keSkge1xuICAgICAgcmVxdWVzdE9wdGlvbnMuYm9keSA9IEh0dHBVdGlscy5nZXRSZXF1ZXN0Qm9keShodHRwUmVxdWVzdE9wdGlvbnMpO1xuICAgIH1cblxuICAgIGlmICghaHR0cFJlcXVlc3RPcHRpb25zLmNvbnRleHQpIHtcbiAgICAgIGh0dHBSZXF1ZXN0T3B0aW9ucy5jb250ZXh0ID0gdGhpczsgLy8gdXNlIEh0dHBVdGlscy5yZXF1ZXN0LmNhbGwodGhpcywuLi4pIHRvIGluaXQgY29udGV4dFxuICAgIH1cblxuICAgIHJldHVybiBIdHRwVXRpbHMuZ2V0SHR0cENsaWVudCgpLnJlcXVlc3QobWV0aG9kLCB1cmwsIHtcbiAgICAgIC4uLnJlcXVlc3RPcHRpb25zLFxuICAgICAgb2JzZXJ2ZTogJ2V2ZW50cydcbiAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIFJ4VXRpbHMucmV0cnkoaHR0cFJlcXVlc3RPcHRpb25zLnJldHJ5LCBIdHRwVXRpbHMudGltZW91dCgpKSxcbiAgICAgICAgZmlsdGVyKGV2ZW50ID0+IGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuU2VudCB8fCBldmVudC50eXBlID09PSBIdHRwRXZlbnRUeXBlLlJlc3BvbnNlKSxcbiAgICAgICAgdGFwKGV2ZW50ID0+IHtcbiAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5TZW50KSB7XG4gICAgICAgICAgICBIdHRwVXRpbHMudXBkYXRlSHR0cFRhZ1N0YXRlKGh0dHBSZXF1ZXN0T3B0aW9ucy50YWcsIHRydWUsIHt1cmwsIG9wdHM6IGh0dHBSZXF1ZXN0T3B0aW9uc30pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcihldmVudCA9PiBldmVudC50eXBlID09PSBIdHRwRXZlbnRUeXBlLlJlc3BvbnNlKSxcbiAgICAgICAgbWFwKGV2ZW50ID0+IHtcbiAgICAgICAgICBsZXQgcmVzcG9uc2UgPSBldmVudDtcbiAgICAgICAgICBpZiAoIWh0dHBSZXF1ZXN0T3B0aW9ucy5vYnNlcnZlIHx8IGh0dHBSZXF1ZXN0T3B0aW9ucy5vYnNlcnZlID09PSAnYm9keScpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0gZXZlbnQuYm9keTtcbiAgICAgICAgICB9XG4gICAgICAgICAgSHR0cFV0aWxzLnVwZGF0ZUh0dHBUYWdTdGF0ZShodHRwUmVxdWVzdE9wdGlvbnMudGFnLCBmYWxzZSwge1xuICAgICAgICAgICAgc3RhdHVzOiAnc3VjY2VzcycsXG4gICAgICAgICAgICBodHRwUmVxdWVzdE9wdGlvbnNcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCByZXNwID0gaHR0cFJlcXVlc3RPcHRpb25zLm9uUmVzcG9uc2VcbiAgICAgICAgICAgID8gaHR0cFJlcXVlc3RPcHRpb25zLm9uUmVzcG9uc2UuY2FsbChodHRwUmVxdWVzdE9wdGlvbnMuY29udGV4dCwgcmVzcG9uc2UsIGh0dHBSZXF1ZXN0T3B0aW9ucylcbiAgICAgICAgICAgIDogcmVzcG9uc2U7XG4gICAgICAgICAgaWYgKGh0dHBSZXF1ZXN0T3B0aW9ucy5zdGF0ZU5hbWUpIHtcbiAgICAgICAgICAgIFN0YXRlc1V0aWxzLnVwZGF0ZShodHRwUmVxdWVzdE9wdGlvbnMuc3RhdGVOYW1lLCByZXNwKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlc3A7XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT4ge1xuICAgICAgICAgIEh0dHBVdGlscy51cGRhdGVIdHRwVGFnU3RhdGUoaHR0cFJlcXVlc3RPcHRpb25zLnRhZywgZmFsc2UsIHtzdGF0dXM6ICdlcnJvcicsIGVycm9yfSk7XG4gICAgICAgICAgaWYgKGh0dHBSZXF1ZXN0T3B0aW9ucy5vbkVycm9yKSB7XG4gICAgICAgICAgICBodHRwUmVxdWVzdE9wdGlvbnMub25FcnJvci5jYWxsKGh0dHBSZXF1ZXN0T3B0aW9ucy5jb250ZXh0LCBlcnJvciwgaHR0cFJlcXVlc3RPcHRpb25zKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG9mKCfmnI3liqHlmajor7fmsYLlpLHotKXvvIznirbmgIHnoIE6JyArIGVycm9yLnN0YXR1cyk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgdXBkYXRlSHR0cFRhZ1N0YXRlKHRhZywgc3RhdGU6IGJvb2xlYW4sIGV4dHJhPzoge30pIHtcbiAgICBpZiAodGFnKSB7XG4gICAgICBTdGF0ZXNVdGlscy5jcmVhdGUoW1N0YXRlTmFtZXMuaHR0cCwgdGFnXSwge3N0YXJ0OiBzdGF0ZSwgLi4uZXh0cmF9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRSZXF1ZXN0UGFyYW1zKG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucykge1xuICAgIGxldCBwYXJhbXM6IEh0dHBQYXJhbXM7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLnBhcmFtcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKHtmcm9tU3RyaW5nOiBvcHRpb25zLnBhcmFtc30pO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBuZXcgSHR0cFBhcmFtcygpO1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gb3B0aW9ucy5wYXJhbXMpIHtcbiAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgIGlmIChvcHRpb25zLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIChvcHRpb25zLnBhcmFtc1trZXldICE9PSBudWxsIHx8IG9wdGlvbnMucGFyYW1zW2tleV0gIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoa2V5LCBDb21tb25zVXRpbHMudG9TdHJpbmcob3B0aW9ucy5wYXJhbXNba2V5XSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFyYW1zO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0UmVxdWVzdEJvZHkob3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zKSB7XG5cbiAgICByZXR1cm4gb3B0aW9ucy5ib2R5O1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0UmVxdWVzdEhlYWRlcihvcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMpOiBIdHRwSGVhZGVycyB7XG4gICAgbGV0IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgaWYgKG9wdGlvbnMuY29udGVudFR5cGUpIHtcbiAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC1UeXBlJywgb3B0aW9ucy5jb250ZW50VHlwZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC1UeXBlJywgSHR0cENvbnRlbnRUeXBlLkpTT04pO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5oZWFkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBvcHRpb25zLmhlYWRlcnMpIHtcbiAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZChrZXksIG9wdGlvbnMuaGVhZGVyc1trZXldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaGVhZGVycztcbiAgfVxuXG4gIHVwbG9hZChmaWxlOiBGaWxlKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8e30+PiB7XG4gICAgY29uc3QgZm9ybWRhdGE6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybWRhdGEuYXBwZW5kKCdmaWxlJywgZmlsZSk7XG4gICAgY29uc3QgcmVxID0gbmV3IEh0dHBSZXF1ZXN0KCdQT1NUJywgYHVwbG9hZGAsIGZvcm1kYXRhLCB7XG4gICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZSxcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXG4gICAgfSk7XG4gICAgcmV0dXJuIEh0dHBVdGlscy5nZXRIdHRwQ2xpZW50KCkucmVxdWVzdChyZXEpO1xuICB9XG5cbn1cbiJdfQ==