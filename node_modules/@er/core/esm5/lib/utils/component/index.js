/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { EventEmitter } from '@angular/core';
import { CommonsUtils } from '@er/utils';
import { takeUntil } from 'rxjs/operators';
import { LogUtils } from '../log/index';
var ComponentUtils = /** @class */ (function () {
    function ComponentUtils() {
    }
    /**
     * @param {?} compInstance
     * @param {?} props
     * @return {?}
     */
    ComponentUtils.resolveProps = /**
     * @param {?} compInstance
     * @param {?} props
     * @return {?}
     */
    function (compInstance, props) {
        /** @type {?} */
        var result = {
            inputs: {},
            outputs: {}
        };
        if (compInstance && CommonsUtils.isJson(props)) {
            Object.keys(props).forEach(function (key) {
                if (compInstance[key] instanceof EventEmitter) {
                    result.outputs[key] = props[key];
                }
                else {
                    result.inputs[key] = props[key];
                }
            });
        }
        return result;
    };
    /**
     * @param {?} compInstance
     * @param {?} hooks
     * @param {?} constructor
     * @param {?} destructor
     * @return {?}
     */
    ComponentUtils.bindLifeCycles = /**
     * @param {?} compInstance
     * @param {?} hooks
     * @param {?} constructor
     * @param {?} destructor
     * @return {?}
     */
    function (compInstance, hooks, constructor, destructor) {
        /** @type {?} */
        var originalLifeCycles;
        if (hooks) {
            originalLifeCycles = {};
            Object.keys(hooks).forEach(function (eventName) {
                /** @type {?} */
                var ngEventName = "ng" + CommonsUtils.capitalize(eventName);
                if (compInstance["__" + ngEventName] === true) {
                    ((/** @type {?} */ (hooks[eventName]))).call(compInstance, compInstance);
                }
                else {
                    /** @type {?} */
                    var original_1 = constructor.prototype[ngEventName];
                    constructor.prototype[ngEventName] = function () {
                        var _a;
                        CommonsUtils.isFunction(original_1) && original_1.apply(compInstance, arguments);
                        /** @type {?} */
                        var args = Array.prototype.slice.call(arguments);
                        (_a = ((/** @type {?} */ (hooks[eventName])))).call.apply(_a, tslib_1.__spread([compInstance], args, [compInstance]));
                    };
                    originalLifeCycles[ngEventName] = original_1;
                }
            });
            if (Object.keys(originalLifeCycles).length > 0) {
                /** @type {?} */
                var destroyLifeCycle_1 = 'ngOnDestroy';
                constructor.prototype[destroyLifeCycle_1] = function () {
                    Object.keys(originalLifeCycles).forEach(function (lifeCycleName) {
                        constructor.prototype[lifeCycleName] = originalLifeCycles[lifeCycleName];
                    });
                    CommonsUtils.isFunction(destructor) && destructor.apply(compInstance);
                    constructor.prototype[destroyLifeCycle_1] = destructor;
                };
            }
        }
    };
    // static bindLifeCycles(compInstance, hooks) {
    //   if (!CommonsUtils.isEmpty(hooks)) {
    //     Object.keys(hooks).forEach(eventName => {
    //       const hookName = `ng${CommonsUtils.capitalize(eventName)}`;
    //       const original = compInstance.__proto__[hookName];
    //       compInstance.__proto__[hookName] = function () {
    //         CommonsUtils.isFunction(original) && original.apply(compInstance, arguments);
    //         const args = Array.prototype.slice.call(arguments);
    //         (<Function>hooks[eventName]).call(compInstance, ...args, compInstance);
    //       };
    //     });
    //   }
    // }
    /**
     * set component instance attributes and event from props object
     */
    // static bindLifeCycles(compInstance, hooks) {
    //   if (!CommonsUtils.isEmpty(hooks)) {
    //     Object.keys(hooks).forEach(eventName => {
    //       const hookName = `ng${CommonsUtils.capitalize(eventName)}`;
    //       const original = compInstance.__proto__[hookName];
    //       compInstance.__proto__[hookName] = function () {
    //         CommonsUtils.isFunction(original) && original.apply(compInstance, arguments);
    //         const args = Array.prototype.slice.call(arguments);
    //         (<Function>hooks[eventName]).call(compInstance, ...args, compInstance);
    //       };
    //     });
    //   }
    // }
    /**
     * set component instance attributes and event from props object
     * @param {?} compInstance
     * @param {?} props
     * @param {?=} unSubscribe
     * @return {?}
     */
    ComponentUtils.bind = 
    // static bindLifeCycles(compInstance, hooks) {
    //   if (!CommonsUtils.isEmpty(hooks)) {
    //     Object.keys(hooks).forEach(eventName => {
    //       const hookName = `ng${CommonsUtils.capitalize(eventName)}`;
    //       const original = compInstance.__proto__[hookName];
    //       compInstance.__proto__[hookName] = function () {
    //         CommonsUtils.isFunction(original) && original.apply(compInstance, arguments);
    //         const args = Array.prototype.slice.call(arguments);
    //         (<Function>hooks[eventName]).call(compInstance, ...args, compInstance);
    //       };
    //     });
    //   }
    // }
    /**
     * set component instance attributes and event from props object
     * @param {?} compInstance
     * @param {?} props
     * @param {?=} unSubscribe
     * @return {?}
     */
    function (compInstance, props, unSubscribe) {
        var _loop_1 = function (prop) {
            if (prop === 'hooks') {
                /** @type {?} */
                var constructor = ComponentUtils.getConstructor(compInstance);
                /** @type {?} */
                var destructor = constructor.prototype['ngOnDestroy'];
                ComponentUtils.bindLifeCycles(compInstance, props[prop], constructor, destructor);
            }
            else if ((compInstance[prop] instanceof EventEmitter)) {
                ((/** @type {?} */ (compInstance[prop])))
                    .pipe(takeUntil(unSubscribe || compInstance['destroyed$']))
                    .subscribe(function (event) {
                    try {
                        if (CommonsUtils.isFunction(compInstance['getEventContext'])) {
                            event = compInstance.getEventContext(event);
                        }
                        props[prop].call(compInstance, event);
                    }
                    catch (e) {
                        LogUtils.error(compInstance, '操作失败', e);
                    }
                });
            }
            else {
                compInstance[prop] = props[prop];
            }
        };
        for (var prop in props) {
            _loop_1(prop);
        }
    };
    /**
     * @param {?} compInstance
     * @param {?} methodName
     * @param {?} newFun
     * @param {?=} position
     * @return {?}
     */
    ComponentUtils.reWriteMethod = /**
     * @param {?} compInstance
     * @param {?} methodName
     * @param {?} newFun
     * @param {?=} position
     * @return {?}
     */
    function (compInstance, methodName, newFun, position) {
        if (position === void 0) { position = 'after'; }
        /** @type {?} */
        var buildInFn = compInstance[methodName];
        Object.defineProperty(compInstance, methodName, {
            get: function () {
                return function (args) {
                    if (buildInFn && position === 'after') {
                        buildInFn.call(compInstance, args);
                    }
                    newFun.call(compInstance, args);
                    if (buildInFn && position === 'before') {
                        buildInFn.call(compInstance, args);
                    }
                };
            }
        });
    };
    /**
     * @param {?} viewContainer
     * @return {?}
     */
    ComponentUtils.getHostComponentInst = /**
     * @param {?} viewContainer
     * @return {?}
     */
    function (viewContainer) {
        if (viewContainer) {
            /** @type {?} */
            var componentView = viewContainer['_data'].componentView;
            if (componentView) {
                return componentView.component;
            }
        }
        return null;
    };
    /**
     * @param {?} viewContainer
     * @return {?}
     */
    ComponentUtils.getViewComponentRef = /**
     * @param {?} viewContainer
     * @return {?}
     */
    function (viewContainer) {
        if (viewContainer) {
            /** @type {?} */
            var view = viewContainer['_view'];
            if (view) {
                return view.component;
            }
        }
        return null;
    };
    /**
     * @param {?} component
     * @return {?}
     */
    ComponentUtils.getConstructor = /**
     * @param {?} component
     * @return {?}
     */
    function (component) {
        return component.__proto__.constructor;
    };
    return ComponentUtils;
}());
export { ComponentUtils };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9jb21wb25lbnQvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFtQixNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQ3ZDLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBRXRDO0lBQUE7SUF1SUEsQ0FBQzs7Ozs7O0lBcklRLDJCQUFZOzs7OztJQUFuQixVQUFvQixZQUFZLEVBQUUsS0FBSzs7WUFDL0IsTUFBTSxHQUFHO1lBQ2IsTUFBTSxFQUFFLEVBQUU7WUFDVixPQUFPLEVBQUUsRUFBRTtTQUNaO1FBQ0QsSUFBSSxZQUFZLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM5QyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLEdBQUc7Z0JBQzVCLElBQUksWUFBWSxDQUFDLEdBQUcsQ0FBQyxZQUFZLFlBQVksRUFBRTtvQkFDN0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2xDO3FCQUFNO29CQUNMLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNqQztZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOzs7Ozs7OztJQUVNLDZCQUFjOzs7Ozs7O0lBQXJCLFVBQXNCLFlBQVksRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLFVBQVU7O1lBQzVELGtCQUFzQjtRQUMxQixJQUFJLEtB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Q0FBQyxDQUFDO29CQUVoQyxJQUFJLFNBQVMsSUFBSSxRQUFRLEtBQUssUUFBUSxFQUFFO3dCQUN0QyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztxQkFDcEM7Z0JBQ0gsQ0FBQyxDQUFDO1lBQ0osQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBRU0sbUNBQW9COzs7O0lBQTNCLFVBQTRCLGFBQStCO1FBQ3pELElBQUksYUFBYSxFQUFFOztnQkFDWCxhQUFhLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLGFBQWE7WUFDMUQsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLE9BQU8sYUFBYSxDQUFDLFNBQVMsQ0FBQzthQUNoQztTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7OztJQUVNLGtDQUFtQjs7OztJQUExQixVQUEyQixhQUErQjtRQUN4RCxJQUFJLGFBQWEsRUFBRTs7Z0JBQ1gsSUFBSSxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUM7WUFDbkMsSUFBSSxJQUFJLEVBQUU7Z0JBQ1IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO2FBQ3ZCO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Ozs7O0lBRU0sNkJBQWM7Ozs7SUFBckIsVUFBc0IsU0FBUztRQUM3QixPQUFPLFNBQVMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDO0lBQ3pDLENBQUM7SUFDSCxxQkFBQztBQUFELENBQUMsQUF2SUQsSUF1SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0V2ZW50RW1pdHRlciwgVmlld0NvbnRhaW5lclJlZn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0NvbW1vbnNVdGlsc30gZnJvbSAnQGVyL3V0aWxzJztcbmltcG9ydCB7dGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0xvZ1V0aWxzfSBmcm9tICcuLi9sb2cvaW5kZXgnO1xuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50VXRpbHMge1xuXG4gIHN0YXRpYyByZXNvbHZlUHJvcHMoY29tcEluc3RhbmNlLCBwcm9wcykge1xuICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgIGlucHV0czoge30sXG4gICAgICBvdXRwdXRzOiB7fVxuICAgIH07XG4gICAgaWYgKGNvbXBJbnN0YW5jZSAmJiBDb21tb25zVXRpbHMuaXNKc29uKHByb3BzKSkge1xuICAgICAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgaWYgKGNvbXBJbnN0YW5jZVtrZXldIGluc3RhbmNlb2YgRXZlbnRFbWl0dGVyKSB7XG4gICAgICAgICAgcmVzdWx0Lm91dHB1dHNba2V5XSA9IHByb3BzW2tleV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0LmlucHV0c1trZXldID0gcHJvcHNba2V5XTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzdGF0aWMgYmluZExpZmVDeWNsZXMoY29tcEluc3RhbmNlLCBob29rcywgY29uc3RydWN0b3IsIGRlc3RydWN0b3IpIHtcbiAgICBsZXQgb3JpZ2luYWxMaWZlQ3ljbGVzOiB7fTtcbiAgICBpZiAoaG9va3MpIHtcbiAgICAgIG9yaWdpbmFsTGlmZUN5Y2xlcyA9IHt9O1xuICAgICAgT2JqZWN0LmtleXMoaG9va3MpLmZvckVhY2goZXZlbnROYW1lID0+IHtcbiAgICAgICAgY29uc3QgbmdFdmVudE5hbWUgPSBgbmcke0NvbW1vbnNVdGlscy5jYXBpdGFsaXplKGV2ZW50TmFtZSl9YDtcblxuICAgICAgICBpZiAoY29tcEluc3RhbmNlW2BfXyR7bmdFdmVudE5hbWV9YF0gPT09IHRydWUpIHtcbiAgICAgICAgICAoPEZ1bmN0aW9uPmhvb2tzW2V2ZW50TmFtZV0pLmNhbGwoY29tcEluc3RhbmNlLCBjb21wSW5zdGFuY2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IG9yaWdpbmFsID0gY29uc3RydWN0b3IucHJvdG90eXBlW25nRXZlbnROYW1lXTtcbiAgICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGVbbmdFdmVudE5hbWVdID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgQ29tbW9uc1V0aWxzLmlzRnVuY3Rpb24ob3JpZ2luYWwpICYmIG9yaWdpbmFsLmFwcGx5KGNvbXBJbnN0YW5jZSwgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpO1xuICAgICAgICAgICAgKDxGdW5jdGlvbj5ob29rc1tldmVudE5hbWVdKS5jYWxsKGNvbXBJbnN0YW5jZSwgLi4uYXJncywgY29tcEluc3RhbmNlKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIG9yaWdpbmFsTGlmZUN5Y2xlc1tuZ0V2ZW50TmFtZV0gPSBvcmlnaW5hbDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBpZiAoT2JqZWN0LmtleXMob3JpZ2luYWxMaWZlQ3ljbGVzKS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGRlc3Ryb3lMaWZlQ3ljbGUgPSAnbmdPbkRlc3Ryb3knO1xuICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGVbZGVzdHJveUxpZmVDeWNsZV0gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgT2JqZWN0LmtleXMob3JpZ2luYWxMaWZlQ3ljbGVzKS5mb3JFYWNoKGxpZmVDeWNsZU5hbWUgPT4ge1xuICAgICAgICAgICAgY29uc3RydWN0b3IucHJvdG90eXBlW2xpZmVDeWNsZU5hbWVdID0gb3JpZ2luYWxMaWZlQ3ljbGVzW2xpZmVDeWNsZU5hbWVdO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIENvbW1vbnNVdGlscy5pc0Z1bmN0aW9uKGRlc3RydWN0b3IpICYmIGRlc3RydWN0b3IuYXBwbHkoY29tcEluc3RhbmNlKTtcbiAgICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGVbZGVzdHJveUxpZmVDeWNsZV0gPSBkZXN0cnVjdG9yO1xuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIHN0YXRpYyBiaW5kTGlmZUN5Y2xlcyhjb21wSW5zdGFuY2UsIGhvb2tzKSB7XG4gIC8vICAgaWYgKCFDb21tb25zVXRpbHMuaXNFbXB0eShob29rcykpIHtcbiAgLy8gICAgIE9iamVjdC5rZXlzKGhvb2tzKS5mb3JFYWNoKGV2ZW50TmFtZSA9PiB7XG4gIC8vICAgICAgIGNvbnN0IGhvb2tOYW1lID0gYG5nJHtDb21tb25zVXRpbHMuY2FwaXRhbGl6ZShldmVudE5hbWUpfWA7XG4gIC8vICAgICAgIGNvbnN0IG9yaWdpbmFsID0gY29tcEluc3RhbmNlLl9fcHJvdG9fX1tob29rTmFtZV07XG4gIC8vICAgICAgIGNvbXBJbnN0YW5jZS5fX3Byb3RvX19baG9va05hbWVdID0gZnVuY3Rpb24gKCkge1xuICAvLyAgICAgICAgIENvbW1vbnNVdGlscy5pc0Z1bmN0aW9uKG9yaWdpbmFsKSAmJiBvcmlnaW5hbC5hcHBseShjb21wSW5zdGFuY2UsIGFyZ3VtZW50cyk7XG4gIC8vICAgICAgICAgY29uc3QgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7XG4gIC8vICAgICAgICAgKDxGdW5jdGlvbj5ob29rc1tldmVudE5hbWVdKS5jYWxsKGNvbXBJbnN0YW5jZSwgLi4uYXJncywgY29tcEluc3RhbmNlKTtcbiAgLy8gICAgICAgfTtcbiAgLy8gICAgIH0pO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIC8qKlxuICAgKiBzZXQgY29tcG9uZW50IGluc3RhbmNlIGF0dHJpYnV0ZXMgYW5kIGV2ZW50IGZyb20gcHJvcHMgb2JqZWN0XG4gICAqL1xuICBzdGF0aWMgYmluZChjb21wSW5zdGFuY2UsIHByb3BzLCB1blN1YnNjcmliZT8pIHtcbiAgICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvcHMpIHtcbiAgICAgIGlmIChwcm9wID09PSAnaG9va3MnKSB7XG4gICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yID0gQ29tcG9uZW50VXRpbHMuZ2V0Q29uc3RydWN0b3IoY29tcEluc3RhbmNlKTtcbiAgICAgICAgY29uc3QgZGVzdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZVsnbmdPbkRlc3Ryb3knXTtcbiAgICAgICAgQ29tcG9uZW50VXRpbHMuYmluZExpZmVDeWNsZXMoY29tcEluc3RhbmNlLCBwcm9wc1twcm9wXSwgY29uc3RydWN0b3IsIGRlc3RydWN0b3IpO1xuICAgICAgfSBlbHNlIGlmICgoY29tcEluc3RhbmNlW3Byb3BdIGluc3RhbmNlb2YgRXZlbnRFbWl0dGVyKSkge1xuICAgICAgICAoY29tcEluc3RhbmNlW3Byb3BdIGFzIEV2ZW50RW1pdHRlcjxhbnk+KVxuICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh1blN1YnNjcmliZSB8fCBjb21wSW5zdGFuY2VbJ2Rlc3Ryb3llZCQnXSkpXG4gICAgICAgICAgLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBpZiAoQ29tbW9uc1V0aWxzLmlzRnVuY3Rpb24oY29tcEluc3RhbmNlWydnZXRFdmVudENvbnRleHQnXSkpIHtcbiAgICAgICAgICAgICAgICBldmVudCA9IGNvbXBJbnN0YW5jZS5nZXRFdmVudENvbnRleHQoZXZlbnQpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHByb3BzW3Byb3BdLmNhbGwoY29tcEluc3RhbmNlLCBldmVudCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIExvZ1V0aWxzLmVycm9yKGNvbXBJbnN0YW5jZSwgJ+aTjeS9nOWksei0pScsIGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29tcEluc3RhbmNlW3Byb3BdID0gcHJvcHNbcHJvcF07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIHJlV3JpdGVNZXRob2QoY29tcEluc3RhbmNlLCBtZXRob2ROYW1lOiBzdHJpbmcsIG5ld0Z1bjogRnVuY3Rpb24sIHBvc2l0aW9uOiAnYmVmb3JlJyB8ICdhZnRlcicgfCAnb3ZlcnJpZGUnID0gJ2FmdGVyJykge1xuICAgIGNvbnN0IGJ1aWxkSW5GbiA9IGNvbXBJbnN0YW5jZVttZXRob2ROYW1lXTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY29tcEluc3RhbmNlLCBtZXRob2ROYW1lLCB7XG4gICAgICBnZXQ6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIChhcmdzKSA9PiB7XG4gICAgICAgICAgaWYgKGJ1aWxkSW5GbiAmJiBwb3NpdGlvbiA9PT0gJ2FmdGVyJykge1xuICAgICAgICAgICAgYnVpbGRJbkZuLmNhbGwoY29tcEluc3RhbmNlLCBhcmdzKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBuZXdGdW4uY2FsbChjb21wSW5zdGFuY2UsIGFyZ3MpO1xuXG4gICAgICAgICAgaWYgKGJ1aWxkSW5GbiAmJiBwb3NpdGlvbiA9PT0gJ2JlZm9yZScpIHtcbiAgICAgICAgICAgIGJ1aWxkSW5Gbi5jYWxsKGNvbXBJbnN0YW5jZSwgYXJncyk7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGdldEhvc3RDb21wb25lbnRJbnN0KHZpZXdDb250YWluZXI6IFZpZXdDb250YWluZXJSZWYpIHtcbiAgICBpZiAodmlld0NvbnRhaW5lcikge1xuICAgICAgY29uc3QgY29tcG9uZW50VmlldyA9IHZpZXdDb250YWluZXJbJ19kYXRhJ10uY29tcG9uZW50VmlldztcbiAgICAgIGlmIChjb21wb25lbnRWaWV3KSB7XG4gICAgICAgIHJldHVybiBjb21wb25lbnRWaWV3LmNvbXBvbmVudDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBzdGF0aWMgZ2V0Vmlld0NvbXBvbmVudFJlZih2aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmKSB7XG4gICAgaWYgKHZpZXdDb250YWluZXIpIHtcbiAgICAgIGNvbnN0IHZpZXcgPSB2aWV3Q29udGFpbmVyWydfdmlldyddO1xuICAgICAgaWYgKHZpZXcpIHtcbiAgICAgICAgcmV0dXJuIHZpZXcuY29tcG9uZW50O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRDb25zdHJ1Y3Rvcihjb21wb25lbnQpIHtcbiAgICByZXR1cm4gY29tcG9uZW50Ll9fcHJvdG9fXy5jb25zdHJ1Y3RvcjtcbiAgfVxufVxuIl19