/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Order } from '@er/types';
import { CommonsUtils, DialogUtils, StatesUtils } from '@er/utils';
import * as esb from 'elastic-builder';
import { throwError } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { ApiUtils } from '../api';
/**
 * @record
 */
export function NextSeqProps() { }
if (false) {
    /** @type {?|undefined} */
    NextSeqProps.prototype.apiEntry;
    /** @type {?|undefined} */
    NextSeqProps.prototype.parent;
    /** @type {?|undefined} */
    NextSeqProps.prototype.query;
    /** @type {?|undefined} */
    NextSeqProps.prototype.parentKey;
    /** @type {?|undefined} */
    NextSeqProps.prototype.seqKey;
    /** @type {?|undefined} */
    NextSeqProps.prototype.seqLen;
    /** @type {?|undefined} */
    NextSeqProps.prototype.withParent;
}
/**
 * @record
 */
export function DistinctValueProps() { }
if (false) {
    /** @type {?|undefined} */
    DistinctValueProps.prototype.apiProps;
    /** @type {?|undefined} */
    DistinctValueProps.prototype.id;
}
var DataUtils = /** @class */ (function () {
    function DataUtils() {
    }
    /**
     * @param {?} options
     * @return {?}
     */
    DataUtils.getNextValue = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        var _a;
        /** @type {?} */
        var opt = CommonsUtils.defaults(options || {}, DataUtils.DEFAULT_PROPS);
        /** @type {?} */
        var q = CommonsUtils.getArrayValue(opt.query) || [];
        if (opt.parent) {
            q.push(esb.termQuery(opt.parentKey, opt.parent));
        }
        return ApiUtils.getByQuery("" + opt.apiEntry, (/** @type {?} */ ({
            query: q,
            sort: (_a = {}, _a[opt.seqKey] = Order.DESC, _a),
            size: 1
        }))).pipe(map(function (data) {
            /** @type {?} */
            var prefix = '0'.repeat(opt.seqLen);
            /** @type {?} */
            var next = 1;
            if (data.total !== 0) {
                /** @type {?} */
                var last = data.items[0];
                if (last[opt.seqKey]) {
                    next = parseInt(last[opt.seqKey].replace(/^0+/, '')) + 1;
                }
                else {
                    DialogUtils.error('错误', '无法生成新的序列号');
                    throwError('无法生成新的序列号');
                }
            }
            /** @type {?} */
            var seq = (prefix + next).slice(-prefix.length);
            if (opt.withParent && opt.parent) {
                return opt.parent + seq;
            }
            else {
                return seq;
            }
        }));
    };
    /**
     * @param {?} props
     * @return {?}
     */
    DataUtils.checkDistinct = /**
     * @param {?} props
     * @return {?}
     */
    function (props) {
        /** @type {?} */
        var result$ = ApiUtils.fetch(tslib_1.__assign({}, props.apiProps, { size: 2 })).pipe(map(function (data) { return !data.items || data.items.length === 0 ||
            (data.items.length === 1 && data.items[0]['id'] === props.id); }), tap(function (distinct) {
            if (!distinct) {
                DialogUtils.error('验证失败', "\u6570\u503C\u3010" + props.apiProps.queryValue + "\u3011\u5DF2\u7ECF\u5B58\u5728\uFF0C\u8BF7\u4FEE\u6539\u540E\u518D\u6267\u884C\u672C\u64CD\u4F5C\uFF01");
            }
        }));
        return result$;
    };
    /**
     * @param {?} event
     * @param {?} keyOrQuery
     * @return {?}
     */
    DataUtils.onNodeSelect = /**
     * @param {?} event
     * @param {?} keyOrQuery
     * @return {?}
     */
    function (event, keyOrQuery) {
        /** @type {?} */
        var treeProps = event['$from'].$props;
        /** @type {?} */
        var tableId = CommonsUtils.get(treeProps, '$ext.$container.table.$id');
        if (tableId) {
            /** @type {?} */
            var q = keyOrQuery;
            /** @type {?} */
            var nodeCode = event.node.data && event.node.data.code;
            if (nodeCode && CommonsUtils.isString(keyOrQuery)) {
                q = esb.prefixQuery(keyOrQuery, nodeCode);
            }
            StatesUtils.update(tableId, (/** @type {?} */ ({
                query: nodeCode ? q : esb.matchAllQuery()
            })));
        }
    };
    DataUtils.DEFAULT_ROOT_SEQ = '001';
    DataUtils.DEFAULT_PROPS = {
        parentKey: 'parent.code',
        seqKey: 'code',
        seqLen: 3
    };
    return DataUtils;
}());
export { DataUtils };
if (false) {
    /** @type {?} */
    DataUtils.DEFAULT_ROOT_SEQ;
    /** @type {?} */
    DataUtils.DEFAULT_PROPS;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZXIvY29yZS8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9kYXRhL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUEyQixLQUFLLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDMUQsT0FBTyxFQUFDLFlBQVksRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQ2pFLE9BQU8sS0FBSyxHQUFHLE1BQU0saUJBQWlCLENBQUM7QUFFdkMsT0FBTyxFQUFhLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUM1QyxPQUFPLEVBQUMsR0FBRyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3hDLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxRQUFRLENBQUM7Ozs7QUFFaEMsa0NBUUM7OztJQVBDLGdDQUFrQjs7SUFDbEIsOEJBQWdCOztJQUNoQiw2QkFBd0I7O0lBQ3hCLGlDQUFtQjs7SUFDbkIsOEJBQWdCOztJQUNoQiw4QkFBZ0I7O0lBQ2hCLGtDQUFxQjs7Ozs7QUFHdkIsd0NBR0M7OztJQUZDLHNDQUF3Qjs7SUFDeEIsZ0NBQVM7O0FBR1g7SUFBQTtJQXlFQSxDQUFDOzs7OztJQS9EUSxzQkFBWTs7OztJQUFuQixVQUFvQixPQUFxQjs7O1lBQ2pDLEdBQUcsR0FBaUIsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLElBQUksRUFBRSxFQUFFLFNBQVMsQ0FBQyxhQUFhLENBQUM7O1lBQ2pGLENBQUMsR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1FBQ3JELElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRTtZQUNkLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0Qs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QyxXQUFXLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQzNDO1lBQ0QsV0FBVyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsbUJBQVk7Z0JBQ3RDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRTthQUMxQyxFQUFBLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQXRFTSwwQkFBZ0IsR0FBRyxLQUFLLENBQUM7SUFFekIsdUJBQWEsR0FBaUI7UUFDbkMsU0FBUyxFQUFFLGFBQWE7UUFDeEIsTUFBTSxFQUFFLE1BQU07UUFDZCxNQUFNLEVBQUUsQ0FBQztLQUNWLENBQUM7SUFpRUosZ0JBQUM7Q0FBQSxBQXpFRCxJQXlFQztTQXpFWSxTQUFTOzs7SUFFcEIsMkJBQWdDOztJQUVoQyx3QkFJRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QXBpRGF0YVByb3BzLCBBcGlQYXlsb2FkLCBPcmRlcn0gZnJvbSAnQGVyL3R5cGVzJztcbmltcG9ydCB7Q29tbW9uc1V0aWxzLCBEaWFsb2dVdGlscywgU3RhdGVzVXRpbHN9IGZyb20gJ0Blci91dGlscyc7XG5pbXBvcnQgKiBhcyBlc2IgZnJvbSAnZWxhc3RpYy1idWlsZGVyJztcbmltcG9ydCB7UXVlcnl9IGZyb20gJ2VsYXN0aWMtYnVpbGRlcic7XG5pbXBvcnQge09ic2VydmFibGUsIHRocm93RXJyb3J9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtBcGlVdGlsc30gZnJvbSAnLi4vYXBpJztcblxuZXhwb3J0IGludGVyZmFjZSBOZXh0U2VxUHJvcHMge1xuICBhcGlFbnRyeT86IHN0cmluZztcbiAgcGFyZW50Pzogc3RyaW5nO1xuICBxdWVyeT86IFF1ZXJ5IHwgUXVlcnlbXTtcbiAgcGFyZW50S2V5Pzogc3RyaW5nO1xuICBzZXFLZXk/OiBzdHJpbmc7XG4gIHNlcUxlbj86IG51bWJlcjtcbiAgd2l0aFBhcmVudD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGlzdGluY3RWYWx1ZVByb3BzIHtcbiAgYXBpUHJvcHM/OiBBcGlEYXRhUHJvcHM7XG4gIGlkPzogYW55O1xufVxuXG5leHBvcnQgY2xhc3MgRGF0YVV0aWxzIHtcblxuICBzdGF0aWMgREVGQVVMVF9ST09UX1NFUSA9ICcwMDEnO1xuXG4gIHN0YXRpYyBERUZBVUxUX1BST1BTOiBOZXh0U2VxUHJvcHMgPSB7XG4gICAgcGFyZW50S2V5OiAncGFyZW50LmNvZGUnLFxuICAgIHNlcUtleTogJ2NvZGUnLFxuICAgIHNlcUxlbjogM1xuICB9O1xuXG4gIHN0YXRpYyBnZXROZXh0VmFsdWUob3B0aW9uczogTmV4dFNlcVByb3BzKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBvcHQ6IE5leHRTZXFQcm9wcyA9IENvbW1vbnNVdGlscy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCBEYXRhVXRpbHMuREVGQVVMVF9QUk9QUyk7XG4gICAgY29uc3QgcSA9IENvbW1vbnNVdGlscy5nZXRBcnJheVZhbHVlKG9wdC5xdWVyeSkgfHwgW107XG4gICAgaWYgKG9wdC5wYXJlbnQpIHtcbiAgICAgIHEucHVzaChlc2IudGVybVF1ZXJ5KG9wdC5wYXJlbnRLZXksIG9wdC5wYXJlbnQpKTtcbiAgICB9XG4gICAgcmV0dXJuIEFwaVV0aWxzLmdldEJ5UXVlcnkoYCR7b3B0LmFwaUVudHJ5fWAsIDxBcGlQYXlsb2FkPntcbiAgICAgIHF1ZXJ5OiBxLFxuICAgICAgc29ydDoge1tvcHQuc2VxS2V5XTogT3JkZXIuREVTQ30sXG4gICAgICBzaXplOiAxXG4gICAgfSkucGlwZShcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IHByZWZpeCA9ICcwJy5yZXBlYXQob3B0LnNlcUxlbik7XG4gICAgICAgIGxldCBuZXh0ID0gMTtcbiAgICAgICAgaWYgKGRhdGEudG90YWwgIT09IDApIHtcbiAgICAgICAgICBjb25zdCBsYXN0ID0gZGF0YS5pdGVtc1swXTtcbiAgICAgICAgICBpZiAobGFzdFtvcHQuc2VxS2V5XSkge1xuICAgICAgICAgICAgbmV4dCA9IHBhcnNlSW50KGxhc3Rbb3B0LnNlcUtleV0ucmVwbGFjZSgvXjArLywgJycpKSArIDE7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIERpYWxvZ1V0aWxzLmVycm9yKCfplJnor68nLCAn5peg5rOV55Sf5oiQ5paw55qE5bqP5YiX5Y+3Jyk7XG4gICAgICAgICAgICB0aHJvd0Vycm9yKCfml6Dms5XnlJ/miJDmlrDnmoTluo/liJflj7cnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2VxID0gKHByZWZpeCArIG5leHQpLnNsaWNlKC1wcmVmaXgubGVuZ3RoKTtcbiAgICAgICAgaWYgKG9wdC53aXRoUGFyZW50ICYmIG9wdC5wYXJlbnQpIHtcbiAgICAgICAgICByZXR1cm4gb3B0LnBhcmVudCArIHNlcTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gc2VxO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBzdGF0aWMgY2hlY2tEaXN0aW5jdChwcm9wczogRGlzdGluY3RWYWx1ZVByb3BzKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgY29uc3QgcmVzdWx0JCA9IEFwaVV0aWxzLmZldGNoKHtcbiAgICAgIC4uLnByb3BzLmFwaVByb3BzLFxuICAgICAgc2l6ZTogMlxuICAgIH0pLnBpcGUoXG4gICAgICBtYXAoKGRhdGEpID0+ICFkYXRhLml0ZW1zIHx8IGRhdGEuaXRlbXMubGVuZ3RoID09PSAwIHx8XG4gICAgICAgIChkYXRhLml0ZW1zLmxlbmd0aCA9PT0gMSAmJiBkYXRhLml0ZW1zWzBdWydpZCddID09PSBwcm9wcy5pZCkpLFxuICAgICAgdGFwKGRpc3RpbmN0ID0+IHtcbiAgICAgICAgaWYgKCFkaXN0aW5jdCkge1xuICAgICAgICAgIERpYWxvZ1V0aWxzLmVycm9yKCfpqozor4HlpLHotKUnLCBg5pWw5YC844CQJHtwcm9wcy5hcGlQcm9wcy5xdWVyeVZhbHVlfeOAkeW3sue7j+WtmOWcqO+8jOivt+S/ruaUueWQjuWGjeaJp+ihjOacrOaTjeS9nO+8gWApO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIHJlc3VsdCQ7XG4gIH1cblxuICBzdGF0aWMgb25Ob2RlU2VsZWN0KGV2ZW50LCBrZXlPclF1ZXJ5KSB7XG4gICAgY29uc3QgdHJlZVByb3BzID0gZXZlbnRbJyRmcm9tJ10uJHByb3BzO1xuICAgIGNvbnN0IHRhYmxlSWQgPSBDb21tb25zVXRpbHMuZ2V0KHRyZWVQcm9wcywgJyRleHQuJGNvbnRhaW5lci50YWJsZS4kaWQnKTtcbiAgICBpZiAodGFibGVJZCkge1xuICAgICAgbGV0IHEgPSBrZXlPclF1ZXJ5O1xuICAgICAgY29uc3Qgbm9kZUNvZGUgPSBldmVudC5ub2RlLmRhdGEgJiYgZXZlbnQubm9kZS5kYXRhLmNvZGU7XG4gICAgICBpZiAobm9kZUNvZGUgJiYgQ29tbW9uc1V0aWxzLmlzU3RyaW5nKGtleU9yUXVlcnkpKSB7XG4gICAgICAgIHEgPSBlc2IucHJlZml4UXVlcnkoa2V5T3JRdWVyeSwgbm9kZUNvZGUpO1xuICAgICAgfVxuICAgICAgU3RhdGVzVXRpbHMudXBkYXRlKHRhYmxlSWQsIDxBcGlQYXlsb2FkPntcbiAgICAgICAgcXVlcnk6IG5vZGVDb2RlID8gcSA6IGVzYi5tYXRjaEFsbFF1ZXJ5KClcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19