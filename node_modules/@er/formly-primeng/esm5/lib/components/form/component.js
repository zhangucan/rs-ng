/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { LogUtils, RouteBindComponent } from '@er/core';
import { FormlyFormComponent } from '@er/formly';
import { CommonsUtils, ConfigUtils, IdUtils } from '@er/utils';
import { of } from 'rxjs';
import { PngFormlyUtils } from '../../utils';
var PngFormlyFormComponent = /** @class */ (function (_super) {
    tslib_1.__extends(PngFormlyFormComponent, _super);
    function PngFormlyFormComponent() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.debug = !!!ConfigUtils.getConfig().isProduction;
        _this.onFormValueChanges = new EventEmitter();
        _this.panelProps = {};
        _this._formProps = {};
        return _this;
    }
    Object.defineProperty(PngFormlyFormComponent.prototype, "props", {
        get: /**
         * @return {?}
         */
        function () {
            return this._props;
        },
        set: /**
         * @param {?} props
         * @return {?}
         */
        function (props) {
            this.panelProps = props['panel'] || {};
            this._props = CommonsUtils.omit(props, 'panel');
            this.initFormProps(this._props);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PngFormlyFormComponent.prototype, "formProps", {
        get: /**
         * @return {?}
         */
        function () {
            return this._formProps || {};
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} event
     * @return {?}
     */
    PngFormlyFormComponent.prototype.formValueChanges = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        if (this.debug) {
            this.formModel$ = of(this.formlyForm.model);
        }
        this.onFormValueChanges.emit(event);
    };
    /**
     * @param {?} props
     * @return {?}
     */
    PngFormlyFormComponent.prototype.beforeRoutePropsBind = /**
     * @param {?} props
     * @return {?}
     */
    function (props) {
        return { props: props };
    };
    /**
     * @param {?} formProps
     * @return {?}
     */
    PngFormlyFormComponent.prototype.resolveFormFields = /**
     * @param {?} formProps
     * @return {?}
     */
    function (formProps) {
        var _this = this;
        if (!formProps || !formProps['fields']) {
            LogUtils.error(this, '没有定义fields!', formProps);
            return;
        }
        formProps.formlyForm = this.formlyForm;
        this.formlyForm.formProps = formProps;
        formProps.fields.forEach(function (field) {
            PngFormlyUtils.resolveField(formProps, field, _this.formlyForm);
        });
    };
    /**
     * @return {?}
     */
    PngFormlyFormComponent.prototype.afterPropsInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @private
     * @param {?} formProps
     * @return {?}
     */
    PngFormlyFormComponent.prototype.initFormProps = /**
     * @private
     * @param {?} formProps
     * @return {?}
     */
    function (formProps) {
        this.resolveFormFields(formProps);
        formProps.$id = IdUtils.getRandom();
        if (formProps.entity) {
            if (!formProps.caption) {
                if (formProps.$routeParams && formProps.$routeParams['id']) {
                    formProps.caption = "\u7F16\u8F91" + formProps.entity.label;
                }
                else {
                    formProps.caption = "\u6DFB\u52A0" + formProps.entity.label;
                }
            }
            if (!formProps.apiEntry) {
                formProps.apiEntry = formProps.entity.apiEntry;
            }
        }
        if (!formProps.apiEntry) {
            LogUtils.warn([this, '没有定义apiEntry,表单不能提交！', formProps]);
        }
        else if (this.formlyForm) {
            this.formlyForm.apiEntry = formProps.apiEntry;
        }
        if (formProps.beforeSubmit) {
            this.beforeSubmit = formProps.beforeSubmit;
            delete formProps.beforeSubmit;
        }
        if (formProps.valueChanges) {
            this.valueChanges = formProps.valueChanges;
            delete formProps.valueChanges;
        }
        if (formProps.afterSubmit) {
            this.afterSubmit = formProps.afterSubmit;
            delete formProps.afterSubmit;
        }
        if (formProps.entity && formProps.entity.initValue) {
            formProps.model = formProps.entity.initValue;
        }
        else {
            formProps.model = {};
        }
        this._formProps = formProps;
        this.afterPropsInit();
    };
    PngFormlyFormComponent.decorators = [
        { type: Component, args: [{
                    selector: 'png-formly-form',
                    template: "\n    <png-panel [showHeader]=\"panelProps['showHeader']\"\n               [header]=\"panelProps['caption']\"\n               [footer]=\"panelProps['footer']\"\n               [icon]=\"panelProps['icon']\"\n               [collapsed]=\"panelProps['collapsed']\"\n               [toggleable]=\"panelProps['collapsable']\"\n               [styleClass]=\"panelProps['panelStyleClass']\"\n               [barStyleClass]=\"panelProps['barStyleClass']\"\n               [style]=\"panelProps['panelStyle']\"\n    >\n      <er-formly-form\n        class=\"my-2\"\n        erPropsBind\n        [props]=\"formProps\"\n        [beforeSubmit]=\"beforeSubmit\"\n        [afterSubmit]=\"afterSubmit\"\n        [valueChanges]=\"valueChanges\"\n        (onFormValueChanges)=\"formValueChanges($event)\"\n      >\n      </er-formly-form>\n    </png-panel>\n    <png-form-debug *ngIf=\"debug\"\n                    [model]=\"formModel$|async\"\n                    [debugFormProps]=\"props\"\n                    [runtimeFormProps]=\"formProps\"\n    >\n    </png-form-debug>\n  "
                }] }
    ];
    PngFormlyFormComponent.propDecorators = {
        debug: [{ type: Input }],
        formlyForm: [{ type: ViewChild, args: [FormlyFormComponent,] }],
        onFormValueChanges: [{ type: Output }],
        props: [{ type: Input }]
    };
    return PngFormlyFormComponent;
}(RouteBindComponent));
export { PngFormlyFormComponent };
if (false) {
    /** @type {?} */
    PngFormlyFormComponent.prototype.debugFormProps;
    /** @type {?} */
    PngFormlyFormComponent.prototype.debug;
    /** @type {?} */
    PngFormlyFormComponent.prototype.formlyForm;
    /** @type {?} */
    PngFormlyFormComponent.prototype.onFormValueChanges;
    /** @type {?} */
    PngFormlyFormComponent.prototype.panelProps;
    /** @type {?} */
    PngFormlyFormComponent.prototype.formModel$;
    /** @type {?} */
    PngFormlyFormComponent.prototype.beforeSubmit;
    /** @type {?} */
    PngFormlyFormComponent.prototype.afterSubmit;
    /** @type {?} */
    PngFormlyFormComponent.prototype.valueChanges;
    /**
     * @type {?}
     * @protected
     */
    PngFormlyFormComponent.prototype._formProps;
    /**
     * @type {?}
     * @protected
     */
    PngFormlyFormComponent.prototype._props;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVyL2Zvcm1seS1wcmltZW5nLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZm9ybS9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNoRixPQUFPLEVBQUMsUUFBUSxFQUFFLGtCQUFrQixFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3RELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLFlBQVksQ0FBQztBQUUvQyxPQUFPLEVBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDN0QsT0FBTyxFQUFhLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBRTNDO0lBaUM0QyxrREFBa0I7SUFqQzlEO1FBQUEscUVBd0pDO1FBbkhVLFdBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsWUFBWSxDQUFDO1FBSS9DLHdCQUFrQixHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRXJFLGdCQUFVLEdBQUcsRUFBRSxDQUFDO1FBVU4sZ0JBQVUsR0FBYyxFQUFFLENBQUM7O0lBbUd2QyxDQUFDO0lBL0ZDLHNCQUNJLHlDQUFLOzs7O1FBRFQ7WUFFRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDckIsQ0FBQzs7Ozs7UUFFRCxVQUFVLEtBQUs7WUFDYixJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNo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LENBQUM7WUFDM0MsT0FBTyxTQUFTLENBQUMsWUFBWSxDQUFDO1NBQy9CO1FBRUQsSUFBSSxTQUFTLENBQUMsV0FBVyxFQUFFO1lBQ3pCLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQztZQUN6QyxPQUFPLFNBQVMsQ0FBQyxXQUFXLENBQUM7U0FDOUI7UUFFRCxJQUFJLFNBQVMsQ0FBQyxNQUFNLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDbEQsU0FBUyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztTQUM5QzthQUFNO1lBQ0wsU0FBUyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7U0FDdEI7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUU1QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDeEIsQ0FBQzs7Z0JBdEpGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsaUJBQWlCO29CQUMzQixRQUFRLEVBQUUsdWlDQTRCVDtpQkFDRjs7O3dCQU1FLEtBQUs7NkJBRUwsU0FBUyxTQUFDLG1CQUFtQjtxQ0FFN0IsTUFBTTt3QkFnQk4sS0FBSzs7SUErRlIsNkJBQUM7Q0FBQSxBQXhKRCxDQWlDNEMsa0JBQWtCLEdBdUg3RDtTQXZIWSxzQkFBc0I7OztJQUVqQyxnREFBMEI7O0lBRTFCLHVDQUF5RDs7SUFFekQsNENBQWdFOztJQUVoRSxvREFBcUU7O0lBRXJFLDRDQUFnQjs7SUFFaEIsNENBQTRCOztJQUU1Qiw4Q0FBb0I7O0lBRXBCLDZDQUFtQjs7SUFFbkIsOENBQW9COzs7OztJQUVwQiw0Q0FBcUM7Ozs7O0lBRXJDLHdDQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0xvZ1V0aWxzLCBSb3V0ZUJpbmRDb21wb25lbnR9IGZyb20gJ0Blci9jb3JlJztcbmltcG9ydCB7Rm9ybWx5Rm9ybUNvbXBvbmVudH0gZnJvbSAnQGVyL2Zvcm1seSc7XG5pbXBvcnQge0Zvcm1Qcm9wc30gZnJvbSAnQGVyL3R5cGVzJztcbmltcG9ydCB7Q29tbW9uc1V0aWxzLCBDb25maWdVdGlscywgSWRVdGlsc30gZnJvbSAnQGVyL3V0aWxzJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtQbmdGb3JtbHlVdGlsc30gZnJvbSAnLi4vLi4vdXRpbHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwbmctZm9ybWx5LWZvcm0nLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxwbmctcGFuZWwgW3Nob3dIZWFkZXJdPVwicGFuZWxQcm9wc1snc2hvd0hlYWRlciddXCJcbiAgICAgICAgICAgICAgIFtoZWFkZXJdPVwicGFuZWxQcm9wc1snY2FwdGlvbiddXCJcbiAgICAgICAgICAgICAgIFtmb290ZXJdPVwicGFuZWxQcm9wc1snZm9vdGVyJ11cIlxuICAgICAgICAgICAgICAgW2ljb25dPVwicGFuZWxQcm9wc1snaWNvbiddXCJcbiAgICAgICAgICAgICAgIFtjb2xsYXBzZWRdPVwicGFuZWxQcm9wc1snY29sbGFwc2VkJ11cIlxuICAgICAgICAgICAgICAgW3RvZ2dsZWFibGVdPVwicGFuZWxQcm9wc1snY29sbGFwc2FibGUnXVwiXG4gICAgICAgICAgICAgICBbc3R5bGVDbGFzc109XCJwYW5lbFByb3BzWydwYW5lbFN0eWxlQ2xhc3MnXVwiXG4gICAgICAgICAgICAgICBbYmFyU3R5bGVDbGFzc109XCJwYW5lbFByb3BzWydiYXJTdHlsZUNsYXNzJ11cIlxuICAgICAgICAgICAgICAgW3N0eWxlXT1cInBhbmVsUHJvcHNbJ3BhbmVsU3R5bGUnXVwiXG4gICAgPlxuICAgICAgPGVyLWZvcm1seS1mb3JtXG4gICAgICAgIGNsYXNzPVwibXktMlwiXG4gICAgICAgIGVyUHJvcHNCaW5kXG4gICAgICAgIFtwcm9wc109XCJmb3JtUHJvcHNcIlxuICAgICAgICBbYmVmb3JlU3VibWl0XT1cImJlZm9yZVN1Ym1pdFwiXG4gICAgICAgIFthZnRlclN1Ym1pdF09XCJhZnRlclN1Ym1pdFwiXG4gICAgICAgIFt2YWx1ZUNoYW5nZXNdPVwidmFsdWVDaGFuZ2VzXCJcbiAgICAgICAgKG9uRm9ybVZhbHVlQ2hhbmdlcyk9XCJmb3JtVmFsdWVDaGFuZ2VzKCRldmVudClcIlxuICAgICAgPlxuICAgICAgPC9lci1mb3JtbHktZm9ybT5cbiAgICA8L3BuZy1wYW5lbD5cbiAgICA8cG5nLWZvcm0tZGVidWcgKm5nSWY9XCJkZWJ1Z1wiXG4gICAgICAgICAgICAgICAgICAgIFttb2RlbF09XCJmb3JtTW9kZWwkfGFzeW5jXCJcbiAgICAgICAgICAgICAgICAgICAgW2RlYnVnRm9ybVByb3BzXT1cInByb3BzXCJcbiAgICAgICAgICAgICAgICAgICAgW3J1bnRpbWVGb3JtUHJvcHNdPVwiZm9ybVByb3BzXCJcbiAgICA+XG4gICAgPC9wbmctZm9ybS1kZWJ1Zz5cbiAgYFxufSlcblxuZXhwb3J0IGNsYXNzIFBuZ0Zvcm1seUZvcm1Db21wb25lbnQgZXh0ZW5kcyBSb3V0ZUJpbmRDb21wb25lbnQge1xuXG4gIGRlYnVnRm9ybVByb3BzOiBGb3JtUHJvcHM7XG5cbiAgQElucHV0KCkgZGVidWcgPSAhISFDb25maWdVdGlscy5nZXRDb25maWcoKS5pc1Byb2R1Y3Rpb247XG5cbiAgQFZpZXdDaGlsZChGb3JtbHlGb3JtQ29tcG9uZW50KSBmb3JtbHlGb3JtOiBGb3JtbHlGb3JtQ29tcG9uZW50O1xuXG4gIEBPdXRwdXQoKSBvbkZvcm1WYWx1ZUNoYW5nZXM6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHBhbmVsUHJvcHMgPSB7fTtcblxuICBmb3JtTW9kZWwkOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgcHVibGljIGJlZm9yZVN1Ym1pdDtcblxuICBwdWJsaWMgYWZ0ZXJTdWJtaXQ7XG5cbiAgcHVibGljIHZhbHVlQ2hhbmdlcztcblxuICBwcm90ZWN0ZWQgX2Zvcm1Qcm9wczogRm9ybVByb3BzID0ge307XG5cbiAgcHJvdGVjdGVkIF9wcm9wczoge307XG5cbiAgQElucHV0KClcbiAgZ2V0IHByb3BzKCkge1xuICAgIHJldHVybiB0aGlzLl9wcm9wcztcbiAgfVxuXG4gIHNldCBwcm9wcyhwcm9wcykge1xuICAgIHRoaXMucGFuZWxQcm9wcyA9IHByb3BzWydwYW5lbCddIHx8IHt9O1xuICAgIHRoaXMuX3Byb3BzID0gQ29tbW9uc1V0aWxzLm9taXQocHJvcHMsICdwYW5lbCcpO1xuICAgIHRoaXMuaW5pdEZvcm1Qcm9wcyh0aGlzLl9wcm9wcyk7XG4gIH1cblxuICBnZXQgZm9ybVByb3BzKCk6IEZvcm1Qcm9wcyB7XG4gICAgcmV0dXJuIHRoaXMuX2Zvcm1Qcm9wcyB8fCB7fTtcbiAgfVxuXG4gIGZvcm1WYWx1ZUNoYW5nZXMoZXZlbnQpIHtcbiAgICBpZiAodGhpcy5kZWJ1Zykge1xuICAgICAgdGhpcy5mb3JtTW9kZWwkID0gb2YodGhpcy5mb3JtbHlGb3JtLm1vZGVsKTtcbiAgICB9XG4gICAgdGhpcy5vbkZvcm1WYWx1ZUNoYW5nZXMuZW1pdChldmVudCk7XG4gIH1cblxuICBiZWZvcmVSb3V0ZVByb3BzQmluZChwcm9wcyk6IHt9IHtcbiAgICByZXR1cm4ge3Byb3BzOiBwcm9wc307XG4gIH1cblxuICByZXNvbHZlRm9ybUZpZWxkcyhmb3JtUHJvcHM6IEZvcm1Qcm9wcykge1xuICAgIGlmICghZm9ybVByb3BzIHx8ICFmb3JtUHJvcHNbJ2ZpZWxkcyddKSB7XG4gICAgICBMb2dVdGlscy5lcnJvcih0aGlzLCAn5rKh5pyJ5a6a5LmJZmllbGRzIScsIGZvcm1Qcm9wcyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9ybVByb3BzLmZvcm1seUZvcm0gPSB0aGlzLmZvcm1seUZvcm07XG5cbiAgICB0aGlzLmZvcm1seUZvcm0uZm9ybVByb3BzID0gZm9ybVByb3BzO1xuXG4gICAgZm9ybVByb3BzLmZpZWxkcy5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgIFBuZ0Zvcm1seVV0aWxzLnJlc29sdmVGaWVsZChmb3JtUHJvcHMsIGZpZWxkLCB0aGlzLmZvcm1seUZvcm0pO1xuICAgIH0pO1xuICB9XG5cbiAgYWZ0ZXJQcm9wc0luaXQoKSB7XG4gIH1cblxuICBwcml2YXRlIGluaXRGb3JtUHJvcHMoZm9ybVByb3BzKSB7XG5cbiAgICB0aGlzLnJlc29sdmVGb3JtRmllbGRzKGZvcm1Qcm9wcyk7XG5cbiAgICBmb3JtUHJvcHMuJGlkID0gSWRVdGlscy5nZXRSYW5kb20oKTtcblxuICAgIGlmIChmb3JtUHJvcHMuZW50aXR5KSB7XG4gICAgICBpZiAoIWZvcm1Qcm9wcy5jYXB0aW9uKSB7XG4gICAgICAgIGlmIChmb3JtUHJvcHMuJHJvdXRlUGFyYW1zICYmIGZvcm1Qcm9wcy4kcm91dGVQYXJhbXNbJ2lkJ10pIHtcbiAgICAgICAgICBmb3JtUHJvcHMuY2FwdGlvbiA9IGDnvJbovpEke2Zvcm1Qcm9wcy5lbnRpdHkubGFiZWx9YDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmb3JtUHJvcHMuY2FwdGlvbiA9IGDmt7vliqAke2Zvcm1Qcm9wcy5lbnRpdHkubGFiZWx9YDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmb3JtUHJvcHMuYXBpRW50cnkpIHtcbiAgICAgICAgZm9ybVByb3BzLmFwaUVudHJ5ID0gZm9ybVByb3BzLmVudGl0eS5hcGlFbnRyeTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWZvcm1Qcm9wcy5hcGlFbnRyeSkge1xuICAgICAgTG9nVXRpbHMud2FybihbdGhpcywgJ+ayoeacieWumuS5iWFwaUVudHJ5LOihqOWNleS4jeiDveaPkOS6pO+8gScsIGZvcm1Qcm9wc10pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5mb3JtbHlGb3JtKSB7XG4gICAgICB0aGlzLmZvcm1seUZvcm0uYXBpRW50cnkgPSBmb3JtUHJvcHMuYXBpRW50cnk7XG4gICAgfVxuXG4gICAgaWYgKGZvcm1Qcm9wcy5iZWZvcmVTdWJtaXQpIHtcbiAgICAgIHRoaXMuYmVmb3JlU3VibWl0ID0gZm9ybVByb3BzLmJlZm9yZVN1Ym1pdDtcbiAgICAgIGRlbGV0ZSBmb3JtUHJvcHMuYmVmb3JlU3VibWl0O1xuICAgIH1cblxuICAgIGlmIChmb3JtUHJvcHMudmFsdWVDaGFuZ2VzKSB7XG4gICAgICB0aGlzLnZhbHVlQ2hhbmdlcyA9IGZvcm1Qcm9wcy52YWx1ZUNoYW5nZXM7XG4gICAgICBkZWxldGUgZm9ybVByb3BzLnZhbHVlQ2hhbmdlcztcbiAgICB9XG5cbiAgICBpZiAoZm9ybVByb3BzLmFmdGVyU3VibWl0KSB7XG4gICAgICB0aGlzLmFmdGVyU3VibWl0ID0gZm9ybVByb3BzLmFmdGVyU3VibWl0O1xuICAgICAgZGVsZXRlIGZvcm1Qcm9wcy5hZnRlclN1Ym1pdDtcbiAgICB9XG5cbiAgICBpZiAoZm9ybVByb3BzLmVudGl0eSAmJiBmb3JtUHJvcHMuZW50aXR5LmluaXRWYWx1ZSkge1xuICAgICAgZm9ybVByb3BzLm1vZGVsID0gZm9ybVByb3BzLmVudGl0eS5pbml0VmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvcm1Qcm9wcy5tb2RlbCA9IHt9O1xuICAgIH1cblxuICAgIHRoaXMuX2Zvcm1Qcm9wcyA9IGZvcm1Qcm9wcztcblxuICAgIHRoaXMuYWZ0ZXJQcm9wc0luaXQoKTtcbiAgfVxuXG59XG4iXX0=