/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { LogUtils, RouteBindComponent } from '@er/core';
import { FormlyFormComponent } from '@er/formly';
import { CommonsUtils, ConfigUtils, IdUtils } from '@er/utils';
import { of } from 'rxjs';
import { PngFormlyUtils } from '../../utils';
export class PngFormlyFormComponent extends RouteBindComponent {
    constructor() {
        super(...arguments);
        this.debug = !!!ConfigUtils.getConfig().isProduction;
        this.onFormValueChanges = new EventEmitter();
        this.panelProps = {};
        this._formProps = {};
    }
    /**
     * @return {?}
     */
    get props() {
        return this._props;
    }
    /**
     * @param {?} props
     * @return {?}
     */
    set props(props) {
        this.panelProps = props['panel'] || {};
        this._props = CommonsUtils.omit(props, 'panel');
        this.initFormProps(this._props);
    }
    /**
     * @return {?}
     */
    get formProps() {
        return this._formProps || {};
    }
    /**
     * @param {?} event
     * @return {?}
     */
    formValueChanges(event) {
        if (this.debug) {
            this.formModel$ = of(this.formlyForm.model);
        }
        this.onFormValueChanges.emit(event);
    }
    /**
     * @param {?} props
     * @return {?}
     */
    beforeRoutePropsBind(props) {
        return { props: props };
    }
    /**
     * @param {?} formProps
     * @return {?}
     */
    resolveFormFields(formProps) {
        if (!formProps || !formProps['fields']) {
            LogUtils.error(this, '没有定义fields!', formProps);
            return;
        }
        formProps.formlyForm = this.formlyForm;
        this.formlyForm.formProps = formProps;
        formProps.fields.forEach(field => {
            PngFormlyUtils.resolveField(formProps, field, this.formlyForm);
        });
    }
    /**
     * @return {?}
     */
    afterPropsInit() {
    }
    /**
     * @private
     * @param {?} formProps
     * @return {?}
     */
    initFormProps(formProps) {
        this.resolveFormFields(formProps);
        formProps.$id = IdUtils.getRandom();
        if (formProps.entity) {
            if (!formProps.caption) {
                if (formProps.$routeParams && formProps.$routeParams['id']) {
                    formProps.caption = `编辑${formProps.entity.label}`;
                }
                else {
                    formProps.caption = `添加${formProps.entity.label}`;
                }
            }
            if (!formProps.apiEntry) {
                formProps.apiEntry = formProps.entity.apiEntry;
            }
        }
        if (!formProps.apiEntry) {
            LogUtils.warn([this, '没有定义apiEntry,表单不能提交！', formProps]);
        }
        else if (this.formlyForm) {
            this.formlyForm.apiEntry = formProps.apiEntry;
        }
        if (formProps.beforeSubmit) {
            this.beforeSubmit = formProps.beforeSubmit;
            delete formProps.beforeSubmit;
        }
        if (formProps.valueChanges) {
            this.valueChanges = formProps.valueChanges;
            delete formProps.valueChanges;
        }
        if (formProps.afterSubmit) {
            this.afterSubmit = formProps.afterSubmit;
            delete formProps.afterSubmit;
        }
        if (formProps.entity && formProps.entity.initValue) {
            formProps.model = formProps.entity.initValue;
        }
        else {
            formProps.model = {};
        }
        this._formProps = formProps;
        this.afterPropsInit();
    }
}
PngFormlyFormComponent.decorators = [
    { type: Component, args: [{
                selector: 'png-formly-form',
                template: `
    <png-panel [showHeader]="panelProps['showHeader']"
               [header]="panelProps['caption']"
               [footer]="panelProps['footer']"
               [icon]="panelProps['icon']"
               [collapsed]="panelProps['collapsed']"
               [toggleable]="panelProps['collapsable']"
               [styleClass]="panelProps['panelStyleClass']"
               [barStyleClass]="panelProps['barStyleClass']"
               [style]="panelProps['panelStyle']"
    >
      <er-formly-form
        class="my-2"
        erPropsBind
        [props]="formProps"
        [beforeSubmit]="beforeSubmit"
        [afterSubmit]="afterSubmit"
        [valueChanges]="valueChanges"
        (onFormValueChanges)="formValueChanges($event)"
      >
      </er-formly-form>
    </png-panel>
    <png-form-debug *ngIf="debug"
                    [model]="formModel$|async"
                    [debugFormProps]="props"
                    [runtimeFormProps]="formProps"
    >
    </png-form-debug>
  `
            }] }
];
PngFormlyFormComponent.propDecorators = {
    debug: [{ type: Input }],
    formlyForm: [{ type: ViewChild, args: [FormlyFormComponent,] }],
    onFormValueChanges: [{ type: Output }],
    props: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    PngFormlyFormComponent.prototype.debugFormProps;
    /** @type {?} */
    PngFormlyFormComponent.prototype.debug;
    /** @type {?} */
    PngFormlyFormComponent.prototype.formlyForm;
    /** @type {?} */
    PngFormlyFormComponent.prototype.onFormValueChanges;
    /** @type {?} */
    PngFormlyFormComponent.prototype.panelProps;
    /** @type {?} */
    PngFormlyFormComponent.prototype.formModel$;
    /** @type {?} */
    PngFormlyFormComponent.prototype.beforeSubmit;
    /** @type {?} */
    PngFormlyFormComponent.prototype.afterSubmit;
    /** @type {?} */
    PngFormlyFormComponent.prototype.valueChanges;
    /**
     * @type {?}
     * @protected
     */
    PngFormlyFormComponent.prototype._formProps;
    /**
     * @type {?}
     * @protected
     */
    PngFormlyFormComponent.prototype._props;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVyL2Zvcm1seS1wcmltZW5nLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZm9ybS9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2hGLE9BQU8sRUFBQyxRQUFRLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDdEQsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sWUFBWSxDQUFDO0FBRS9DLE9BQU8sRUFBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUM3RCxPQUFPLEVBQWEsRUFBRSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFtQzNDLE1BQU0sT0FBTyxzQkFBdUIsU0FBUSxrQkFBa0I7SUFqQzlEOztRQXFDVyxVQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDLFlBQVksQ0FBQztRQUkvQyx1QkFBa0IsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVyRSxlQUFVLEdBQUcsRUFBRSxDQUFDO1FBVU4sZUFBVSxHQUFjLEVBQUUsQ0FBQztJQW1HdkMsQ0FBQzs7OztJQS9GQyxJQUNJLEtBQUs7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQzs7Ozs7SUFFRCxJQUFJLEtBQUssQ0FBQyxLQUFLO1FBQ2IsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7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QVcsRUFBRTtZQUN6QixJQUFJLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUM7WUFDekMsT0FBTyxTQUFTLENBQUMsV0FBVyxDQUFDO1NBQzlCO1FBRUQsSUFBSSxTQUFTLENBQUMsTUFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFO1lBQ2xELFNBQVMsQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7U0FDOUM7YUFBTTtZQUNMLFNBQVMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1NBQ3RCO1FBRUQsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFFNUIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hCLENBQUM7OztZQXRKRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGlCQUFpQjtnQkFDM0IsUUFBUSxFQUFFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBNEJUO2FBQ0Y7OztvQkFNRSxLQUFLO3lCQUVMLFNBQVMsU0FBQyxtQkFBbUI7aUNBRTdCLE1BQU07b0JBZ0JOLEtBQUs7Ozs7SUF0Qk4sZ0RBQTBCOztJQUUxQix1Q0FBeUQ7O0lBRXpELDRDQUFnRTs7SUFFaEUsb0RBQXFFOztJQUVyRSw0Q0FBZ0I7O0lBRWhCLDRDQUE0Qjs7SUFFNUIsOENBQW9COztJQUVwQiw2Q0FBbUI7O0lBRW5CLDhDQUFvQjs7Ozs7SUFFcEIsNENBQXFDOzs7OztJQUVyQyx3Q0FBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtMb2dVdGlscywgUm91dGVCaW5kQ29tcG9uZW50fSBmcm9tICdAZXIvY29yZSc7XG5pbXBvcnQge0Zvcm1seUZvcm1Db21wb25lbnR9IGZyb20gJ0Blci9mb3JtbHknO1xuaW1wb3J0IHtGb3JtUHJvcHN9IGZyb20gJ0Blci90eXBlcyc7XG5pbXBvcnQge0NvbW1vbnNVdGlscywgQ29uZmlnVXRpbHMsIElkVXRpbHN9IGZyb20gJ0Blci91dGlscyc7XG5pbXBvcnQge09ic2VydmFibGUsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7UG5nRm9ybWx5VXRpbHN9IGZyb20gJy4uLy4uL3V0aWxzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG5nLWZvcm1seS1mb3JtJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8cG5nLXBhbmVsIFtzaG93SGVhZGVyXT1cInBhbmVsUHJvcHNbJ3Nob3dIZWFkZXInXVwiXG4gICAgICAgICAgICAgICBbaGVhZGVyXT1cInBhbmVsUHJvcHNbJ2NhcHRpb24nXVwiXG4gICAgICAgICAgICAgICBbZm9vdGVyXT1cInBhbmVsUHJvcHNbJ2Zvb3RlciddXCJcbiAgICAgICAgICAgICAgIFtpY29uXT1cInBhbmVsUHJvcHNbJ2ljb24nXVwiXG4gICAgICAgICAgICAgICBbY29sbGFwc2VkXT1cInBhbmVsUHJvcHNbJ2NvbGxhcHNlZCddXCJcbiAgICAgICAgICAgICAgIFt0b2dnbGVhYmxlXT1cInBhbmVsUHJvcHNbJ2NvbGxhcHNhYmxlJ11cIlxuICAgICAgICAgICAgICAgW3N0eWxlQ2xhc3NdPVwicGFuZWxQcm9wc1sncGFuZWxTdHlsZUNsYXNzJ11cIlxuICAgICAgICAgICAgICAgW2JhclN0eWxlQ2xhc3NdPVwicGFuZWxQcm9wc1snYmFyU3R5bGVDbGFzcyddXCJcbiAgICAgICAgICAgICAgIFtzdHlsZV09XCJwYW5lbFByb3BzWydwYW5lbFN0eWxlJ11cIlxuICAgID5cbiAgICAgIDxlci1mb3JtbHktZm9ybVxuICAgICAgICBjbGFzcz1cIm15LTJcIlxuICAgICAgICBlclByb3BzQmluZFxuICAgICAgICBbcHJvcHNdPVwiZm9ybVByb3BzXCJcbiAgICAgICAgW2JlZm9yZVN1Ym1pdF09XCJiZWZvcmVTdWJtaXRcIlxuICAgICAgICBbYWZ0ZXJTdWJtaXRdPVwiYWZ0ZXJTdWJtaXRcIlxuICAgICAgICBbdmFsdWVDaGFuZ2VzXT1cInZhbHVlQ2hhbmdlc1wiXG4gICAgICAgIChvbkZvcm1WYWx1ZUNoYW5nZXMpPVwiZm9ybVZhbHVlQ2hhbmdlcygkZXZlbnQpXCJcbiAgICAgID5cbiAgICAgIDwvZXItZm9ybWx5LWZvcm0+XG4gICAgPC9wbmctcGFuZWw+XG4gICAgPHBuZy1mb3JtLWRlYnVnICpuZ0lmPVwiZGVidWdcIlxuICAgICAgICAgICAgICAgICAgICBbbW9kZWxdPVwiZm9ybU1vZGVsJHxhc3luY1wiXG4gICAgICAgICAgICAgICAgICAgIFtkZWJ1Z0Zvcm1Qcm9wc109XCJwcm9wc1wiXG4gICAgICAgICAgICAgICAgICAgIFtydW50aW1lRm9ybVByb3BzXT1cImZvcm1Qcm9wc1wiXG4gICAgPlxuICAgIDwvcG5nLWZvcm0tZGVidWc+XG4gIGBcbn0pXG5cbmV4cG9ydCBjbGFzcyBQbmdGb3JtbHlGb3JtQ29tcG9uZW50IGV4dGVuZHMgUm91dGVCaW5kQ29tcG9uZW50IHtcblxuICBkZWJ1Z0Zvcm1Qcm9wczogRm9ybVByb3BzO1xuXG4gIEBJbnB1dCgpIGRlYnVnID0gISEhQ29uZmlnVXRpbHMuZ2V0Q29uZmlnKCkuaXNQcm9kdWN0aW9uO1xuXG4gIEBWaWV3Q2hpbGQoRm9ybWx5Rm9ybUNvbXBvbmVudCkgZm9ybWx5Rm9ybTogRm9ybWx5Rm9ybUNvbXBvbmVudDtcblxuICBAT3V0cHV0KCkgb25Gb3JtVmFsdWVDaGFuZ2VzOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwYW5lbFByb3BzID0ge307XG5cbiAgZm9ybU1vZGVsJDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gIHB1YmxpYyBiZWZvcmVTdWJtaXQ7XG5cbiAgcHVibGljIGFmdGVyU3VibWl0O1xuXG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM7XG5cbiAgcHJvdGVjdGVkIF9mb3JtUHJvcHM6IEZvcm1Qcm9wcyA9IHt9O1xuXG4gIHByb3RlY3RlZCBfcHJvcHM6IHt9O1xuXG4gIEBJbnB1dCgpXG4gIGdldCBwcm9wcygpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvcHM7XG4gIH1cblxuICBzZXQgcHJvcHMocHJvcHMpIHtcbiAgICB0aGlzLnBhbmVsUHJvcHMgPSBwcm9wc1sncGFuZWwnXSB8fCB7fTtcbiAgICB0aGlzLl9wcm9wcyA9IENvbW1vbnNVdGlscy5vbWl0KHByb3BzLCAncGFuZWwnKTtcbiAgICB0aGlzLmluaXRGb3JtUHJvcHModGhpcy5fcHJvcHMpO1xuICB9XG5cbiAgZ2V0IGZvcm1Qcm9wcygpOiBGb3JtUHJvcHMge1xuICAgIHJldHVybiB0aGlzLl9mb3JtUHJvcHMgfHwge307XG4gIH1cblxuICBmb3JtVmFsdWVDaGFuZ2VzKGV2ZW50KSB7XG4gICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgIHRoaXMuZm9ybU1vZGVsJCA9IG9mKHRoaXMuZm9ybWx5Rm9ybS5tb2RlbCk7XG4gICAgfVxuICAgIHRoaXMub25Gb3JtVmFsdWVDaGFuZ2VzLmVtaXQoZXZlbnQpO1xuICB9XG5cbiAgYmVmb3JlUm91dGVQcm9wc0JpbmQocHJvcHMpOiB7fSB7XG4gICAgcmV0dXJuIHtwcm9wczogcHJvcHN9O1xuICB9XG5cbiAgcmVzb2x2ZUZvcm1GaWVsZHMoZm9ybVByb3BzOiBGb3JtUHJvcHMpIHtcbiAgICBpZiAoIWZvcm1Qcm9wcyB8fCAhZm9ybVByb3BzWydmaWVsZHMnXSkge1xuICAgICAgTG9nVXRpbHMuZXJyb3IodGhpcywgJ+ayoeacieWumuS5iWZpZWxkcyEnLCBmb3JtUHJvcHMpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvcm1Qcm9wcy5mb3JtbHlGb3JtID0gdGhpcy5mb3JtbHlGb3JtO1xuXG4gICAgdGhpcy5mb3JtbHlGb3JtLmZvcm1Qcm9wcyA9IGZvcm1Qcm9wcztcblxuICAgIGZvcm1Qcm9wcy5maWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICBQbmdGb3JtbHlVdGlscy5yZXNvbHZlRmllbGQoZm9ybVByb3BzLCBmaWVsZCwgdGhpcy5mb3JtbHlGb3JtKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFmdGVyUHJvcHNJbml0KCkge1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Rm9ybVByb3BzKGZvcm1Qcm9wcykge1xuXG4gICAgdGhpcy5yZXNvbHZlRm9ybUZpZWxkcyhmb3JtUHJvcHMpO1xuXG4gICAgZm9ybVByb3BzLiRpZCA9IElkVXRpbHMuZ2V0UmFuZG9tKCk7XG5cbiAgICBpZiAoZm9ybVByb3BzLmVudGl0eSkge1xuICAgICAgaWYgKCFmb3JtUHJvcHMuY2FwdGlvbikge1xuICAgICAgICBpZiAoZm9ybVByb3BzLiRyb3V0ZVBhcmFtcyAmJiBmb3JtUHJvcHMuJHJvdXRlUGFyYW1zWydpZCddKSB7XG4gICAgICAgICAgZm9ybVByb3BzLmNhcHRpb24gPSBg57yW6L6RJHtmb3JtUHJvcHMuZW50aXR5LmxhYmVsfWA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZm9ybVByb3BzLmNhcHRpb24gPSBg5re75YqgJHtmb3JtUHJvcHMuZW50aXR5LmxhYmVsfWA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZm9ybVByb3BzLmFwaUVudHJ5KSB7XG4gICAgICAgIGZvcm1Qcm9wcy5hcGlFbnRyeSA9IGZvcm1Qcm9wcy5lbnRpdHkuYXBpRW50cnk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFmb3JtUHJvcHMuYXBpRW50cnkpIHtcbiAgICAgIExvZ1V0aWxzLndhcm4oW3RoaXMsICfmsqHmnInlrprkuYlhcGlFbnRyeSzooajljZXkuI3og73mj5DkuqTvvIEnLCBmb3JtUHJvcHNdKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZm9ybWx5Rm9ybSkge1xuICAgICAgdGhpcy5mb3JtbHlGb3JtLmFwaUVudHJ5ID0gZm9ybVByb3BzLmFwaUVudHJ5O1xuICAgIH1cblxuICAgIGlmIChmb3JtUHJvcHMuYmVmb3JlU3VibWl0KSB7XG4gICAgICB0aGlzLmJlZm9yZVN1Ym1pdCA9IGZvcm1Qcm9wcy5iZWZvcmVTdWJtaXQ7XG4gICAgICBkZWxldGUgZm9ybVByb3BzLmJlZm9yZVN1Ym1pdDtcbiAgICB9XG5cbiAgICBpZiAoZm9ybVByb3BzLnZhbHVlQ2hhbmdlcykge1xuICAgICAgdGhpcy52YWx1ZUNoYW5nZXMgPSBmb3JtUHJvcHMudmFsdWVDaGFuZ2VzO1xuICAgICAgZGVsZXRlIGZvcm1Qcm9wcy52YWx1ZUNoYW5nZXM7XG4gICAgfVxuXG4gICAgaWYgKGZvcm1Qcm9wcy5hZnRlclN1Ym1pdCkge1xuICAgICAgdGhpcy5hZnRlclN1Ym1pdCA9IGZvcm1Qcm9wcy5hZnRlclN1Ym1pdDtcbiAgICAgIGRlbGV0ZSBmb3JtUHJvcHMuYWZ0ZXJTdWJtaXQ7XG4gICAgfVxuXG4gICAgaWYgKGZvcm1Qcm9wcy5lbnRpdHkgJiYgZm9ybVByb3BzLmVudGl0eS5pbml0VmFsdWUpIHtcbiAgICAgIGZvcm1Qcm9wcy5tb2RlbCA9IGZvcm1Qcm9wcy5lbnRpdHkuaW5pdFZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3JtUHJvcHMubW9kZWwgPSB7fTtcbiAgICB9XG5cbiAgICB0aGlzLl9mb3JtUHJvcHMgPSBmb3JtUHJvcHM7XG5cbiAgICB0aGlzLmFmdGVyUHJvcHNJbml0KCk7XG4gIH1cblxufVxuIl19