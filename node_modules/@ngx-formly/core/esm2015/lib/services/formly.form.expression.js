/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { FormGroup, FormArray } from '@angular/forms';
import { evalExpression, FORMLY_VALIDATORS, getFieldModel, isObject, getKeyPath, isNullOrUndefined } from '../utils';
/**
 * \@internal
 */
export class FormlyFormExpression {
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    checkFields(form, fields = [], model, options) {
        this._checkFields(form, fields, model, options);
    }
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    _checkFields(form, fields = [], model, options) {
        fields.forEach(field => {
            this.checkFieldExpressionChange(form, field, this.getParentModel(model, field), options);
            this.checkFieldVisibilityChange(form, field, this.getParentModel(model, field), options);
            if (field.fieldGroup && field.fieldGroup.length > 0) {
                this._checkFields(field.formControl ? /** @type {?} */ (field.formControl) : form, field.fieldGroup, this.getParentModel(model, field), options);
            }
        });
    }
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} options
     * @return {?}
     */
    checkFieldExpressionChange(form, field, model, options) {
        if (!field || !field.expressionProperties) {
            return;
        }
        const /** @type {?} */ expressionProperties = field.expressionProperties;
        const /** @type {?} */ validators = FORMLY_VALIDATORS.map(v => `templateOptions.${v}`);
        for (const /** @type {?} */ key in expressionProperties) {
            const /** @type {?} */ expressionValue = evalExpression(expressionProperties[key].expression, { field }, [model, options.formState]);
            if (expressionProperties[key].expressionValue !== expressionValue
                && (!isObject(expressionValue) || JSON.stringify(expressionValue) !== JSON.stringify(expressionProperties[key].expressionValue))) {
                expressionProperties[key].expressionValue = expressionValue;
                evalExpression(expressionProperties[key].expressionValueSetter, { field }, [expressionValue, model, field]);
                if (key.indexOf('model.') === 0) {
                    const /** @type {?} */ path = key.replace(/^model\./, ''), /** @type {?} */
                    control = field.key && key === path ? field.formControl : form.get(path);
                    if (control
                        && !(isNullOrUndefined(control.value) && isNullOrUndefined(expressionValue))
                        && control.value !== expressionValue) {
                        control.patchValue(expressionValue);
                    }
                }
                if (validators.indexOf(key) !== -1 && field.formControl) {
                    field.formControl.updateValueAndValidity({ emitEvent: false });
                }
            }
        }
    }
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} options
     * @return {?}
     */
    checkFieldVisibilityChange(form, field, model, options) {
        if (!field || isNullOrUndefined(field.hideExpression)) {
            return;
        }
        const /** @type {?} */ hideExpressionResult = !!evalExpression(field.hideExpression, { field }, [model, options.formState]);
        if (hideExpressionResult !== field.hide) {
            // toggle hide
            field.hide = hideExpressionResult;
            field.templateOptions.hidden = hideExpressionResult;
            if (field.formControl && field.key) {
                const /** @type {?} */ parent = this.fieldParentFormControl(form, field);
                if (parent) {
                    const /** @type {?} */ control = parent.get(`${this.fieldKey(field)}`);
                    if (hideExpressionResult === true && control) {
                        this.removeFieldControl(parent, field);
                    }
                    else if (hideExpressionResult === false && !control) {
                        this.addFieldControl(parent, field, model);
                    }
                }
            }
            if (options.fieldChanges) {
                options.fieldChanges.next(/** @type {?} */ ({ field: field, type: 'hidden', value: hideExpressionResult }));
            }
        }
    }
    /**
     * @param {?} parent
     * @param {?} field
     * @param {?} model
     * @return {?}
     */
    addFieldControl(parent, field, model) {
        const /** @type {?} */ fieldModel = this.getFieldModel(model, field);
        if (!(isNullOrUndefined(field.formControl.value) && isNullOrUndefined(fieldModel))
            && field.formControl.value !== fieldModel) {
            field.formControl.patchValue(fieldModel, { emitEvent: false });
        }
        if (parent instanceof FormArray) {
            parent.push(field.formControl);
        }
        else if (parent instanceof FormGroup) {
            parent.addControl(`${this.fieldKey(field)}`, field.formControl);
        }
    }
    /**
     * @param {?} model
     * @param {?} field
     * @return {?}
     */
    getFieldModel(model, field) {
        if (field.fieldGroup || field.fieldArray) {
            return model;
        }
        return getFieldModel(model, field, false);
    }
    /**
     * @param {?} model
     * @param {?} field
     * @return {?}
     */
    getParentModel(model, field) {
        if (field.key && (field.fieldGroup || field.fieldArray)) {
            return getFieldModel(model, field, true);
        }
        return model;
    }
    /**
     * @param {?} parent
     * @param {?} field
     * @return {?}
     */
    removeFieldControl(parent, field) {
        if (parent instanceof FormArray) {
            parent.removeAt(/** @type {?} */ (this.fieldKey(field)));
        }
        else if (parent instanceof FormGroup) {
            parent.removeControl(`${this.fieldKey(field)}`);
        }
    }
    /**
     * @param {?} form
     * @param {?} field
     * @return {?}
     */
    fieldParentFormControl(form, field) {
        const /** @type {?} */ paths = getKeyPath(field);
        paths.pop(); // remove last path
        return /** @type {?} */ ((paths.length > 0 ? form.get(paths) : form));
    }
    /**
     * @param {?} field
     * @return {?}
     */
    fieldKey(field) {
        return getKeyPath(field).pop();
    }
}
FormlyFormExpression.decorators = [
    { type: Injectable },
];

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWx5LmZvcm0uZXhwcmVzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZm9ybWx5LmZvcm0uZXhwcmVzc2lvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxjQUFjLEVBQUUsaUJBQWlCLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7Ozs7QUFNckgsTUFBTTs7Ozs7Ozs7SUFDSixXQUFXLENBQUMsSUFBMkIsRUFBRSxTQUE4QixFQUFFLEVBQUUsS0FBVSxFQUFFLE9BQTBCO1FBQy9HLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDakQ7Ozs7Ozs7O0lBRU8sWUFBWSxDQUFDLElBQTJCLEVBQUUsU0FBOEIsRUFBRSxFQUFFLEtBQVUsRUFBRSxPQUEwQjtRQUN4SCxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JCLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3pGLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRXpGLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdB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LENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFRLEVBQUM7Ozs7OztJQUdwRCxRQUFRLENBQUMsS0FBd0I7UUFDdkMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7OztZQWpKbEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCwgRm9ybUFycmF5IH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seUZvcm1PcHRpb25zLCBGb3JtbHlWYWx1ZUNoYW5nZUV2ZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtbHkuZmllbGQuY29uZmlnJztcbmltcG9ydCB7IGV2YWxFeHByZXNzaW9uLCBGT1JNTFlfVkFMSURBVE9SUywgZ2V0RmllbGRNb2RlbCwgaXNPYmplY3QsIGdldEtleVBhdGgsIGlzTnVsbE9yVW5kZWZpbmVkIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRm9ybWx5Rm9ybUV4cHJlc3Npb24ge1xuICBjaGVja0ZpZWxkcyhmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtdLCBtb2RlbDogYW55LCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIHRoaXMuX2NoZWNrRmllbGRzKGZvcm0sIGZpZWxkcywgbW9kZWwsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2hlY2tGaWVsZHMoZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBmaWVsZHM6IEZvcm1seUZpZWxkQ29uZmlnW10gPSBbXSwgbW9kZWw6IGFueSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBmaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICB0aGlzLmNoZWNrRmllbGRFeHByZXNzaW9uQ2hhbmdlKGZvcm0sIGZpZWxkLCB0aGlzLmdldFBhcmVudE1vZGVsKG1vZGVsLCBmaWVsZCksIG9wdGlvbnMpO1xuICAgICAgdGhpcy5jaGVja0ZpZWxkVmlzaWJpbGl0eUNoYW5nZShmb3JtLCBmaWVsZCwgdGhpcy5nZXRQYXJlbnRNb2RlbChtb2RlbCwgZmllbGQpLCBvcHRpb25zKTtcblxuICAgICAgaWYgKGZpZWxkLmZpZWxkR3JvdXAgJiYgZmllbGQuZmllbGRHcm91cC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuX2NoZWNrRmllbGRzKGZpZWxkLmZvcm1Db250cm9sID8gPEZvcm1Hcm91cD4gZmllbGQuZm9ybUNvbnRyb2wgOiBmb3JtLCBmaWVsZC5maWVsZEdyb3VwLCB0aGlzLmdldFBhcmVudE1vZGVsKG1vZGVsLCBmaWVsZCksIG9wdGlvbnMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0ZpZWxkRXhwcmVzc2lvbkNoYW5nZShmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZywgbW9kZWw6IGFueSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBpZiAoIWZpZWxkIHx8ICFmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4cHJlc3Npb25Qcm9wZXJ0aWVzID0gZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXM7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IEZPUk1MWV9WQUxJREFUT1JTLm1hcCh2ID0+IGB0ZW1wbGF0ZU9wdGlvbnMuJHt2fWApO1xuXG4gICAgZm9yIChjb25zdCBrZXkgaW4gZXhwcmVzc2lvblByb3BlcnRpZXMpIHtcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25WYWx1ZSA9IGV2YWxFeHByZXNzaW9uKFxuICAgICAgICBleHByZXNzaW9uUHJvcGVydGllc1trZXldLmV4cHJlc3Npb24sXG4gICAgICAgIHsgZmllbGQgfSxcbiAgICAgICAgW21vZGVsLCBvcHRpb25zLmZvcm1TdGF0ZV0sXG4gICAgICApO1xuXG4gICAgICBpZiAoXG4gICAgICAgIGV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0uZXhwcmVzc2lvblZhbHVlICE9PSBleHByZXNzaW9uVmFsdWVcbiAgICAgICAgJiYgKCFpc09iamVjdChleHByZXNzaW9uVmFsdWUpIHx8IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25WYWx1ZSkgIT09IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0uZXhwcmVzc2lvblZhbHVlKSlcbiAgICAgICkge1xuICAgICAgICBleHByZXNzaW9uUHJvcGVydGllc1trZXldLmV4cHJlc3Npb25WYWx1ZSA9IGV4cHJlc3Npb25WYWx1ZTtcbiAgICAgICAgZXZhbEV4cHJlc3Npb24oXG4gICAgICAgICAgZXhwcmVzc2lvblByb3BlcnRpZXNba2V5XS5leHByZXNzaW9uVmFsdWVTZXR0ZXIsXG4gICAgICAgICAgeyBmaWVsZCB9LFxuICAgICAgICAgIFtleHByZXNzaW9uVmFsdWUsIG1vZGVsLCBmaWVsZF0sXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGtleS5pbmRleE9mKCdtb2RlbC4nKSA9PT0gMCkge1xuICAgICAgICAgIGNvbnN0IHBhdGggPSBrZXkucmVwbGFjZSgvXm1vZGVsXFwuLywgJycpLFxuICAgICAgICAgICAgY29udHJvbCA9IGZpZWxkLmtleSAmJiBrZXkgPT09IHBhdGggPyBmaWVsZC5mb3JtQ29udHJvbCA6IGZvcm0uZ2V0KHBhdGgpO1xuXG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgY29udHJvbFxuICAgICAgICAgICAgJiYgIShpc051bGxPclVuZGVmaW5lZChjb250cm9sLnZhbHVlKSAmJiBpc051bGxPclVuZGVmaW5lZChleHByZXNzaW9uVmFsdWUpKVxuICAgICAgICAgICAgJiYgY29udHJvbC52YWx1ZSAhPT0gZXhwcmVzc2lvblZhbHVlXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBjb250cm9sLnBhdGNoVmFsdWUoZXhwcmVzc2lvblZhbHVlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmFsaWRhdG9ycy5pbmRleE9mKGtleSkgIT09IC0xICYmIGZpZWxkLmZvcm1Db250cm9sKSB7XG4gICAgICAgICAgZmllbGQuZm9ybUNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSh7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRmllbGRWaXNpYmlsaXR5Q2hhbmdlKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCBtb2RlbDogYW55LCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIGlmICghZmllbGQgfHwgaXNOdWxsT3JVbmRlZmluZWQoZmllbGQuaGlkZUV4cHJlc3Npb24pKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaGlkZUV4cHJlc3Npb25SZXN1bHQ6IGJvb2xlYW4gPSAhIWV2YWxFeHByZXNzaW9uKFxuICAgICAgZmllbGQuaGlkZUV4cHJlc3Npb24sXG4gICAgICB7IGZpZWxkIH0sXG4gICAgICBbbW9kZWwsIG9wdGlvbnMuZm9ybVN0YXRlXSxcbiAgICApO1xuXG4gICAgaWYgKGhpZGVFeHByZXNzaW9uUmVzdWx0ICE9PSBmaWVsZC5oaWRlKSB7XG4gICAgICAvLyB0b2dnbGUgaGlkZVxuICAgICAgZmllbGQuaGlkZSA9IGhpZGVFeHByZXNzaW9uUmVzdWx0O1xuICAgICAgZmllbGQudGVtcGxhdGVPcHRpb25zLmhpZGRlbiA9IGhpZGVFeHByZXNzaW9uUmVzdWx0O1xuXG4gICAgICBpZiAoZmllbGQuZm9ybUNvbnRyb2wgJiYgZmllbGQua2V5KSB7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZmllbGRQYXJlbnRGb3JtQ29udHJvbChmb3JtLCBmaWVsZCk7XG4gICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICBjb25zdCBjb250cm9sID0gcGFyZW50LmdldChgJHt0aGlzLmZpZWxkS2V5KGZpZWxkKX1gKTtcbiAgICAgICAgICBpZiAoaGlkZUV4cHJlc3Npb25SZXN1bHQgPT09IHRydWUgJiYgY29udHJvbCkge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZENvbnRyb2wocGFyZW50LCBmaWVsZCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChoaWRlRXhwcmVzc2lvblJlc3VsdCA9PT0gZmFsc2UgJiYgIWNvbnRyb2wpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRmllbGRDb250cm9sKHBhcmVudCwgZmllbGQsIG1vZGVsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG9wdGlvbnMuZmllbGRDaGFuZ2VzKSB7XG4gICAgICAgIG9wdGlvbnMuZmllbGRDaGFuZ2VzLm5leHQoPEZvcm1seVZhbHVlQ2hhbmdlRXZlbnQ+IHsgZmllbGQ6IGZpZWxkLCB0eXBlOiAnaGlkZGVuJywgdmFsdWU6IGhpZGVFeHByZXNzaW9uUmVzdWx0IH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRmllbGRDb250cm9sKHBhcmVudDogRm9ybUFycmF5IHwgRm9ybUdyb3VwLCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcsIG1vZGVsOiBhbnkpIHtcbiAgICBjb25zdCBmaWVsZE1vZGVsID0gdGhpcy5nZXRGaWVsZE1vZGVsKG1vZGVsLCBmaWVsZCk7XG5cbiAgICBpZiAoXG4gICAgICAhKGlzTnVsbE9yVW5kZWZpbmVkKGZpZWxkLmZvcm1Db250cm9sLnZhbHVlKSAmJiBpc051bGxPclVuZGVmaW5lZChmaWVsZE1vZGVsKSlcbiAgICAgICYmIGZpZWxkLmZvcm1Db250cm9sLnZhbHVlICE9PSBmaWVsZE1vZGVsXG4gICAgKSB7XG4gICAgICBmaWVsZC5mb3JtQ29udHJvbC5wYXRjaFZhbHVlKGZpZWxkTW9kZWwsIHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICB9XG5cbiAgICBpZiAocGFyZW50IGluc3RhbmNlb2YgRm9ybUFycmF5KSB7XG4gICAgICBwYXJlbnQucHVzaChmaWVsZC5mb3JtQ29udHJvbCk7XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBGb3JtR3JvdXApIHtcbiAgICAgIHBhcmVudC5hZGRDb250cm9sKGAke3RoaXMuZmllbGRLZXkoZmllbGQpfWAsIGZpZWxkLmZvcm1Db250cm9sKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEZpZWxkTW9kZWwobW9kZWw6IGFueSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgaWYgKGZpZWxkLmZpZWxkR3JvdXAgfHwgZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgcmV0dXJuIG1vZGVsO1xuICAgIH1cblxuICAgIHJldHVybiBnZXRGaWVsZE1vZGVsKG1vZGVsLCBmaWVsZCwgZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYXJlbnRNb2RlbChtb2RlbDogYW55LCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBpZiAoZmllbGQua2V5ICYmIChmaWVsZC5maWVsZEdyb3VwIHx8IGZpZWxkLmZpZWxkQXJyYXkpKSB7XG4gICAgICByZXR1cm4gZ2V0RmllbGRNb2RlbChtb2RlbCwgZmllbGQsIHRydWUpO1xuICAgIH1cbiAgICByZXR1cm4gbW9kZWw7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUZpZWxkQ29udHJvbChwYXJlbnQ6IEZvcm1BcnJheSB8IEZvcm1Hcm91cCwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgaWYgKHBhcmVudCBpbnN0YW5jZW9mIEZvcm1BcnJheSkge1xuICAgICAgcGFyZW50LnJlbW92ZUF0KHRoaXMuZmllbGRLZXkoZmllbGQpIGFzIG51bWJlcik7XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBGb3JtR3JvdXApIHtcbiAgICAgIHBhcmVudC5yZW1vdmVDb250cm9sKGAke3RoaXMuZmllbGRLZXkoZmllbGQpfWApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZmllbGRQYXJlbnRGb3JtQ29udHJvbChmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZyk6IEZvcm1BcnJheSB8IEZvcm1Hcm91cCB7XG4gICAgY29uc3QgcGF0aHMgPSBnZXRLZXlQYXRoKGZpZWxkKTtcbiAgICBwYXRocy5wb3AoKTsgLy8gcmVtb3ZlIGxhc3QgcGF0aFxuXG4gICAgcmV0dXJuIChwYXRocy5sZW5ndGggPiAwID8gZm9ybS5nZXQocGF0aHMpIDogZm9ybSkgYXMgYW55O1xuICB9XG5cbiAgcHJpdmF0ZSBmaWVsZEtleShmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICByZXR1cm4gZ2V0S2V5UGF0aChmaWVsZCkucG9wKCk7XG4gIH1cbn1cbiJdfQ==