/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { AbstractControl, FormGroup, FormArray, FormControl } from '@angular/forms';
import { getKeyPath, isNullOrUndefined } from '../../utils';
/**
 * \@experimental
 */
export class FieldFormExtension {
    /**
     * @param {?} field
     * @return {?}
     */
    onPopulate(field) {
        if (field.key && field.type) {
            /** @type {?} */
            const paths = getKeyPath({ key: field.key });
            /** @type {?} */
            let rootForm = (/** @type {?} */ (field.parent.formControl));
            /** @type {?} */
            let rootModel = field.fieldGroup ? { [paths[0]]: field.model } : field.model;
            paths.forEach((path, index) => {
                // FormGroup/FormArray only allow string value for path
                /** @type {?} */
                const formPath = path.toString();
                // is last item
                if (index === paths.length - 1) {
                    this.addFormControl(rootForm, field, rootModel, formPath);
                }
                else {
                    if (!rootModel[path]) {
                        rootModel[path] = typeof path === 'string' ? {} : [];
                    }
                    this.addFormControl(rootForm, { key: formPath, fieldGroup: [], modelOptions: {}, templateOptions: {} }, rootModel, formPath);
                    rootForm = (/** @type {?} */ (rootForm.get(formPath)));
                    rootModel = rootModel[path];
                }
            });
        }
        if (field.fieldGroup && !field.formControl) {
            field.formControl = field.parent.formControl;
        }
    }
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    addFormControl(form, field, model, path) {
        /** @type {?} */
        const abstractControlOptions = (/** @type {?} */ ({
            validators: field._validators,
            asyncValidators: field._asyncValidators,
            updateOn: field.modelOptions.updateOn,
        }));
        /** @type {?} */
        let control;
        if (field.formControl instanceof AbstractControl || form.get((/** @type {?} */ (path)))) {
            control = field.formControl || form.get((/** @type {?} */ (path)));
            if (!(isNullOrUndefined(control.value) && isNullOrUndefined(model[path]))
                && control.value !== model[path]
                && control instanceof FormControl) {
                control.patchValue(model[path]);
            }
            if (abstractControlOptions.validators || abstractControlOptions.asyncValidators) {
                if (abstractControlOptions.validators) {
                    control.setValidators(abstractControlOptions.validators);
                }
                if (abstractControlOptions.asyncValidators) {
                    control.setAsyncValidators(abstractControlOptions.asyncValidators);
                }
                control.updateValueAndValidity();
            }
        }
        else if (field._componentFactory && field._componentFactory.component && field._componentFactory.component.createControl) {
            /** @type {?} */
            const component = field._componentFactory.component;
            console.warn(`NgxFormly: '${component.name}::createControl' is deprecated since v5.0, use 'prePopulate' hook instead.`);
            control = component.createControl(model[path], field);
        }
        else if (field.fieldGroup && !field.fieldArray) {
            control = new FormGroup({}, abstractControlOptions);
        }
        else if (field.fieldArray) {
            control = new FormArray([], abstractControlOptions);
        }
        else {
            control = new FormControl(model[path], abstractControlOptions);
        }
        if (field.templateOptions.disabled) {
            control.disable();
        }
        // Replace decorated property with a getter that returns the observable.
        // https://github.com/angular-redux/store/blob/master/src/decorators/select.ts#L79-L85
        if (delete field.templateOptions.disabled) {
            Object.defineProperty(field.templateOptions, 'disabled', {
                get: () => !field.formControl.enabled,
                set: (value) => value ? field.formControl.disable() : field.formControl.enable(),
                enumerable: true,
                configurable: true,
            });
        }
        if (field) {
            field.formControl = control;
        }
        if (form instanceof FormArray) {
            if (form.at((/** @type {?} */ (path))) !== control) {
                form.setControl((/** @type {?} */ (path)), control);
            }
        }
        else {
            if (form.get((/** @type {?} */ (path))) !== control) {
                form.setControl((/** @type {?} */ (path)), control);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGQtZm9ybS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvZXh0ZW5zaW9ucy9maWVsZC1mb3JtL2ZpZWxkLWZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUVBLE9BQU8sRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQTBCLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUcsT0FBTyxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQzs7OztBQUc1RCxNQUFNLE9BQU8sa0JBQWtCOzs7OztJQUM3QixVQUFVLENBQUMsS0FBNkI7UUFDdEMsSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7O2tCQUNyQixLQUFLLEdBQUcsVUFBVSxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7Z0JBQ3hDLFFBQVEsR0FBRyxtQkFBQSxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBYTs7Z0JBQUUsU0FBUyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLO1lBQzlILEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7OztzQkFFdEIsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2hDLGVBQWU7Z0JBQ2YsSUFBSSxLQUFLLEtBQUssS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQzlCLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7aUJBQzNEO3FCQUFNO29CQUNMLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUU7d0JBQ3BCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO3FCQUN0RDtvQkFDRCxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7b0JBRTdILFFBQVEsR0FBRyxtQkFBWSxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFBLENBQUM7b0JBQzlDLFNBQVMsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQzdCO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUVELElBQUksS0FBSyxDQUFDLFVBQVUsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUU7WUFDMUMsS0FBSyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztTQUM5QztJQUNILENBQUM7Ozs7Ozs7O0lBRU8sY0FBYyxDQUFDLElBQTJCLEVBQUUsS0FBNkIsRUFBRSxLQUFVLEVBQUUsSUFBcUI7O2NBQzVHLHNCQUFzQixHQUFHLG1CQUFBO1lBQzdCLFVBQVUsRUFBRSxLQUFLLENBQUMsV0FBVztZQUM3QixlQUFlLEVBQUUsS0FBSyxDQUFDLGdCQUFnQjtZQUN2QyxRQUFRLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxRQUFRO1NBQ3RDLEVBQTBCOztZQUN2QixPQUF3QjtRQUU1QixJQUFJLEtBQUssQ0FBQyxXQUFXLFlBQVksZUFBZSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsbUJBQVMsSUFBSSxFQUFBLENBQUMsRUFBRTtZQUMzRSxPQUFPLEdBQUcsS0FBSyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFTLElBQUksRUFBQSxDQUFDLENBQUM7WUFDdkQsSUFDRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO21CQUNsRSxPQUFPLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQUM7bUJBQzdCLE9BQU8sWUFBWSxXQUFXLEVBQ2pDO2dCQUNBLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDakM7WUFFRCxJQUFJLHNCQUFzQixDQUFDLFVBQVUsSUFBSSxzQkFBc0IsQ0FBQyxlQUFlLEVBQUU7Z0JBQy9FLElBQUksc0JBQXNCLENBQUMsVUFBVSxFQUFFO29CQUNyQyxPQUFPLENBQUMsYUFBYSxDQUFDLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxDQUFDO2lCQUMxRDtnQkFDRCxJQUFJLHNCQUFzQixDQUFDLGVBQWUsRUFBRTtvQkFDMUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxDQUFDO2lCQUNwRTtnQkFDRCxPQUFPLENBQUMsc0JBQXNCLEVBQUUsQ0FBQzthQUNsQztTQUNGO2FBQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRTs7a0JBQ3BILFNBQVMsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUMsU0FBUztZQUNuRCxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsU0FBUyxDQUFDLElBQUksNEVBQTRFLENBQUMsQ0FBQztZQUN4SCxPQUFPLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkQ7YUFBTSxJQUFJLEtBQUssQ0FBQyxVQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ2hELE9BQU8sR0FBRyxJQUFJLFNBQVMsQ0FBQyxFQUFFLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztTQUNyRDthQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUMzQixPQUFPLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxFQUFFLHNCQUFzQixDQUFDLENBQUM7U0FDckQ7YUFBTTtZQUNMLE9BQU8sR0FBRyxJQUFJLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztTQUNoRTtRQUVELElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUU7WUFDbEMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ25CO1FBRUQsd0VBQXdFO1FBQ3hFLHNGQUFzRjtRQUN0RixJQUFJLE9BQU8sS0FBSyxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUU7WUFDekMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLFVBQVUsRUFBRTtnQkFDdkQsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPO2dCQUNyQyxHQUFHLEVBQUUsQ0FBQyxLQUFjLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3pGLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixZQUFZLEVBQUUsSUFBSTthQUNuQixDQUFDLENBQUM7U0FDSjtRQUVELElBQUksS0FBSyxFQUFFO1lBQ1QsS0FBSyxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUM7U0FDN0I7UUFFRCxJQUFJLElBQUksWUFBWSxTQUFTLEVBQUU7WUFDN0IsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDLG1CQUFTLElBQUksRUFBQSxDQUFDLEtBQUssT0FBTyxFQUFFO2dCQUN0QyxJQUFJLENBQUMsVUFBVSxDQUFDLG1CQUFTLElBQUksRUFBQSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQ3pDO1NBQ0Y7YUFBTTtZQUNMLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBUyxJQUFJLEVBQUEsQ0FBQyxLQUFLLE9BQU8sRUFBRTtnQkFDdkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxtQkFBUyxJQUFJLEVBQUEsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUN6QztTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybWx5RXh0ZW5zaW9uIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvZm9ybWx5LmNvbmZpZyc7XG5pbXBvcnQgeyBGb3JtbHlGaWVsZENvbmZpZ0NhY2hlIH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9mb3JtbHkuZmllbGQuY29uZmlnJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sLCBBYnN0cmFjdENvbnRyb2xPcHRpb25zIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgZ2V0S2V5UGF0aCwgaXNOdWxsT3JVbmRlZmluZWQgfSBmcm9tICcuLi8uLi91dGlscyc7XG5cbi8qKiBAZXhwZXJpbWVudGFsICovXG5leHBvcnQgY2xhc3MgRmllbGRGb3JtRXh0ZW5zaW9uIGltcGxlbWVudHMgRm9ybWx5RXh0ZW5zaW9uIHtcbiAgb25Qb3B1bGF0ZShmaWVsZDogRm9ybWx5RmllbGRDb25maWdDYWNoZSkge1xuICAgIGlmIChmaWVsZC5rZXkgJiYgZmllbGQudHlwZSkge1xuICAgICAgY29uc3QgcGF0aHMgPSBnZXRLZXlQYXRoKHsga2V5OiBmaWVsZC5rZXkgfSk7XG4gICAgICBsZXQgcm9vdEZvcm0gPSBmaWVsZC5wYXJlbnQuZm9ybUNvbnRyb2wgYXMgRm9ybUdyb3VwLCByb290TW9kZWwgPSBmaWVsZC5maWVsZEdyb3VwID8geyBbcGF0aHNbMF1dOiBmaWVsZC5tb2RlbCB9IDogZmllbGQubW9kZWw7XG4gICAgICBwYXRocy5mb3JFYWNoKChwYXRoLCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBGb3JtR3JvdXAvRm9ybUFycmF5IG9ubHkgYWxsb3cgc3RyaW5nIHZhbHVlIGZvciBwYXRoXG4gICAgICAgIGNvbnN0IGZvcm1QYXRoID0gcGF0aC50b1N0cmluZygpO1xuICAgICAgICAvLyBpcyBsYXN0IGl0ZW1cbiAgICAgICAgaWYgKGluZGV4ID09PSBwYXRocy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgdGhpcy5hZGRGb3JtQ29udHJvbChyb290Rm9ybSwgZmllbGQsIHJvb3RNb2RlbCwgZm9ybVBhdGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghcm9vdE1vZGVsW3BhdGhdKSB7XG4gICAgICAgICAgICByb290TW9kZWxbcGF0aF0gPSB0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycgPyB7fSA6IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmFkZEZvcm1Db250cm9sKHJvb3RGb3JtLCB7IGtleTogZm9ybVBhdGgsIGZpZWxkR3JvdXA6IFtdLCBtb2RlbE9wdGlvbnM6IHt9LCB0ZW1wbGF0ZU9wdGlvbnM6IHt9IH0sIHJvb3RNb2RlbCwgZm9ybVBhdGgpO1xuXG4gICAgICAgICAgcm9vdEZvcm0gPSA8Rm9ybUdyb3VwPiByb290Rm9ybS5nZXQoZm9ybVBhdGgpO1xuICAgICAgICAgIHJvb3RNb2RlbCA9IHJvb3RNb2RlbFtwYXRoXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLmZpZWxkR3JvdXAgJiYgIWZpZWxkLmZvcm1Db250cm9sKSB7XG4gICAgICBmaWVsZC5mb3JtQ29udHJvbCA9IGZpZWxkLnBhcmVudC5mb3JtQ29udHJvbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZEZvcm1Db250cm9sKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUsIG1vZGVsOiBhbnksIHBhdGg6IHN0cmluZyB8IG51bWJlcikge1xuICAgIGNvbnN0IGFic3RyYWN0Q29udHJvbE9wdGlvbnMgPSB7XG4gICAgICB2YWxpZGF0b3JzOiBmaWVsZC5fdmFsaWRhdG9ycyxcbiAgICAgIGFzeW5jVmFsaWRhdG9yczogZmllbGQuX2FzeW5jVmFsaWRhdG9ycyxcbiAgICAgIHVwZGF0ZU9uOiBmaWVsZC5tb2RlbE9wdGlvbnMudXBkYXRlT24sXG4gICAgfSBhcyBBYnN0cmFjdENvbnRyb2xPcHRpb25zO1xuICAgIGxldCBjb250cm9sOiBBYnN0cmFjdENvbnRyb2w7XG5cbiAgICBpZiAoZmllbGQuZm9ybUNvbnRyb2wgaW5zdGFuY2VvZiBBYnN0cmFjdENvbnRyb2wgfHwgZm9ybS5nZXQoPHN0cmluZz4gcGF0aCkpIHtcbiAgICAgIGNvbnRyb2wgPSBmaWVsZC5mb3JtQ29udHJvbCB8fCBmb3JtLmdldCg8c3RyaW5nPiBwYXRoKTtcbiAgICAgIGlmIChcbiAgICAgICAgIShpc051bGxPclVuZGVmaW5lZChjb250cm9sLnZhbHVlKSAmJiBpc051bGxPclVuZGVmaW5lZChtb2RlbFtwYXRoXSkpXG4gICAgICAgICYmIGNvbnRyb2wudmFsdWUgIT09IG1vZGVsW3BhdGhdXG4gICAgICAgICYmIGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQ29udHJvbFxuICAgICAgKSB7XG4gICAgICAgIGNvbnRyb2wucGF0Y2hWYWx1ZShtb2RlbFtwYXRoXSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChhYnN0cmFjdENvbnRyb2xPcHRpb25zLnZhbGlkYXRvcnMgfHwgYWJzdHJhY3RDb250cm9sT3B0aW9ucy5hc3luY1ZhbGlkYXRvcnMpIHtcbiAgICAgICAgaWYgKGFic3RyYWN0Q29udHJvbE9wdGlvbnMudmFsaWRhdG9ycykge1xuICAgICAgICAgIGNvbnRyb2wuc2V0VmFsaWRhdG9ycyhhYnN0cmFjdENvbnRyb2xPcHRpb25zLnZhbGlkYXRvcnMpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhYnN0cmFjdENvbnRyb2xPcHRpb25zLmFzeW5jVmFsaWRhdG9ycykge1xuICAgICAgICAgIGNvbnRyb2wuc2V0QXN5bmNWYWxpZGF0b3JzKGFic3RyYWN0Q29udHJvbE9wdGlvbnMuYXN5bmNWYWxpZGF0b3JzKTtcbiAgICAgICAgfVxuICAgICAgICBjb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGZpZWxkLl9jb21wb25lbnRGYWN0b3J5ICYmIGZpZWxkLl9jb21wb25lbnRGYWN0b3J5LmNvbXBvbmVudCAmJiBmaWVsZC5fY29tcG9uZW50RmFjdG9yeS5jb21wb25lbnQuY3JlYXRlQ29udHJvbCkge1xuICAgICAgY29uc3QgY29tcG9uZW50ID0gZmllbGQuX2NvbXBvbmVudEZhY3RvcnkuY29tcG9uZW50O1xuICAgICAgY29uc29sZS53YXJuKGBOZ3hGb3JtbHk6ICcke2NvbXBvbmVudC5uYW1lfTo6Y3JlYXRlQ29udHJvbCcgaXMgZGVwcmVjYXRlZCBzaW5jZSB2NS4wLCB1c2UgJ3ByZVBvcHVsYXRlJyBob29rIGluc3RlYWQuYCk7XG4gICAgICBjb250cm9sID0gY29tcG9uZW50LmNyZWF0ZUNvbnRyb2wobW9kZWxbcGF0aF0sIGZpZWxkKTtcbiAgICB9IGVsc2UgaWYgKGZpZWxkLmZpZWxkR3JvdXAgJiYgIWZpZWxkLmZpZWxkQXJyYXkpIHtcbiAgICAgIGNvbnRyb2wgPSBuZXcgRm9ybUdyb3VwKHt9LCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9IGVsc2UgaWYgKGZpZWxkLmZpZWxkQXJyYXkpIHtcbiAgICAgIGNvbnRyb2wgPSBuZXcgRm9ybUFycmF5KFtdLCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChtb2RlbFtwYXRoXSwgYWJzdHJhY3RDb250cm9sT3B0aW9ucyk7XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLnRlbXBsYXRlT3B0aW9ucy5kaXNhYmxlZCkge1xuICAgICAgY29udHJvbC5kaXNhYmxlKCk7XG4gICAgfVxuXG4gICAgLy8gUmVwbGFjZSBkZWNvcmF0ZWQgcHJvcGVydHkgd2l0aCBhIGdldHRlciB0aGF0IHJldHVybnMgdGhlIG9ic2VydmFibGUuXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItcmVkdXgvc3RvcmUvYmxvYi9tYXN0ZXIvc3JjL2RlY29yYXRvcnMvc2VsZWN0LnRzI0w3OS1MODVcbiAgICBpZiAoZGVsZXRlIGZpZWxkLnRlbXBsYXRlT3B0aW9ucy5kaXNhYmxlZCkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGZpZWxkLnRlbXBsYXRlT3B0aW9ucywgJ2Rpc2FibGVkJywge1xuICAgICAgICBnZXQ6ICgpID0+ICFmaWVsZC5mb3JtQ29udHJvbC5lbmFibGVkLFxuICAgICAgICBzZXQ6ICh2YWx1ZTogYm9vbGVhbikgPT4gdmFsdWUgPyBmaWVsZC5mb3JtQ29udHJvbC5kaXNhYmxlKCkgOiBmaWVsZC5mb3JtQ29udHJvbC5lbmFibGUoKSxcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkKSB7XG4gICAgICBmaWVsZC5mb3JtQ29udHJvbCA9IGNvbnRyb2w7XG4gICAgfVxuXG4gICAgaWYgKGZvcm0gaW5zdGFuY2VvZiBGb3JtQXJyYXkpIHtcbiAgICAgIGlmIChmb3JtLmF0KDxudW1iZXI+IHBhdGgpICE9PSBjb250cm9sKSB7XG4gICAgICAgIGZvcm0uc2V0Q29udHJvbCg8bnVtYmVyPiBwYXRoLCBjb250cm9sKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGZvcm0uZ2V0KDxzdHJpbmc+IHBhdGgpICE9PSBjb250cm9sKSB7XG4gICAgICAgIGZvcm0uc2V0Q29udHJvbCg8c3RyaW5nPiBwYXRoLCBjb250cm9sKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==