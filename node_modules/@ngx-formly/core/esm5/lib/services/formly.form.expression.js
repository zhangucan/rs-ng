/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { FormGroup, FormArray } from '@angular/forms';
import { evalExpression, FORMLY_VALIDATORS, getFieldModel, isObject, getKeyPath, isNullOrUndefined } from '../utils';
/**
 * \@internal
 */
var FormlyFormExpression = /** @class */ (function () {
    function FormlyFormExpression() {
    }
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    FormlyFormExpression.prototype.checkFields = /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    function (form, fields, model, options) {
        if (fields === void 0) { fields = []; }
        this._checkFields(form, fields, model, options);
    };
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    FormlyFormExpression.prototype._checkFields = /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    function (form, fields, model, options) {
        var _this = this;
        if (fields === void 0) { fields = []; }
        fields.forEach(function (field) {
            _this.checkFieldExpressionChange(form, field, _this.getParentModel(model, field), options);
            _this.checkFieldVisibilityChange(form, field, _this.getParentModel(model, field), options);
            if (field.fieldGroup && field.fieldGroup.length > 0) {
                _this._checkFields(field.formControl ? /** @type {?} */ (field.formControl) : form, field.fieldGroup, _this.getParentModel(model, field), options);
            }
        });
    };
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} options
     * @return {?}
     */
    FormlyFormExpression.prototype.checkFieldExpressionChange = /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} options
     * @return {?}
     */
    function (form, field, model, options) {
        if (!field || !field.expressionProperties) {
            return;
        }
        var /** @type {?} */ expressionProperties = field.expressionProperties;
        var /** @type {?} */ validators = FORMLY_VALIDATORS.map(function (v) { return "templateOptions." + v; });
        for (var /** @type {?} */ key in expressionProperties) {
            var /** @type {?} */ expressionValue = evalExpression(expressionProperties[key].expression, { field: field }, [model, options.formState]);
            if (expressionProperties[key].expressionValue !== expressionValue
                && (!isObject(expressionValue) || JSON.stringify(expressionValue) !== JSON.stringify(expressionProperties[key].expressionValue))) {
                expressionProperties[key].expressionValue = expressionValue;
                evalExpression(expressionProperties[key].expressionValueSetter, { field: field }, [expressionValue, model, field]);
                if (key.indexOf('model.') === 0) {
                    var /** @type {?} */ path = key.replace(/^model\./, ''), /** @type {?} */
                    control = field.key && key === path ? field.formControl : form.get(path);
                    if (control
                        && !(isNullOrUndefined(control.value) && isNullOrUndefined(expressionValue))
                        && control.value !== expressionValue) {
                        control.patchValue(expressionValue);
                    }
                }
                if (validators.indexOf(key) !== -1 && field.formControl) {
                    field.formControl.updateValueAndValidity({ emitEvent: false });
                }
            }
        }
    };
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} options
     * @return {?}
     */
    FormlyFormExpression.prototype.checkFieldVisibilityChange = /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} options
     * @return {?}
     */
    function (form, field, model, options) {
        if (!field || isNullOrUndefined(field.hideExpression)) {
            return;
        }
        var /** @type {?} */ hideExpressionResult = !!evalExpression(field.hideExpression, { field: field }, [model, options.formState]);
        if (hideExpressionResult !== field.hide) {
            // toggle hide
            field.hide = hideExpressionResult;
            field.templateOptions.hidden = hideExpressionResult;
            if (field.formControl && field.key) {
                var /** @type {?} */ parent_1 = this.fieldParentFormControl(form, field);
                if (parent_1) {
                    var /** @type {?} */ control = parent_1.get("" + this.fieldKey(field));
                    if (hideExpressionResult === true && control) {
                        this.removeFieldControl(parent_1, field);
                    }
                    else if (hideExpressionResult === false && !control) {
                        this.addFieldControl(parent_1, field, model);
                    }
                }
            }
            if (options.fieldChanges) {
                options.fieldChanges.next(/** @type {?} */ ({ field: field, type: 'hidden', value: hideExpressionResult }));
            }
        }
    };
    /**
     * @param {?} parent
     * @param {?} field
     * @param {?} model
     * @return {?}
     */
    FormlyFormExpression.prototype.addFieldControl = /**
     * @param {?} parent
     * @param {?} field
     * @param {?} model
     * @return {?}
     */
    function (parent, field, model) {
        var /** @type {?} */ fieldModel = this.getFieldModel(model, field);
        if (!(isNullOrUndefined(field.formControl.value) && isNullOrUndefined(fieldModel))
            && field.formControl.value !== fieldModel) {
            field.formControl.patchValue(fieldModel, { emitEvent: false });
        }
        if (parent instanceof FormArray) {
            parent.push(field.formControl);
        }
        else if (parent instanceof FormGroup) {
            parent.addControl("" + this.fieldKey(field), field.formControl);
        }
    };
    /**
     * @param {?} model
     * @param {?} field
     * @return {?}
     */
    FormlyFormExpression.prototype.getFieldModel = /**
     * @param {?} model
     * @param {?} field
     * @return {?}
     */
    function (model, field) {
        if (field.fieldGroup || field.fieldArray) {
            return model;
        }
        return getFieldModel(model, field, false);
    };
    /**
     * @param {?} model
     * @param {?} field
     * @return {?}
     */
    FormlyFormExpression.prototype.getParentModel = /**
     * @param {?} model
     * @param {?} field
     * @return {?}
     */
    function (model, field) {
        if (field.key && (field.fieldGroup || field.fieldArray)) {
            return getFieldModel(model, field, true);
        }
        return model;
    };
    /**
     * @param {?} parent
     * @param {?} field
     * @return {?}
     */
    FormlyFormExpression.prototype.removeFieldControl = /**
     * @param {?} parent
     * @param {?} field
     * @return {?}
     */
    function (parent, field) {
        if (parent instanceof FormArray) {
            parent.removeAt(/** @type {?} */ (this.fieldKey(field)));
        }
        else if (parent instanceof FormGroup) {
            parent.removeControl("" + this.fieldKey(field));
        }
    };
    /**
     * @param {?} form
     * @param {?} field
     * @return {?}
     */
    FormlyFormExpression.prototype.fieldParentFormControl = /**
     * @param {?} form
     * @param {?} field
     * @return {?}
     */
    function (form, field) {
        var /** @type {?} */ paths = getKeyPath(field);
        paths.pop(); // remove last path
        return /** @type {?} */ ((paths.length > 0 ? form.get(paths) : form));
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormExpression.prototype.fieldKey = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        return getKeyPath(field).pop();
    };
    FormlyFormExpression.decorators = [
        { type: Injectable },
    ];
    return FormlyFormExpression;
}());
export { FormlyFormExpression };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWx5LmZvcm0uZXhwcmVzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZm9ybWx5LmZvcm0uZXhwcmVzc2lvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxjQUFjLEVBQUUsaUJBQWlCLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7Ozs7Ozs7Ozs7Ozs7O0lBT25ILDBDQUFXOzs7Ozs7O0lBQVgsVUFBWSxJQUEyQixFQUFFLE1BQWdDLEVBQUUsS0FBVSxFQUFFLE9BQTBCO1FBQXhFLHVCQUFBLEVBQUEsV0FBZ0M7UUFDdkUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNqRDs7Ozs7Ozs7SUFFTywyQ0FBWTs7Ozs7OztjQUFDLElBQTJCLEVBQUUsTUFBZ0MsRUFBRSxLQUFVLEVBQUUsT0FBMEI7O1FBQXhFLHVCQUFBLEVBQUEsV0FBZ0M7UUFDaEYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFBLEtBQUs7WUFDbEIsS0FBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDekYsS0FBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFFekYsRUFBRSxDQUFDLENBQUMsS0FB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O1FBQ2hDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVaLE1BQU0sbUJBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFRLEVBQUM7Ozs7OztJQUdwRCx1Q0FBUTs7OztjQUFDLEtBQXdCO1FBQ3ZDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7OztnQkFqSmxDLFVBQVU7OytCQVJYOztTQVNhLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCwgRm9ybUFycmF5IH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seUZvcm1PcHRpb25zLCBGb3JtbHlWYWx1ZUNoYW5nZUV2ZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtbHkuZmllbGQuY29uZmlnJztcbmltcG9ydCB7IGV2YWxFeHByZXNzaW9uLCBGT1JNTFlfVkFMSURBVE9SUywgZ2V0RmllbGRNb2RlbCwgaXNPYmplY3QsIGdldEtleVBhdGgsIGlzTnVsbE9yVW5kZWZpbmVkIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRm9ybWx5Rm9ybUV4cHJlc3Npb24ge1xuICBjaGVja0ZpZWxkcyhmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtdLCBtb2RlbDogYW55LCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIHRoaXMuX2NoZWNrRmllbGRzKGZvcm0sIGZpZWxkcywgbW9kZWwsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2hlY2tGaWVsZHMoZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBmaWVsZHM6IEZvcm1seUZpZWxkQ29uZmlnW10gPSBbXSwgbW9kZWw6IGFueSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBmaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICB0aGlzLmNoZWNrRmllbGRFeHByZXNzaW9uQ2hhbmdlKGZvcm0sIGZpZWxkLCB0aGlzLmdldFBhcmVudE1vZGVsKG1vZGVsLCBmaWVsZCksIG9wdGlvbnMpO1xuICAgICAgdGhpcy5jaGVja0ZpZWxkVmlzaWJpbGl0eUNoYW5nZShmb3JtLCBmaWVsZCwgdGhpcy5nZXRQYXJlbnRNb2RlbChtb2RlbCwgZmllbGQpLCBvcHRpb25zKTtcblxuICAgICAgaWYgKGZpZWxkLmZpZWxkR3JvdXAgJiYgZmllbGQuZmllbGRHcm91cC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuX2NoZWNrRmllbGRzKGZpZWxkLmZvcm1Db250cm9sID8gPEZvcm1Hcm91cD4gZmllbGQuZm9ybUNvbnRyb2wgOiBmb3JtLCBmaWVsZC5maWVsZEdyb3VwLCB0aGlzLmdldFBhcmVudE1vZGVsKG1vZGVsLCBmaWVsZCksIG9wdGlvbnMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0ZpZWxkRXhwcmVzc2lvbkNoYW5nZShmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZywgbW9kZWw6IGFueSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBpZiAoIWZpZWxkIHx8ICFmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4cHJlc3Npb25Qcm9wZXJ0aWVzID0gZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXM7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IEZPUk1MWV9WQUxJREFUT1JTLm1hcCh2ID0+IGB0ZW1wbGF0ZU9wdGlvbnMuJHt2fWApO1xuXG4gICAgZm9yIChjb25zdCBrZXkgaW4gZXhwcmVzc2lvblByb3BlcnRpZXMpIHtcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25WYWx1ZSA9IGV2YWxFeHByZXNzaW9uKFxuICAgICAgICBleHByZXNzaW9uUHJvcGVydGllc1trZXldLmV4cHJlc3Npb24sXG4gICAgICAgIHsgZmllbGQgfSxcbiAgICAgICAgW21vZGVsLCBvcHRpb25zLmZvcm1TdGF0ZV0sXG4gICAgICApO1xuXG4gICAgICBpZiAoXG4gICAgICAgIGV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0uZXhwcmVzc2lvblZhbHVlICE9PSBleHByZXNzaW9uVmFsdWVcbiAgICAgICAgJiYgKCFpc09iamVjdChleHByZXNzaW9uVmFsdWUpIHx8IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25WYWx1ZSkgIT09IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0uZXhwcmVzc2lvblZhbHVlKSlcbiAgICAgICkge1xuICAgICAgICBleHByZXNzaW9uUHJvcGVydGllc1trZXldLmV4cHJlc3Npb25WYWx1ZSA9IGV4cHJlc3Npb25WYWx1ZTtcbiAgICAgICAgZXZhbEV4cHJlc3Npb24oXG4gICAgICAgICAgZXhwcmVzc2lvblByb3BlcnRpZXNba2V5XS5leHByZXNzaW9uVmFsdWVTZXR0ZXIsXG4gICAgICAgICAgeyBmaWVsZCB9LFxuICAgICAgICAgIFtleHByZXNzaW9uVmFsdWUsIG1vZGVsLCBmaWVsZF0sXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGtleS5pbmRleE9mKCdtb2RlbC4nKSA9PT0gMCkge1xuICAgICAgICAgIGNvbnN0IHBhdGggPSBrZXkucmVwbGFjZSgvXm1vZGVsXFwuLywgJycpLFxuICAgICAgICAgICAgY29udHJvbCA9IGZpZWxkLmtleSAmJiBrZXkgPT09IHBhdGggPyBmaWVsZC5mb3JtQ29udHJvbCA6IGZvcm0uZ2V0KHBhdGgpO1xuXG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgY29udHJvbFxuICAgICAgICAgICAgJiYgIShpc051bGxPclVuZGVmaW5lZChjb250cm9sLnZhbHVlKSAmJiBpc051bGxPclVuZGVmaW5lZChleHByZXNzaW9uVmFsdWUpKVxuICAgICAgICAgICAgJiYgY29udHJvbC52YWx1ZSAhPT0gZXhwcmVzc2lvblZhbHVlXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBjb250cm9sLnBhdGNoVmFsdWUoZXhwcmVzc2lvblZhbHVlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmFsaWRhdG9ycy5pbmRleE9mKGtleSkgIT09IC0xICYmIGZpZWxkLmZvcm1Db250cm9sKSB7XG4gICAgICAgICAgZmllbGQuZm9ybUNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSh7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRmllbGRWaXNpYmlsaXR5Q2hhbmdlKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCBtb2RlbDogYW55LCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIGlmICghZmllbGQgfHwgaXNOdWxsT3JVbmRlZmluZWQoZmllbGQuaGlkZUV4cHJlc3Npb24pKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaGlkZUV4cHJlc3Npb25SZXN1bHQ6IGJvb2xlYW4gPSAhIWV2YWxFeHByZXNzaW9uKFxuICAgICAgZmllbGQuaGlkZUV4cHJlc3Npb24sXG4gICAgICB7IGZpZWxkIH0sXG4gICAgICBbbW9kZWwsIG9wdGlvbnMuZm9ybVN0YXRlXSxcbiAgICApO1xuXG4gICAgaWYgKGhpZGVFeHByZXNzaW9uUmVzdWx0ICE9PSBmaWVsZC5oaWRlKSB7XG4gICAgICAvLyB0b2dnbGUgaGlkZVxuICAgICAgZmllbGQuaGlkZSA9IGhpZGVFeHByZXNzaW9uUmVzdWx0O1xuICAgICAgZmllbGQudGVtcGxhdGVPcHRpb25zLmhpZGRlbiA9IGhpZGVFeHByZXNzaW9uUmVzdWx0O1xuXG4gICAgICBpZiAoZmllbGQuZm9ybUNvbnRyb2wgJiYgZmllbGQua2V5KSB7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZmllbGRQYXJlbnRGb3JtQ29udHJvbChmb3JtLCBmaWVsZCk7XG4gICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICBjb25zdCBjb250cm9sID0gcGFyZW50LmdldChgJHt0aGlzLmZpZWxkS2V5KGZpZWxkKX1gKTtcbiAgICAgICAgICBpZiAoaGlkZUV4cHJlc3Npb25SZXN1bHQgPT09IHRydWUgJiYgY29udHJvbCkge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZENvbnRyb2wocGFyZW50LCBmaWVsZCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChoaWRlRXhwcmVzc2lvblJlc3VsdCA9PT0gZmFsc2UgJiYgIWNvbnRyb2wpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRmllbGRDb250cm9sKHBhcmVudCwgZmllbGQsIG1vZGVsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG9wdGlvbnMuZmllbGRDaGFuZ2VzKSB7XG4gICAgICAgIG9wdGlvbnMuZmllbGRDaGFuZ2VzLm5leHQoPEZvcm1seVZhbHVlQ2hhbmdlRXZlbnQ+IHsgZmllbGQ6IGZpZWxkLCB0eXBlOiAnaGlkZGVuJywgdmFsdWU6IGhpZGVFeHByZXNzaW9uUmVzdWx0IH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRmllbGRDb250cm9sKHBhcmVudDogRm9ybUFycmF5IHwgRm9ybUdyb3VwLCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcsIG1vZGVsOiBhbnkpIHtcbiAgICBjb25zdCBmaWVsZE1vZGVsID0gdGhpcy5nZXRGaWVsZE1vZGVsKG1vZGVsLCBmaWVsZCk7XG5cbiAgICBpZiAoXG4gICAgICAhKGlzTnVsbE9yVW5kZWZpbmVkKGZpZWxkLmZvcm1Db250cm9sLnZhbHVlKSAmJiBpc051bGxPclVuZGVmaW5lZChmaWVsZE1vZGVsKSlcbiAgICAgICYmIGZpZWxkLmZvcm1Db250cm9sLnZhbHVlICE9PSBmaWVsZE1vZGVsXG4gICAgKSB7XG4gICAgICBmaWVsZC5mb3JtQ29udHJvbC5wYXRjaFZhbHVlKGZpZWxkTW9kZWwsIHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICB9XG5cbiAgICBpZiAocGFyZW50IGluc3RhbmNlb2YgRm9ybUFycmF5KSB7XG4gICAgICBwYXJlbnQucHVzaChmaWVsZC5mb3JtQ29udHJvbCk7XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBGb3JtR3JvdXApIHtcbiAgICAgIHBhcmVudC5hZGRDb250cm9sKGAke3RoaXMuZmllbGRLZXkoZmllbGQpfWAsIGZpZWxkLmZvcm1Db250cm9sKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEZpZWxkTW9kZWwobW9kZWw6IGFueSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgaWYgKGZpZWxkLmZpZWxkR3JvdXAgfHwgZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgcmV0dXJuIG1vZGVsO1xuICAgIH1cblxuICAgIHJldHVybiBnZXRGaWVsZE1vZGVsKG1vZGVsLCBmaWVsZCwgZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYXJlbnRNb2RlbChtb2RlbDogYW55LCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBpZiAoZmllbGQua2V5ICYmIChmaWVsZC5maWVsZEdyb3VwIHx8IGZpZWxkLmZpZWxkQXJyYXkpKSB7XG4gICAgICByZXR1cm4gZ2V0RmllbGRNb2RlbChtb2RlbCwgZmllbGQsIHRydWUpO1xuICAgIH1cbiAgICByZXR1cm4gbW9kZWw7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUZpZWxkQ29udHJvbChwYXJlbnQ6IEZvcm1BcnJheSB8IEZvcm1Hcm91cCwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgaWYgKHBhcmVudCBpbnN0YW5jZW9mIEZvcm1BcnJheSkge1xuICAgICAgcGFyZW50LnJlbW92ZUF0KHRoaXMuZmllbGRLZXkoZmllbGQpIGFzIG51bWJlcik7XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBGb3JtR3JvdXApIHtcbiAgICAgIHBhcmVudC5yZW1vdmVDb250cm9sKGAke3RoaXMuZmllbGRLZXkoZmllbGQpfWApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZmllbGRQYXJlbnRGb3JtQ29udHJvbChmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZyk6IEZvcm1BcnJheSB8IEZvcm1Hcm91cCB7XG4gICAgY29uc3QgcGF0aHMgPSBnZXRLZXlQYXRoKGZpZWxkKTtcbiAgICBwYXRocy5wb3AoKTsgLy8gcmVtb3ZlIGxhc3QgcGF0aFxuXG4gICAgcmV0dXJuIChwYXRocy5sZW5ndGggPiAwID8gZm9ybS5nZXQocGF0aHMpIDogZm9ybSkgYXMgYW55O1xuICB9XG5cbiAgcHJpdmF0ZSBmaWVsZEtleShmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICByZXR1cm4gZ2V0S2V5UGF0aChmaWVsZCkucG9wKCk7XG4gIH1cbn1cbiJdfQ==